<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couchbase &middot; daschl writes. sometimes.</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.42.1" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Couchbase &middot; daschl writes. sometimes.">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Couchbase &middot; daschl writes. sometimes.">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://nitschinger.at/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="daschl writes. sometimes." href="https://nitschinger.at/index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title">
                <a href="https://nitschinger.at">daschl writes. sometimes.</a>
            </h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/daschl">
                        <i class="fa fa-twitter"></i> Twitter</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/daschl">
                        <i class="fa fa-github-alt"></i> github</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://nitschinger.at/index.xml">
                        <i class="fa fa-rss"></i> rss</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://nitschinger.at/imprint">Imprint</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">07 Nov 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/New-Features-in-the-Couchbase-Java-Client-1-1-dp4/" class="post-title">New Features in the Couchbase Java Client 1.1-dp4</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="introduction">Introduction</h2>

<p>The latest <a href="http://www.couchbase.com/develop/java/next">Java Developer Preview (dp4)</a> is hot off the press, and therefore I thought it would be a good idea to show you how to use some of the brand-new features that are now available. This post will show you how to use the new <code>ComplexKey</code> class for view queries and also how to create and delete buckets directly from your SDK.</p>

<p>First, we added a very flexible way of providing parameters to view queries. The idea is that, instead of having to deal with JSON strings on your own, you can pass in Java objects and the appropriate JSON string will be created for you. While it may not sound like a big deal first, this also frees you from the worries about encoding it properly so that it can be transferred over HTTP. Before we dig into the inner workings, lets first start with a basic example on how to create a view query.</p>

<p>Every time you query a view, you need to create a <code>Query</code> and a <code>View</code> object. The <code>View</code> both  object defines the name of the design document and the view, and the <code>Query</code> object allows you to control the params that you can supply with the query.</p>

<pre><code>View myview = client.getView(&quot;designdoc&quot;, &quot;viewname&quot;);
</code></pre>

<p>Instead of creating the <code>View</code> object directly, you use the <code>getView()</code> method on the client object. It is important to know that the SDK actually fetches view information from the server and will throw an exception if either the design document name or the view name are not found. An exception typically looks like this:</p>

<pre><code>com.couchbase.client.protocol.views.InvalidViewException: Could not load view &quot;viewname&quot; for design doc &quot;designdoc&quot;
</code></pre>

<p>Now that we have our view created, let&rsquo;s instantiate a query object:</p>

<pre><code>Query myquery = new Query();
</code></pre>

<p>If you don&rsquo;t specify anything else, the query object will work with the default settings. This means that no reduce function will be used and the full documents are not included. If you want to change these settings (or others), the <code>Query</code> instance provides setter methods for all of them. If you want to find out more, look at the SDK documentation or at the <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-querying-rest-api.html">Couchbase Server manual</a>. Basically, you can control everything that you could too while querying a view from the Couchbase UI. Here are some examples:</p>

<pre><code>// Include the full documents as well
myquery.setIncludeDocs(true);

// Enable the reduce function
myquery.setReduce(true);

// Set the group level
myquery.setGroupLevel(2);
</code></pre>

<p>Note that it doesn&rsquo;t make sense to include the full documents and run the reduce phase, since you don&rsquo;t have document references left after the reduce phase. If you try to set both to true, the SDK complains with the following exception:</p>

<pre><code>// query.setReduce(true); query.setIncludeDocs(true);
java.lang.UnsupportedOperationException: Reduced views don't contain documents
</code></pre>

<p>Also, if your view doesn&rsquo;t contain a reduce function and you set <code>reduce</code> to <code>true</code>, you&rsquo;ll see the following:</p>

<pre><code>// query.setReduce(true); on a view with no reduce function defined.
java.lang.RuntimeException: This view doesn't contain a reduce function
</code></pre>

<h2 id="querying-with-complexkeys">Querying with ComplexKeys</h2>

<p>Enough with exceptions, here comes the fun part: some query setter methods not only accept boolean or string arguments, they also allow instances of <code>ComplexKey</code>. <code>ComplexKey</code> takes care of translating your Java objects (or primitives) to their appropriate <a href="http://json.org/">JSON</a> representation. Here is a list of the query methods who support it:</p>

<ul>
<li>setKey(ComplexKey): Return only documents that match the specified key.</li>
<li>setKeys(ComplexKey): Return only documents that match each of keys specified within the given array.</li>
<li>setRange(ComplexKey, ComplexKey): Returns records in the given key range.</li>
<li>setRangeStart(ComplexKey): Return records with a value equal to or greater than the specified key.</li>
<li>setRangeEnd(ComplexKey): Stop returning records when the specified key is reached.</li>
</ul>

<p>An instance of a <code>ComplexKey</code> object is obtained through the static <code>of</code> factory method. When the query object is accessed during the view query, the <code>toJSON()</code> method is called on it and as a result the JSON string is generated. Here are some examples:</p>

<pre><code>// JSON Result: 100
ComplexKey.of(100);

// JSON Result: &quot;Hello&quot;
ComplexKey.of(&quot;Hello&quot;);

// JSON Result: [&quot;Hello&quot;, &quot;World&quot;]
ComplexKey.of(&quot;Hello&quot;, &quot;World&quot;);

// JSON Result: [1349360771542,1]
ComplexKey.of(new Date().getTime(), 1);
</code></pre>

<p>This means that you don&rsquo;t have to deal with building the proper JSON strings for yourself (and make sure the escaping is correct). All methods except <code>setRange()</code> expect exactly one instance of ComplexKey. For example, if you emit keys with a unix timestamp and you want to fetch all records until now, you could do it like so:</p>

<pre><code>Query query = new Query();
query.setRangeEnd(ComplexKey.of(new Date().getTime()));
</code></pre>

<p>When converted to a string to send it over the wire, it would look like this: <code>?endkey=1349361137738</code>. This makes it also very easy to create a full range query:</p>

<pre><code>long now = new Date().getTime();
long tomorrow = now + 86400;
Query query = new Query();
query.setRange(ComplexKey.of(now), ComplexKey.of(tomorrow));
</code></pre>

<p>This converts to <code>?startkey=1349362647742&amp;endkey=1349362734142</code> on the wire.</p>

<h2 id="bucket-management-through-the-clustermanager">Bucket management through the ClusterManager</h2>

<p>Until now, you&rsquo;d have to <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-admin-web-console-data-buckets.html">create and delete buckets</a> either manually through the Couchbase UI or by using the REST API directly. With the addition of the <code>ClusterManager</code>, it is now possible to mange your buckets directly through the SDK, be it for testing purposes or to automatically create them when your code is deployed to a new environment. This can be especially useful if you want to automate bucket management in a staging or CI environment.</p>

<p>The management API is not accessible through <code>CouchbaseClient</code>, but through the <code>ClusterManager</code> class. This is because the <code>CouchbaseClient</code> is bound to a specific bucket and was not designed for management purposes like this. Instead, you create a new instance of the <code>ClusterManager</code> class and pass it a list of URIs and the admin user name and password.</p>

<pre><code>List&lt;URI&gt; uris = new LinkedList&lt;URI&gt;();
uris.add(URI.create(&quot;http://127.0.0.1:8091/pools&quot;));
ClusterManager manager = new ClusterManager(uris, &quot;Administrator&quot;, &quot;password&quot;);

// .. your code

manager.shutdown();
</code></pre>

<p>You can now create and delete buckets (of type <code>Couchbase</code> or <code>Memcached</code>). You can also list all available buckets in the Couchbase cluster or flush the bucket (if flush is enabled). Here are some examples:</p>

<pre><code>// Create the default bucket with a 100MB memory limit and 0 replicas.
manager.createDefaultBucket(BucketType.COUCHBASE, 100, 0);

// Create a bucket with authentication.
manager.createSaslBucket(BucketType.COUCHBASE, &quot;saslbucket&quot;, 100, 0, &quot;password&quot;);

// Get a list of all buckets in the cluster.
List&lt;String&gt; buckets = manager.listBuckets();

// Delete a bucket
manager.deleteBucket(&quot;saslbucket&quot;);

// Check if a bucket named &quot;mybucket&quot; exists in the cluster:
List&lt;String&gt; buckets = manager.listBuckets();
assertTrue(buckets.contains(&quot;mybucket&quot;));

// Flush the &quot;default&quot; bucket if flush is enabled
manager.flushBucket(&quot;default&quot;);
</code></pre>

<p>Note that creating, deleting and flushing may take some time (from milliseconds to seconds, depending on the cluster load). You can either wait a few seconds before you move on (with a Thread.sleep()), or you can wait until <code>listBuckets()</code> contains your created bucket. There is also a callback-approach (which the client library uses internally to minimize waiting times during tests), but this involves more code on the application side.</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>This post showed you two brand-new features shipped with the 1.1-dp4 release.</p>

<p>While you can still use string-based keys to run range or key queries, the <code>ComplexKey</code> class hopefully provides a convenient addition to your tool belt. While also useful for primitives and single objects, it makes it much more convenient to create JSON arrays or objects since you don&rsquo;t have to deal with brackets and escaping yourself.</p>

<p>The <code>ClusterManager</code> gives you the flexibility to manage your buckets directly from the SDK to avoid separate HTTP calls or even manual interaction through the UI.</p>

<p>The full release notes are available <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/couchbase-sdk-java-rn_1-1-0d.html">here</a>. As always, we&rsquo;re curious what you say about this and if you encounter bugs or know how to enhance it even more, feel free to comment below, create a ticket or post in the forums!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">22 Oct 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/New-Job-Couchbase-Server-2-0-and-Couch-Conf-Berlin/" class="post-title">New Job, Couchbase Server 2.0 and CouchConf Berlin</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>The last weeks have been pretty exciting for me. I joined Couchbase as a Developer Advocate mostly working on the Java and PHP SDKs as well as helping out developers who are getting started with our product or have questions during their development process.</p>

<p>The 2.0 release is currently in beta and can be downloaded <a href="http://www.couchbase.com/couchbase-server/beta">here</a>, you may also want to look into the decent <a href="http://www.couchbase.com/couchbase-server/beta#resources">documentation</a> put together by our docs team. If you are speaking german, <a href="http://it-republik.de/php/artikel/Couchbase-2.0-Mehr-als-nur-Key-Value-Store-5329.html">here</a> is a short article that has been published about Couchbase and PHP in preparation for a much longer article coming up in one of the next issues of the <a href="http://it-republik.de/php/">PHP Magazin</a>.</p>

<p>If you are located in Germany or Europe, you may want to join us during <a href="http://www.couchbase.com/couchconf-berlin">CouchConf Berlin</a>, which is happening on October 30th. We also offer developer and operation trainings during that time, so if you want to get your feet wet with Couchbase this is an excellent opportunity. I&rsquo;ll be giving a talk on &ldquo;Getting started with Couchbase App Development&rdquo; and also be around all day (and evening).</p>

<p>When the 2.0 version is released (in combination with all of the supported SDKs), I will also be able to blog more frequently and also provide sample applications with either Java or PHP. There is a lot cool stuff in the pipeline, so stay tuned.</p>

<p>If you have any questions around Couchbase or its proper integration up the stack, feel free to ping me directly or get in touch with the other folks either through IRC (#couchbase, #libcouchbase) or the <a href="http://www.couchbase.com/forums/">Forums</a>. While I certainly can&rsquo;t provide answers to all questions, I can link you up with the right people.</p>

<p>See you in Berlin!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">17 Jul 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/A-Real-Time-chat-with-Play-Java-and-Couchbase-Part-1/" class="post-title">A Real-Time chat with Play, Java and Couchbase - Part 1</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="introduction">Introduction</h2>

<p>I&rsquo;ve been mostly blogging about PHP and <a href="http://lithify.me">Lithium</a>, but recently I&rsquo;ve also been looking into a very promising framework on the JVM - the <a href="http://www.playframework.org/">play! framework</a>. The current version (2.0) brings lots of enhancements and features and is (at least to me) the first framework that really boosts developer productivity on the JVM (and that I would work with in my free time).</p>

<p>In this project, we&rsquo;ll develop a chat application (called <code>couchplay</code>) that allows people to login with a username and then talk to others in real-time. We&rsquo;ll make use of the built-in <a href="http://en.wikipedia.org/wiki/Comet_%28programming%29">Comet</a> functionality and also work with various other aspects of the whole stack. Our application will be powered by <a href="http://www.couchbase.com/">Couchbase</a>, a very fast and flexible NoSQL database that is exactly suited for an application like this.</p>

<p>Note that this tutorial requires a reasonable amount of Java knowledge. Play! itself is mostly written in <a href="http://www.scala-lang.org/">Scala</a> (and uses it for its templates), but I think it should be easy to grasp - at least for the part we&rsquo;ll cover here.</p>

<p>I&rsquo;ve also added the code to a <a href="https://github.com/daschl/couchplay/">repository</a> on GitHub for your convenience. You can find a tag for every post I&rsquo;ll publish so you can just clone the repository and checkout the appropriate tag to follow along.</p>

<h2 id="about-the-stack">About the stack</h2>

<p>Our language of choice will be Java. I first thought about writing it in Scala, but then I realized that with Java I could attract a larger group of readers. Also, I did most of my past explorations in Scala, so this is a great opportunity for me to use the framework from the Java-side as well. The good thing is that the framework allows you to use both languages in parallel, so you can start out with one and then evolve if you need to.</p>

<p>As I said, the play! framework is mostly written in Scala. As a result, the default template engine requires a bit of Scala knowledge, but for our examples here the concepts should not be too hard to learn.  If you come from a mostly servlet-oriented background I predict you a very refreshing look on how web applications can be built also (it is built on top of <a href="http://netty.io/">netty</a> and <a href="http://akka.io/">akka</a>). Once you get the hang of it, you think twice about going back. If you don&rsquo;t believe me now, just follow along.</p>

<p>The framework provides support for relational databases out of the box, but to make things more interesting we&rsquo;re going to use a different database. Couchbase is a high-performant and flexible &ldquo;NoSQL&rdquo; database that is mostly used in real-time analytics, session stores and in general where you need sub-millisecond response times. At the end of the blog series you should have a good idea how you can use it for your own projects. Note that I also wrote a blog post on getting started with Couchbase on either <a href="http://nitschinger.at/Getting-Started-with-Couchbase-and-PHP">PHP</a> and <a href="http://nitschinger.at/Accessing-Couchbase-from-Scala">Scala</a>, so you might want to check them out. For this tutorial, we&rsquo;re going to use the <a href="http://www.couchbase.com/develop/java/next">Couchbase Java SDK</a>, which has everything built-in that we need.</p>

<p>From here on I assume that you have Java 1.6 or later installed and included it in your <code>PATH</code>. If you haven&rsquo;t, there should be plenty of material available on the internet.</p>

<h2 id="installing-couchbase">Installing Couchbase</h2>

<p>Before we start digging into the framework, we need to stop for a second and install our backend database.</p>

<p>Depending on your operating system, you have different choices available. Couchbase provides installers for Windows and Mac OS X, for Linux-based systems I&rsquo;d recommend the package-manager installations. You can find all packages <a href="http://www.couchbase.com/download">here</a>.</p>

<p>We are going to use Couchbase 2.0, which is currently in developer preview (at the time of writing). Just download it, it is very stable and a beta release will be released soon. We are going to use this version because it includes a mechanism called &ldquo;views&rdquo; that allows us to query our data in a very flexible manner (if you&rsquo;re familiar with the <a href="http://en.wikipedia.org/wiki/MapReduce">Map/Reduce-Pattern</a>, this is the method we&rsquo;re going to use here). We&rsquo;ll cover all of those aspects in a later post.</p>

<p>After the installation has finished, open your browser, head over to <code>http://localhost:8091</code> and click through the setup wizard. You can go with the default settings, just make sure to give it a reasonable amount of RAM. If you run into trouble, the official <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-getting-started-install.html">docs</a> are there to help you out.</p>

<h2 id="setting-up-our-play-project">Setting up our play! project</h2>

<p>Now that we have our database installed, it&rsquo;s time to set up the actual play! project. Go to <a href="http://www.playframework.org/">their official website</a> and download the current stable release (2.0.2 at the time of writing).</p>

<p>After the download has finished, unpack the zipfile. Copy it over to a place where it doesn&rsquo;t get accidentally deleted and add it to your <code>PATH</code>. Adding it to the <code>PATH</code> here is pure convenience as I don&rsquo;t like to remember the full path everytime I need to run it.</p>

<p>Now we can use the <code>play new</code> command to setup a new project. I&rsquo;m using Ubuntu Linux here, but the command also works the same on Windows (I haven&rsquo;t tried it on a Mac but it shouldn&rsquo;t be much different).</p>

<pre><code>michael@daschl:~$ play new couchplay
    _            _
_ __ | | __ _ _  _| |
| '_ \| |/ _' | || |_|
|  __/|_|\____|\__ (_)
|_|            |__/

play! 2.0.2, http://www.playframework.org

The new application will be created in /home/michael/couchplay

What is the application name?
&gt; couchplay

Which template do you want to use for this new application?

1 - Create a simple Scala application
2 - Create a simple Java application
3 - Create an empty project

&gt; 2

OK, application couchplay is created.

Have fun!
</code></pre>

<p>The application generator asks you for an application name and if you want to either generate a Scala or Java application. You don&rsquo;t have to choose the language for your final application here, it only wants to know in what language it should generats the sample controller for example.</p>

<p>To make sure it&rsquo;s up and running, change into the directory and run the <code>play</code> command again. This should bring up the play console. For now, just type <code>run</code> and point your browser to <code>http://localhost:9000</code>. You should see the default welcome page of the framework.</p>

<pre><code>michael@daschl:~/couchplay$ play
Getting org.scala-sbt sbt_2.9.1 0.11.3 ...
:: retrieving :: org.scala-sbt#boot-app
    confs: [default]
    37 artifacts copied, 0 already retrieved (7245kB/44ms)
[info] Loading project definition from /home/michael/couchplay/project
[info] Set current project to couchplay (in build file:/home/michael/couchplay/)
    _            _
_ __ | | __ _ _  _| |
| '_ \| |/ _' | || |_|
|  __/|_|\____|\__ (_)
|_|            |__/

play! 2.0.2, http://www.playframework.org

&gt; Type &quot;help play&quot; or &quot;license&quot; for more information.
&gt; Type &quot;exit&quot; or use Ctrl+D to leave this console.

[couchplay] $ run

[info] Updating {file:/home/michael/couchplay/}couchplay...
[info] Resolving org.hibernate.javax.persistence#hibernate-jpa-2.0-api;1.0.1.Fin                                                                                [info] Done updating.
--- (Running the application from SBT, auto-reloading is enabled) ---

[info] play - Listening for HTTP on port 9000...

(Server started, use Ctrl+D to stop and go back to the console...)
</code></pre>

<p>As you can see, the initial dependencies are resolved and loaded automatically. If you already have something running on port <code>9000</code> (like <a href="http://php-fpm.org/">php-fpm</a>), then you can use the <code>run [PORTNUM]</code> command to specify a different port. There are lots of other possibilities here and we&rsquo;ll cover some of them as we progress further. If you&rsquo;re curious, you can type <code>help</code> to see the available commands.</p>

<p>You may experience a large response time (a few seconds) when you open up the page for the first time. This is because in development mode, play! compiles everything for you on the fly. If you don&rsquo;t change anything, the next reload should be pretty fast. Since we only modify short bits of code between every refresh, the compiling times should not be an issue. In production, everything is precompiled anyway. If you look on your console, you can see that the files have been compiled automatically for you:</p>

<pre><code>[info] Compiling 4 Scala sources and 2 Java sources to /home/michael/couchplay/target/scala-2.9.1/classes...
[info] play - Application started (Dev)
</code></pre>

<p>One last tip here: if you use <code>~run</code> instead of <code>run</code>, the framework will detect code changes immediately (when you save your file) and compile it on the fly. If you use <code>run</code>, it will start compiling when you reload the page. As a result, when using <code>~run</code> the compile times should be even less noticable since you also need some time to switch back and forth between your IDE and the browser. Also keep in mind that all this is handled for you and you don&rsquo;t need to setup tomcat in your IDE and make sure everything is pushed correctly. If you are like me and have spent hours and hours of configuring eclipse and tomcat, this is pretty awesome news. You can of course still use Eclipse (or any other IDE), but you can concentrate on writing code, the rest will be done for you in the background.</p>

<h2 id="connecting-to-couchbase">Connecting to Couchbase</h2>

<p>Currently, our application doesn&rsquo;t know about our backend database. Since play! doesn&rsquo;t have built-in support for Couchbase, we&rsquo;re going to use the Couchbase Java SDK to fill the gap.</p>

<p>Couchbase thankfully provides a Maven repository, so we just need to define and load the dependency. Head over to the <code>project/Build.scala</code> file and add the following:</p>

<pre><code>val appDependencies = Seq(
    &quot;couchbase&quot; % &quot;couchbase-client&quot; % &quot;1.1-dp&quot;
)

val main = PlayProject(appName, appVersion, appDependencies, mainLang = SCALA).settings(
    resolvers += &quot;Couchbase Maven Repository&quot; at &quot;http://files.couchbase.com/maven2&quot;
)
</code></pre>

<p>Back in the play console, hit <code>ctrl-d</code> to stop the server and type <code>reload</code> and <code>update</code> to fetch the new dependencies. If everything finished without errors, type &ldquo;~run&rdquo; again.</p>

<pre><code>[couchplay] $ reload
[info] Loading project definition from /home/michael/couchplay/project
[info] Set current project to couchplay (in build file:/home/michael/couchplay/)
[couchplay] $ update
[info] Updating {file:/home/michael/couchplay/}couchplay...
[info] Resolving org.hibernate.javax.persistence#hibernate-jpa-2.0-api;1.0.1.Fin                                                                                [info] downloading http://files.couchbase.com/maven2/couchbase/couchbase-client/1.1-dp/couchbase-client-1.1-dp.jar ...
[info]  [SUCCESSFUL ] couchbase#couchbase-client;1.1-dp!couchbase-client.jar (1821ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/org/jboss/netty/netty/3.2.0.Final/netty-3.2.0.Final.jar ...
[info]  [SUCCESSFUL ] org.jboss.netty#netty;3.2.0.Final!netty.jar(bundle) (3661ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/org/codehaus/jettison/jettison/1.1/jettison-1.1.jar ...
[info]  [SUCCESSFUL ] org.codehaus.jettison#jettison;1.1!jettison.jar(bundle) (828ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/commons-codec/commons-codec/1.5/commons-codec-1.5.jar ...
[info]  [SUCCESSFUL ] commons-codec#commons-codec;1.5!commons-codec.jar (835ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/spy/spymemcached/2.8.1/spymemcached-2.8.1.jar ...
[info]  [SUCCESSFUL ] spy#spymemcached;2.8.1!spymemcached.jar (1446ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/org/apache/httpcomponents/httpcore/4.1.1/httpcore-4.1.1.jar ...
[info]  [SUCCESSFUL ] org.apache.httpcomponents#httpcore;4.1.1!httpcore.jar (1059ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/org/apache/httpcomponents/httpcore-nio/4.1.1/httpcore-nio-4.1.1.jar ...
[info]  [SUCCESSFUL ] org.apache.httpcomponents#httpcore-nio;4.1.1!httpcore-nio.jar (1062ms)
[info] downloading http://repo.typesafe.com/typesafe/releases/stax/stax-api/1.0.1/stax-api-1.0.1.jar ...
[info]  [SUCCESSFUL ] stax#stax-api;1.0.1!stax-api.jar (1556ms)
[info] Done updating.
[success] Total time: 39 s, completed Jul 7, 2012 9:25:52 AM
[couchplay] $ ~run

--- (Running the application from SBT, auto-reloading is enabled) ---

[info] play - Listening for HTTP on port 9000...

(Server started, use Ctrl+D to stop and go back to the console...)
</code></pre>

<p>I&rsquo;m quite sure you wonder about the strange syntax we&rsquo;ve been using to define our dependency. This is actually Scala code, since play! uses the awesome <a href="http://www.scala-sbt.org/">sbt</a> to manage its dependencies (the play console also builds upon it). There is a good introduction <a href="http://www.youtube.com/watch?v=V2rl62CZPVc">video</a> available if you want to learn more.</p>

<p>The dependency is now in place, but we also need to connect to the database when the application starts and disconnect from it when it stops. If we&rsquo;d use the databases supported by the framework, this would be handled for us (but that&rsquo;s half the fun, right?). Since this is not the case, we need to &ldquo;hook&rdquo; into some kind of <code>start</code> and <code>stop</code> events.</p>

<p>Play! provides us with something called the <a href="http://www.playframework.org/documentation/2.0.2/JavaGlobal">application Global object</a> that has methods we can override. Create a new file called <code>Global.java</code> inside the <code>app</code> directory and insert the following.</p>

<pre><code>import play.*;

import datasources.Couchbase;

public class Global extends GlobalSettings {

    public void onStart(Application app) {
        Logger.info(&quot;Application started&quot;);
        Couchbase.connect();
    }

    public void  onStop(Application app) {
        Logger.info(&quot;Application stopped&quot;);
        Couchbase.disconnect();
    }

}
</code></pre>

<p>We override the <code>onStart</code> and <code>onStop</code> methods to place our custom connect logic in there (and do some logging as well). We make use of a <code>Couchabase</code> connection class to abstract our connection logic, so we&rsquo;d better write that one too. Create a new file called <code>Couchbase.java</code> inside the <code>app/datasources</code> directory (which you also need to create).</p>

<pre><code>package datasources;

import java.net.URI;
import java.util.LinkedList;
import java.util.List;
import java.io.IOException;
import java.util.concurrent.TimeUnit;

import play.*;
import com.couchbase.client.CouchbaseClient;

/**
* The `Couchbase` class acts a simple connection manager for the `CouchbaseClient`
* and makes sure that only one connection is alive throughout the application.
*
* You may want to extend and harden this implementation in a production environment.
*/
public final class Couchbase {

    /**
    * Holds the actual `CouchbaseClient`.
    */
    private static CouchbaseClient client = null;

    /**
    * Connects to Couchbase based on the configuration settings.
    *
    * If the database is not reachable, an error message is written and the
    * application exits.
    */
    public static boolean connect() {
        String hostname = Play.application().configuration().getString(&quot;couchbase.hostname&quot;);
        String port = Play.application().configuration().getString(&quot;couchbase.port&quot;);
        String bucket = Play.application().configuration().getString(&quot;couchbase.bucket&quot;);
        String password = Play.application().configuration().getString(&quot;couchbase.password&quot;);

        List&lt;URI&gt; uris = new LinkedList&lt;URI&gt;();
        uris.add(URI.create(&quot;http://&quot;+hostname+&quot;:&quot;+port+&quot;/pools&quot;));


        try {
            client = new CouchbaseClient(uris, bucket, password);
        } catch(IOException e) {
            Logger.error(&quot;Error connection to Couchbase: &quot; + e.getMessage());
            System.exit(0);
        }

        return true;
    }

    /**
    * Disconnect from Couchbase.
    */
    public static boolean disconnect() {
        if(client == null) {
            return false;
        }

        return client.shutdown(3, TimeUnit.SECONDS);
    }

    /**
    * Returns the actual `CouchbaseClient` connection object.
    *
    * If no connection is established yet, it tries to connect. Note that
    * this is just in place for pure convenience, make sure to connect explicitly.
    */
    public static CouchbaseClient getConnection() {
        if(client == null) {
            connect();
        }

        return client;
    }

}
</code></pre>

<p>We basically define a <code>connect</code> and a <code>disconnect</code> method, which get called from our <code>Gobal.java</code> class. Inside the <code>connect</code> method we read configuration settings (more on that shortly) and then try to open the Couchbase connection. The <code>disconnect</code> method waits 3 seconds to finish any queued operations and then disconnects. Also, we provide a <code>getConnection()</code> method that returns the actual instance of the client object (which we&rsquo;ll use later in our models).</p>

<p>It is always a good idea to just open one connection for the whole lifecycle instead of opening a new connection every time a request comes in. This removes unneeded handshake-latency and should therefore improve the overall performance of the application.</p>

<p>You may have noticed the various <code>Play.application().configuration().getString();</code> calls. With these method calls you can read the values from your <code>conf/application.conf</code> configuration file. By defining your connection settings there instead of the actual implementation, you can easily swap the settings if you deploy your application into production. More on the configuration file can be found <a href="http://www.playframework.org/documentation/2.0.2/Configuration">here</a>. To define the settings we need, open your <code>application.conf</code> file and add the following to the end (or somewhere in between):</p>

<pre><code># Couchbase configuration
# ~~~~~
couchbase.hostname=&quot;localhost&quot;
couchbase.port=8091
couchbase.bucket=&quot;default&quot;
couchbase.password=&quot;&quot;
</code></pre>

<p>Now we have everything in place to configure the settings and connect to the database. If you start the server again and load the page for the first time, you can see the debug output of the Couchbase SDK:</p>

<pre><code>[info] application - Application started
2012-07-17 19:12:43.788 INFO com.couchbase.client.CouchbaseConnection:  Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
2012-07-17 19:12:43.789 INFO com.couchbase.client.CouchbaseClient:  viewmode property isn't defined. Setting viewmode to production mode
2012-07-17 19:12:43.790 INFO com.couchbase.client.ViewConnection:  Added localhost/127.0.0.1:8092 to connect queue
2012-07-17 19:12:43.794 INFO com.couchbase.client.CouchbaseConnection:  Connection state changed for sun.nio.ch.SelectionKeyImpl@1d179fb
[info] play - Application started (Dev)
</code></pre>

<p>Note that since we haven&rsquo;t defined a <code>viewmode</code> setting, Couchbase assumes you&rsquo;re running in production mode. You can change this setting, but I haven&rsquo;t done this here (we&rsquo;ll push our views into production before we use them inside the application).</p>

<p>If you press <code>ctrl+d</code> to stop the application, you can see that Couchbase correctly closes the connection:</p>

<pre><code>[info] application - Application stopped
2012-07-17 19:24:52.216 INFO com.couchbase.client.CouchbaseConnection:  Shut down Couchbase client
2012-07-17 19:24:52.226 INFO com.couchbase.client.ViewConnection:  Shut down Couchbase client
2012-07-17 19:24:52.226 INFO com.couchbase.client.ViewNode:  Couchbase I/O reactor terminated
</code></pre>

<h2 id="wrapping-up">Wrapping up</h2>

<p>This post hopefully gave you an overview of what we&rsquo;re going to implement, namely a real-time web chat application. We&rsquo;re going to use Java, the play! framework and Couchbase. Also we&rsquo;ve set up the database, the project itself and connected both. In the next post we&rsquo;ll build on this foundation and add session management to let users sign in and out.</p>

<p>As always, comment below if you have any thoughts on this!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">25 Jun 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/How-to-store-PHP-sessions-in-Couchbase/" class="post-title">How to store PHP sessions in Couchbase</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>My <a href="http://nitschinger.at/Using-Couchbase-as-a-flexible-session-store">last post</a> about storing sessions in Couchbase was more of a general overview on what&rsquo;s possible. This post builds on the foundations and principles discussed and shows you various ways to store PHP sessions in Couchbase. We start out simple by using the built-in <code>session</code> ini -directives, then head over to the brand new <a href="http://php.net/manual/en/class.sessionhandlerinterface.php">SessionHandlerInterface</a> introduced in PHP 5.4 and finally implement it completely on our own. We&rsquo;ll see how both the complexity and flexibility increase during each of our approaches. In the end it&rsquo;s up to you which method seems appropriate for your use-case.</p>

<h2 id="session-handler-and-memcached">session_handler and memcached</h2>

<p>This approach has one big advantage: it&rsquo;s dead easy to setup and use. Let&rsquo;s tackle the good parts first and then discuss the weaknesses of this approach.</p>

<p>We are using the protocol-compatible nature of Couchbase and let the built-in <code>memcached</code> session handler do the job for us. So the first thing we need to do (apart from installing Couchbase) is install the <code>php5-memcached</code> extension. If you&rsquo;re on a debian-based system it&rsquo;s as easy as running</p>

<pre><code>$ sudo aptitude install php5-memcached
</code></pre>

<p>If you want to make sure that the extension is correctly installed, check the module on the command line:</p>

<pre><code>$ php -m | grep mem
memcached
</code></pre>

<p>Now we need to tell PHP to use the <code>memcached</code> session handler and where it should save the data. To do this, we need to modify the <code>php.ini</code> file accordingly. I&rsquo;m using <a href="http://httpd.apache.org/">Apache</a> on <a href="http://www.ubuntu.com/">Ubuntu</a>, so my <code>php.ini</code> is located under <code>/etc/php5/apache2/php.ini</code>. Find and replace the following settings with their new values:</p>

<pre><code>[Session]
session.save_handler = memcached
session.save_path = &quot;localhost:11211&quot;
</code></pre>

<p>Of course, you want to replace <code>localhost</code> with a different address if Couchbase is not running on your local machine. Couchbase uses <code>11211</code> as its <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-network-ports.html">data port</a>, just like memcached. Now we have everything in place, restart the server to get it up and running:</p>

<pre><code>$ sudo service apache2 restart
</code></pre>

<p>The infrastructure is in place, so we can now start working with the session store through the <code>$_SESSION</code> superglobal. Here is a short script that shows how you can work with it:</p>

<pre><code>&lt;?php

// Start the session.
session_start();

// Dump the session to the screen.
var_dump($_SESSION);

// Define some data to store.
class User { public $firstname = &quot;hoo&quot;; }
$user = new User();

// Store it in the session object.
$_SESSION['user'] = $user;
$_SESSION['randomStuff'] = array(1 =&gt; 'blue', 'couchbase' =&gt; 'rocks');

?&gt;
</code></pre>

<p>This is not rocket science and exactly the way you&rsquo;d handle sessions through the interface provided by PHP. Check out the <a href="http://php.net/manual/en/reserved.variables.session.php">documentation</a> if you haven&rsquo;t used it yet.</p>

<p>So, how does PHP store the data in Couchbase? The first thing to note is that all your session data is stored in the <code>default</code> bucket and uses a binary format (like how it would be stored in memcached). If you inspect the output from our example above, you can see that the user object is actually stored as an object so PHP uses the built-in serializer (if not configured differently) to store the session data. If you look in the bucket, you can see a key like this:</p>

<pre><code>memc.sess.key.a6sgl1oldchknlsj8mc3c37b11
</code></pre>

<p>The first part is the prefix and the cryptic string at the end is the PHP session identifier which is carried along by the client through a cookie. If you fire up firebug or chrome and inspect the headers, you can see the corresponding <code>PHPSESSID</code>:</p>

<pre><code>Cookie:PHPSESSID=a6sgl1oldchknlsj8mc3c37b11;
</code></pre>

<p>The stored document looks like this:</p>

<pre><code>{
&quot;_id&quot;: &quot;memc.sess.key.a6sgl1oldchknlsj8mc3c37b11&quot;,
&quot;_rev&quot;: &quot;10-000003794c342b870000009800000000&quot;,
&quot;$flags&quot;: 0,
&quot;$expiration&quot;: 0,
&quot;$att_reason&quot;: &quot;invalid_json&quot;
}
</code></pre>

<p>Since the data is not stored in JSON format, you can&rsquo;t inspect it from the Couchbase GUI directly. So why did I include it here anyway? Look at the <code>$expiration</code> key. It is important to note that we don&rsquo;t specify an expiration time here, because this is handled through PHP. So if you want to change the expiration time you have to change the appropriate setting using the <code>session.cache_expire</code> directive. This is different to the approach we&rsquo;ll cover at the end of the article where we implement everything on our own and don&rsquo;t rely on those built-in features.</p>

<p>This approach is very simple and may suit your needs perfectly, but it comes with some limitations that you need to keep in mind.</p>

<p>Since the data is not stored in JSON format, you can&rsquo;t use the awesome map/reduce querying mechanisms that Couchbase 2.0 provides. Also, you can&rsquo;t change the bucket or key-names. Another problem is that you can&rsquo;t make use of the automatic, dynamic reconfiguration mechanisms provided by Couchbase. So if the server at the ip-address goes down, PHP won&rsquo;t be able to store sessions in the cluster anymore. Couchbase provides an optional component called <a href="http://www.couchbase.com/docs/moxi-manual-1.8/moxi-introduction.html">Moxi</a> that acts as a proxy between your client and the couchbase cluster and is able to handle such situations. So if you&rsquo;re not able to use the approaches shown in the rest of this post you definitely need to take a look at it!</p>

<h2 id="more-flexibility-through-the-sessionhandlerinterface">More flexibility through the SessionHandlerInterface</h2>

<p>PHP 5.4 provides a brand new interface called <a href="http://www.php.net/manual/en/class.sessionhandlerinterface.php">SessionHandlerInterface</a> through which we can implement our own session handler. This way, we can use the familiar and built-in <code>$_SESSION</code> superglobal and make use of the advanced Couchbase functionality.</p>

<p>We need to implement the following interface:</p>

<pre><code>SessionHandlerInterface {
    abstract public bool close ( void )
    abstract public bool destroy ( string $session_id )
    abstract public bool gc ( string $maxlifetime )
    abstract public bool open ( string $save_path , string $session_id )
    abstract public string read ( string $session_id )
    abstract public bool write ( string $session_id , string $session_data )
}
</code></pre>

<p>The following implementation is not meant to be used 1:1 in production, since I haven&rsquo;t tested every aspect of it. Nevertheless it should give you an idea on how such a implementation may look like. Note that you need to have the <code>php-ext-couchbase</code> extension installed. If you are not sure on how to do this, see my post about <a href="http://nitschinger.at/Getting-Started-with-Couchbase-and-PHP">Getting Started with Couchbase and PHP</a>. You can also find a github gist <a href="https://gist.github.com/2986942">here</a>.</p>

<pre><code>&lt;?php

/**
* A reference implementation of a custom Couchbase session handler.
*/
class CouchbaseSessionHandler implements SessionHandlerInterface {

    /**
    * Holds the Couchbase connection.
    */
    protected $_connection = null;

    /**
    * The Couchbase host and port.
    */
    protected $_host = null;

    /**
    * The Couchbase bucket name.
    */
    protected $_bucket = null;

    /**
    * The prefix to be used in Couchbase keynames.
    */
    protected $_keyPrefix = 'session:';

    /**
    * Define a expiration time of 10 minutes.
    */
    protected $_expire = 600;

    /**
    * Set the default configuration params on init.
    */
    public function __construct($host = '127.0.0.1:8091', $bucket = 'default') {
        $this-&gt;_host = $host;
        $this-&gt;_bucket = $bucket;
    }

    /**
    * Open the connection to Couchbase (called by PHP on `session_start()`)
    */
    public function open($savePath, $sessionName) {
        $this-&gt;_connection = new Couchbase($this-&gt;_host, $this-&gt;_bucket);
        return $this-&gt;_connection ? true : false;
    }

    /**
    * Close the connection. Called by PHP when the script ends.
    */
    public function close() {
        unset($this-&gt;_connection);
        return true;
    }

    /**
    * Read data from the session.
    */
    public function read($sessionId) {
        $key = $this-&gt;_keyPrefix . $sessionId;
        $result = $this-&gt;_connection-&gt;get($key);

        return $result ?: null;
    }

    /**
    * Write data to the session.
    */
    public function write($sessionId, $sessionData) {
        $key = $this-&gt;_keyPrefix . $sessionId;
        if(empty($sessionData)) {
            return false;
        }

        $result = $this-&gt;_connection-&gt;set($key, $sessionData, $this-&gt;_expire);
        return $result ? true : false;
    }

    /**
    * Delete data from the session.
    */
    public function destroy($sessionId) {
        $key = $this-&gt;_keyPrefix . $sessionId;
        $result = $this-&gt;_connection-&gt;delete($key);

        return $result ? true : false;
    }

    /**
    * Run the garbage collection.
    */
    public function gc($maxLifetime) {
        return true;
    }

}

?&gt;
</code></pre>

<p>It&rsquo;s not that complex as it may look like in the first place. At the top of the class we&rsquo;re defining and initializing some variables that hold our configuration. We don&rsquo;t have to do this, but this way we&rsquo;re getting a bit more flexibility and can pass custom settings through the constructor.</p>

<p>The <code>open</code> method takes two arguments (according to the interface definition), one for the <code>savePath</code> and one for the <code>sessionName</code>. These arguments correspond to the <code>ini</code>-settings, but we ignore them and make use of our configuration variables passed through the constructor. Inside the <code>open</code> method we initialize the connection to Couchbase and store the connection resource in a protected variable for later use.</p>

<p>The <code>close</code> method is called when the PHP-script ends. We just unset the resource, since there is nothing more to do in our case. If you use a file storage engine you&rsquo;d want to close the file-handle here.</p>

<p>From now on, we always get the <code>sessionId</code> passed as an argument. The <code>read</code> method takes it and adds zhr <code>keyPrefix</code> we&rsquo;ved defined to the beginning of the string. It then tries to read the record from Couchbase and returns it when it&rsquo;s found. Note that we return <code>null</code> here, but since <code>$_SESSION</code> is an array, you&rsquo;ll always work with (empty) arrays on the caller-side.</p>

<p>The <code>write</code> method gets the payload as an additional argument since we need to store it somewhere. Note that the data is already serialized, so don&rsquo;t try to use <code>json_encode</code> or something like this before storing it in Couchbase (that&rsquo;s what I did and then wondered what the hell is wrong unless someone on IRC pointed out that you can&rsquo;t control the serialization mechanism on your own here). As a result, the <code>read</code> method expects the serialized data as a string and fails silently if you return something else.</p>

<p>The <code>destroy</code> method should not contain any surprises, we just delete the document based on the key if it exists. The <code>gc</code> method is not used here, because Couchbase handles the garbage collection for us. If you store your data in files, you want to clean up old sessions here.</p>

<p>Now we can use our handler and do some work with it:</p>

<pre><code>&lt;?php
$handler = new CouchbaseSessionHandler();

session_set_save_handler($handler, true);
session_start();

var_dump($_SESSION);

$_SESSION['foo'] = null;
$_SESSION['data'] = array(
    'couchbase' =&gt; 'rocks'
);
?&gt;
</code></pre>

<p>On the first load, the <code>$_SESSION</code> variable is of course empty. When you reload the page, you should see output like this:</p>

<pre><code>array(2) { 'foo' =&gt; NULL 'data' =&gt; array(1) { 'couchbase' =&gt; string(5) &quot;rocks&quot; } }
</code></pre>

<p>In the Couchbase GUI, we can see that a key has been added to the <code>default</code> bucket named something like this:</p>

<pre><code>session:a6sgl1oldchknlsj8mc3c37b11
</code></pre>

<p>Couchbase provides a handy tool on the command line to inspect our documents - it&rsquo;s called <code>cbc</code>. We can use it to fetch the contents of our key and peek inside:</p>

<pre><code>$ cbc cat session:a6sgl1oldchknlsj8mc3c37b11
&quot;session:a6sgl1oldchknlsj8mc3c37b11&quot; Size 45 Flags 0x0 CAS 0x9d394b19130a0000
foo|N;data|a:1:{s:9:&quot;couchbase&quot;;s:5:&quot;rocks&quot;;}
</code></pre>

<p>You can see that the PHP session handler still stores the data in a serialized way (you can also <code>var_dump()</code> the content of the <code>$sessionData</code> variable handed over to our <code>write()</code> method to see the serialized data string).</p>

<p>This approach is a huge leap forward because it let&rsquo;s us shape the interaction with Couchbase the way we want it to (and we can leverage all commands from the Couchbase PHP-SDK instead of just using a subset provided by the memcached extension). Also, we use the expiration mechanism provided by Couchbase and don&rsquo;t have to handle it ourselves. Finally, by using the <code>php-ext-couchbase</code> SDK, we don&rsquo;t need to use Moxi anymore because this is all handled for us underneath by the <code>libcouchbase</code> C library. There is only one limitation left: we still can&rsquo;t use map/reduce functionality because the documents aren&rsquo;t stored in JSON format. To accomplish this, we&rsquo;re getting rid of the PHP session handler altogether and implement it for ourselves.</p>

<p>Chances are that you&rsquo;re still using PHP 5.3 or lower. If this is the case, you want to either use the <a href="http://at.php.net/manual/en/class.sessionhandler.php">old way</a> to define your session handler or just read on (because the method described below isn&rsquo;t bound to a specific PHP version).</p>

<h2 id="implementing-it-on-our-own">Implementing it on our own</h2>

<p>When we implement the session handling mechanism on our own, we can reuse all insights from above and also use <a href="http://nitschinger.at/Handling-JSON-like-a-boss-in-PHP">JSON</a> instead of the PHP object serialization. Imagine we&rsquo;re writing yet another PHP framework (don&rsquo;t do that&hellip;) and define a session interface like this:</p>

<pre><code>&lt;?php
namespace framework\sessions;

interface SessionHandler {
    public function read($sessionId);
    public function write($sessionId, $data);
    public function delete($sessionId);
    public function check($sessionId);
}
?&gt;
</code></pre>

<p>The <code>read</code>, <code>write</code> and <code>delete</code> methods should be clear what they&rsquo;re doing. The <code>check</code> method checks if the given key is found in the session store.</p>

<p>Here&rsquo;s again the full implementation, we&rsquo;ll talk it through afterwards:</p>

<pre><code>&lt;?php
namespace framework\sessions;

use Couchbase;

class CouchbaseSessionHandler implements SessionHandler {

    /**
    * Holds the Couchbase connection.
    */
    protected $_connection = null;
    /**
    * The prefix to be used in Couchbase keynames.
    */
    protected $_keyPrefix = 'session:';

    /**
    * Define a expiration time of 10 minutes.
    */
    protected $_expire = 600;

    /**
    * Currently in development mode? Used for view loading.
    */
    protected $_development = null;

    /**
    * Connect to Couchbase.
    */
    public function __construct($host = '127.0.0.1:8091', $bucket = 'default', $dev = true) {
            $this-&gt;_development = $dev;
            $this-&gt;_connection = new Couchbase($host, $bucket);
            return $this-&gt;_connection ? true : false;
    }

    /**
    * Read the document for the given `sessionId`.
    */
    public function read($sessionId) {
        $key = $this-&gt;_keyPrefix . $sessionId;

        $data = $this-&gt;_connection-&gt;get($key);
        return $data ? json_decode($data, true) : null;
    }

    /**
    * Write the data.
    */
    public function write($sessionId, $data) {
        $key = $this-&gt;_keyPrefix . $sessionId;
        $data = $data + array('type' =&gt; 'session');

        return $this-&gt;_connection-&gt;set($key, json_encode($data), $this-&gt;_expire);
    }

    /**
    * Delete the data for the given `sessionId`.
    */
    public function delete($sessionId) {
        $key = $this-&gt;_keyPrefix . $sessionId;

        return $this-&gt;_connection-&gt;delete($key);
    }

    /**
    * Check if a document exists.
    **/
    public function check($sessionId) {
        $key = $this-&gt;_keyPrefix . $sessionId;
        return $this-&gt;_connection-&gt;get($key) ? true : false;
    }

}
?&gt;
</code></pre>

<p>This implementation is pretty basic and should give you just an idea what&rsquo;s possible. Since we&rsquo;re storing JSON in Couchbase, you can get fancy and implement the <code>read</code> and <code>check</code> method not only on the <code>sessionId</code> level, but also do fine-grained inspection of the keys inside the JSON document.</p>

<p>The code provided here is very similar to the example above, with only minor changes. The first one is that we open the connection on <code>__construct</code> and don&rsquo;t have a <code>gc</code> method since we don&rsquo;t need it here. Inside <code>read</code> and <code>write</code> we make use of <code>json_encode</code> and <code>json_decode</code> to convert the PHP payload into JSON. The <code>check</code> method works in a similar fashion to <code>read</code> but returns <code>true/false</code> instead of the actual data.</p>

<p>Let&rsquo;s run some code against our implementation:</p>

<pre><code>&lt;?php
use framework\sessions\CouchbaseSessionHandler;

/**
* Init the Handler.
*/
$handler = new CouchbaseSessionHandler();

/**
* Generate a Session ID for testing purposes.
*/
$sessionId = uniqid();

/**
* Store and retreive.
*/
$data = array('couchbase' =&gt; 'rocks');

// Write some data
$handler-&gt;write($sessionId, $data);

// Returns the array
var_dump($handler-&gt;read($sessionId));

// Returns true
var_dump($handler-&gt;check($sessionId));

// Delete the document
$handler-&gt;delete($sessionId);

// Returns NULL
var_dump($handler-&gt;read($sessionId));

// Returns false
var_dump($handler-&gt;check($sessionId));

?&gt;
</code></pre>

<p>If you comment out the <code>delete</code> part you can see that the document is stored as JSON in Couchbase. On the next request, you don&rsquo;t need the <code>write</code> call anymore since the data is loaded directly from Couchbase.</p>

<p>As a side note, my original idea was to implement a <code>clear</code> method that deletes all stored session documents. This is a perfect use-case for a view, but since the PHP extension with view support is still in a developer preview, <a href="http://www.couchbase.com/issues/browse/PCBC-76">something went wrong</a>. When this issue is resolved I&rsquo;ll write another blog post focusing on handling views. If you want to implement the <code>clear</code> method now, you can workaround <code>memcached</code>-style and maintain a separate document that just holds all keys of the current sessions. You can load this one and then delete all fetched keys.</p>

<h2 id="final-thoughts">Final thoughts</h2>

<p>There are lots of possibilities on how you can use Couchbase to store your PHP sessions. If you just want to switch to Couchbase on the backend and don&rsquo;t want to touch your code at all, the first option is for you. If you&rsquo;ve used the built-in PHP session handling mechanisms and want to switch to a much more powerful storage engine, the second method may be a good fit. Finally, if you&rsquo;re using a PHP framework that uses its own adapters the last method provides the most flexibility and can be modified to suit all your needs.</p>

<p>Feel free to share your opinions below!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">21 Jun 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/Using-Couchbase-as-a-flexible-session-store/" class="post-title">Using Couchbase as a flexible session store</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>This post shows you how you can use the <a href="http://www.couchbase.com">Couchbase 2.0 server</a> as a flexible session store. What do I mean by flexible? Well, the combination of a highly scalable key-value store and the possibility to query your data through views allows you to gain unique insight inside your data in near realtime.</p>

<p>Let&rsquo;s look at some obstacles that we as application developers face and then see how we may solve them through Couchbase and its functionality. Of course, there are lots of ways to solve the same problem domain and the solutions provided here may not fit your problem as good as another technology/stack/software. I&rsquo;d love to hear your opinions on this if you have a more elegant or flexible approach with a similar technology.</p>

<h2 id="introduction">Introduction</h2>

<p>The root of all session storage problems is that most web applications need to store some kind of state across pages and HTTP is by design <a href="http://en.wikipedia.org/wiki/Stateless_protocol">stateless</a>. Therefore, we need to use some of the solutions that were invented to fill exactly this gap.</p>

<p>As a developer, you can choose between storing session data either on the client-side or on the server-side. The client-side usually is a synonym for <a href="http://en.wikipedia.org/wiki/HTTP_cookie">cookies</a>, but new technologies like <a href="http://www.html5rocks.com/en/tutorials/offline/storage/">HTML 5 client-side storage</a> slowly emerge. Since cookies are stored on the client-side, they are not under complete control of the application and are therefore a possible security issue (and have size limitations that may be too small for your requirements). Solutions like <a href="http://nitschinger.at/Session-Encryption-with-Lithium">encryption</a> and <a href="http://en.wikipedia.org/wiki/HMAC">HMAC</a> exist, but still they lack the dynamic part of backend databases.</p>

<p>On the server-side, you can usually choose between either a storage mechanism provided by your language/application server or a standalone software. For example, PHP provides a <a href="http://www.php.net/manual/en/reserved.variables.session.php">$_SESSION</a> superglobal that stores data across requests.  In Java, you can work with <a href="http://docs.oracle.com/cd/E17802_01/webservices/webservices/docs/1.6/api/javax/servlet/http/HttpSession.html">HttpSession</a> objects that allow you to do the same. All these mechanisms have one limitation: they are bound to the application container/webserver where the application is executed (therefore, they are called &ldquo;sticky&rdquo;). This means that when we need to use more than one application server to scale out at the same time and a <a href="http://haproxy.1wt.eu/">proxy</a> (or load balancer) routes the requests randomly, it is possible that application server 1 has no idea what sessions are active on application server 2. As a result, a user may be logged out on the next request.</p>

<p>To overcome this issue, we need to refactor the session handling part out of the application server into a standalone software. This allows our application servers to read and write from a central session store and as a result all of them share the same session state.</p>

<p>One of the oldest and most used software solutions is <a href="http://memcached.org/">memcached</a>. Memcached was developed by <a href="http://www.danga.com/">Danga Interactive</a> to remedy the scalability issues at <a href="http://www.livejournal.com/">LiveJournal</a>. It provides a distributed memory object caching system that has a key-based lookup mechanism and is fast because all data is stored in-memory. While memcached is amazing, it has one major limitation: it doesn&rsquo;t persist the data on disk, so if one server goes down it may take some time to prime the cache again (called warm-up time).</p>

<p>Some developers identified the additional need and started a full protocol-compatible project that was eventually called <a href="http://en.wikipedia.org/wiki/Membase">Membase</a>. Aside from disk persistence, Membase provided more functionality like replication and live cluster reconfiguration. In 2011, Membase merged with CouchOone (the main driver behind <a href="http://couchdb.apache.org/">Apache CouchDB</a>) to form <a href="http://www.couchbase.com/">Couchbase</a>. Couchbase 1.8 is basically a renamed and slightly enhanced version of Membase, while Couchbase 2.0 (currently in developer preview release) adds incremental map/reduce, distributed indexing and cross-cluster replication.</p>

<p>That&rsquo;s the short story on the origins of Couchbase. Note that there are lots of other awesome projects out there that help you achieve similar results, with <a href="http://redis.io/">Redis</a>, <a href="http://www.mongodb.org/">MongoDB</a> or <a href="http://wiki.basho.com/">Riak</a> as the more prominent ones. Espcially Redis provides more powerful data structures on top of the &ldquo;key/value&rdquo; pattern and is definitely worth a look.</p>

<h2 id="implementation">Implementation</h2>

<p>The most simple use case that all session stores need to fulfill is - of course - to store and read session data in a very performant way. Most of the time, a unique session identifier is used as the key and some arbitrary payload as the value (for example usernames, ids or other related data).</p>

<p>Note that this post aims to be a SDK-independent introduction to the topic, and the exact syntax may vary a bit from SDK to SDK (I&rsquo;m using PHP here, but the syntax is nearly identical for the other SDKs). As the Couchbase API is similar to memcached, you should feel right at home if you&rsquo;ve used it already (at least for the basic commands).</p>

<p>Couchbase provides you with <code>get</code> and <code>set</code> methods to read and store a value identified by a unique key. The key should be a string and the value preferably a JSON object. You can also store serialized or binary data, but you then loose the ability to query it through views. On the <code>set</code>-command, you can also pass in an optional expiration time, which comes in handy if you want to expire sessions automatically. Here&rsquo;s an example to store a session document:</p>

<pre><code>$user = array(
    'username' =&gt; 'daschl',
    'fullname' =&gt; 'Michael Nitschinger'
);
$document = json_encode($user);
$couchbase-&gt;set('user:1234', $document, 60);
</code></pre>

<p>This stores the given JSON document with the key <code>user:1234</code> and a expiry time of 60 seconds in Couchbase. If you provide a expiry time that is larger than 30 days, Couchbase assumes that you pass in a unix timestamp (as a result, you can also pass absolute timestamps instead of relative ones).</p>

<p>To read it back afterwards, you can use the <code>get</code> method:</p>

<pre><code>$result = $couchbase-&gt;get('user:1234');
</code></pre>

<p>If you want to delete the key (for example to destroy the session), you can just remove the key:</p>

<pre><code>$result = $couchbase-&gt;delete('user:1234');
</code></pre>

<p>You can also just &ldquo;touch&rdquo; the document, so that the expiry key will be refreshed:</p>

<pre><code>$result = $couchbase-&gt;touch('user:1234', 60);
</code></pre>

<p>Of course that&rsquo;s just the simplest use case, but it is often enough to start with. If you&rsquo;re curious, you can also <a href="http://www.couchbase.com/docs/couchbase-sdk-php-1.1/api-reference-summary.html">look into</a> <code>getMulti</code> and <code>setMulti</code> to fetch more keys at the same time. One thing to remember is that when you specify an expiration time the key will only be deleted on the next fetch and not automatically. If you have a large batch of keys that you want to remove you need some kind of background script that touches them and makes sure they are actually deleted. Note that you can also wait for the Couchbase background job to delete the expired keys for you which runs every hour by default.</p>

<p>Now, all of this can be done with nearly every key/value store out there (let&rsquo;s leave the other capabilities like replication and persistence out for now). Since CouchOne merged with Membase, Couchbase 2.0 includes a key feature of CouchDB: accessing your data through views.</p>

<p>Let&rsquo;s assume we want to write an admin dashboard that allows us to monitor some of our application KPIs to help us understand the current load it is facing. To achieve this, we want to graph the following information in realtime:</p>

<ul>
<li>How many users are currently active on the website.</li>
<li>How many users are currently logged in.</li>
<li>All users that come from Vienna/Austria (since our website sells local food here in Austria).</li>
</ul>

<p>In order to achieve this, we need some way to differentiate if a user is just visiting the website or is logged in. Also, we need to store the location from where he is coming. Since this a more-or-less SDK-agnostic post, here are some hints how this could be done:</p>

<p>When an anonymous user requests our website, we initiate a session that identifies him by his ip-address and does a lookup of his location based on some external information (for example the <a href="http://www.maxmind.com/app/geolite">MaxMind GeoLite database</a>). We store a session identifier in a cookie and the following document in Couchbase:</p>

<pre><code>// Key: user:&lt;SESSION-IDENTIFIER&gt;
{
    &quot;namespace&quot;: &quot;sessions&quot;,
    &quot;type&quot;: &quot;anonymous&quot;,
    &quot;lastSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;firstSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;remoteAddress&quot;: &quot;&lt;ipaddr&gt;&quot;,
    &quot;location&quot;: &quot;Vienna/Austria&quot;
}
</code></pre>

<p>If the user is logged in, we can clear the old session and instantiate a new one with more details about our user:</p>

<pre><code>// Key: user:&lt;SESSION-IDENTIFIER&gt;
{
    &quot;namespace&quot;: &quot;sessions&quot;,
    &quot;type&quot;: &quot;user&quot;,
    &quot;userID&quot;: &quot;&lt;userID&gt;&quot;,
    &quot;lastSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;firstSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;remoteAddress&quot;: &quot;&lt;ipaddr&gt;&quot;,
    &quot;location&quot;: &quot;Vienna/Austria&quot;,
    &quot;name&quot;: &quot;&lt;full name&gt;&quot;
}
</code></pre>

<p>The whole store, delete and update calls can be done with the basic methods described above, but what I want to concentrate on are the views. If you want to follow along, here is a short PHP script that populates the default bucket with some data to work with:</p>

<pre><code>&lt;?php
    // Open the Connection
    $couchbase = new Couchbase(&quot;127.0.0.1:8091&quot;);

    // Create some fake data with random hashes to simulate session identifiers.
    $data = array(
        '68ea304124beaa7e648cc1327d793b0a' =&gt; array(
            'namespace' =&gt; 'sessions',
            'type' =&gt; 'anonymous',
            'lastSeen' =&gt; time(),
            'firstSeen' =&gt; time(),
            'remoteAddress' =&gt; '192.168.0.1',
            'location' =&gt; 'Vienna/Austria'
        ),
        '6254b64d554a88b629bdbfc507d8c267' =&gt; array(
            'namespace' =&gt; 'sessions',
            'type' =&gt; 'anonymous',
            'lastSeen' =&gt; time(),
            'firstSeen' =&gt; time()-3600,
            'remoteAddress' =&gt; '10.10.10.10',
            'location' =&gt; 'Berlin/Germany'
        ),
        '6148bae4fad02c0edfd7dbd8d54d79f1' =&gt; array(
            'namespace' =&gt; 'sessions',
            &quot;type&quot; =&gt; &quot;user&quot;,
            &quot;userID&quot; =&gt; &quot;1234&quot;,
            'lastSeen' =&gt; time()-7200,
            'firstSeen' =&gt; time()-7800,
            &quot;remoteAddress&quot; =&gt; &quot;1.2.3.4&quot;,
            &quot;location&quot; =&gt; &quot;Rome/Italy&quot;,
            &quot;name&quot; =&gt; &quot;Luigi Manfrotto&quot;
        ),
        '4aeb265e299c41450dd6af813d0bef97' =&gt; array(
            'namespace' =&gt; 'sessions',
            &quot;type&quot; =&gt; &quot;user&quot;,
            &quot;userID&quot; =&gt; &quot;1104&quot;,
            'lastSeen' =&gt; time(),
            'firstSeen' =&gt; time(),
            &quot;remoteAddress&quot; =&gt; &quot;2.3.4.5&quot;,
            &quot;location&quot; =&gt; &quot;Vienna/Austria&quot;,
            &quot;name&quot; =&gt; &quot;Hans Huber&quot;
        )
    );

    // Store the documents in Couchbase
    foreach($data as $hash =&gt; $document) {
        $couchbase-&gt;set(&quot;user:$hash&quot;, json_encode($document));
    }
?&gt;
</code></pre>

<p>Now that we have four documents to work with, we can start creating views from the Couchbase GUI. Head over to the &ldquo;Views&rdquo; section and click on &ldquo;Create Development View&rdquo;. The way Couchbase works is that you write your view queries in development mode on a subset of your documents and when you&rsquo;re finished you can publish them to production. Since we have only four documents in the bucket, it won&rsquo;t make any difference here.</p>

<p>The name of our design document is <code>_design/dev_sessions</code> and the first view is called <code>active</code>. This one will return all currently logged in users:</p>

<pre><code>function (doc) {
    if(doc.namespace == 'sessions') {
        emit(doc._id, doc);
    }
}
</code></pre>

<p>If you save it and click <code>Show Results</code>, then you&rsquo;ll see all four documents below that got matched. You can also click on the URI string above <code>?connection_timeout=60000&amp;limit=10&amp;skip=0</code> to see the actual response in your browser. But what if we just want the total number of users logged in? We can use a built-in reduce function for that. In the &ldquo;Reduce&rdquo; textarea to the right just enter <code>_count</code>. If you click save and then show the results again, you can see that we just got one document back with no key and just <code>4</code> as the value.</p>

<p>The nice thing here is that we can pass <code>reduce=true/false</code> as a param and then get either the full response back or just the aggregated version. So this query gives us all active users on the website. Let&rsquo;s write another view that just returns the logged in users:</p>

<p>Modify the view like here and then click <code>Save As...</code> and name it <code>logged_in</code>:</p>

<pre><code>function (doc) {
    if(doc.namespace == 'sessions' &amp;&amp; doc.type == 'user') {
        emit(doc._id, doc);
    }
}
</code></pre>

<p>The reduce function can be reused in the same way. As you can see, with just a bit more code in JavaScript we have another view that just returns the logged in users. Now we want to display a third diagram that displays all users from <code>Vienna/Austria</code>. This time, we want to differentiate between anonymous and logged in users so that they can be displayed in two distinct graphs. Our map function may look like this:</p>

<pre><code>function (doc) {
    if(doc.namespace == 'sessions' &amp;&amp; doc.location == 'Vienna/Austria') {
        emit(doc.type, 1);
    }
}
</code></pre>

<p>Every time we find a document with the correct location, we emit a document with the key of either <code>anonymous</code> or <code>user</code>. As values we supply a value of <code>1</code> since we can reuse that in our reduce function. The reduce function is again the built in <code>_count</code> function, but this time we pass an additional param <code>group_level</code> with a value of <code>1</code> to our query. This way, Couchbase aggregates our data and returns a document like this:</p>

<pre><code>// Params: ?group_level=1&amp;reduce=true&amp;connection_timeout=60000&amp;limit=10&amp;skip=0
{
    &quot;rows&quot;: [
        {&quot;key&quot;:&quot;anonymous&quot;,&quot;value&quot;:1},
        {&quot;key&quot;:&quot;user&quot;,&quot;value&quot;:1}
    ]
}
</code></pre>

<p>If we insert another <code>user</code> document the counter would display <code>2</code>. If we don&rsquo;t use the grouping level setting, Couchbase would just return the total amount of documents emitted.</p>

<p>All of these views assumed that we have some kind of realtime polling to our backend, because the results didn&rsquo;t include grouping by a distinct timestamp. In order to load a graph with meaningful results for the last hour, we can return it aggregated by timestamp (we can reuse the same <code>_count</code> reduce function and the level 1 grouping):</p>

<pre><code>function (doc) {
    if(doc.namespace == 'sessions') {
        emit(doc.lastSeen, 1);
    }
}
</code></pre>

<p>An example output would look like this:</p>

<pre><code>// Params: ?group_level=1&amp;connection_timeout=60000&amp;limit=10&amp;skip=0
{
    &quot;rows&quot;:[
        {&quot;key&quot;:1339997680,&quot;value&quot;:1},
        {&quot;key&quot;:1340004880,&quot;value&quot;:3}
    ]
}
</code></pre>

<p>Now, if we have record for the last year in our database it won&rsquo;t make much sense to fetch them all on every request. If you look one entry below the <code>group_level</code> param, you&rsquo;ll find <code>startkey</code> and <code>endkey</code> options. With these two you can provide a timerange to fetch the results.</p>

<h2 id="performance">Performance</h2>

<p>I know that synthetic benchmarks never provide reproducible results in production environments, but they provide at least a rough estimation on how the application may be able to perform under certain conditions.</p>

<p>Thankfully, <a href="http://trondn.blogspot.co.at/">Trond Norbye</a> added a nice little program to <a href="http://www.couchbase.com/develop/c/next">libcouchbase</a> that allows you to generate load on your Couchbase server and then analyze the response times directly on the console (of course you can get real-time metrics from the Couchbase GUI as well). The program is called <code>pillowfight</code> and is distributed with the source of libcouchbase. It stores a bunch of keys (1000 by default) and then runs &ldquo;mget&rdquo; operations on them and measures the time they need to get returned. In order to run it, you need to compile it from source (which I&rsquo;ll show in a later post but it&rsquo;s not that hard if you are used to compiling on unix-based systems).</p>

<p>On my middle-class Dell notebook with an average processor (Core2 Duo P8700), 4 gigs of RAM and a SSD drive, 90% of the keys return in about 70 microseconds. If I look at the Couchbase GUI for my bucket, I can see that my instance runs somewhere between 10.000 and 12.000 operations per second. I recommend you to run this program on your dev machine just for fun and to get a feeling how it performs. It is also a handy way to generate a constant load on your Couchbase instances and add a large number of keys in an easy way (you can find more params with the -? switch).</p>

<p>If you ran the program, it would be cool to share your results in the comments below.</p>

<h2 id="wrapping-up">Wrapping Up</h2>

<p>From both its history and current feature set, chances are that Couchbase is a possible solution to your session store needs. It provides you with both fast and flexible querying mechanisms and is capable to scale up to more nodes with just a few clicks if you need it to. There are definitely other good storage systems out there (like redis), so make sure to dig deeper into the concepts to find out if Couchbase is right for your application.</p>

<p>As Couchbase 2.0 comes closer and closer to the final release, I think it&rsquo;s a good time to look into the system and see what it&rsquo;s capable of. Also, if you need any help I found that the guys behind Couchbase are very friendly and helpful. You can also ping me via twitter if you like!</p>

<p>If you&rsquo;re just getting your feet wet with Couchbase, I also have two introductory posts on <a href="http://nitschinger.at/Getting-Started-with-Couchbase-and-PHP">PHP</a> and <a href="http://nitschinger.at/Accessing-Couchbase-from-Scala">Scala</a> that you may find helpful!</p>

<p>Finally, kudos to <a href="http://twitter.com/ingenthr">@ingenthr</a> for reviewing this post and providing valuable insight into Couchbase.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">26 Apr 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/Accessing-Couchbase-from-Scala/" class="post-title">Accessing Couchbase from Scala</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>In my recent adventure on exploring both <a href="http://www.couchbase.com/">Couchbase</a> and <a href="http://www.scala-lang.org/">Scala</a>, I noticed that there are not
many tutorials out there using both at the same time. We&rsquo;ll use the <a href="http://www.couchbase.com/develop/java/next">couchbase-java driver</a> in its latest
version (1.1), because it provides support for views and Couchbase 2.0. Note that I won&rsquo;t cover installing Couchbase here, since there is plenty of
material <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-getting-started-install.html">out there</a>. Also, I assume you have scala and
<a href="https://github.com/harrah/xsbt">sbt</a> already installed. The <a href="http://typesafe.com/stack">typesafe stack</a> provides a convenient shortcut to get you
up and running in minutes, so check it out if you haven&rsquo;t already. For the purpos of simplicity, I assume that your Couchbase instance runs on
<code>localhost</code>. If it runs elswhere, just modify the URI string later accordingly.</p>

<p>Let&rsquo;s create the standard directory structure for our project. We&rsquo;ll use sbt to manage our dependencies, so create a <code>build.sbt</code> file too.</p>

<pre><code>/couchbase-scala
    /src
        /main
            /scala
                Main.scala
    build.sbt
</code></pre>

<p>Let&rsquo;s write the <code>build.sbt</code> first:</p>

<pre><code>name := &quot;couchbase-scala&quot;

version := &quot;1.0&quot;

scalaVersion := &quot;2.9.2&quot;

resolvers += &quot;Couchbase Maven Repository&quot; at &quot;http://files.couchbase.com/maven2&quot;

libraryDependencies += &quot;couchbase&quot; % &quot;couchbase-client&quot; % &quot;1.1-dp&quot;
</code></pre>

<p>We need to add the <a href="http://files.couchbase.com/maven2">Couchbase Maven Repository</a> to our resolvers list, since it contains the Couchbase package and all
its dependencies. The last line adds the actual dependency. If you want the (older) stable release, use &ldquo;1.0.2&rdquo; instead of &ldquo;1.1-dp&rdquo;. Tip: you can browse the
repository directly in your browser and see what versions are available.</p>

<p>Let&rsquo;s add a simple <code>Main</code> object in <code>Main.scala</code>:</p>

<pre><code>object Main extends App {
    println(&quot;Hello World&quot;)
}
</code></pre>

<p>Now, start sbt and run the application for the first time:</p>

<pre><code>couchbase-scala$ sbt
&gt; run
** ((Omitting Fetch and Compile Output)) **
[info] Running Main
Hello World
[success] Total time: 4 s, completed 24.04.2012 11:01:33
</code></pre>

<p>I&rsquo;ve omited the part where sbt resolves our dependencies and compiles the libraries, but the output should look like the one above. Now that we have all our
dependencies in place, we can start talking to the Couchbase server. Here&rsquo;s a short example with synchronous set and get operations (note that no exception
handling takes place here):</p>

<pre><code>import collection.JavaConversions._ 
import collection.mutable.ArrayBuffer

import java.net.URI;
import java.net.ConnectException;

import com.couchbase.client.CouchbaseClient;

object Main extends App {
    val uris = ArrayBuffer(URI.create(&quot;http://127.0.0.1:8091/pools&quot;))
    val client = new CouchbaseClient(uris, &quot;default&quot;, &quot;&quot;)

    client.set(&quot;hello&quot;, 0, &quot;world&quot;)
    println(&quot;Receiving -&gt; &quot; + client.get(&quot;hello&quot;))

    client.shutdown()
    System.exit(0)
}
</code></pre>

<p>Save the file, type <code>run</code> again in sbt and you should get the following output (you only need to leave the REPL if you&rsquo;ve changed the <code>build.sbt</code> file):</p>

<pre><code>[info] Compiling 1 Scala source to &lt;Path\to\Sourcecode&gt;\couchbase-scala\target\scala-2.9.2\classes...
[info] Running Main
2012-04-24 11:05:11.850 INFO com.couchbase.client.CouchbaseConnection:  Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
2012-04-24 11:05:11.856 INFO com.couchbase.client.CouchbaseClient:  viewmode property isn't defined. Setting viewmode to production mode
2012-04-24 11:05:11.856 INFO com.couchbase.client.CouchbaseConnection:  Connection state changed for sun.nio.ch.SelectionKeyImpl@10319d7
2012-04-24 11:05:11.926 INFO com.couchbase.client.ViewConnection:  Added daschl-notebook/127.0.0.1:8092 to connect queue
Receiving -&gt; world
2012-04-24 11:05:12.360 INFO com.couchbase.client.CouchbaseConnection:  Shut down Couchbase client
2012-04-24 11:05:12.368 INFO com.couchbase.client.ViewConnection:  Shut down Couchbase client
2012-04-24 11:05:12.374 INFO com.couchbase.client.ViewNode:  Couchbase I/O reactor terminated
[success] Total time: 6 s, completed 24.04.2012 11:05:12
</code></pre>

<p>You see all the Couchbase log messages here, because the default logger logs directly to STDOUT. Right in the middle you can see the output of our synchronous <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/couchbase-sdk-java-retrieve-get.html#table-couchbase-sdk_java_get">get</a> operation. You should also see the
created document in your Couchbase <a href="http://localhost:8091/index.html#sec=documents&amp;bucketName=default">default bucket</a>.</p>

<p>Let&rsquo;s go through the main code line by line and see what&rsquo;s going on.</p>

<pre><code>val uris = ArrayBuffer(URI.create(&quot;http://127.0.0.1:8091/pools&quot;))   
val client = new CouchbaseClient(uris, &quot;default&quot;, &quot;&quot;)
</code></pre>

<p>The <code>CouchbaseClient</code> accepts a list of URIs to communicate with as the first argument (you need to import <code>collection.JavaConversions._</code>, so that <code>ÀrrayBuffer</code> gets
converted to a <code>java.util.List</code>). The second argument is the bucket name, the third one is an optional bucket password (which is always empty for the <code>default</code> one).</p>

<pre><code>client.set(&quot;hello&quot;, 0, &quot;world&quot;)
println(&quot;Receiving -&gt; &quot; + client.get(&quot;hello&quot;))
</code></pre>

<p>We can now throw all commands at the client, be it synchronous or asynchronous ones. You can find all supported methods <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/api-reference-summary.html">here</a>.</p>

<pre><code>client.shutdown()
</code></pre>

<p>Finally, we close the connection to the server. You can pass optional timeouts here, so that the client waits for the given amount of time before it finally closes the connection.
This allows asynchronous commands to finish first.</p>

<p>This post was a very basic introduction on using Couchbase from Scala. The next post will translate the <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/tutorial.html">tutorial</a> to Scala. As always, I&rsquo;m open to suggestions and
improvements!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">12 Mar 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/Getting-Started-with-Couchbase-and-PHP/" class="post-title">Getting Started with Couchbase and PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p><a href="http://www.couchbase.com/">Couchbase</a> is a simple, fast and elastic document-oriented database. It is the product of a merge between the companies behind Memcached (Membase) and CouchDB. The current version is 1.8 and the 2.0 version is already in a developer preview release. If you haven&rsquo;t heard much about Couchbase yet, start at the <a href="http://www.couchbase.com/webinar/couchbase-server-2.0-overview">Couchbase Webinar Series</a>, which will get you up to speed. The full manual is available <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/index.html">here</a>.</p>

<p>As there were a lot of merges, renamings and releases, it was pretty hard to follow up with the current/best database version and SDK to use for your project. Now as the dust has settled a bit, here&rsquo;s what I&rsquo;ve come up with:</p>

<p>Couchbase 2.0 will be the next major version and is already pretty stable, so I&rsquo;ll jump straight onto it and skip 1.8. When it comes to PHP SDKs, you should either use the more feature-complete <a href="https://github.com/couchbaselabs/php-couchbase">php-couchbase</a> SDK (which is based on pecl/memcached) or work the brand new <a href="https://github.com/couchbaselabs/php-ext-couchbase">php-ext-couchbase</a> extension. Note that it doesn&rsquo;t support working with views currently, but according to <a href="https://twitter.com/#!/janl">janl</a> this will be available in a few days. He also mentioned that this extension is the
future way of interacting with Couchbase, so it is definitely worth a look.</p>

<p>The rest of this post guides you through the installation process of both Couchbase and the PHP SDKs.</p>

<h2 id="installing-couchbase">Installing Couchbase</h2>

<p>The easiest way to install Couchbase is through a precompiled binary for Ubuntu, RedHat, Windows or Mac OS X. You can find all of them
<a href="http://www.couchbase.com/download">here</a>. The installation process is really straightforward: you first need to install the binary and
then configure Couchbase from a web interface. I recommend you to watch the webinar starting from minute 7 <a href="http://www.couchbase.com/webinar/couchbase-server-2.0-overview">here</a>, where Perry Krug describes the necessary steps in detail. For the purpose of this post, you can just stick with the default settings.</p>

<pre><code>$ sudo dpkg -i couchbase-server-community_x86_2.0.0-dev-preview-3.deb
</code></pre>

<p>After the installation, you should have a Couchbase instance listening on <code>127.0.0.1:8091</code>.</p>

<h2 id="installing-php-ext-couchbase">Installing php-ext-couchbase</h2>

<p>The new PHP SDK ships as a PHP extension, so we need to compile it. Make sure you have both the build tools (like <code>build-essentials</code>) and the PHP development packages (<code>php5-dev php-pear</code>) installed. You also need to install <code>libssl0.9.8</code>. On Ubuntu it looks like this:</p>

<pre><code>$ sudo aptitude install libssl0.9.8 php5-dev php-pear
</code></pre>

<p>The extension also depends on the <code>libcouchbase</code> library, which can be installed through the Couchbase repository (for more information on this, look <a href="http://www.couchbase.com/develop/c/current">here</a>).</p>

<p>Add this to your <code>/etc/apt/sources.list</code>:</p>

<pre><code># Ubuntu 11.10 Oneiric Ocelot (Debian unstable)
deb http://packages.couchbase.com/ubuntu oneiric oneiric/main
</code></pre>

<p>Then, import the key, update your repositories and install the package:</p>

<pre><code>$ wget -O- http://packages.couchbase.com/ubuntu/couchbase.key | sudo apt-key add -
$ sudo aptitude update &amp;&amp; sudo aptitude install libcouchbase-dev
</code></pre>

<p>Now, we need to <a href="https://github.com/couchbaselabs/php-ext-couchbase/zipball/master">download</a> the extension and build it.</p>

<pre><code>$ unzip couchbaselabs-php-ext-couchbase-2680b64.zip
$ cd couchbaselabs-php-ext-couchbase-2680b64

$ phpize
$ ./configure
$ make
$ sudo make install
  Installing shared extensions:     /usr/lib/php5/20090626+lfs/
</code></pre>

<p>The last thing we need to do is create a new <code>couchbase.ini</code> file in <code>/etc/php5/conf.d</code> with the following content:</p>

<pre><code>extension=couchbase.so
</code></pre>

<p>Now we can see that the couchbase extension is installed correctly:</p>

<pre><code>$ php -m | grep couch
couchbase
</code></pre>

<p>Of course you&rsquo;ll need to restart your webserver or your fastcgi processes too.</p>

<h2 id="installing-php-couchbase">Installing php-couchbase</h2>

<p>If you want to work with the current stable SDK, you need to download the code from the <a href="https://github.com/couchbaselabs/php-couchbase">php-couchbase</a> repository. This SDK extends the <code>memcached</code> extension, which you can install directly through apt:</p>

<pre><code>$ sudo aptitude install php5-memcached
</code></pre>

<p>Documentation for the PHP 1.1 SDK can be found <a href="http://www.couchbase.com/docs/couchbase-sdk-php-1.1/getting-started.html">here</a>.</p>

<p>Note that for the rest of this post I&rsquo;ll use the API provided by the <code>php-ext-couchbase</code> extension, but the one for <code>php-couchbase</code> shouldn&rsquo;t be much different.</p>

<h2 id="basic-usage">Basic Usage</h2>

<p>Historically, communication with CouchDB was done over pure HTTP while memcached provided a custom protocol. Couchbase uses both methods, depending on the task you want to accomplish. Create, update and delete actions are done through the <code>memcached</code> protocol. If you want to read data, you can do that either based on the key (through the memcached protocol) or on a view (through HTTP). Thankfully, the SDK abstracts this away from you, but its always good if you know whats going on under the hood.</p>

<p>You can access the API through an object-oriented interface or directly through their exported functions. I couldn&rsquo;t find any online documentation for now, but here&rsquo;s the function list from the source-code:</p>

<pre><code>/* {{{ couchbase_functions[]
*/
static zend_function_entry couchbase_functions[] = {
    PHP_FE(couchbase_connect, arginfo_connect)
    PHP_FE(couchbase_add, arginfo_add)
    PHP_FE(couchbase_set, arginfo_set)
    PHP_FE(couchbase_set_multi, arginfo_set_multi)
    PHP_FE(couchbase_replace, arginfo_replace)
    PHP_FE(couchbase_prepend, arginfo_prepend)
    PHP_FE(couchbase_append, arginfo_append)
    PHP_FE(couchbase_cas, arginfo_cas)
    PHP_FE(couchbase_get, arginfo_get)
    PHP_FE(couchbase_get_multi, arginfo_get_multi)
    PHP_FE(couchbase_get_delayed, arginfo_get_delayed)
    PHP_FE(couchbase_fetch, arginfo_fetch)
    PHP_FE(couchbase_fetch_all, arginfo_fetch_all)
    PHP_FE(couchbase_increment, arginfo_increment)
    PHP_FE(couchbase_decrement, arginfo_decrement)
    PHP_FE(couchbase_get_stats, arginfo_get_stats)
    PHP_FE(couchbase_delete, arginfo_delete)
    PHP_FE(couchbase_flush, arginfo_flush)
    PHP_FE(couchbase_get_result_code, arginfo_result_code)
    PHP_FE(couchbase_set_option, arginfo_set_option)
    PHP_FE(couchbase_get_option, arginfo_get_option)
    PHP_FE(couchbase_version, arginfo_version)
    {NULL, NULL, NULL}
};
</code></pre>

<p>The <a href="https://github.com/couchbaselabs/php-ext-couchbase/tree/master/tests">test cases</a> also provide vital information on how to use the API.</p>

<p>Let&rsquo;s create 10 JSON documents and store them in Couchbase:</p>

<pre><code>&lt;?php

$connection = new Couchbase(&quot;127.0.0.1:8091&quot;);

for($i=0;$i&lt;10;$i++) {
    $doc = array(
        'title' =&gt; &quot;This is Post $i&quot;
    );
    $connection-&gt;set(&quot;post_$i&quot;, json_encode($doc));
}

?&gt;
</code></pre>

<p>You can view your stored documents instantly through the GUI (<a href="http://localhost:8091/index.html#sec=documents&amp;bucketName=default">http://localhost:8091/index.html#sec=documents&amp;bucketName=default</a>). Now we can retrieve all documents again by their keys:</p>

<pre><code>&lt;?php

$connection = new Couchbase(&quot;127.0.0.1:8091&quot;);

echo &quot;&lt;ul&gt;&quot;;
for($i=0;$i&lt;10;$i++) {
    $post = json_decode($connection-&gt;get(&quot;post_$i&quot;));
    echo &quot;&lt;li&gt;&quot; . $post-&gt;title .  &quot;&lt;/li&gt;&quot;;
}
echo &quot;&lt;/ul&gt;&quot;;

?&gt;
</code></pre>

<p>Note that we need to encode/decode our JSON documents by hand, because in Couchbase you can store pretty much what you want in a document.</p>

<p>There are lots of other things that can be explored, but for now you should have a Couchbase instance up and running and you can start to explore it on your own!</p>

<p>&rdquo;&lsquo;Edit 1:&ldquo;&rsquo;
Jan <a href="https://twitter.com/#!/janl/status/179166150205259776">pointed out</a> that they don&rsquo;t recommend php-couchbase at this point as the extension will gain all functionality soon. Thanks!</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/tags/couchbase/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 2 of 2</span>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; Michael Nitschinger 2010-2018</li>
        </ul>
    </div>
</div>
<script src="https://nitschinger.at/js/all.min.js"></script>
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-19686689-1', 'auto');
    ga('send', 'pageview');
    ga('set', 'anonymizeIp', true);
</script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
