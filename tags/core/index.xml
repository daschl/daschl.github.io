<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>daschl writes. sometimes.</title>
    <link>http://nitschinger.at/tags/core/index.xml</link>
    <description>Recent content on daschl writes. sometimes.</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <atom:link href="http://nitschinger.at/tags/core/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Testing the Lithium core for fun and profit</title>
      <link>http://nitschinger.at/Testing-the-Lithium-core-for-fun-and-profit/</link>
      <pubDate>Sat, 09 Jul 2011 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Testing-the-Lithium-core-for-fun-and-profit/</guid>
      <description>

&lt;p&gt;In modern web frameworks, testing is one of the most important pillars that ensure a clean, stable and extendable codebase. Testing support in Lithium was built in from the beginning and therefore it already features a great code coverage. The Lithium project aims to work out of the box on many platforms, including Microsoft Windows and its IIS, which was often neglected in the past.&lt;/p&gt;

&lt;p&gt;The main purpose of this post is to show you how core tests work and were the core team needs help to improve things further. At the end of this post you should be able to write new and extend existing test cases. A side effect of this is that you&amp;rsquo;ll learn parts of the core from the inside out while you&amp;rsquo;re testing them.&lt;/p&gt;

&lt;h2 id=&#34;introducing-core-tests&#34;&gt;Introducing core tests&lt;/h2&gt;

&lt;p&gt;Before you start writing your own tests, make sure the existing cases work as expected (without any &lt;code&gt;Exceptions&lt;/code&gt; or &lt;code&gt;Errors&lt;/code&gt;). For developing directly in the core, I&amp;rsquo;d recommend you a slightly different setup than the default one. You should clone the &lt;code&gt;framework&lt;/code&gt; and the &lt;code&gt;lithium&lt;/code&gt; repository in different directories so you can quickly exchange functionality and symlink stuff if you have to. My setup looks similar to this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;- web
    - framework
    - libraries
        - lithium
        - li3_docs
        - manual
        - lithium_qa
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now tell your &lt;code&gt;framework&lt;/code&gt; to look at the right path, hop into &lt;code&gt;app/config/bootstrap/libraries.php&lt;/code&gt; and modify the &lt;code&gt;LITHIUM_LIBRARY_PATH&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;define(&#39;LITHIUM_LIBRARY_PATH&#39;, dirname(dirname(LITHIUM_APP_PATH)) . &#39;/libraries&#39;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you haven&amp;rsquo;t already, make sure that the &lt;code&gt;app/resources&lt;/code&gt; folder is writable.&lt;/p&gt;

&lt;p&gt;Assuming you have your &lt;code&gt;DOCROOT&lt;/code&gt; pointing to &lt;code&gt;web&lt;/code&gt;, try to run the tests from the test dashboard located at &lt;code&gt;http://localhost/framework/test&lt;/code&gt;. Ideally, your test output should look something like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://nitschinger.at/img/core_testing_overview.png&#34; title=&#34;Test Dashboard&#34; /&gt;&lt;/p&gt;

&lt;p&gt;If you have any failing tests, try to track down if it is your setup or some test cases are not working correctly. If you&amp;rsquo;re unsure, you can always get feedback on #li3 at freenode.&lt;/p&gt;

&lt;h2 id=&#34;understanding-test-filters&#34;&gt;Understanding test filters&lt;/h2&gt;

&lt;p&gt;Now that existing tests are running as expected, take a look at the buttons on the top. The &lt;code&gt;Affected&lt;/code&gt;, &lt;code&gt;Complexity&lt;/code&gt;, &lt;code&gt;Coverage&lt;/code&gt; and &lt;code&gt;Profiler&lt;/code&gt; labeled buttons are called &amp;ldquo;test filters&amp;rdquo; and perform specific tasks on the selected group of test cases.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://nitschinger.at/img/core_testing_filters.png&#34; title=&#34;Test Filters&#34; /&gt;&lt;/p&gt;

&lt;p&gt;As they are very important, let&amp;rsquo;s go through them in more detail. Note that you need to turn on &lt;a href=&#34;http://xdebug.org/&#34;&gt;Xdebug&lt;/a&gt; to use them, but you should install this extension anyway in your development environment.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Affected:&lt;/strong&gt; The &lt;code&gt;affected&lt;/code&gt; filter shows you what other tests depend on the currently tested class. This helps you to understand what impact a change to the current code would have and where to look out for possible errors.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Complexity:&lt;/strong&gt; The &lt;code&gt;complexity&lt;/code&gt; filter calculates the &lt;a href=&#34;http://en.wikipedia.org/wiki/Cyclomatic_complexity&#34;&gt;Cyclomatic Complexity&lt;/a&gt; for each executed method and shows you the worst offenders. According to best practices, a cyclomatic complexity greater than 10 is &amp;ldquo;very complex&amp;rdquo; and should be refactored if possible. This of course depends heavily on the type of code but it provides a good overview on how complex the class is in general and where to look first to decrease complexity.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Coverage:&lt;/strong&gt; The &lt;code&gt;coverage&lt;/code&gt; filters tries to find out which lines of the tested code got executed in your test. Lithium has the baseline of 85% test coverage for core classes which should ensure that most of the code is at least once tested somewhere. The current implementation of the coverage filter also shows some false-negatives so make sure to take the result with a grain of salt.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Profiler:&lt;/strong&gt; The &lt;code&gt;profiler&lt;/code&gt; filter tells you how long it took to execute the tests and how much memory was used. You can use this to measure the performance of the code and check the impact of code modifications.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Make sure to get familiar with these filters as they are crucial in verifying and investigating your written tests.&lt;/p&gt;

&lt;h2 id=&#34;investigating-core-tests&#34;&gt;Investigating core tests&lt;/h2&gt;

&lt;p&gt;The best way to get familiar with core tests is to look at existing ones. Let&amp;rsquo;s investigate one test case of the &lt;code&gt;ValidatorTest&lt;/code&gt; class.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Tests that new methods can be called on Validator by adding rules using Validator::add().
 *
 * @return void
 */
public function testAddCustomRegexMethods() {
    $this-&amp;gt;assertNull(Validator::rules(&#39;foo&#39;));

    Validator::add(&#39;foo&#39;, &#39;/^foo$/&#39;);
    $this-&amp;gt;assertTrue(Validator::isFoo(&#39;foo&#39;));
    $this-&amp;gt;assertFalse(Validator::isFoo(&#39;bar&#39;));
    $this-&amp;gt;assertTrue(in_array(&#39;foo&#39;, Validator::rules()));
    $this-&amp;gt;assertEqual(&#39;/^foo$/&#39;, Validator::rules(&#39;foo&#39;));

    $this-&amp;gt;expectException(&amp;quot;Rule `bar` is not a validation rule.&amp;quot;);
    $this-&amp;gt;assertNull(Validator::isBar(&#39;foo&#39;));
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you look closely, you can identify a pattern here that will come frequently. Before you test a specific functionality/value, make sure it isn&amp;rsquo;t already set. You can do this with &lt;code&gt;assertFalse&lt;/code&gt;, &lt;code&gt;assertNull&lt;/code&gt; or maybe &lt;code&gt;assertTrue(empty(..))&lt;/code&gt;. Next, perform the piece of code you want to test (like adding a custom regex rule here) and then perform checks on the entity again. A good rule of thumb is to test normal cases first and then exceptional cases (which often raise &lt;code&gt;Exceptions&lt;/code&gt;). You can also break down complicated tests in smaller ones and add helper methods that get called from the main test case.&lt;/p&gt;

&lt;p&gt;If your tests contain dependencies, make sure to initialize them in &lt;code&gt;setUp()&lt;/code&gt; and remove/reset them in &lt;code&gt;tearDown()&lt;/code&gt;. These methods get called before/after all tests in the test class and should leave the environment in a clean state. This prevents unexpected failures in later tests and also keeps the memory usage on a normal level. Here&amp;rsquo;s an example of the &lt;code&gt;MongoDb&lt;/code&gt; test class:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public function setUp() {
    Connections::config(array(&#39;lithium_mongo_test&#39; =&amp;gt; $this-&amp;gt;_testConfig));
    $this-&amp;gt;db = Connections::get(&#39;lithium_mongo_test&#39;);
    $model = $this-&amp;gt;_model;
    $model::config(array(&#39;key&#39; =&amp;gt; &#39;_id&#39;));
    $model::resetConnection(false);

    $this-&amp;gt;query = new Query(compact(&#39;model&#39;) + array(
        &#39;entity&#39; =&amp;gt; new Document(compact(&#39;model&#39;))
    ));
}

public function tearDown() {
    try {
        $this-&amp;gt;db-&amp;gt;delete($this-&amp;gt;query);
    } catch (Exception $e) {}
    unset($this-&amp;gt;query);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;setUp()&lt;/code&gt; method initializes a test connection to the database and &lt;code&gt;tearDown()&lt;/code&gt; makes sure that the test database gets deleted and the &lt;code&gt;$this-&amp;gt;query&lt;/code&gt; object is freed.&lt;/p&gt;

&lt;p&gt;There are a lot more patterns that you&amp;rsquo;ll learn while writing core tests, but this should give you a start.&lt;/p&gt;

&lt;h2 id=&#34;qa-your-code&#34;&gt;QA your code&lt;/h2&gt;

&lt;p&gt;To ensure a high-quality codebase, Lithium enforces a set of coding standards which can be found &lt;a href=&#34;https://github.com/UnionOfRAD/lithium/wiki/Coding-Standards&#34;&gt;here&lt;/a&gt;. You don&amp;rsquo;t have to know every part of the standard by heart, because Lithium provides a plugin called &lt;a href=&#34;https://github.com/UnionOfRAD/lithium_qa&#34;&gt;lithium_qa&lt;/a&gt;. This plugin checks your code if it complies to the standards and shows you what parts of it are wrong. I recommend you to clone it into the &lt;code&gt;libraries&lt;/code&gt; directory shown above. It is also a good idea to add the &lt;code&gt;li3&lt;/code&gt; command to your &lt;code&gt;PATH&lt;/code&gt; so your calls don&amp;rsquo;t get too verbose.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cd /usr/local/bin
$ sudo ln -s /path/to/lithium/console/li3 li3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s assume we want to check classes in the &lt;code&gt;lithium\core&lt;/code&gt; namespace:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cd lithium_qa
$ li3 syntax ../lithium/core
[Passed ] syntax check of `core/Object.php`
[Passed ] syntax check of `core/Adaptable.php`
[Failed ] syntax check of `core/StaticObject.php`
59| 101| Maximum line length exceeded
[Passed ] syntax check of `core/Environment.php`
[Passed ] syntax check of `core/ConfigException.php`
[Passed ] syntax check of `core/ClassNotFoundException.php`
[Passed ] syntax check of `core/NetworkException.php`
[Passed ] syntax check of `core/ErrorHandler.php`
[Passed ] syntax check of `core/Libraries.php`
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There you can see that each core class passed the test except the &lt;code&gt;StaticObject&lt;/code&gt; class which has one line (59) that is too long. Now you can edit that file and modify it accordingly. If you&amp;rsquo;re not sure what the output means, head back to the &lt;a href=&#34;https://github.com/UnionOfRAD/lithium/wiki/Coding-Standards&#34;&gt;official standard&lt;/a&gt; and look for the corresponding entry.&lt;/p&gt;

&lt;p&gt;Please make sure that all code you want to see in the core respects these standards. You can also use it to test your own code as well!&lt;/p&gt;

&lt;h2 id=&#34;getting-help&#34;&gt;Getting help&lt;/h2&gt;

&lt;p&gt;If you&amp;rsquo;re new to code testing in Lithium, make sure to read the official guide in the &lt;a href=&#34;http://lithify.me/docs/manual/10_testing/readme.wiki&#34;&gt;manual&lt;/a&gt; first. Next, check out the main &lt;a href=&#34;https://github.com/UnionOfRAD/lithium/issues/17&#34;&gt;testing ticket on GitHub&lt;/a&gt; which is constantly updated and shows what classes need testing. If you need help on testing the core, make sure to join #li3-core on freenode and ping one of the core developers. You can also contact me directly and I&amp;rsquo;ll make sure to help you out or point you in the right direction.&lt;/p&gt;

&lt;h2 id=&#34;wrapping-up&#34;&gt;Wrapping up&lt;/h2&gt;

&lt;p&gt;You should now be able to run the core tests, extend and write your own and also pass your code through the official code quality assurance tool. Please help out and fork the core, run it on your machine, check for errors, extend current tests, write new ones and correct QA issues. If we all work together, I&amp;rsquo;m sure we can make Lithium the best tested web framework out there. If you want to see more information regarding this topic on my blog, comment down below and I&amp;rsquo;ll see what I can provide.&lt;/p&gt;

&lt;p&gt;Keep on coding!&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>