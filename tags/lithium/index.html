<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lithium &middot; daschl writes. sometimes.</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.17" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Lithium &middot; daschl writes. sometimes.">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Lithium &middot; daschl writes. sometimes.">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://nitschinger.at//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="daschl writes. sometimes." href="http://nitschinger.at//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://nitschinger.at/">daschl writes. sometimes.</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/daschl"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/daschl"><i class="fa fa-github-alt"></i> github</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="http://nitschinger.at//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">03 Mar 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Introducing-Relationships-in-Lithium/" class="post-title">Introducing Relationships in Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="introduction">Introduction</h1>

<p>The model relationship support in Lithium is one of the hottest topics on IRC lately, so I thought it would be a good idea to blog about it.</p>

<p>Currently, Lithium supports 1:1 and 1:n relationships for relational databases. There is no m:n support out of the box (like CakePHP&rsquo;s <code>$hasAndBelongsToMany</code>). This also means that MongoDB relationships are not implemented for now. If you look at the <a href="https://github.com/UnionOfRAD/lithium/wiki/Roadmap">Roadmap</a>, you can see that this is on the &ldquo;pre 1.0&rdquo; list and will be addressed before the 1.0 version is released.</p>

<p>This post gives you a little background on relationship types and their database representations before we implement a simple example in PHP.</p>

<h1 id="basics-first">Basics First</h1>

<p>If you know how the three &ldquo;big&rdquo; relationship types 1:1, 1:n and m:n are implemented on the database side, feel free to jump straight to the practical example. This is not a exhaustive guide to the relational database model and should only set the stage for the practical example later. Note that I didn&rsquo;t add any foreign key constraints on the database level to make it easier to follow along.</p>

<p>If you work with a relational data model, and have a (more or less) <a href="http://en.wikipedia.org/wiki/Database_normalization">normalized</a> schema, you need to find a way to model relationships between relations (speak &ldquo;entities&rdquo; or &ldquo;tables&rdquo;). In pratice, these relationships fall into three categories:</p>

<h2 id="1-1-relationships">1:1 Relationships</h2>

<p>Exactly one entity belongs to exactly one other entity. For example, think of a <code>people</code> relation and you want to model
the relationship between married people. One husband can only belong to one wife and vice versa (depending from where you are reading this post this might be different ;)). In a physical database schema, it may look like this.</p>

<pre><code>mysql&gt; describe people;
+-----------+--------------+------+-----+---------+----------------+
| Field     | Type         | Null | Key | Default | Extra          |
+-----------+--------------+------+-----+---------+----------------+
| id        | int(11)      | NO   | PRI | NULL    | auto_increment |
| name      | varchar(255) | YES  |     | NULL    |                |
| spouse_id | int(11)      | YES  |     | NULL    |                |
+-----------+--------------+------+-----+---------+----------------+
3 rows in set (0.01 sec)
</code></pre>

<p>The <code>spouse_id</code> references a different person (note that it is not important if you reference an entity in the same or a different table. Here&rsquo;s some example data:</p>

<pre><code>mysql&gt; select * from people;
+----+--------+-----------+
| id | name   | spouse_id |
+----+--------+-----------+
|  1 | Bob    |         2 |
|  2 | Alice  |         1 |
+----+--------+-----------+
4 rows in set (0.00 sec)
</code></pre>

<p><code>Bob</code> and <code>Alice</code> are married and their relationship is identified over the foreign key <code>spouse id</code>. In Lithium, this type of relation is called <code>hasOne</code>.</p>

<h2 id="1-n-relationships">1:n Relationships</h2>

<p>Exactly one entity belongs to zero or more other entites. This is easy: a user can write zero or more blog posts. Let&rsquo;s model this accordingly:</p>

<pre><code>mysql&gt; describe posts;
+---------+--------------+------+-----+---------+----------------+
| Field   | Type         | Null | Key | Default | Extra          |
+---------+--------------+------+-----+---------+----------------+
| id      | int(11)      | NO   | PRI | NULL    | auto_increment |
| title   | varchar(255) | NO   |     | NULL    |                |
| user_id | int(11)      | NO   |     | NULL    |                |
+---------+--------------+------+-----+---------+----------------+
3 rows in set (0.01 sec)

mysql&gt; describe users;
+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(255) | NO   |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
2 rows in set (0.01 sec)
</code></pre>

<p>Here&rsquo;s some example data to work with:</p>

<pre><code>mysql&gt; select * from posts;
+----+--------------+---------+
| id | title        | user_id |
+----+--------------+---------+
|  1 | First post.  |       1 |
|  2 | Second post. |       1 |
+----+--------------+---------+
2 rows in set (0.00 sec)

mysql&gt; select * from users;
+----+-----------+
| id | name      |
+----+-----------+
|  1 | Bob       |
|  2 | Alice     |
+----+-----------+
1 row in set (0.00 sec)
</code></pre>

<p>It&rsquo;s easy to see that Bob wrote two posts while Alice didn&rsquo;t write a single one. We can look at these relations from two different angles (and can also answer two different questions): &ldquo;What posts did Bob write?&rdquo; and &ldquo;Who is the author of the first post?&rdquo;. To answer both questions
 orrectly, Lithium uses two different relation types for the models: <code>hasMany</code> and <code>belongsTo</code>. One user <code>hasMany</code> blog posts, but one post <code>belongsTo</code> only one user. The wording also implies where the foreign key is placed: in a <code>hasMany</code> relationship, the foreign key is expected on the other model, while <code>belongsTo</code> expects it in the current model. We&rsquo;ll see shortly how this works out in practice.</p>

<h2 id="m-n-relationships">m:n Relationships</h2>

<p>Lastly, zero or more entities can belong to zero or more other entities. This is a bit tricky, because we need a third table to model this relationship efficiently. For example, a user can belong to zero or more groups and groups can have zero or more members.</p>

<pre><code>mysql&gt; describe users;
+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(255) | NO   |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
2 rows in set (0.02 sec)

mysql&gt; describe groups;
+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(255) | YES  |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
2 rows in set (0.02 sec)

mysql&gt; describe users_groups;
+----------+---------+------+-----+---------+-------+
| Field    | Type    | Null | Key | Default | Extra |
+----------+---------+------+-----+---------+-------+
| group_id | int(11) | NO   |     | NULL    |       |
| user_id  | int(11) | NO   |     | NULL    |       |
+----------+---------+------+-----+---------+-------+
2 rows in set (0.01 sec)
</code></pre>

<p>You can see that we need a third table to &ldquo;glue&rdquo; the other two together. Here&rsquo;s some example data:</p>

<pre><code>mysql&gt; select * from users;
+----+-----------+
| id | name      |
+----+-----------+
|  1 | Alice     |
|  2 | John      |
|  3 | Tom       |
+----+-----------+
3 rows in set (0.00 sec)

mysql&gt; select * from groups;
+----+----------------+
| id | name           |
+----+----------------+
|  1 | Administrators |
|  2 | Support        |
+----+----------------+
2 rows in set (0.00 sec)

mysql&gt; select * from users_groups;
+----------+---------+
| group_id | user_id |
+----------+---------+
|        1 |       1 |
|        1 |       2 |
|        2 |       2 |
+----------+---------+
3 rows in set (0.00 sec)
</code></pre>

<p><code>John</code> has access to both groups, while the <code>Administrator</code> group has two members. Lithium doesn&rsquo;t support this kind of relationship for now, but in CakePHP it is called <code>hasAndBelongsToMany</code>.</p>

<h1 id="the-blog-example">The Blog example</h1>

<p>Now that we&rsquo;ve got the basics settled, let&rsquo;s get our hands on some code and implement the &ldquo;Hello World 2.0&rdquo; example -
a blog. Along the way we can reuse some of the tables above.</p>

<p>Let&rsquo;s assume we want to store blog posts and their authors. For simplicity, every author can belong to only one group and a group can only have one member. This way, we can practice 1:n and 1:1 relationships. Let&rsquo;s create the appropriate data model using the MySQL DDL:</p>

<pre><code>CREATE TABLE groups (
    id integer auto_increment primary key,
    name varchar(255) not null
);

CREATE TABLE authors (
    id integer auto_increment primary key,
    firstname varchar(255) not null,
    lastname varchar(255) not null,
    group_id integer
);

CREATE TABLE posts (
    id integer auto_increment primary key,
    title varchar(255) not null,
    body text,
    author_id integer
);
</code></pre>

<p>Let&rsquo;s insert some demo data to work with:</p>

<pre><code>insert into groups (name) values ('Admins');
insert into groups (name) values ('Editors');

insert into authors (firstname, lastname, group_id) values ('Johnnie', 'Walker', 1);
insert into authors (firstname, lastname, group_id) values ('John', 'Jameson', 2);
insert into authors (firstname, lastname, group_id) values ('Jack', 'Daniels', 2);

insert into posts (author_id, title, body) values (1, 'On whisky nosing', '...');
insert into posts (author_id, title, body) values (2, 'Irish on the ROCKS', '...');
insert into posts (author_id, title, body) values (2, 'Without fear.', '...');
insert into posts (author_id, title, body) values (3, 'On drinking Bourbon', '...');
</code></pre>

<p>Next, grab a fresh copy of Lithium and create a connection in <code>config/bootstrap/connections.php</code>:</p>

<pre><code>Connections::add('default', array(
    'type' =&gt; 'database',
    'adapter' =&gt; 'MySql',
    'host' =&gt; 'localhost',
    'login' =&gt; '&lt;USER&gt;',
    'password' =&gt; '&lt;PASSWORD&gt;',
    'database' =&gt; '&lt;DBNAME&gt;',
    'encoding' =&gt; 'UTF-8'
));
</code></pre>

<p>Now, let&rsquo;s create three bare-bone models in <code>app\models</code> to start with:</p>

<pre><code>&lt;?php
// Filename: /app/models/Posts.php
namespace app\models;

class Posts extends \lithium\data\Model {

}
?&gt;

&lt;?php
// Filename: /app/models/Authors.php
namespace app\models;

class Authors extends \lithium\data\Model {

}
?&gt;

&lt;?php
// Filename: /app/models/Groups.php
namespace app\models;

class Groups extends \lithium\data\Model {

}
?&gt;
</code></pre>

<p>To produce meaningful output in the browser, we&rsquo;d better add a controller and a view template.</p>

<pre><code>&lt;?php
// Filename: /app/controllers/PostsController.php
namespace app\controllers;

use app\models\Posts;
use app\models\Authors;
use app\models\Groups;

class PostsController extends \lithium\action\Controller {

    public function index() {

    }

}
?&gt;


&lt;!-- Filename: /app/views/posts/index.html.php --&gt;
&lt;h2&gt;All Posts.&lt;/h2&gt;

More stuff will be here soon.
</code></pre>

<p>Now that we have everything in place, we can define our relationships in Lithium. Place the following snippets in their appropriate models:</p>

<pre><code>// Posts:
public $belongsTo = array('Authors');

// Authors:
public $hasMany = array('Posts');

// Groups:
public $hasOne = array('Authors');
</code></pre>

<p>As our database tables rely on conventional column names, we don&rsquo;t have to provide more configuration params to Lithium. Now, let&rsquo;s read all posts, their corresponding authors and print them in the template.</p>

<pre><code>// PostsController:
public function index() {
    $posts = Posts::all(array('with' =&gt; 'Authors'));
    return compact('posts');
}


// index.html.php:
&lt;ul&gt;
    &lt;?php foreach($posts as $post): ?&gt;
        &lt;li&gt;
            &lt;strong&gt;&lt;?= $post-&gt;title; ?&gt;&lt;/strong&gt;, by 
            &lt;?= $post-&gt;author-&gt;firstname; ?&gt; &lt;?= $post-&gt;author-&gt;lastname; ?&gt;
        &lt;/li&gt;
    &lt;?php endforeach; ?&gt;
&lt;/ul&gt;
</code></pre>

<p>The <code>with</code> param controls what relationships you want to fetch. In this case, as a post belongs to one author, Lithium knows that only one <code>Record</code> is returned and you can use the <code>author</code> directly. If you don&rsquo;t provide the appropriate class there, Lithium won&rsquo;t call the associated model and an error will be raised (because <code>$post-&gt;author</code> isn&rsquo;t set, PHP complains that you want to access <code>firstname</code> from a non-object). This is a common mistake, so keep it in mind!</p>

<p>Lithium is very flexible on the data layer, and you can write instance methods on your model and access them through the relation. Let&rsquo;s say we want to provide the full name at the model layer, so that we don&rsquo;t have to read both the first- and the lastname in the template.</p>

<pre><code>// Authors:
public function fullName($entity) {
    return $entity-&gt;firstname.&quot; &quot;.$entity-&gt;lastname;
}

// index.html.php:
&lt;strong&gt;&lt;?= $post-&gt;title; ?&gt;&lt;/strong&gt;, by &lt;?= $post-&gt;author-&gt;fullName(); ?&gt;
</code></pre>

<p>We can also read all posts that belong to a particular author:</p>

<pre><code>$posts = Authors::first(array(
    'conditions' =&gt; array('posts.id' =&gt; $author_id), 
    'with' =&gt; 'Posts'
))-&gt;posts;
</code></pre>

<p>To find data through our 1:1 relation, we can use the same mechanisms:</p>

<pre><code>// Find the author name for a group:
$name = Groups::first(array(
    'conditions' =&gt; array('groups.id' =&gt; $group_id),
    'with' =&gt; array('Authors')
))-&gt;author-&gt;fullName();
</code></pre>

<p>Note that if we want to find the name of the associated group for an author, we would need to add a foreign key to the <code>groups</code> table (there is no real difference between <code>hasOne</code> and <code>hasMany</code>, just the fact that <code>hasOne</code> returns exactly one entity instead of zero or more and therefore no <code>Collection</code> is needed).</p>

<h1 id="wrapping-up">Wrapping up</h1>

<p>This post has covered the basics of model relationships and how to model the 1:1 and 1:n types in Lithium. We now set the stage for more advanced topics, including: form integration, faking the m:n relationship for relational databases, faking relationships for MongoDB and advanced relationship handling through the <code>Relationship</code> class. If you have any other interesting topics that you want to read about soon, share your ideas!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">24 Feb 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/RFC-li3_fixtures-Rewrite/" class="post-title">RFC: li3_fixtures Rewrite</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>The <a href="https://github.com/daschl/li3_fixtures">li3_fixtures</a> plugin was my first Lithium plugin ever, and while it works okay, I feel there is a lot I can do to make it better and more flexible. In this post I want to share my ideas for a new fixture plugin and also want to gather feedback from the community to make it even more awesome.</p>

<p>As far as I can see, there are three big use cases for fixtures:</p>

<h2 id="unit-testing-models">Unit-Testing Models</h2>

<p>This seems to be the most common use case. To test models effectively, you need a bunch of demo data on which your tests rely on. This data includes both valid and invalid data to test if validations work as expected and how the application can handle large batches of data. The database itself is not mocked, but fixture data is used to populate it before or during the actual tests.</p>

<p>This can be done without fixtures too, but you need to reinvent the wheel and store your demo data either in external files or directly in your code. When you store it in external files, you need to mess around with file loading and parsing. If you store it directly in your code it gets bloated and makes your code unreadable (and your data is always bound to the test class and can&rsquo;t be reused). To make it as easy as possible, the <code>li3_fixtures</code> plugin needs to provide the following:</p>

<ul>
<li>centralized storage of fixture data.</li>
<li>transparent support for various data types (JSON, XML and YAML).</li>
<li>easy loading of fixture datasets into the database.</li>
</ul>

<h2 id="mocking-models">Mocking Models</h2>

<p>When you test your controllers, you often need to work with data from your models. There are two different scenarios here: you can either write integration tests and populate your real database with data, or mock your models away and work with static data instead of touching the database (for unit-testing controller actions). This allows you to work independently on both layers and improves the performance of your tests.</p>

<p>Lithium already uses Mocks extensively, so the plugin needs tight integration into them. It should be easy to load fixture data that acts like &ldquo;real&rdquo; data (like iterating over Document/RecordSets).</p>

<h2 id="mocking-web-services-and-apis">Mocking Web-Services and APIs</h2>

<p>The third use case is not really different from the two mentioned above, but works more with the <code>service</code> than the the <code>data</code> layer. As web services are often not inside the boundaries of the developer, the plugin should make it easy to provide demo data for mocks while testing web services.</p>

<h2 id="additional-functionality">Additional Functionality</h2>

<p>In terms of rapid application development, it would be great to generate fixture data automatically based on patterns or generation rules. There are great libraries like <a href="https://github.com/fzaninotto/Faker">Faker</a> out there, and it would be great to have a feature like this integrated (accessible from the command line). Also, fixture file generation should happen automatically when new models are created from the command line.</p>

<h2 id="implementation-documentation">Implementation &amp; Documentation</h2>

<p>I want to make extensive use of adapters and strategies, as they make a lot of sense in this context. I think it would be a good idea to use adapters for all input file types (JSON, XML and YAML) and strategies for their representation in the test classes (DocumentSets, RecordSets, Collections or plain arrays). This also makes it trivial to implement custom file types and representations.</p>

<p>For documentation, I plan to use li3_docs for both the API docs and the actual manual. A current version of the manual will be found as a subdomain on my blog here (of course you&rsquo;ll also have it in your app when you use li3_docs).</p>

<p>Finally, the plugin will be usable through composer and uses it too to manage external dependencies (I plan to use the Symfony parser for the YAML format).</p>

<h2 id="next-steps">Next Steps</h2>

<p>Now it&rsquo;s your turn! Comment below and tell me wheter you like the ideas presented here or not. I&rsquo;m open to every suggestion!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">23 Jan 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Playing-with-Composer-and-Lithium/" class="post-title">Playing with Composer and Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="about-composer">About Composer</h2>

<p><a href="http://packagist.org/about-composer">Composer</a> is a command-line tool that helps you manage your application dependencies. It automatically
fetches packages, resolves dependencies and is easy to configure. The really good thing about Composer is that it isn&rsquo;t bound to a specific framework and can be used with every kind of repository. Composer is similar to package managers like npm, so you may feel at home quickly.</p>

<p>The default repository of Composer is <a href="http://packagist.org/">Packagist</a>. If you want to use Composer in your project, you basically need two things: a <code>composer.json</code> file in your application root and the <code>composer.phar</code> application file itself. The easiest way to get it is to download it <a href="http://getcomposer.org/composer.phar">directly</a> and drop it somewhere on your file system. A minimal <code>composer.json</code> file looks like this:</p>

<pre><code>{
    &quot;name&quot;: &quot;my-project&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;require&quot;: {
        &quot;monolog/monolog&quot;: &quot;1.0.0&quot;
    }
}
</code></pre>

<p>As Packagist acts as the default repository, this will fetch the <a href="http://packagist.org/packages/monolog/monolog">monolog</a> library from there into the <code>vendor</code> directory. There are a lot of configuration options that can be found <a href="https://raw.github.com/composer/composer/master/doc/composer-schema.json">here</a>.</p>

<p>Let&rsquo;s go through a quick example hands-on. Consider the following directory structure:</p>

<pre><code>/web
    composer.phar
    /my-project
        composer.json
</code></pre>

<p>If you execute the following commands:</p>

<pre><code>$ cd my-project/
$ php path/to/composer.phar install
</code></pre>

<p>Your directory structure will look like this afterwards:</p>

<pre><code>/web
    composer.phar
    composer.lock
    /my-project
        composer.json
        /vendor
            /bin
            /monolog
                ....
</code></pre>

<p>If you stick with the defaults, all your dependencies will be installed in the <code>vendor</code> directory. Lithium uses the <code>libraries</code> directory to store the dependencies instead, but composer makes it easy to change the default directory (as you&rsquo;ll see shortly). You may also notice that there&rsquo;s a <code>bin</code> directory, which contains executable files (of course only if the installed  dependencies provide some).</p>

<p>Composer also creates a <code>composer.lock</code> file that contains a &ldquo;frozen&rdquo; state of the current dependency tree.</p>

<pre><code>{
    &quot;hash&quot;: &quot;a725fb1bf93f5c534217bbce2897ddc9&quot;,
    &quot;packages&quot;: [
        {
            &quot;package&quot;: &quot;monolog\/monolog&quot;,
            &quot;version&quot;: &quot;1.0.0&quot;
        }
    ]
}
</code></pre>

<h2 id="managing-lithium">Managing Lithium</h2>

<p>Now that we know how to work with Composer, let&rsquo;s manage a Lithium application with it. Currently, Lithium doesn&rsquo;t provide Composer packages out of the box, but it&rsquo;s easy to write one.</p>

<p>The first thing you want to do is clone (or download) the <code>framework</code> repository. You can also use the <code>li3 library extract</code> command but then you&rsquo;d have to change the <code>LITHIUM_LIBRARY_PATH</code> back to the default location.</p>

<pre><code>$ git clone git://github.com/UnionOfRAD/framework.git composer-test
Cloning into composer-test...
remote: Counting objects: 29794, done.
remote: Compressing objects: 100% (8622/8622), done.
remote: Total 29794 (delta 18425), reused 29672 (delta 18332)
Receiving objects: 100% (29794/29794), 3.94 MiB | 1.52 MiB/s, done.
Resolving deltas: 100% (18425/18425), done.
</code></pre>

<p>Now, instead of initializing the git submodules (which would fetch the Lithium core the good old way), add this <code>composer.json</code> file to <code>/composer-test</code>.</p>

<pre><code>{
    &quot;name&quot;: &quot;composer-test&quot;,
    &quot;version&quot;: &quot;0.1.0&quot;,
    &quot;config&quot;: {
        &quot;vendor-dir&quot;: &quot;libraries&quot;
    },


    &quot;repositories&quot;: {
        &quot;UnionOfRAD&quot;: {
            &quot;package&quot;: {
                &quot;name&quot;: &quot;lithium&quot;,
                &quot;version&quot;: &quot;master&quot;,
                &quot;source&quot;: {
                    &quot;url&quot;: &quot;git://github.com/UnionOfRAD/lithium.git&quot;,
                    &quot;type&quot;: &quot;git&quot;,
                    &quot;reference&quot;: &quot;master&quot;
                }
            }
        }
    },

    &quot;require&quot;: {
        &quot;lithium&quot;: &quot;master&quot;
    }
}
</code></pre>

<p>The <code>vendor-dir</code> setting changes the default <code>vendor</code> directory to <code>libraries</code>, which is recognized automatically by the Lithium class loader. If you don&rsquo;t like this approach, you could also change the <code>LITHIUM_LIBRARY_PATH</code> and point it to the <code>vendor</code> directory or create a symlink, but we stick with it for now. The <code>repositories</code> setting
adds the git repository of the lithium core (if Lithium would provide a package on Packagist, then you wouldn&rsquo;t have to do this). The <code>require</code> setting is where all your application dependencies go into. The key <code>lithium</code> here refers to the package name in the <code>repositories</code> setting above.</p>

<p>Let&rsquo;s install the dependencies:</p>

<pre><code>$ php path/to/composer.phar install
Installing dependencies
Writing lock file
Generating autoload files
</code></pre>

<p>If you look into the <code>/composer-test/libraries</code> directory, you can see that the <code>lithium</code> directory has been added successfully.</p>

<p>If we now want to install <a href="http://twig.sensiolabs.org/">twig</a>, we can modify our <code>composer.json</code> file accordingly:</p>

<pre><code>&quot;require&quot;: {
    &quot;lithium&quot;: &quot;master&quot;,
    &quot;twig/extensions&quot;: &quot;master-dev&quot;
}
</code></pre>

<p>Not that the twig library is already available on Packagist, so we don&rsquo;t have to tell Composer where to find it. We can now run <code>composer.phar update</code> to update our dependencies (and the <code>composer.lock</code> file):</p>

<pre><code>$ php ../composer.phar update
Updating dependencies
- Package twig/twig (1.6.0-dev)
    Downloading
    Unpacking archive
    Cleaning up

- Package twig/extensions (master-dev)
    Downloading
    Unpacking archive
    Cleaning up

Writing lock file
Generating autoload files
</code></pre>

<p>As you can see, Composer has automatically downloaded all dependencies needed by <code>twig/extensions</code> too!</p>

<p>You can now start managing your dependencies through composer, regardless if they actually provide composer packages or not. There is an <a href="https://github.com/UnionOfRAD/lithium/issues/285">ongoing discussion</a> on how Lithium will handle dependency management in the future, so stay tuned.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">20 Jan 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Session-Encryption-with-Lithium/" class="post-title">Session Encryption with Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="the-basics">The Basics</h2>

<p>If you check out the <code>master</code> branch, you can use the new <code>Encrypt</code> strategy to encrypt your session data automatically. This means that you can read and write session data in cleartext and they will be encrypted on the fly before getting stored (in a cookie, for example). You can read my post about &ldquo;baking cookies like a chef&rdquo; for  PHPAdvent 2011 <a href="http://phpadvent.org/2011/bake-cookies-like-a-chef-by-michael-nitschinger">here</a>. The article covers both HMAC signatures and encryption, and is a good place to start. This post will go a little bit deeper in how to use and configure the <code>Encrypt</code> strategy in Lithium. Note that you need to have the <a href="http://php.net/manual/en/book.mcrypt.php">mcrypt</a> extension installed and enabled for this to work.</p>

<p>Here&rsquo;s the simplest configuration you can start with:</p>

<pre><code>Session::config(array('default' =&gt; array(
    'adapter' =&gt; 'Cookie',
    'strategies' =&gt; array('Encrypt' =&gt; array('secret' =&gt; 'f00bar$l1thium'))
)));
</code></pre>

<p>This will store all your session data in a cookie. If you don&rsquo;t change anything else, your data will be encrypted with <a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a> in  <a href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation#Cipher-block_chaining_.28CBC.29">CBC</a> mode with a block size of 256 bits (32 byte). This is a secure and sensible default, so if you don&rsquo;t need anything special just stick with the defaults.</p>

<p>You can now read and write cleartext data and it will be encrypted on the fly for you. For example:</p>

<pre><code>Session::write('key', 'my secret value');
</code></pre>

<p>The result will look like this on the client side:</p>

<pre><code>appcookie[__encrypted]=c3Rqv%2FFYnuwAevxeseII7lOvyoOTi2foMfB%2FCoO4l4FcutRvBn7qq%2BZrPVWC%2FzEYEiSSFMWv7EhEx4ew99%2FmPQ%3D%3D
</code></pre>

<p>You can then read the value again with <code>Session::read('key');</code> or delete it with <code>Session::delete('key');</code>.</p>

<p>That&rsquo;s it. If you don&rsquo;t want to dig into the internals, you can safely stop reading now and implement it in your own application.</p>

<h2 id="further-discussion">Further Discussion</h2>

<p>Still here? Awesome!</p>

<p>While the <code>mcrypt</code> extension does the heavy lifting for us, the <code>Encrypt</code> strategy abstracts necessary cruft like vector generation, key strengthening and resource management. While this is okay for most parts of the framework, in my opinion, when it comes to security, you should have a good understanding what is going on under the hood. Code ist not perfect, and it may contain semantical or design flaws that put your whole application (and customers) to risk. Also, security standards shift over time and what is now secure may not be in a few months.</p>

<p>If you don&rsquo;t override the default settings, Lithium encrypts your data with the <code>MCRYPT_RIJNDAEL_128</code> cipher in <code>MCRYPT_MODE_CBC</code> mode. What
most developers get wrong is the fact that the <code>128</code> doesn&rsquo;t represent the strength of the key size, but the block size that is used. Strictly
speaking, <code>MCRYPT_RIJNDAEL_256</code> is not part of the AES standard (because AES has a fixed block size of 128 bits and a key size of 128, 192 or 256 bits). The key size is determined by the length of the key that you pass to the <code>mcrypt</code> extension.</p>

<p>So to make sure we use the longest key possible, we hash the given secret with <code>sha256</code> and then substring the length we need. As <code>mcrypt</code> tells us which key lengths are supported for which cipher (through <a href="http://php.net/manual/en/function.mcrypt-enc-get-key-size.php">mcrypt_enc_get_key_size</a>), it is possible to determine the strongest key length. Note that this doesn&rsquo;t mean that you should use weak keys in the first place just because they get hashed anyway. In practice, you will only create them once so make sure they contain enough entropy.</p>

<p>As always, the Lithium core provides sensible defaults but also lets you outgrow the framework if you need to. You can specify your own cipher or mode like this:</p>

<pre><code>Session::config(array('default' =&gt; array(
    'adapter' =&gt; 'Cookie',
    'strategies' =&gt; array('Encrypt' =&gt; array(
        'cipher' =&gt; MCRYPT_RIJNDAEL_256,
        'mode'   =&gt; MCRYPT_MODE_ECB, // Don't use ECB when you don't have to!
        'secret'     =&gt; 'f00bar$l1thium'
    ))
)));
</code></pre>

<p>Here&rsquo;s a list of <a href="http://www.php.net/manual/en/mcrypt.ciphers.php">ciphers</a> and <a href="http://www.php.net/manual/en/mcrypt.constants.php">modes</a> you can use. Of course you need to make sure that your custom cipher/mode combination is supported.</p>

<p>If you don&rsquo;t like how Lithium hashes your key or if you want to has it on your own, there&rsquo;s also a way to do this. If the length of your key is equal or longer than the longest key size supported by the algorithm, it gets passed through unchanged. Here&rsquo;s how it works:</p>

<pre><code>protected function _hashSecret($key) {
    $size = mcrypt_enc_get_key_size(static::$_resource);

    if (strlen($key) &gt;= $size) {
        return $key;
    }

    return substr(hash('sha256', $key, true), 0, $size);
}
</code></pre>

<p>In my opinion, you should always encrypt your data if it gets stored on the client side. Lithium provides a convenient and transparent way to do it, so go ahead and use it in your own applications to make them more secure.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">16 Sep 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Quick-Tip-Lithium-Redirect/" class="post-title">Quick Tip: Lithium Redirect</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>While migrating <a href="https://github.com/UnionOfRAD/lithium_bin">lithium_bin</a> as part of research over to MongoDB (from CouchDB), I found the following snippet in the <code>routes.php</code> file:</p>

<pre><code>Router::connect('/', array(), function($request) {
    $location = array('controller' =&gt; 'pastes', 'action' =&gt; 'add');
    return new Response(compact('location'));
});
</code></pre>

<p>This means that when the user enters the application via the root url (<code>/</code>), he instantly gets redirected to <code>/pastes/add</code> (or a different URL if you have custom routes configured).</p>

<p>This may seem ok at first, but there&rsquo;s a problem. It doesn&rsquo;t take URLs into account that don&rsquo;t live directly under the document root. So if your application lives under <code>http://localhost/pastium/</code>, it will redirect you to <code>http://localhost/pastes/add/</code> which is not really what you want. Instead, do it like this:</p>

<pre><code>Router::connect('/', array(), function($request) {
    $location = Router::match('Pastes::add', $request);
    return new Response(compact('location'));
});
</code></pre>

<p>In this snippet, the <code>Router</code> takes the current <code>Request</code> into account and returns the correct location (based on the reverse routing information). Now it should redirect you correctly to <code>http://localhost/pastium/pastes/add/</code>.</p>

<p>By the way, this is extracted from the <code>Controller::redirect</code> method, which is implemented in a similar way:</p>

<pre><code>public function redirect($url, array $options = array()) {
    //...
    $this-&gt;_filter(__METHOD__, $params, function($self, $params) use ($router) {
        $options = $params['options'];
        $location = $options['location'] ?: $router::match($params['url'], $self-&gt;request);
        $self-&gt;render(compact('location') + $options);
    });
    //...
}
</code></pre>

<p>If you have any ideas on how to improve this further, feel free to comment below!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">05 Sep 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Letters-from-Lithium-2/" class="post-title">Letters from Lithium #2</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="about">About</h2>

<p>Letters from Lithium keeps you up to date about what happens in the Lithium core and community. If you have interesting news to share, comment below or ping me on <a href="http://twitter.com/daschl">twitter</a>.</p>

<h2 id="core-news">Core News</h2>

<p>Routing got a bit more awesome with <a href="https://github.com/UnionOfRAD/lithium/commit/792b916249052b87c368e2e25798a93dceaa0154#L3R636">route continuations</a>. They allow you match more routes in one request, which is very useful in many cases. Take a look at this test case:</p>

<pre><code>/**
* Tests that continuation routes properly fall through and aggregate multiple route parameters.
*/
public function testRouteContinuations() {
    Router::connect('/{:locale:en|de|it|jp}/{:args}', array(), array('continue' =&gt; true));
    Router::connect('/{:controller}/{:action}/{:id:[0-9]+}');

    $request = new Request(array('url' =&gt; '/en/posts/view/1138'));
    $result = Router::process($request)-&gt;params;
    $expected = array (
        'controller' =&gt; 'posts', 'action' =&gt; 'view', 'id' =&gt; '1138', 'locale' =&gt; 'en'
    );
    $this-&gt;assertEqual($expected, $result);
}
</code></pre>

<p>The data branch has been <a href="https://github.com/UnionOfRAD/lithium/commit/107f596b3224b47cfe91a820bae5867a5e0aee6c">merged</a> recently, which should improve the overall stability of the model layer and add a few smaller features. Thanks to <a href="https://github.com/vesln">Veselin Todorov</a>, you <a href="https://github.com/UnionOfRAD/lithium/commit/0c35bef1a36f3ffd6baee3586bf8c3380dfabb81">can now use</a> the &ldquo;last&rdquo; option in validations. This lets you better control the validation stack.</p>

<p><a href="https://github.com/mackstar">Richard McIntyre</a> added <a href="https://github.com/UnionOfRAD/lithium/commit/427ee643e0725cceb42d6f1ee66cf5668d18effa">console environment detection</a> and Nate Abele improved the application detection process.</p>

<p>Of course, various other bugs have been fixed (including the <a href="https://github.com/UnionOfRAD/lithium/commit/cbd0c4d2c07837e2e5ea4f9e8ff8c6a0d1fa1c61">HMAC bug</a>) and small enhancements like <a href="https://github.com/UnionOfRAD/lithium/commit/74514b870c13aac98236111c524ab5c1bc04656f">collection sorting</a> and <a href="https://github.com/UnionOfRAD/lithium/commit/c0d4ff82b1b3bb662ed0e78ed9599437306ca068">Form::error() filtering</a> found their way into the core.</p>

<h2 id="plugins">Plugins</h2>

<p><a href="https://github.com/eLod">eLod</a> (also known as &ldquo;smoking_kiddo&rdquo; on IRC) created a plugin called <a href="https://github.com/eLod/li3_console">li3_console</a> which provides a fully functional PHP <a href="http://en.wikipedia.org/wiki/Read-eval-print_loop">REPL</a> and also lets you interact with your Lithium environment (like models) from the command line.</p>

<p>If you need to deploy your Lithium application to remote servers and are used to <a href="https://github.com/capistrano/capistrano">Capistrano</a>, you should take a look at <a href="https://github.com/mehlah/capium">capium</a>. It is a ruby gem that provides deploy recipes and rake tasks for Lithium.</p>

<h2 id="blogs-and-media">Blogs and Media</h2>

<p>For those new to Lithium, <a href="http://www.davidgolding.net/">David Golding</a> recently published a very informative introduction <a href="http://www.scribd.com/doc/62146078/New-to-Lithium-Part-1">here</a>. It gets you up and running quickly and walks you through the creation of models, controllers and views.</p>

<p>Also, <a href="http://www.jblotus.com/">James Fuller</a> released a few blog posts in the last weeks, covering various topics around Lithium. Head over to his blog and read about <a href="http://www.jblotus.com/2011/08/17/adding-a-session-flash-message-to-your-site-in-lithium-php/">Flash Messages</a>, the <a href="http://www.jblotus.com/2011/08/19/how-to-add-a-html-button-element-using-lithium-phps-formhelper/">FormHelper</a>, <a href="http://www.jblotus.com/2011/08/20/super-simple-lithium-php-json-web-service-calls/">Web Service Calls</a>, <a href="http://www.jblotus.com/2011/08/27/understanding-filters-in-lithium-php/">Filters</a> and <a href="http://www.jblotus.com/2011/08/31/using-an-appcontroller-in-lithium-php-to-pass-data-to-the-layout/">AppControllers</a>.</p>

<h2 id="universe">Universe</h2>

<p>Recently, <a href="http://www.engineyard.com/">Engine Yard</a> (mostly known for their knowledge and cloud platforms in the Ruby on Rails world) acquired <a href="http://orchestra.io">Orchestra</a> to extend their language support. Orchestra is a great platform to deploy your PHP and Lithium applications on to, so give it a try (they also provide free accounts) if you haven&rsquo;t already. The <a href="http://lithify.me/docs/manual/cloud/readme.wiki">manual</a> also provides a short guide if you need help.</p>

<p><a href="https://github.com/Ciaro">Ciaro Vermeire</a> started a (unofficial) community forum for Lithium, which you can find <a href="http://lithium-framework.com/">here</a>. If you like this type of communication, feel free to register, ask for help and - most importantly - share what you know.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">02 Aug 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Letters-from-Lithium-1/" class="post-title">Letters from Lithium #1</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="about">About</h2>

<p>&ldquo;Letters from Lithium&rdquo; will be published on a regular basis to give you an update on what happens in the Lithium community. If you have interesting topics/plugins/stuff you want to read about, feel free to contact me through twitter or email.</p>

<h2 id="core-news">Core News</h2>

<p>The <a href="https://github.com/UnionOfRAD/lithium/wiki/Roadmap">Roadmap</a> to 1.0 is going pretty well so far, and relationship support for relational databases has been already merged into master. For the impatient, there is also some documentation for it underway which can be found <a href="https://github.com/UnionOfRAD/manual/blob/master/en/working-with-data/relationships.wiki">here</a>. As the docs are not finished yet, you&rsquo;ll have to clone the repository locally to view them in their full glory (don&rsquo;t forget to clone <code>li3_docs</code> too). The core team is also working on relationship support for MongoDB, which will also ship before 1.0. For those who come from CakePHP: there won&rsquo;t be a <code>hasAndBelongsToMany</code> relationship, because we&rsquo;ll add support for nested relationships which can be used to achieve the same result in a better and cleaner way.</p>

<p>We&rsquo;re very excited to see more and more people contributing code to the core. <a href="https://github.com/doobry">Chris Beswick</a> did an awesome job recently and refactored a significant part of the routing system (<a href="https://github.com/UnionOfRAD/lithium/commits/master?author=doobry">commits</a>) which makes compiling routes significantly faster. Also there&rsquo;s a huge <a href="https://github.com/UnionOfRAD/lithium/pull/45">pull request</a> open that brings <a href="http://www.postgresql.org/">PostgreSQL</a> integration to the Lithium core.</p>

<p>Lithium wants to be a first-class citizen on Windows, so there&rsquo;s a <a href="https://github.com/UnionOfRAD/lithium/tree/windows">branch</a> open that tries to track, find and fix all bugs and test-cases on Windows. If you&rsquo;re developing on Windows and have some spare time, contact one of the core members on IRC and we&rsquo;ll get you started. We aim to make all test cases run on Windows before the 1.0 release.</p>

<h2 id="plugins">Plugins</h2>

<p>I&rsquo;ve recently <a href="http://nitschinger.at/Lithium-plugin-roundup">compiled a list of plugins</a> and readers also posted their additions in the comments below. There are plans to bring the <a href="http://lab.lithify.me">Lithium Lab</a> up to date and integrate it even better with the Lithium framework so in the future you should be able to install and share plugins right from there. I&rsquo;ll cover this in greater detail in one of the next letters.</p>

<p><a href="https://github.com/alkemann">Alexander Morland</a> is developing a <a href="https://github.com/alkemann/li3_zmq">plugin</a> for <a href="http://www.zeromq.org/">ZeroMQ</a> and is always searching for feedback and contributions. If you need message passing in your application (like queues or pub/sub), then you should definitely check it out.</p>

<p>If you don&rsquo;t know which plugins are available, try <a href="https://github.com/search?langOverride=&amp;language=PHP&amp;q=li3_&amp;repo=&amp;start_value=1&amp;type=Repositories&amp;x=32&amp;y=21">this</a> search on Github!</p>

<h2 id="blogs-media">Blogs &amp; Media</h2>

<p>For those who don&rsquo;t know yet, <a href="http://raymondjulin.com/">Raymond Julin</a> did compile a list of useful resources back in January which can be found <a href="http://blog.raymondjulin.com/2011/01/06/list-of-useful-lithium-li3-resources/">here</a>. In addition to that, <a href="http://www.shift8creative.com/about">Tom Maiaroto</a> wrote a <a href="http://www.shift8creative.com/blog/getting-started-with-minerva">blog post</a> that helps you to get up and running with <a href="https://github.com/tmaiaroto/minerva">Minerva</a>, his CMS based on Lithium.</p>

<p>Lithium now has <a href="http://vimeo.com/channels/li3">Vimeo Channel</a> which also contains the <a href="http://vimeo.com/26183322">Introducing Lithium</a> talk by Nate. You should definitely check that out if you&rsquo;re new to Lithium and need a one-hour introduction.</p>

<h2 id="universe">Universe</h2>

<p>As a side note, the <a href="http://www.union-of-rad.com/">UnionOfRAD</a> is looking for client work (preferrably in the NY area), so if you need talented developers that know Lithium and its surroundings from the inside out please contact <a href="http://www.nateabele.com">Nate Abele</a> on <a href="http://www.twitter.com/nateabele">twitter</a> or IRC.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">19 Jul 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Using-Environments-in-Lithium/" class="post-title">Using Environments in Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="introduction">Introduction</h2>

<p>Environments help you to manage multiple configurations for your application. Maybe you have a different database for testing than for production or you use file caching in development but <a href="http://www.php.net/manual/en/intro.apc.php">APC</a> in production. If your framework does not support this (or a similar) concept, it can be a pain to code this overhead for yourself. Therefore, Lithium frees you from this by providing a <code>Environment</code> class (in the <code>\lithium\core</code> namespace) which handles everything for you automatically. Other concepts like <code>adapters</code> integrate with your environments and give you a high flexibility while maintaining a set of sensible defaults.</p>

<p>The next chapter is a whirlwind tour on how to use environments in many places in the framework. Once you know how to work with them, we&rsquo;ll see how you can change the behavior and adapt it further to the needs of your application.</p>

<h2 id="using-environments">Using environments</h2>

<p>Let&rsquo;s start with the most common use case of environments: define a separate database connection for <code>development</code>, <code>test</code> and <code>production</code>:</p>

<pre><code>Connections::add('default', array(
    'development' =&gt; array(
        'type' =&gt; 'MongoDb',
        'host' =&gt; 'localhost',
        'database' =&gt; 'blog_dev'
    ), 
    'test' =&gt; array(
        'type' =&gt; 'MongoDb',
        'host' =&gt; 'localhost',
        'database' =&gt; 'blog_test'
    ),
    'production' =&gt; array(
        'type' =&gt; 'MongoDb',
        'host' =&gt; 'localhost',
        'database' =&gt; 'blog_prod'
    )
));
</code></pre>

<p>As you can see, we don&rsquo;t work with the <code>Environment</code> class here directly. Instead, the <code>Adaptable</code> class (from which the <code>Connections</code> class derives) takes care for us. To understand what&rsquo;s going on, investigate <code>_config()</code> method inside the <code>Adaptable</code> class.</p>

<pre><code>/**
 * Gets an array of settings for the given named configuration in the current
 * environment.
 *
 * The default types of settings for all adapters will contain keys for:
 * `adapter` - The class name of the adapter
 * `filters` - An array of filters to be applied to the adapter methods
 *
 * @see lithium\core\Environment
 * @param string $name Named configuration.
 * @return array Settings for the named configuration.
 */
protected static function _config($name) {
    //...
    $env = Environment::get();
    $config = isset($settings[$env]) ? $settings[$env] : $settings;
    //...
}
</code></pre>

<p>The important part is done in the middle of the method. The <code>Environment::get()</code> method is called and based on the result it either uses the appropriate environment configuration or uses the whole array. This means that you are free to use environments or not.</p>

<p>You can use the <code>Environment::get()</code> method for yourself to check out the current environment.</p>

<pre><code>use lithium\core\Environment;
echo Environment::get();
</code></pre>

<p>For most of you, this will return <code>development</code> (if not, the next chapter will show you why). In addition to the <code>get()</code> method, there is also the <code>is()</code> method. This method takes a string as the param and returns either true or false if the environment matches your string. There are a lot of use cases for this, one can be found in your <code>routes.php</code> file:</p>

<pre><code>/**
* Test routes.
*/
if (!Environment::is('production')) {
    Router::connect('/test/{:args}', array('controller' =&gt; 'lithium\test\Controller'));
    Router::connect('/test', array('controller' =&gt; 'lithium\test\Controller'));
}
</code></pre>

<p>This code snippet only includes the <code>test</code> routes if you&rsquo;re not running a production setup. Here&rsquo;s another one:</p>

<pre><code>if(Environment::is('development')) {
    Libraries::add('li3_docs');
}
</code></pre>

<p>This only includes the <code>li3_docs</code> library during development, because you generally won&rsquo;t need it in production or testing. And the last one:</p>

<pre><code>$default = array('adapter' =&gt; 'File', 'strategies' =&gt; array('Serializer'));

if ($apcEnabled &amp;&amp; Environment::is('production')) {
    $default = array('adapter' =&gt; 'Apc');
}
Cache::config(compact('default'));
</code></pre>

<p>This snippet tells Lithium to use file caching in development and APC for production (this is a modified version of the code you can find by default in <code>app/config/cache.php</code>). I won&rsquo;t give another example here, I think you get the point.</p>

<h2 id="advanced-usage">Advanced usage</h2>

<p>Now that we know how to use environments, let&rsquo;s see how we can tailor them to our needs. Most of the time you have either different environments or the default detection mechanism doesn&rsquo;t work as expected.</p>

<p>Before we start to modify the environment detection mechanism, we should look at how it is implemented by default:</p>

<pre><code>protected static function _detector() {
    return static::$_detector ?: function($request) {
        switch (true) {
            case (in_array($request-&gt;env('SERVER_ADDR'), array('::1', '127.0.0.1'))):
                return 'development';
            case (preg_match('/^test/', $request-&gt;env('HTTP_HOST'))):
                return 'test';
            default:
                return 'production';
        }
    };
}
</code></pre>

<p>You can see that if the server address is &ldquo;127.0.0.1&rdquo; (which basically means you&rsquo;re running on localhost) then the environment defaults to &ldquo;devlopment&rdquo;. If this isn&rsquo;t the case, it tries to find <code>test</code> in the <code>HTTP_HOST</code> settings. This is also used by the testing framework so you may want to keep this as it is. If none of these checks match, you&rsquo;re running in production mode.</p>

<p>Let&rsquo;s say we want to add a <code>staging</code> environment which is identified by its ip address <code>192.168.100.22</code>:</p>

<pre><code>use lithium\core\Environment;
Environment::is(function($request) {
    switch (true) {
        case (in_array($request-&gt;env('SERVER_ADDR'), array('::1', '127.0.0.1'))):
            return 'development';
        case ($request-&gt;env('SERVER_ADDR') == '192.168.100.22'):
            return 'staging';
        case (preg_match('/^test/', $request-&gt;env('HTTP_HOST'))):
            return 'test';
        default:
            return 'production';
    }
});
</code></pre>

<p>Easy enough, so here&rsquo;s a final example: assume we don&rsquo;t want to rely on this detection mechanisms. Instead, we set the <code>LITHIUM_ENVIRONMENT</code> variable in our apache config (maybe through <code>SetEnv LITHIUM_ENVIRONMENT &quot;development&quot;</code>) and use it in our application. If no config variable is set, let&rsquo;s default to <code>development</code>:</p>

<pre><code>use lithium\core\Environment;
Environment::is(function($request) {
    return $request-&gt;env('lithium_environment') ?: 'development';
});
</code></pre>

<p>Of course, you have to make sure that your custom environment routines get executed before the dependent parts get bootstrapped. You can either put it at the bottom of <code>app/config/boostrap/libraries.php</code> or add a new config file that gets loaded afterwards.</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>After reading this post you should have a basic idea on how environments work in Lithium, how to use them and also how to tailor them to your needs. Keep in mind that they are also reused in other classes and patterns like <code>Adaptable</code>.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">09 Jul 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Testing-the-Lithium-core-for-fun-and-profit/" class="post-title">Testing the Lithium core for fun and profit</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>In modern web frameworks, testing is one of the most important pillars that ensure a clean, stable and extendable codebase. Testing support in Lithium was built in from the beginning and therefore it already features a great code coverage. The Lithium project aims to work out of the box on many platforms, including Microsoft Windows and its IIS, which was often neglected in the past.</p>

<p>The main purpose of this post is to show you how core tests work and were the core team needs help to improve things further. At the end of this post you should be able to write new and extend existing test cases. A side effect of this is that you&rsquo;ll learn parts of the core from the inside out while you&rsquo;re testing them.</p>

<h2 id="introducing-core-tests">Introducing core tests</h2>

<p>Before you start writing your own tests, make sure the existing cases work as expected (without any <code>Exceptions</code> or <code>Errors</code>). For developing directly in the core, I&rsquo;d recommend you a slightly different setup than the default one. You should clone the <code>framework</code> and the <code>lithium</code> repository in different directories so you can quickly exchange functionality and symlink stuff if you have to. My setup looks similar to this:</p>

<pre><code>- web
    - framework
    - libraries
        - lithium
        - li3_docs
        - manual
        - lithium_qa
</code></pre>

<p>Now tell your <code>framework</code> to look at the right path, hop into <code>app/config/bootstrap/libraries.php</code> and modify the <code>LITHIUM_LIBRARY_PATH</code>.</p>

<pre><code>define('LITHIUM_LIBRARY_PATH', dirname(dirname(LITHIUM_APP_PATH)) . '/libraries');
</code></pre>

<p>If you haven&rsquo;t already, make sure that the <code>app/resources</code> folder is writable.</p>

<p>Assuming you have your <code>DOCROOT</code> pointing to <code>web</code>, try to run the tests from the test dashboard located at <code>http://localhost/framework/test</code>. Ideally, your test output should look something like this:</p>

<p><img src="http://nitschinger.at/img/core_testing_overview.png" title="Test Dashboard" /></p>

<p>If you have any failing tests, try to track down if it is your setup or some test cases are not working correctly. If you&rsquo;re unsure, you can always get feedback on #li3 at freenode.</p>

<h2 id="understanding-test-filters">Understanding test filters</h2>

<p>Now that existing tests are running as expected, take a look at the buttons on the top. The <code>Affected</code>, <code>Complexity</code>, <code>Coverage</code> and <code>Profiler</code> labeled buttons are called &ldquo;test filters&rdquo; and perform specific tasks on the selected group of test cases.</p>

<p><img src="http://nitschinger.at/img/core_testing_filters.png" title="Test Filters" /></p>

<p>As they are very important, let&rsquo;s go through them in more detail. Note that you need to turn on <a href="http://xdebug.org/">Xdebug</a> to use them, but you should install this extension anyway in your development environment.</p>

<ul>
<li><strong>Affected:</strong> The <code>affected</code> filter shows you what other tests depend on the currently tested class. This helps you to understand what impact a change to the current code would have and where to look out for possible errors.</li>
<li><strong>Complexity:</strong> The <code>complexity</code> filter calculates the <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity">Cyclomatic Complexity</a> for each executed method and shows you the worst offenders. According to best practices, a cyclomatic complexity greater than 10 is &ldquo;very complex&rdquo; and should be refactored if possible. This of course depends heavily on the type of code but it provides a good overview on how complex the class is in general and where to look first to decrease complexity.</li>
<li><strong>Coverage:</strong> The <code>coverage</code> filters tries to find out which lines of the tested code got executed in your test. Lithium has the baseline of 85% test coverage for core classes which should ensure that most of the code is at least once tested somewhere. The current implementation of the coverage filter also shows some false-negatives so make sure to take the result with a grain of salt.</li>
<li><strong>Profiler:</strong> The <code>profiler</code> filter tells you how long it took to execute the tests and how much memory was used. You can use this to measure the performance of the code and check the impact of code modifications.</li>
</ul>

<p>Make sure to get familiar with these filters as they are crucial in verifying and investigating your written tests.</p>

<h2 id="investigating-core-tests">Investigating core tests</h2>

<p>The best way to get familiar with core tests is to look at existing ones. Let&rsquo;s investigate one test case of the <code>ValidatorTest</code> class.</p>

<pre><code>/**
 * Tests that new methods can be called on Validator by adding rules using Validator::add().
 *
 * @return void
 */
public function testAddCustomRegexMethods() {
    $this-&gt;assertNull(Validator::rules('foo'));

    Validator::add('foo', '/^foo$/');
    $this-&gt;assertTrue(Validator::isFoo('foo'));
    $this-&gt;assertFalse(Validator::isFoo('bar'));
    $this-&gt;assertTrue(in_array('foo', Validator::rules()));
    $this-&gt;assertEqual('/^foo$/', Validator::rules('foo'));

    $this-&gt;expectException(&quot;Rule `bar` is not a validation rule.&quot;);
    $this-&gt;assertNull(Validator::isBar('foo'));
}
</code></pre>

<p>If you look closely, you can identify a pattern here that will come frequently. Before you test a specific functionality/value, make sure it isn&rsquo;t already set. You can do this with <code>assertFalse</code>, <code>assertNull</code> or maybe <code>assertTrue(empty(..))</code>. Next, perform the piece of code you want to test (like adding a custom regex rule here) and then perform checks on the entity again. A good rule of thumb is to test normal cases first and then exceptional cases (which often raise <code>Exceptions</code>). You can also break down complicated tests in smaller ones and add helper methods that get called from the main test case.</p>

<p>If your tests contain dependencies, make sure to initialize them in <code>setUp()</code> and remove/reset them in <code>tearDown()</code>. These methods get called before/after all tests in the test class and should leave the environment in a clean state. This prevents unexpected failures in later tests and also keeps the memory usage on a normal level. Here&rsquo;s an example of the <code>MongoDb</code> test class:</p>

<pre><code>public function setUp() {
    Connections::config(array('lithium_mongo_test' =&gt; $this-&gt;_testConfig));
    $this-&gt;db = Connections::get('lithium_mongo_test');
    $model = $this-&gt;_model;
    $model::config(array('key' =&gt; '_id'));
    $model::resetConnection(false);

    $this-&gt;query = new Query(compact('model') + array(
        'entity' =&gt; new Document(compact('model'))
    ));
}

public function tearDown() {
    try {
        $this-&gt;db-&gt;delete($this-&gt;query);
    } catch (Exception $e) {}
    unset($this-&gt;query);
}
</code></pre>

<p>The <code>setUp()</code> method initializes a test connection to the database and <code>tearDown()</code> makes sure that the test database gets deleted and the <code>$this-&gt;query</code> object is freed.</p>

<p>There are a lot more patterns that you&rsquo;ll learn while writing core tests, but this should give you a start.</p>

<h2 id="qa-your-code">QA your code</h2>

<p>To ensure a high-quality codebase, Lithium enforces a set of coding standards which can be found <a href="https://github.com/UnionOfRAD/lithium/wiki/Coding-Standards">here</a>. You don&rsquo;t have to know every part of the standard by heart, because Lithium provides a plugin called <a href="https://github.com/UnionOfRAD/lithium_qa">lithium_qa</a>. This plugin checks your code if it complies to the standards and shows you what parts of it are wrong. I recommend you to clone it into the <code>libraries</code> directory shown above. It is also a good idea to add the <code>li3</code> command to your <code>PATH</code> so your calls don&rsquo;t get too verbose.</p>

<pre><code>$ cd /usr/local/bin
$ sudo ln -s /path/to/lithium/console/li3 li3
</code></pre>

<p>Let&rsquo;s assume we want to check classes in the <code>lithium\core</code> namespace:</p>

<pre><code>$ cd lithium_qa
$ li3 syntax ../lithium/core
[Passed ] syntax check of `core/Object.php`
[Passed ] syntax check of `core/Adaptable.php`
[Failed ] syntax check of `core/StaticObject.php`
59| 101| Maximum line length exceeded
[Passed ] syntax check of `core/Environment.php`
[Passed ] syntax check of `core/ConfigException.php`
[Passed ] syntax check of `core/ClassNotFoundException.php`
[Passed ] syntax check of `core/NetworkException.php`
[Passed ] syntax check of `core/ErrorHandler.php`
[Passed ] syntax check of `core/Libraries.php`
</code></pre>

<p>There you can see that each core class passed the test except the <code>StaticObject</code> class which has one line (59) that is too long. Now you can edit that file and modify it accordingly. If you&rsquo;re not sure what the output means, head back to the <a href="https://github.com/UnionOfRAD/lithium/wiki/Coding-Standards">official standard</a> and look for the corresponding entry.</p>

<p>Please make sure that all code you want to see in the core respects these standards. You can also use it to test your own code as well!</p>

<h2 id="getting-help">Getting help</h2>

<p>If you&rsquo;re new to code testing in Lithium, make sure to read the official guide in the <a href="http://lithify.me/docs/manual/10_testing/readme.wiki">manual</a> first. Next, check out the main <a href="https://github.com/UnionOfRAD/lithium/issues/17">testing ticket on GitHub</a> which is constantly updated and shows what classes need testing. If you need help on testing the core, make sure to join #li3-core on freenode and ping one of the core developers. You can also contact me directly and I&rsquo;ll make sure to help you out or point you in the right direction.</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>You should now be able to run the core tests, extend and write your own and also pass your code through the official code quality assurance tool. Please help out and fork the core, run it on your machine, check for errors, extend current tests, write new ones and correct QA issues. If we all work together, I&rsquo;m sure we can make Lithium the best tested web framework out there. If you want to see more information regarding this topic on my blog, comment down below and I&rsquo;ll see what I can provide.</p>

<p>Keep on coding!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">22 Jun 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Lithium-plugin-roundup/" class="post-title">Lithium plugin roundup</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Note that this list is by no means complete. If you don&rsquo;t find your own mentioned here, feel free to comment below. I&rsquo;ve also tried to roughly group them so you can find them later more easily.</p>

<h2 id="authentication-security">Authentication &amp; Security</h2>

<p><a href="https://github.com/tmaiaroto/li3_access">li3_access</a>: Access control library by <em>tmaiaroto</em>.</p>

<p><a href="https://github.com/weluse/li3_ids">li3_ids</a>: Intrusion detection integration (phpids) by <em>weluse</em>.</p>

<p><a href="https://github.com/gwoo/li3_oauth">li3_oauth</a>: OAuth library by <em>gwoo</em>.</p>

<h2 id="apis-and-externals">APIs and Externals</h2>

<p><a href="https://github.com/cgarvis/li3_delayed_job">li3_delayed_job</a>: Ruby&rsquo;s Delayed::Job port to Lithium by <em>cgarvis</em>.</p>

<p><a href="https://github.com/tmaiaroto/li3_facebook">li3_facebook</a>: Facebook API wrapper by <em>tmaiaroto</em>.</p>

<p><a href="https://github.com/JacopKane/li3_flickr">li3_flickr</a>: Flickr API wrapper by <em>jacopKane</em>.</p>

<p><a href="https://github.com/greut/li3_swiftmailer">li3_swiftmailer</a>: Interface to the Swiftmailer library by <em>greut</em>.</p>

<h2 id="view-layer-helpers">View Layer &amp; Helpers</h2>

<p><a href="https://github.com/greut/li3_analytics">li3_analytics</a>: Integrate Google Analytics easily by <em>greut</em>.</p>

<p><a href="https://github.com/UnionOfRAD/li3_design">li3_design</a>: Useful things for designers like placeholder texts by <em>UnionOfRAD</em>.</p>

<p><a href="http://rad-dev.org/li3_flash_message">li3_flash_message</a>: Flash message generation by <em>michaelhue</em>.</p>

<p><a href="http://rad-dev.org/li3_gravatar">li3_gravatar</a>: Gravatar integration by <em>michaelhue</em>.</p>

<p><a href="https://github.com/harikt/li3_htmlpurifier">li3_htmlpurifier</a>: Wrapper around the HTML filtering library by <em>harikt</em>.</p>

<p><a href="https://github.com/indiefan/li3_injector">li3_injector</a>: DOM markup injection by <em>indiefan</em>.</p>

<p><a href="https://github.com/glaszig/li3_less">li3_less</a>: Support for LESS CSS by <em>glaszig</em>.</p>

<p><a href="https://github.com/sandelius/li3_markdown">li3_markdown</a>: Wrapper for PHP Markdown by <em>sandelius</em>.</p>

<p><a href="https://github.com/primetheus/li3_paginate">li3_paginate</a>: Pagination plugin by <em>primetheus</em>.</p>

<p><a href="https://github.com/greut/li3_pdf">li3_pdf</a>: PDF generation plugin by <em>greut</em>.</p>

<p><a href="https://github.com/masom/li3_sitemap">li3_sitemap</a>: Sitemap generator by <em>masom</em>.</p>

<p><a href="https://github.com/henrikbjorn/li3_twig">li3_twig</a>: Twig templating support by <em>henrikbjorn</em>.</p>

<h2 id="data-layer">Data Layer</h2>

<p><a href="https://github.com/greut/li3_activerecord">li3_activerecord</a>: PHP ActiveRecord wrapper by <em>greut</em>.</p>

<p><a href="http://rad-dev.org/li3_behaviors">li3_behaviors</a>: Model behavior support by <em>nateabele</em>.</p>

<p><a href="https://github.com/weluse/li3_dateable">li3_dateable</a>: Adds timestamp to records/documents by <em>weluse</em>.</p>

<p><a href="http://rad-dev.org/li3_doctrine">li3_doctrine</a>: Doctrine2 integration by <em>Richard McIntyre</em>.</p>

<p><a href="http://rad-dev.org/li3_geo">li3_geo</a>: Geospatial querying for multiple databases by <em>nateabele</em>.</p>

<p><a href="https://github.com/raisinbread/li3_simplesearch">li3_simplesearch</a>: SQLite3 based searching by <em>raisinbread</em>.</p>

<p><a href="https://github.com/jperras/li3_sqlsrv">li3_sqlsrv</a>: SQL Server datasource by <em>jperras</em>.</p>

<p><a href="https://github.com/vogan/li3_tree">li3_tree</a>: Tree model behavior by <em>vogan</em>.</p>

<h2 id="testing-documentation">Testing &amp; Documentation</h2>

<p><a href="https://github.com/UnionOfRAD/li3_docs">li3_docs</a>: Official documentation plugin by <em>UnionOfRAD</em>.</p>

<p><a href="https://github.com/daschl/li3_fixtures">li3_fixtures</a>: Add Fixtures to your tests by <em>daschl</em>.</p>

<p><a href="http://rad-dev.org/li3_junit">li3_junit</a>: JUnit integration by <em>Michael Harris</em>.</p>

<h2 id="misc">Misc</h2>

<p><a href="https://github.com/UnionOfRAD/li3_cldr">li3_cldr</a>: Query the Unicode CLDR by <em>UnionOfRAD</em>.</p>

<p><a href="https://github.com/Howard3/li3_config_loader">li3_config_loader</a>: Load configs on the fly during bootstrap by <em>Howard3</em>.</p>

<p><a href="https://github.com/Howard3/li3_debug">li3_debug</a>: Debugging Library by <em>Howard3</em>.</p>

<p><a href="https://github.com/daschl/li3_rest">li3_rest</a>: adds REST support to your application by <em>daschl</em>.</p>

<p>I have to say that I&rsquo;m very excited to see what the community is currently building and how Lithium as a whole evolves. Thanks to everyone who is participating and keep up the awesome work!</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 1 of 2</span>
    
      <a href="/tags/lithium/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
                <li>&copy; Michael Nitschinger 2010-2016</li>
        </ul>
    </div>
</div>
<script src="http://nitschinger.at//js/all.min.js"></script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19686689-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
        'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();

</script>

        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
