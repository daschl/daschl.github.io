<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Php &middot; daschl writes. sometimes.</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.15" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Php &middot; daschl writes. sometimes.">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Php &middot; daschl writes. sometimes.">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://nitschinger.at//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="daschl writes. sometimes." href="http://nitschinger.at//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://nitschinger.at/">daschl writes. sometimes.</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/daschl"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/daschl "><i class="fa fa-github-alt"></i> github</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="http://nitschinger.at//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">22 Jun 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Lithium-plugin-roundup/" class="post-title">Lithium plugin roundup</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Note that this list is by no means complete. If you don&rsquo;t find your own mentioned here, feel free to comment below. I&rsquo;ve also tried to roughly group them so you can find them later more easily.</p>

<h2 id="authentication-security:2d9d963d696621d0e0a880c999f831f8">Authentication &amp; Security</h2>

<p><a href="https://github.com/tmaiaroto/li3_access">li3_access</a>: Access control library by <em>tmaiaroto</em>.</p>

<p><a href="https://github.com/weluse/li3_ids">li3_ids</a>: Intrusion detection integration (phpids) by <em>weluse</em>.</p>

<p><a href="https://github.com/gwoo/li3_oauth">li3_oauth</a>: OAuth library by <em>gwoo</em>.</p>

<h2 id="apis-and-externals:2d9d963d696621d0e0a880c999f831f8">APIs and Externals</h2>

<p><a href="https://github.com/cgarvis/li3_delayed_job">li3_delayed_job</a>: Ruby&rsquo;s Delayed::Job port to Lithium by <em>cgarvis</em>.</p>

<p><a href="https://github.com/tmaiaroto/li3_facebook">li3_facebook</a>: Facebook API wrapper by <em>tmaiaroto</em>.</p>

<p><a href="https://github.com/JacopKane/li3_flickr">li3_flickr</a>: Flickr API wrapper by <em>jacopKane</em>.</p>

<p><a href="https://github.com/greut/li3_swiftmailer">li3_swiftmailer</a>: Interface to the Swiftmailer library by <em>greut</em>.</p>

<h2 id="view-layer-helpers:2d9d963d696621d0e0a880c999f831f8">View Layer &amp; Helpers</h2>

<p><a href="https://github.com/greut/li3_analytics">li3_analytics</a>: Integrate Google Analytics easily by <em>greut</em>.</p>

<p><a href="https://github.com/UnionOfRAD/li3_design">li3_design</a>: Useful things for designers like placeholder texts by <em>UnionOfRAD</em>.</p>

<p><a href="http://rad-dev.org/li3_flash_message">li3_flash_message</a>: Flash message generation by <em>michaelhue</em>.</p>

<p><a href="http://rad-dev.org/li3_gravatar">li3_gravatar</a>: Gravatar integration by <em>michaelhue</em>.</p>

<p><a href="https://github.com/harikt/li3_htmlpurifier">li3_htmlpurifier</a>: Wrapper around the HTML filtering library by <em>harikt</em>.</p>

<p><a href="https://github.com/indiefan/li3_injector">li3_injector</a>: DOM markup injection by <em>indiefan</em>.</p>

<p><a href="https://github.com/glaszig/li3_less">li3_less</a>: Support for LESS CSS by <em>glaszig</em>.</p>

<p><a href="https://github.com/sandelius/li3_markdown">li3_markdown</a>: Wrapper for PHP Markdown by <em>sandelius</em>.</p>

<p><a href="https://github.com/primetheus/li3_paginate">li3_paginate</a>: Pagination plugin by <em>primetheus</em>.</p>

<p><a href="https://github.com/greut/li3_pdf">li3_pdf</a>: PDF generation plugin by <em>greut</em>.</p>

<p><a href="https://github.com/masom/li3_sitemap">li3_sitemap</a>: Sitemap generator by <em>masom</em>.</p>

<p><a href="https://github.com/henrikbjorn/li3_twig">li3_twig</a>: Twig templating support by <em>henrikbjorn</em>.</p>

<h2 id="data-layer:2d9d963d696621d0e0a880c999f831f8">Data Layer</h2>

<p><a href="https://github.com/greut/li3_activerecord">li3_activerecord</a>: PHP ActiveRecord wrapper by <em>greut</em>.</p>

<p><a href="http://rad-dev.org/li3_behaviors">li3_behaviors</a>: Model behavior support by <em>nateabele</em>.</p>

<p><a href="https://github.com/weluse/li3_dateable">li3_dateable</a>: Adds timestamp to records/documents by <em>weluse</em>.</p>

<p><a href="http://rad-dev.org/li3_doctrine">li3_doctrine</a>: Doctrine2 integration by <em>Richard McIntyre</em>.</p>

<p><a href="http://rad-dev.org/li3_geo">li3_geo</a>: Geospatial querying for multiple databases by <em>nateabele</em>.</p>

<p><a href="https://github.com/raisinbread/li3_simplesearch">li3_simplesearch</a>: SQLite3 based searching by <em>raisinbread</em>.</p>

<p><a href="https://github.com/jperras/li3_sqlsrv">li3_sqlsrv</a>: SQL Server datasource by <em>jperras</em>.</p>

<p><a href="https://github.com/vogan/li3_tree">li3_tree</a>: Tree model behavior by <em>vogan</em>.</p>

<h2 id="testing-documentation:2d9d963d696621d0e0a880c999f831f8">Testing &amp; Documentation</h2>

<p><a href="https://github.com/UnionOfRAD/li3_docs">li3_docs</a>: Official documentation plugin by <em>UnionOfRAD</em>.</p>

<p><a href="https://github.com/daschl/li3_fixtures">li3_fixtures</a>: Add Fixtures to your tests by <em>daschl</em>.</p>

<p><a href="http://rad-dev.org/li3_junit">li3_junit</a>: JUnit integration by <em>Michael Harris</em>.</p>

<h2 id="misc:2d9d963d696621d0e0a880c999f831f8">Misc</h2>

<p><a href="https://github.com/UnionOfRAD/li3_cldr">li3_cldr</a>: Query the Unicode CLDR by <em>UnionOfRAD</em>.</p>

<p><a href="https://github.com/Howard3/li3_config_loader">li3_config_loader</a>: Load configs on the fly during bootstrap by <em>Howard3</em>.</p>

<p><a href="https://github.com/Howard3/li3_debug">li3_debug</a>: Debugging Library by <em>Howard3</em>.</p>

<p><a href="https://github.com/daschl/li3_rest">li3_rest</a>: adds REST support to your application by <em>daschl</em>.</p>

<p>I have to say that I&rsquo;m very excited to see what the community is currently building and how Lithium as a whole evolves. Thanks to everyone who is participating and keep up the awesome work!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Jun 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Securing-Lithium-Forms/" class="post-title">Securing Lithium Forms</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>CSRF (Cross-Site-Request-Forgery) attacks work by sending arbitary (form) requests from a victim. Normally, the receiving site (in our case the <code>Controller</code> who processes the form data) doesn&rsquo;t know where the data comes from. The CSRF protection in Lithium aims to solve this problem in an elegant and secure way. You can read more about those attacks
<a href="http://shiflett.org/articles/cross-site-request-forgeries">here</a>. Note that
you&rsquo;ll need to clone the latest <code>master</code> branch of Lithium if you want to
try it out now.</p>

<p>CSRF protection in Lithium is twofold. First, you need to add a unique token to your forms and then check in your controller if the sent token is correct. As Lithium stores the generated <code>sessionKey</code> in your session, make sure that you have session support enabled. If you don&rsquo;t activate sessions, the <code>check</code> method fails silently (which we&rsquo;llsee later on). So uncomment the following line in <code>app/config/bootstrap.php</code> (if you haven&rsquo;t already):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/**</span>
<span style="color: #177500"> * This file contains configuration for session (and/or cookie) storage, and user or web service</span>
<span style="color: #177500"> * authentication.</span>
<span style="color: #177500"> *</span>
<span style="color: #177500"> */</span>
<span style="color: #000000">//</span>require __DIR__ <span style="color: #000000">.</span> <span style="color: #C41A16">&#39;/bootstrap/session.php&#39;</span><span style="color: #000000">;</span>
</pre></div>

<p>Let&rsquo;s look at the view layer first with a very simple form:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">form</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">create</span>(); <span style="color: #633820">?&gt;</span>
    <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">security</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">requestToken</span>(); <span style="color: #633820">?&gt;</span>
    <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">form</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">field</span>(<span style="color: #C41A16">&#39;title&#39;</span>); <span style="color: #633820">?&gt;</span>
    <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">form</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">submit</span>(<span style="color: #C41A16">&#39;Submit&#39;</span>); <span style="color: #633820">?&gt;</span>
<span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">form</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">end</span>(); <span style="color: #633820">?&gt;</span>
</pre></div>

<p>Thanks to lazy loading, we don&rsquo;t have to do anything special to
include our new <code>Security</code> helper. The helper provides the
<code>requestToken()</code> method that generates a unique token (a salted hash) and renders it in a hidden field. If you inspect your form, you should see
something like this (note that i&rsquo;ve shortened the value attribute for better
readability):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">&lt;input type=&quot;hidden&quot; value=&quot;$2a$1...Ay62/W&quot; name=&quot;security[token]&quot;&gt;
</pre></div>

<p>Now that we&rsquo;ve adapted our form, we can work with it in our controller.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>

<span style="color: #A90D91">namespace</span> <span style="color: #000000">app\controllers</span>;

<span style="color: #A90D91">use</span> <span style="color: #000000">lithium\security\validation\RequestToken</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">TasksController</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\action\Controller</span> {

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">add</span>() {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$this-&gt;</span><span style="color: #836C28">request</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">data</span>) {
            <span style="color: #A90D91">if</span>(<span style="color: #000000">!RequestToken::</span><span style="color: #836C28">check</span>(<span style="color: #000000">$this-&gt;</span><span style="color: #836C28">request</span>)) {
                <span style="color: #000000">RequestToken::</span><span style="color: #836C28">get</span>(<span style="color: #A90D91">array</span>(<span style="color: #C41A16">&#39;regenerate&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">true</span>));
            } <span style="color: #A90D91">else</span> {
                <span style="color: #177500">// work with the request as usual</span>
            }
        }
    }

}

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>There are many ways how to handle security checks, so the code snippet above shows only one of them. Let&rsquo;s tackle the important parts one by one.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">use lithium\security\validation\RequestToken;
</pre></div>

<p>You&rsquo;ll need to import the <code>RequestToken</code> class into your namespace, as it is the responsible class for dealing with the tokens.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">RequestToken::check($this-&gt;request);</span>
</pre></div>

<p>The <code>check</code> method reads the <code>sessionKey</code> from your session and checks if it is identical to the requested one. You can also provide the key directly:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;request-&gt;data</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;security&#39;</span><span style="color: #633820">][</span><span style="color: #C41A16">&#39;token&#39;</span><span style="color: #633820">]</span><span style="color: #000000">;</span>
<span style="color: #000000">RequestToken::check($key);</span>
</pre></div>

<p>Now you can modify the key manually (set it to <code>foobar</code> or so) and then see if the <code>check</code> method fails. How you may handle security errors depends heavily on your application. In our example, we regenerate the token with:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">RequestToken::get(array(</span><span style="color: #C41A16">&#39;regenerate&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">true));</span>
</pre></div>

<p>If you go down this route, you&rsquo;ll also have to tell the user what happend in your view. A more secure route would be to raise an exception (or render a error template) and log what happened. In normal production environments this is clearly a exceptional behavior and therefore should be treated this way. If you need this more often in your controller, you can also move the checks to the <code>_init()</code> method.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">class</span> <span style="color: #000000">TasksController</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\action\Controller</span> {

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">_init</span>() {
        <span style="color: #000000">parent::_init</span>();

        <span style="color: #A90D91">if</span>(<span style="color: #000000">$this-&gt;request-&gt;data</span> <span style="color: #000000">&amp;&amp;</span> <span style="color: #000000">!RequestToken::check</span>(<span style="color: #000000">$this-&gt;request</span>)) {
            <span style="color: #000000">$host</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;request-&gt;env</span>(<span style="color: #C41A16">&#39;HTTP_HOST&#39;</span>);
            <span style="color: #000000">Logger::error</span>(<span style="color: #C41A16">&quot;Possible CSRF attack from host $host&quot;</span>);
            <span style="color: #000000">$this-&gt;redirect</span>(<span style="color: #C41A16">&#39;/&#39;</span>);
        }
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">add</span>() {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$this-&gt;request-&gt;data</span>) {
                <span style="color: #177500">// save your data as usual</span>
        }
    }

}
</pre></div>

<p>This should give you a good starting point on how to work with the new
CSRF protection mechanisms. As of today, there is only one major feature left (namely MongoDB relationships) until Lithium reaches the &ldquo;big one&rdquo; so stay tuned for more announcements in the next weeks!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">03 Jun 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Custom-Finders-with-Lithium/" class="post-title">Custom Finders with Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Finders assist you with often-used database queries so you don&rsquo;t have to write them over and over again. Out of the box, Lithium provides you with a bunch of them: <code>all</code>, <code>first</code>, <code>count</code> <code>list</code> and &ldquo;magic finders like&rdquo;
<code>findById</code> or <code>findFirstById</code>. How these are constructed in the core is not
relevant for now, but Lithium provides you with a mechanism to write your own finders easily.</p>

<p>To understand how we can implement our own finder, let&rsquo;s take a look at the built-in <code>first</code> one. If you want to dig deeper, look at the
<a href="http://lithify.me/docs/lithium/data/Model::_findFilters%28%29">_findFilters()</a> method. The <code>_findFilters()</code> method constructs the default finders and returns them to the <code>Model::config()</code> method so that they are loaded when your model is initialized.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">// ... some php code ...</span>
<span style="color: #C41A16">&#39;first&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">function</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>) {
    <span style="color: #000000">$params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;options&#39;</span><span style="color: #633820">][</span><span style="color: #C41A16">&#39;limit&#39;</span><span style="color: #633820">]</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">1</span>;
    <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #000000">$chain-&gt;next</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>);
    <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #000000">is_object</span>(<span style="color: #000000">$data</span>) <span style="color: #000000">?</span> <span style="color: #000000">$data-&gt;rewind</span>() <span style="color: #000000">:</span> <span style="color: #000000">$data</span>;
    <span style="color: #A90D91">return</span> <span style="color: #000000">$data</span> <span style="color: #000000">?:</span> <span style="color: #A90D91">null</span>;
}
<span style="color: #177500">// ... more finders ...</span>
</pre></div>

<p>Your custom finders will also take the same params, so they let&rsquo;s investigate them:</p>

<ul>
<li><code>$self</code> contains the current model as a string</li>
<li><code>$params</code> contains the find options that you already know like <code>order</code>
or <code>conditions</code>.</li>
<li><code>$chain</code> contains filter chain.</li>
</ul>

<p>As you may have recognized, this looks like our typical
<a href="http://rad-dev.org/drafts/source/en/02_lithium_basics/02_filters.wiki">Filters</a> pattern in Lithium! In fact, all finders run through the filter system and this is good news for us: we can also adapt the default ones if we need to.</p>

<p>Our code example first sets a <code>limit</code> option and then lets the chain move on. At the end of the chain, it sets the returned data to the beginning if its an object or just returns the array. Now it&rsquo;s time to write our own finder. To keep things simple at first, let&rsquo;s say we want to find the first five datasets in our model. Just add it to your controller for now, we&rsquo;ll see a bit later how to move it to your model.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Tasks::finder</span>(<span style="color: #C41A16">&#39;firstFive&#39;</span>, <span style="color: #A90D91">function</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>) {
    <span style="color: #000000">$params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;options&#39;</span><span style="color: #633820">][</span><span style="color: #C41A16">&#39;limit&#39;</span><span style="color: #633820">]</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">5</span>;
    <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #000000">$chain-&gt;next</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>);
    <span style="color: #A90D91">return</span> <span style="color: #000000">$data</span> <span style="color: #000000">?:</span> <span style="color: #A90D91">null</span>;       
});
</pre></div>

<p>In our example we have a <code>Tasks</code> model who just has an <code>id</code> and a task <code>name</code> stored. Note that we use MySQL here so that noone can say I&rsquo;m always using MongoDB ;). We can now run our finder with one of the following methods:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$tasks</span> <span style="color: #000000">=</span> <span style="color: #000000">Tasks::find(</span><span style="color: #C41A16">&#39;firstFive&#39;</span><span style="color: #000000">)</span>
<span style="color: #000000">$tasks</span> <span style="color: #000000">=</span> <span style="color: #000000">Tasks::firstFive();</span>
</pre></div>

<p>If you want to check the results immediately, you can use the handy <code>to('array')</code> method on the result set:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">var_dump(Tasks::firstFive()-&gt;to(</span><span style="color: #C41A16">&#39;array&#39;</span><span style="color: #000000">));</span>

<span style="color: #000000">//</span> <span style="color: #000000">Should</span> <span style="color: #000000">print</span> <span style="color: #000000">something</span> <span style="color: #000000">like</span>
<span style="color: #000000">array</span>
    <span style="color: #000000">1</span> <span style="color: #000000">=&gt;</span> 
        <span style="color: #000000">array</span>
            <span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;1&#39;</span> <span style="color: #000000">(length=1)</span>
            <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;first task&#39;</span> <span style="color: #000000">(length=10)</span>
    <span style="color: #000000">2</span> <span style="color: #000000">=&gt;</span> 
        <span style="color: #000000">array</span>
            <span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;2&#39;</span> <span style="color: #000000">(length=1)</span>
            <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;second task&#39;</span> <span style="color: #000000">(length=11)</span>
    <span style="color: #000000">3</span> <span style="color: #000000">=&gt;</span> 
        <span style="color: #000000">array</span>
            <span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;3&#39;</span> <span style="color: #000000">(length=1)</span>
            <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;third task&#39;</span> <span style="color: #000000">(length=10)</span>
    <span style="color: #000000">4</span> <span style="color: #000000">=&gt;</span> 
        <span style="color: #000000">array</span>
            <span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;4&#39;</span> <span style="color: #000000">(length=1)</span>
            <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;fourth task&#39;</span> <span style="color: #000000">(length=11)</span>
    <span style="color: #000000">5</span> <span style="color: #000000">=&gt;</span> 
        <span style="color: #000000">array</span>
            <span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;5&#39;</span> <span style="color: #000000">(length=1)</span>
            <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">string</span> <span style="color: #C41A16">&#39;fifth task&#39;</span> <span style="color: #000000">(length=10)</span>
</pre></div>

<p>If you comment out the limit line in our filter, you can see that you get all results back from the database (just make sure you have more than five rows stored so you can see the difference).</p>

<p>Recently, a new functionality was added to make custom finders a bit more flexible. You can now just hand over an array of params and you don&rsquo;t need to provide a full closure. This comes in handy when you just want to add a <code>limit</code> or a fixed set of <code>conditions</code>. Note that this is currently only available in the <code>x-relationships</code> branch. Once the whole relationship-related code gets merged into master, this feature will also be available.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Tasks::finder(</span><span style="color: #C41A16">&#39;myAwesomeFinder&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span>
    <span style="color: #C41A16">&#39;fields&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;id&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;name&#39;</span><span style="color: #000000">),</span>
    <span style="color: #C41A16">&#39;conditions&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">2)</span>
<span style="color: #000000">));</span>

<span style="color: #000000">$tasks</span> <span style="color: #000000">=</span> <span style="color: #000000">Tasks::myAwesomeFinder();</span>
</pre></div>

<p>You can also add the custom finder in your model, so you don&rsquo;t have to deal with it in the controller. According to the MVC pattern, I&rsquo;d recomend you to place it there. You can override the <code>__init()</code> method so that your finder will be loaded at runtime.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__init</span>() {
    <span style="color: #000000">parent::__init</span>();
    <span style="color: #A90D91">static</span><span style="color: #000000">::finder</span>(<span style="color: #C41A16">&#39;firstFive&#39;</span>, <span style="color: #A90D91">function</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>) {
        <span style="color: #000000">$params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;options&#39;</span><span style="color: #633820">][</span><span style="color: #C41A16">&#39;limit&#39;</span><span style="color: #633820">]</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">5</span>;
        <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #000000">$chain-&gt;next</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$data</span> <span style="color: #000000">?:</span> <span style="color: #A90D91">null</span>;
    });
}
</pre></div>

<p>I think this is enough for a short introduction into custom finders, if you want to find out more you should check out the <a href="http://lithify.me/docs/lithium/data/Model::finder%28%29">Model::finder</a>
method and poke around in the <a href="http://lithify.me/docs/lithium/data/Model::find%28%29">Model::find</a> source. Once the model part of the <a href="http://rad-dev.org/drafts/source">drafts</a> is finished, you&rsquo;ll finde more detailed documentation on this topic.</p>

<p>With this tool in mind, interesting possibilities start to pop up. You can now easily add logging during development to your finders, add caching mechanisms and so on. Please cast your vote in the comments if you want to read more on this topic. So now go ahead and <a href="http://de.wikipedia.org/wiki/Don%E2%80%99t_repeat_yourself">DRY</a> up your controllers and models!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">30 May 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Caching-responses-in-Lithium/" class="post-title">Caching responses in Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>If you need to cache full <code>Response</code> objects in Lithium (which means that your controllers don&rsquo;t even get called when there&rsquo;s a cache hit), you can place this in your <code>app/config/bootstrap/cache.php</code> file (note that this is certainly not &ldquo;production ready&rdquo;, but it should give you a starting point):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/**</span>
<span style="color: #177500"> * Cache full Responses</span>
<span style="color: #177500"> */</span>
<span style="color: #000000">Dispatcher::applyFilter</span>(<span style="color: #C41A16">&#39;run&#39;</span>, <span style="color: #A90D91">function</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>) {
    <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">md5</span>(<span style="color: #000000">LITHIUM_APP_PATH</span>) . <span style="color: #C41A16">&#39;.app.cache.&#39;</span>.<span style="color: #000000">md5</span>(<span style="color: #000000">$params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;request&#39;</span><span style="color: #633820">]</span><span style="color: #000000">-&gt;url</span>);
    <span style="color: #A90D91">if</span>(<span style="color: #000000">$cache</span> <span style="color: #000000">=</span> <span style="color: #000000">Cache::read</span>(<span style="color: #C41A16">&#39;default&#39;</span>, <span style="color: #000000">$key</span>)) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$cache</span>;
    }

    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$chain-&gt;next</span>(<span style="color: #000000">$self</span>, <span style="color: #000000">$params</span>, <span style="color: #000000">$chain</span>);

    <span style="color: #000000">Cache::write</span>(<span style="color: #C41A16">&#39;default&#39;</span>, <span style="color: #000000">$key</span>, <span style="color: #000000">$result</span>, <span style="color: #C41A16">&#39;+1 day&#39;</span>);
    <span style="color: #A90D91">return</span> <span style="color: #000000">$result</span>;
});
</pre></div>

<p>It filters the <code>Dispatcher</code> and first checks if the <code>Response</code> object is already stored in the cache. The cache key is based on the requested URL, so if your <code>/</code> URL points to `<code>/posts/index</code>, both requests will be cached seperately (you could modify the code snipped so that it talks to the <code>Router</code> and checks for the corresponding controller/action object and cache on this key).</p>

<p>Your filter chain returns the <code>Response</code> object, so we can directly cache it. The serialization strategy takes care of correctly storing and retrieving our cached object.</p>

<p>If you have alternative approaches to tackle this, please let me know!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">24 Feb 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Understanding-the-Lithium-Router-Part-2/" class="post-title">Understanding the Lithium Router - Part 2</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h3 id="introduction:7d5f34c0cc895ef21f6fb009931e6d2c">Introduction</h3>

<p>Routes play an essential role in your request/response-cycle and therefore should also be tested like any other component that you develop. As the Lithium routing infrastructure also consists of classes and methods, we can run unit and integration tests against them.</p>

<p>If we follow the testing conventions, we need to differentiate two distinct methods of testing. The first one (the so called &ldquo;<a href="http://en.wikipedia.org/wiki/Unit_testing">Unit Test</a>&rdquo;), is used to test your routes one by one, isolated from your application and ideally all dependencies are mocked away. The second one (called &ldquo;<a href="http://en.wikipedia.org/wiki/Integration_testing">Integration Test</a>&rdquo;), takes the state of your actual application into account and therefore tests the routes in a &ldquo;real environment&rdquo;. This way we can validate their functionality in isolation, and when we are confident with that we can check that no dependencies or other interfaces change the expected behavior.</p>

<p>Let&rsquo;s cover unit tests first and then move on to the integration tests. Afterwards, we&rsquo;ll look at testing reverse routes (more on that later).</p>

<h3 id="unit-testing:7d5f34c0cc895ef21f6fb009931e6d2c">Unit Testing</h3>

<p>Let me clarify one thing first: in general, you don&rsquo;t need to unit test your routes (instead you only need to do integration testing, but more on that later). There core developers did an awesome job in unit testing the routing infrastructure for you, so there is no need for you to duplicate their tests.</p>

<p>Nevertheless, learning  something about unit testing routes has two benefits. On the one hand, you get some practice in writing unit tests and on the other hand you get a better understand on how the routing system works internally. So i really recommend you to read through this section and play around with the code.</p>

<p>If we don&rsquo;t know how to implement unit tests, it is always a good idea to look at the core tests, as they show us how to do this properly and at the same time give us use cases that we can use in our own application. We can also copy and modify some tests, because often our own tests will be similar.</p>

<p>Before we can unit test some routes, we need to add a unit test file. According to the namespace standard, let&rsquo;s create the appropriate file (<code>RouteTest.php</code>) in <code>app\tests\cases\net\http</code>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">app\tests\cases\net\http</span>;

<span style="color: #A90D91">use</span> <span style="color: #000000">lithium\action\Request</span>;
<span style="color: #A90D91">use</span> <span style="color: #000000">lithium\net\http\Route</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">RouteTest</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\test\Unit</span> {

}

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>In our first test, we want to make sure that the route <code>/foo</code>, matches the <code>FooController</code> and the <code>index</code> action. Insert the following test case in your previously created class and run it through the test runner (&ldquo;<a href="http://example.com/test/app/tests/cases/net/http/RouteTest&quot;">http://example.com/test/app/tests/cases/net/http/RouteTest&quot;</a>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testFooRoute</span>() {
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;foo&#39;</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>);
    <span style="color: #000000">$route</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Route</span>(<span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;template&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;/foo&#39;</span>,
        <span style="color: #C41A16">&#39;params&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$params</span>
    ));

    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/foo&#39;</span>;

    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;parse</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$params</span>, <span style="color: #000000">$result-&gt;params</span>);
}
</pre></div>

<p>If we run <code>Router::connect()</code>, the <code>Router</code> basically creates a new <code>Route</code> object and passes the arguments to its constructor. In our tests we do the same, but we initialize the Route directly. This way, we can test the route in isolation. When we create a new route, the <code>template</code> param is the URL that our route will match (remember that it can also contain non-static identifiers). The params argument tells
the route what to return when the template matches the request. We then create a simple <code>Request</code> object (that mimics a request by the browser) and hard-code a URL (in the real application, the <code>$request-&gt;url</code> will be dynamically assigned). Now we run <code>parse()</code>,
that&rsquo;s exactly what the Router does route for route when the <code>Dispatcher</code> asks him to route the request. The parse method returns a <code>Request</code> object with the params set accordingly when it matches, and false when it does not.</p>

<p>To get more familiar, we&rsquo;ll add some more assertions to this test, just append them after the last <code>assertEqual()</code> and run the tests again. You can see that this route really matches only <code>/foo</code> and nothing else:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$<span style="color: #000000">request</span>-&gt;url = &#39;/bar&#39;;
$<span style="color: #000000">result</span> = $<span style="color: #000000">route</span>-&gt;parse($<span style="color: #000000">request</span>);
$<span style="color: #000000">this</span>-&gt;assertFalse($<span style="color: #000000">result</span>);

$<span style="color: #000000">request</span>-&gt;url = &#39;/foo/edit&#39;;
$<span style="color: #000000">result</span> = $<span style="color: #000000">route</span>-&gt;parse($<span style="color: #000000">request</span>);
$<span style="color: #000000">this</span>-&gt;assertFalse($<span style="color: #000000">result</span>);
</pre></div>

<p>Now that we wrote some basic tests, let&rsquo;s move on to a slightly more complex example with a non-static routing template. The route <code>/users/{:id}</code> matches with or without an ID given and passes it as a param in the returned request object.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testUserWithIdRoute</span>() {
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">null</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>, <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;users&#39;</span>);
    <span style="color: #000000">$route</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Route</span>(<span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;template&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;/users/{:id}&#39;</span>,
        <span style="color: #C41A16">&#39;params&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$params</span>
    ));
    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/users&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;parse</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$params</span>, <span style="color: #000000">$result-&gt;params</span>);
    <span style="color: #000000">$this-&gt;assertNull</span>(<span style="color: #000000">$result-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;id&#39;</span><span style="color: #633820">]</span>);

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/users/4&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;parse</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #1C01CE">4</span>, <span style="color: #000000">$result-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;id&#39;</span><span style="color: #633820">]</span>);
}
</pre></div>

<p>We can also test for various HTTP parameters like the request type (typically GET, PUT, POST and DELETE). Let&rsquo;s assume we want to match <code>/cocktails/delete/{:id}</code> only when the id is present (non-optional), it is numeric and the request method is <code>delete</code>. The equivalent router call in our <code>routes.php</code> file would be <code>Router::connect('/cocktails/delete/{:id:\d+}, array('controller' =&gt; 'cocktails', 
'action' =&gt; 'delete', 'http:method' =&gt; 'DELETE'));</code>.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testCocktailDeleteRoute</span>() {
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;cocktails&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;delete&#39;</span>,
        <span style="color: #C41A16">&#39;http:method&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;DELETE&#39;</span>
    );
    <span style="color: #000000">$route</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Route</span>(<span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;template&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;/cocktails/delete/{:id:\d+}&#39;</span>,
        <span style="color: #C41A16">&#39;params&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$params</span>
    ));

    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/cocktails/delete/4&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;parse</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertFalse</span>(<span style="color: #000000">$result</span>);

    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>(<span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;env&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;REQUEST_METHOD&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;DELETE&#39;</span>)));
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/cocktails/delete&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;parse</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertFalse</span>(<span style="color: #000000">$result</span>);

    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>(<span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;env&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;REQUEST_METHOD&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;DELETE&#39;</span>)));
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/cocktails/delete/4&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;parse</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #1C01CE">4</span>, <span style="color: #000000">$result-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;id&#39;</span><span style="color: #633820">]</span>);
}
</pre></div>

<p>As stated in the first lines of this section, you won&rsquo;t need to do this in your application code, but writing this kind of tests has one more benefit: if something goes wrong, it is a great tool to understand the inner workings and also to test scenarios in isolation. If you encounter any bugs in the router, writing a unit test that shows the failure is also highly recommended, so that the core team is able to track down your problem and reproduce it in their environments. Also, writing failing test cases ensures that after a bug is fixed, it never happens again.</p>

<p>A great way to inspect and debug routes is the <code>export()</code> method. With this method, you can inspect the full state of an route and run assertions against it. Let&rsquo;s try this in a test:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testExport</span>() {
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;posts&#39;</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>);
    <span style="color: #000000">$route</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Route</span>(<span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;template&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;/read&#39;</span>,
        <span style="color: #C41A16">&#39;params&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$params</span>
    ));

    <span style="color: #000000">$exported</span> <span style="color: #000000">=</span> <span style="color: #000000">$route-&gt;</span><span style="color: #A90D91">export</span>();
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$params</span>, <span style="color: #000000">$exported</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;params&#39;</span><span style="color: #633820">]</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #C41A16">&#39;/read&#39;</span>, <span style="color: #000000">$exported</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;template&#39;</span><span style="color: #633820">]</span>);
    <span style="color: #000000">$this-&gt;assertFalse</span>(<span style="color: #000000">$exported</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;handler&#39;</span><span style="color: #633820">]</span>);
}
</pre></div>

<p>Now let&rsquo;s move on to something that we should really use in our applications, integration testing.</p>

<h3 id="integration-testing:7d5f34c0cc895ef21f6fb009931e6d2c">Integration Testing</h3>

<p>Now that we&rsquo;ve tested each route in isolation, it&rsquo;s time to get a higher-level view of our application. When we test more than one class in isolation, we call that &ldquo;Integration Testing&rdquo;. Technically, these tests are similar to normal unit tests, so you don&rsquo;t need to learn something new. In a typical framework request, the <code>Dispatcher</code> calls the <code>Router</code> with a <code>Request</code>, and the router matches it against all connected routes and checks if there is a match.</p>

<p>The following code snippets are suited for a default installation. Create a <code>RouterTest.php</code> file in <code>app/tests/integration/net/http</code>. Additionally, you may also need to create the appropriate subdirectories in there.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">app\tests\integration\net\http</span>;
<span style="color: #A90D91">use</span> <span style="color: #000000">lithium\net\http\Router</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">RouterTest</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\test\Unit</span> {

}

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>We can issue a request against the router and check that the output is correct. Let&rsquo;s do that for a subset of our default routes:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testRootRoute</span>() {
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pages&#39;</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;view&#39;</span>);

    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/&#39;</span>;

    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);
}

<span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testPagesRoutes</span>() {
    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/pages&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pages&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;view&#39;</span>
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/pages/1&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;args&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;1&#39;</span>),
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pages&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;view&#39;</span>
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);
}

<span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testDefaultRoutes</span>() {
    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/foo&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;foo&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/foo/bar&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;foo&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;bar&#39;</span>
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);

    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/foo/bar/1&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;foo&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;bar&#39;</span>,
        <span style="color: #C41A16">&#39;args&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;1&#39;</span>)
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);
}
</pre></div>

<p>Most of the code should look familiar to you, the most interesting part is the call of <code>Router::process()</code>. This method is also called by the dispatcher (but with the actual Request object). For every call to the Router, we simulate a request by the client browser. This code contains a high amount of duplication, so you may want to compact this and create a helper method in your test class that wraps and simplifies the duplicated code.</p>

<p>Here is another example for a route that we can test:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">use</span> <span style="color: #000000">app\models\Post</span>;

<span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/{:slug:</span><span style="color: #633820">[</span><span style="color: #000000">\w\-</span><span style="color: #633820">]</span><span style="color: #C41A16">+}&#39;</span>, <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;Posts::show&#39;</span>), <span style="color: #A90D91">function</span>(<span style="color: #000000">$request</span>) {

    <span style="color: #000000">$conditions</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;conditions&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(
            <span style="color: #C41A16">&#39;slug&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$request-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;slug&#39;</span><span style="color: #633820">]</span>
        )
    );

    <span style="color: #A90D91">if</span>(<span style="color: #000000">Post::count</span>(<span style="color: #000000">$conditions</span>)) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$request</span>;
    } <span style="color: #A90D91">else</span> {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
    }

});
</pre></div>

<p>When this route is placed right before the default routes, it should correctly match URLs like <code>/a-cool-article</code>. The code inside the closure calls the database and checks if the given slug really exists in the database. If it does, it returns the request (and false if not). The router iterates over each route and when false is returned, he tries the next route. So when we return the <code>Request</code>-object, we tell the router that our route is the one he has searched for. To ensure that everything works as expected, we can write some integration tests.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testSlugRoute</span>() {
    <span style="color: #000000">$request</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Request</span>();

    <span style="color: #177500">// a correct slug (stored in the db)</span>
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/a-correct-slug&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;posts&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;show&#39;</span>,
        <span style="color: #C41A16">&#39;slug&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;a-correct-slug&#39;</span>
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);

    <span style="color: #177500">// not a correct slug, renders a default route</span>
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/foobar-not-a-slug-here&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;posts&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;show&#39;</span>,
        <span style="color: #C41A16">&#39;slug&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;foobar-not-a-slug-here&#39;</span>
    );
    <span style="color: #000000">$this-&gt;assertNotEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);
    <span style="color: #000000">$this-&gt;assertFalse</span>(<span style="color: #000000">isset</span>(<span style="color: #000000">$result-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;slug&#39;</span><span style="color: #633820">]</span>));

    <span style="color: #177500">// tests should always come first</span>
    <span style="color: #000000">$request-&gt;url</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/test&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::process</span>(<span style="color: #000000">$request</span>);
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(
        <span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;lithium\test\Controller&#39;</span>,
        <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>,
    );
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result-&gt;params</span>);
    <span style="color: #000000">$this-&gt;assertFalse</span>(<span style="color: #000000">isset</span>(<span style="color: #000000">$result-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;slug&#39;</span><span style="color: #633820">]</span>));
}
</pre></div>

<p>This code assumes that your database has a reproducible set of posts stored in it. I&rsquo;d recommend you to load a set of posts with the <a href="http://rad-dev.org/li3_fixtures">li3_fixtures</a> plugin and then populate the database in the <code>setUp()</code> method. If you want to play around with it some more, I&rsquo;d suggest you to check the current <a href="http://lithify.me/docs/lithium/core/Environment">Environment</a> and test the different behavior for different environments.</p>

<p>With this tools at hand, you should be able to test everything that has to do with your routes and make sure that they are connected in the correct order and return the response you&rsquo;ve intended.</p>

<h3 id="reverse-routing:7d5f34c0cc895ef21f6fb009931e6d2c">Reverse Routing</h3>

<p>As the router also handles reverse routing (which is used by the HTML helper to generate links), we can test it here too. Because we look at the router and its routes, reverse routing fits well into our router integration tests.</p>

<p>Testing reverse routing is straightforward, so let&rsquo;s start with some examples and work them through afterwards.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testReverseRouting</span>() {
    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/foo/bar&#39;</span>;
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;foo&#39;</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;bar&#39;</span>);
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::match</span>(<span style="color: #000000">$params</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result</span>);

    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/pages&#39;</span>;
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pages&#39;</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>);
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::match</span>(<span style="color: #000000">$params</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result</span>);

    <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;/pages/index/1&#39;</span>;
    <span style="color: #000000">$params</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pages&#39;</span>, <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;index&#39;</span>, <span style="color: #C41A16">&#39;args&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;1&#39;</span>));
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::match</span>(<span style="color: #000000">$params</span>);
    <span style="color: #000000">$this-&gt;assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$result</span>);
}
</pre></div>

<p>Here, we test the opposite direction. We pass the router a set of arguments and get an URL back. As it&rsquo;s the case with normal
routing, if two routes compete for the same URL, the first one wins. We call <code>Router::match()</code> with our request params and get a URL as a string returned. This way, we can test that our HTML helper will return the desired URLs in our application. Of course, you can also add some tests to the HTML Helper (where you can make sure that the echoed HTML code is correct). If the router is not able to translate your params into a URL, it will raise an exception.</p>

<h3 id="wrapping-up:7d5f34c0cc895ef21f6fb009931e6d2c">Wrapping up</h3>

<p>In part two of our series we&rsquo;ve looked at unit testing routes, running integration tests against them and also testing the reverse routing
mechanism. Of course, these tests depend heavily on your application and will surely become more complex as the previous examples. The next higher level would be to do add some acceptance tests with <a href="http://seleniumhq.org/">Selenium</a>, so that you can test routes in combination with links and forms on your page, to make sure that the data flow works as expected between pages. Also, I&rsquo;m working on a BDD plugin for Lithium that works similar to <a href="http://cukes.info/">Cucumber</a>, so stay tuned.</p>

<p>I really hope that you&rsquo;ve enjoyed the second part of this series. Also, thanks again to <a href="http://twitter.com/#!/nateabele">@nateabele</a> for his helpful comments.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">05 Feb 2011</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Understanding-the-Lithium-Router-Part-1/" class="post-title">Understanding the Lithium Router - Part 1</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h3 id="introduction:e82f59798b0cae34bbddd906b7b84192">Introduction</h3>

<p>The router is an integral part of the framework and has two main purposes. The first one is to match a URL against a set of previously connected routes, the second one is to generate a URL from a set of arguments (reverse routing). The router itself is very flexible as we&rsquo;ll see later on, but getting started is pretty easy. Lithium comes with a set of sensible default routes that help you to get on track immediately. While developing, you can always add, modify or remove routes and the application will instantly take these changes into account. When you are running in production mode, routes should be cached for performance reasons, because compiling and analyzing routes takes some time for every request. We&rsquo;ll see how this works in one of the upcoming posts.</p>

<p>At the time of writing, there is no full featured guide available. Nevertheless, Lithium provides an extensive API documentation that covers nearly every aspect of the routing system. For your convenience, here are some short links to <a href="http://lithify.me/docs/lithium/net/http/Router">the Router</a> and <a href="http://lithify.me/docs/lithium/net/http/Route">the Route</a> classes. Usually a good place for examples are unit tests, and the core developers worked hard to implement high code coverage and extensive unit tests. You can find them online <a href="http://dev.lithify.me/lithium/source/libraries/lithium/tests/cases/net/http">here</a>.</p>

<h4 id="the-request-response-cycle:e82f59798b0cae34bbddd906b7b84192">The Request/Response-Cycle</h4>

<p>Before we dive into the router itself, it would be a good idea to take a look where the router is placed in the request/response-cycle and how it participates in the typical dispatching process.</p>

<p>The index.php-Page creates a new request object and hands it over to the dispatcher. The dispatcher hands this request object over to the router, who matches it against his connected routes and returns parameters that tell the dispatcher which controller and action to execute. If no matching route is found, an exception is raised. The dispatcher then instantiates the correct Controller object, which returns - after processing the associated models, controller actions and views - a response object. The dispatcher then sends the headers
and the content of the response object back to the browser.</p>

<p>After reading this, you may notice that the flow of the request and response objects is really straightforward. It is possible to modify or exchange every part of this dispatching process, so you have the full flexibility at your fingertips if you need it.</p>

<p>The whole Lithium routing functionality is organized in separate classes that perform distinct operations. Two classes mainly participate in the routing process. The <code>lithium\net\http\Router</code> has one or more  instances of <code>lithium\net\http\Route</code> connected to itself. When the router has to route the request, it iterates over the connected routes and checks if one of them match. The routes are checked in the same order as they&rsquo;re connected, so the first match wins the race. Therefore you need to be careful when designing your routes, as this may have some impact on your performance. When no matching routes are found (and no default routes are in place), then a <code>lithium\net\http\RoutingException</code> is raised. We&rsquo;ll use this behavior in the second part to render a 404-Page.</p>

<p>Enough talk, let&rsquo;s get started.</p>

<h3 id="basics-first:e82f59798b0cae34bbddd906b7b84192">Basics First</h3>

<p>Usually, there is only one file you&rsquo;ll need to modify when you want to add or modify your application routes. The <code>app/config/routes.php</code> file is part of the bootstrap process and connects your routes to the router. If you open the file, you&rsquo;ll see that there are already a few routes defined. We&rsquo;ll look at them route by route, because they cover most of the syntax we&rsquo;ll usually need.</p>

<p>We always use the  <code>Router::connect()</code> method if we want to bind a given URL to a set of parameters. The first route is also called the &ldquo;root&rdquo;, because this route will be used if the user hits your application with no additional parameters (like <code>http://www.example.com</code>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;Pages::view&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;args&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;home&#39;</span><span style="color: #000000">)));</span>
</pre></div>

<p>The <code>Router::connect()</code> method expects at least one argument, two more can also be specified. We&rsquo;ll see more of them in later examples. The first argument is a string with the URL, the second one can be just a string or an array with information on how to map the URL to controllers and actions. For the first route, when the user hits the application with the root URL &ldquo;/&rdquo;, the <code>app\controllers\PagesController</code> and its <code>view</code> action is called. Additionally, a &ldquo;args&rdquo; param with the value &lsquo;home&rsquo; is passed to the controller. This argument is used afterwards in the controller action to render the <code>home</code> view. Of course this is not necessary, but it showcases the flexibility of routes.</p>

<p>The next route connects URLs like <code>/pages/foo</code> or <code>/pages/bar</code> to the PagesController and the view action.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/pages/{:args}&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;Pages::view&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>If you re-read the first route now, you should see obvious similarities. These two routes call the same controller and the same action, but the first route sets the <code>args</code> param to a static value, while the second route sets it dynamically (based on the request). You can also pass an array as the second argument, which can give you more flexibility. The equal method call with an array passed as the second argument would look like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/pages/{:args}&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pages&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;view&#39;</span><span style="color: #000000">));</span>
</pre></div>

<p>This way of calling <code>Router::connect()</code>allows you to specify more arguments, but if you only need to route to a Controller/Action combination without further arguments, the first example is much shorter and as a result way easier to read.</p>

<p>The <code>{:args}</code> string acts as a placeholder, so let&rsquo;s have a look at the controller and see how he uses the passed arguments (<code>app\controllers\PagesController</code>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">view</span>() {
    <span style="color: #000000">$path</span> <span style="color: #000000">=</span> <span style="color: #000000">func_get_args</span>();

    <span style="color: #A90D91">if</span> (<span style="color: #000000">empty</span>(<span style="color: #000000">$path</span>)) {
        <span style="color: #000000">$path</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;home&#39;</span>);
    }
    <span style="color: #000000">$this-&gt;render</span>(<span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;template&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">join</span>(<span style="color: #C41A16">&#39;/&#39;</span>, <span style="color: #000000">$path</span>)));
}
</pre></div>

<p>The <code>args</code> keyword defined in the route is passed to the view action as a param. If no path was set, the action sets it to &ldquo;home&rdquo;. Afterwards, the correct template is rendered. This is just one way to use the passed arguments, we&rsquo;ll see different methods in a minute.</p>

<p>The next code snippet connects testing routes, but only when we are not in the production environment. You see that the routing system is flexible enough to take other conditions of the environment into account.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">if</span> <span style="color: #000000">(!Environment::is(</span><span style="color: #C41A16">&#39;production&#39;</span><span style="color: #000000">))</span> {
    <span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/test/{:args}&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;lithium\test\Controller&#39;</span>));
    <span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/test&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;lithium\test\Controller&#39;</span>));
}
</pre></div>

<p>By default, Lithium searches for the controller in the <code>app\controllers</code> namespace, so if you want to specify a controller in a different path, you&rsquo;ll need to give Lithium the fully namespaced path (for example if you need to match a route against a controller in a plugin). These two routes match <code>/test</code> and also <code>/test/lithium/tests/cases/action/ControllerTest</code>.</p>

<p>The last routes you&rsquo;ll find in the <code>routes.php</code> file are the so called &ldquo;default routes&rdquo;. Because of the fact that route matching occurs in the same order as they are connected, they need to be connected at last (otherwise these routes would always match every request).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/{:controller}/{:action}/{:id:</span><span style="color: #633820">[</span><span style="color: #1C01CE">0</span><span style="color: #000000">-</span><span style="color: #1C01CE">9</span><span style="color: #633820">]</span><span style="color: #C41A16">+}.{:type}&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;id&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">null));</span>
<span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/{:controller}/{:action}/{:id:</span><span style="color: #633820">[</span><span style="color: #1C01CE">0</span><span style="color: #000000">-</span><span style="color: #1C01CE">9</span><span style="color: #633820">]</span><span style="color: #C41A16">+}&#39;</span><span style="color: #000000">);</span>
<span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/{:controller}/{:action}/{:args}&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>The <code>{:controller}</code>, <code>{:action}</code>and <code>{:type}</code> keywords are treated specially. These three keywords are used by the router to dynamically find and match the correct Controller/Action combination and render the result as the correct <code>lithium\net\http\Media</code>-type. If a optional <code>{:id}</code> is given, it is also passed down to the action. By convention, if no action is given <code>YourController::index()</code> is assumed. The default routes also make it easy to define a separate output type (like JSON or XML), which can be used to render the data in an other format instead of HTML. If you want to learn more about this feature, be sure to read my blog post about <a href="http://nitschinger.at/Add-an-RSS-Feed-to-your-blog-with-Lithium">&ldquo;Adding an RSS Feed to your blog with Lithium&rdquo;</a>.</p>

<p>These default routes match nearly everything, like <code>/posts</code>, <code>/posts/show/4</code> or <code>/posts/index.json</code>. This default routes work perfectly with ids generated by MySQL auto increment (or anything similar), but it doesn&rsquo;t work with MongoDB-IDs. Check out my blog post about <a href="http://nitschinger.at/Lithium-Routes-And-Mongo-DB">&ldquo;Lithium Routes And MongoDB&rdquo;</a>.</p>

<p>To understand the routing process full-stack, we also need to investigate how we can access the <code>Request</code>-object and its params. In the next snippet you&rsquo;ll find various examples of routes and how their params can be used in your controller. They always follow the same schema, so once you get used to it you should not need to look up the documentation again.</p>

<p>The slug-route is a bit more complex for now, but we&rsquo;ll cover these kind of routes in the next part.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">/**</span>
<span style="color: #177500"> * connects the root URL to the PostsController and the &quot;index&quot;-action.</span>
<span style="color: #177500"> */</span>
<span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/&#39;</span>, <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;Posts::index&#39;</span>));

<span style="color: #177500">/**</span>
<span style="color: #177500"> * connects login and logout shorthand URLs to the UsersController.</span>
<span style="color: #177500"> */</span>
<span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/login&#39;</span>, <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;Users::login&#39;</span>));
<span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/logout&#39;</span>, <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;Users::logout&#39;</span>));

<span style="color: #177500">/**</span>
<span style="color: #177500"> * connects slug URLs in my blog to the PostsController.</span>
<span style="color: #177500"> */</span>
<span style="color: #000000">Router::connect</span>(<span style="color: #C41A16">&#39;/{:slug:</span><span style="color: #633820">[</span><span style="color: #000000">\w\-</span><span style="color: #633820">]</span><span style="color: #C41A16">+}&#39;</span>, <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;Posts::show&#39;</span>));

<span style="color: #177500">/**</span>
<span style="color: #177500"> * the corresponding Posts::show() action (the slug is passed in the request object).</span>
<span style="color: #177500"> * the show-action can be called with an id (default route), or with a slug (previous route)</span>
<span style="color: #177500"> */</span>
<span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">show</span>() {
    <span style="color: #A90D91">if</span>(<span style="color: #000000">isset</span>(<span style="color: #000000">$this-&gt;request-&gt;id</span>)) {
        <span style="color: #000000">$post</span> <span style="color: #000000">=</span> <span style="color: #000000">Post::first</span>(<span style="color: #000000">$this-&gt;request-&gt;id</span>);
    } <span style="color: #000000">elseif</span>(<span style="color: #000000">isset</span>(<span style="color: #000000">$this-&gt;request-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;slug&#39;</span><span style="color: #633820">]</span>)) {
        <span style="color: #000000">$post</span> <span style="color: #000000">=</span> <span style="color: #000000">Post::first</span>(<span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;conditions&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;slug&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$this-&gt;request-&gt;params</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;slug&#39;</span><span style="color: #633820">]</span>)));
    }
    <span style="color: #A90D91">if</span>(<span style="color: #000000">!count</span>(<span style="color: #000000">$post</span>)) {
        <span style="color: #000000">$this-&gt;redirect</span>(<span style="color: #C41A16">&#39;Posts::index&#39;</span>);
    }
    <span style="color: #A90D91">return</span> <span style="color: #000000">compact</span>(<span style="color: #C41A16">&#39;post&#39;</span>);
}
</pre></div>

<h4 id="generating-urls:e82f59798b0cae34bbddd906b7b84192">Generating URLs</h4>

<p>As said previously, the routing infrastructure is not only capable of matching URLs to routes, but also matching a set of given parameters and generate a URL out of them. This technique is called &ldquo;reverse routing&rdquo;. The HTML-Helper for example does this for if you use its <a href="http://lithify.me/docs/lithium/template/helper/Html::link%28%29">&ldquo;link&rdquo;</a>-method. If you want to trigger the reverse routing functionality manually, you can do this by querying the <code>Router::match()</code> method. Here is an example from the Lithium documentation that illustrates this behavior. Both <code>Router::match()</code> queries return the URL &ldquo;/login&rdquo; as a result:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/login&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;users&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;login&#39;</span><span style="color: #000000">));</span>
<span style="color: #000000">//</span> <span style="color: #000000">params</span> <span style="color: #000000">as</span> <span style="color: #000000">an</span> <span style="color: #000000">array</span>
<span style="color: #000000">$url</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::match(array(</span><span style="color: #C41A16">&#39;controller&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;users&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;action&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;login&#39;</span><span style="color: #000000">));</span>
<span style="color: #000000">//</span> <span style="color: #000000">a</span> <span style="color: #000000">more</span> <span style="color: #000000">compact</span> <span style="color: #000000">syntax</span>
<span style="color: #000000">$url</span> <span style="color: #000000">=</span> <span style="color: #000000">Router::match(</span><span style="color: #C41A16">&#39;User::login&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>By using this method to generate URLs, you also make sure that your application is portable and works even if you place the application under a subdirectory on the server.</p>

<h3 id="wrapping-up:e82f59798b0cae34bbddd906b7b84192">Wrapping Up</h3>

<p>After reading this post you should have a basic understanding on how the router works and how it participates in the whole request/response cycle. The next posts will cover more advanced topics like testing routes,
<a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST</a>ful routes, namespaces/prefixes, bypassing the framework altogether, catching exceptions and even various production deployment considerations.</p>

<p>If you want to read about a specific topic, feel free to comment below. Any feedback would be also greatly appreciated. Lastly, special thanks to <a href="http://twitter.com/#!/nateabele">@nateabele</a> for reading through this post and providing important feedback.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">16 Dec 2010</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Understanding-the-Inflector/" class="post-title">Understanding the Inflector</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h3 id="introduction:80a65fb5d80eeadafeb3cbaa12fa2dd1">Introduction</h3>

<p>The Inflector is one of many utility classes that ship with Lithium out of the box. Those classes are designed to assist you with common tasks that need to be done.</p>

<p>One of those tasks may be to pluralize, singularize, camel-case or humanize strings, database keys or other dynamic content. Let&rsquo;s see how the class itself is described:</p>

<blockquote>
<p>Utility for modifying format of words. Change singular to plural and vice versa. Under_score a CamelCased word and vice versa. Replace spaces and special characters. Create a human readable word from the others. Used when consistency in naming conventions must be enforced.</p>
</blockquote>

<p>The Inflector can be found in <code>lithium\util</code> and you can get it into your namespace with <code>use lithium\util\Inflector</code>. The documentation can be found online at <a href="http://lithify.me/docs/lithium/util/Inflector">lithify.me/docs</a>.</p>

<h3 id="methods:80a65fb5d80eeadafeb3cbaa12fa2dd1">Methods</h3>

<p>Here is a comprehensive list of the methods that the Inflector provides to you (the descriptions are quoted from their documentation):</p>

<ul>
<li><strong>pluralize</strong>: changes the form of a word from singular to plural.</li>
<li><strong>singularize</strong>: changes the form of a word from plural to singular.</li>
<li><strong>camelize</strong>: takes a under_scored word and turns it into a CamelCased or camelBack word.</li>
<li><strong>underscore</strong>: takes a CamelCased version of a word and turns it into an under_scored one.</li>
<li><strong>slug</strong>: returns a string with all spaces converted to given replacement and non word characters removed.</li>
<li><strong>humanize</strong>: takes an under_scored version of a word and turns it into an human- readable form by replacing underscores with a space, and by upper casing the initial character.</li>
<li><strong>tableize</strong>: takes a CamelCased class name and returns corresponding under_scored table name.</li>
<li><strong>classify</strong>: takes a under_scored table name and returns corresponding class name.</li>
</ul>

<p>There are more public methods in there, but we&rsquo;ll get to those later on. Now that you have an idea what the Inflector can do for you, we&rsquo;ll explore each of these methods in detail. One quick note: if you need more examples, the <a href="http://rad-dev.org/lithium/source/libraries/lithium/tests/cases/util/InflectorTest.php#highlight">tests</a> are a great place to find some.</p>

<h4 id="inflector-pluralize:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::pluralize()</h4>

<p>The <code>pluralize()</code> method takes a singular word (string) and returns you the pluralized version of it. Here are some examples:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::pluralize(</span><span style="color: #C41A16">&#39;Apple&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;Apples&quot;</span>
<span style="color: #000000">Inflector::pluralize(</span><span style="color: #C41A16">&#39;Menu&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;Menus&quot;</span>
<span style="color: #000000">Inflector::pluralize(</span><span style="color: #C41A16">&#39;News&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;News&quot;</span>
</pre></div>

<p>If you are not sure what the pluralized word will look like, take a look at the <code>lithium\util\Inflector::$_plural</code> property.</p>

<h4 id="inflector-singularize:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::singularize()</h4>

<p>The <code>singularize()</code> method takes a plural word (string) and returns you the singularized version of it. Here are some examples:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::singularize(</span><span style="color: #C41A16">&#39;Houses&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;House&quot;</span>
<span style="color: #000000">Inflector::singularize(</span><span style="color: #C41A16">&#39;Bananas&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;Banana&quot;</span>
<span style="color: #000000">Inflector::singularize(</span><span style="color: #C41A16">&#39;Men&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;Man&quot;</span>
</pre></div>

<p>If you are not sure what the pluralized word will look like, take a look at the <code>lithium\util\Inflector::$_singular</code> property.</p>

<h4 id="inflector-camelize:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::camelize()</h4>

<p>You can hand the <code>camelize()</code> method either a slugged or a under_scored word and it will return you this word CamelCased or camelBacked (if you provide <code>false</code> as the second argument). Some examples:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::camelize(</span><span style="color: #C41A16">&#39;foo_bar&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;FooBar&quot;</span> 
<span style="color: #000000">Inflector::camelize(</span><span style="color: #C41A16">&#39;foo_bar&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">false);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;fooBar&quot;</span>
</pre></div>

<h4 id="inflector-slug:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::slug()</h4>

<p>The <code>slug()</code> method takes a string and creates a &ldquo;slugged&rdquo; representation of it. This basically means that all spaces will be replaced with a given character (defaults to &ldquo;-&rdquo;), non-word characters will be removed and characters with accents like &ldquo;&rdquo; will be translated to their ASCII representation. Here are some examples:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::slug(</span><span style="color: #C41A16">&#39;The truth - and- more- news&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;The-truth-and-more-news&quot;</span>
<span style="color: #000000">Inflector::slug(</span><span style="color: #C41A16">&#39;!@$#exciting stuff! - what !@-# was that?&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;exciting-stuff-what-was-that&quot;</span>
</pre></div>

<h4 id="inflector-underscore:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::underscore()</h4>

<p>The <code>underscore()</code> method basically takes a camel-cased word, slugs it and lowercases all characters.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">Inflector::underscore(&#39;TestField&#39;) // returns test_field
Inflector::underscore(&#39;Feinepfel&#39;) // returns feine_aepfel
</pre></div>

<p>Note here that characters with accents will be transliterated, because of the translation into a slug. I don&rsquo;t know if this is the intended behavior so this may change in future releases.</p>

<h4 id="inflector-humanize:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::humanize()</h4>

<p>The <code>humanize()</code> method takes an underscored word, removes a given seperator (defaults to &ldquo;_&ldquo;) and uppercases the first characters of the words. Some examples from the core tests:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::humanize(</span><span style="color: #C41A16">&#39;posts&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;Posts&quot;</span>
<span style="color: #000000">Inflector::humanize(</span><span style="color: #C41A16">&#39;posts_tags&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;Posts Tags&quot;</span>
<span style="color: #000000">Inflector::humanize(</span><span style="color: #C41A16">&#39;file_systems&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span>  <span style="color: #C41A16">&quot;File Systems&quot;</span>
</pre></div>

<h4 id="inflector-tableize:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::tableize()</h4>

<p>The <code>tableize()</code> method takes your string, underscores (remember the slug?) and finally pluralizes it. As you can see, those methods use other low level methods provided to build exactly what you need. With this method, you can hand over a Model name and get the correct table name for it.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::tableize(</span><span style="color: #C41A16">&#39;Post&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;posts&quot;</span>
<span style="color: #000000">Inflector::tableize(</span><span style="color: #C41A16">&#39;ArtistsGenre&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;artists_genres&quot;</span>
<span style="color: #000000">Inflector::tableize(</span><span style="color: #C41A16">&#39;FileSystem&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;file_systems&quot;</span>
</pre></div>

<h4 id="inflector-classify:80a65fb5d80eeadafeb3cbaa12fa2dd1">Inflector::classify()</h4>

<p>The <code>classify()</code> method is basically the opposite to the <code>tabelize()</code> method. You hand it over a table name and get the correct class (Model) name back. It singularizes and camelizes the given string.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">    <span style="color: #000000">Inflector::classify(</span><span style="color: #C41A16">&#39;artists_genres&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;ArtistsGenre&quot;</span>
    <span style="color: #000000">Inflector::classify(</span><span style="color: #C41A16">&#39;file_systems&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;FileSystem&quot;</span>
    <span style="color: #000000">Inflector::classify(</span><span style="color: #C41A16">&#39;news&#39;</span><span style="color: #000000">);</span> <span style="color: #000000">//</span> <span style="color: #000000">returns</span> <span style="color: #C41A16">&quot;News&quot;</span>
</pre></div>

<h3 id="add-your-own-rules:80a65fb5d80eeadafeb3cbaa12fa2dd1">Add your own rules</h3>

<p>If you need, you can add your own rules and/or override default rules. The <code>Inflector::rules()</code> method is responsible for that and works as a setter or getter for all stored rules. The core tests provide an example:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Inflector::rules(</span><span style="color: #C41A16">&#39;singular&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;/rata/&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;\1ratus&#39;</span><span style="color: #000000">));</span>
</pre></div>

<p>You can also add transliterations that maps language specific or accented characters to ASCII ones (they are used to create slugs, for example). The core tests also provide a nice example:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$this-&gt;assertNotEqual(Inflector::slug(</span><span style="color: #C41A16">&#39;JRGEN&#39;</span><span style="color: #000000">),</span> <span style="color: #C41A16">&#39;JORGEN&#39;</span><span style="color: #000000">);</span>
<span style="color: #000000">Inflector::rules(</span><span style="color: #C41A16">&#39;transliteration&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;//&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;O&#39;</span><span style="color: #000000">));</span>
<span style="color: #000000">$this-&gt;assertEqual(Inflector::slug(</span><span style="color: #C41A16">&#39;JRGEN&#39;</span><span style="color: #000000">),</span> <span style="color: #C41A16">&#39;JORGEN&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>Good practice is to store your custom rules in a bootstrap file, so that they are immediately available to your application when it is fully loaded. If you need to do that on-the-fly, be sure to read the next chapter about caching translation results.</p>

<h3 id="caching:80a65fb5d80eeadafeb3cbaa12fa2dd1">Caching</h3>

<p>You&rsquo;ve probably heard or used the methods above previously. What you maybe don&rsquo;t know is, that the Inflector caches your <code>singularize</code>, <code>pluralize</code>,&hellip; calls and if you call the same method with the same word again it will be served directly out of an array.</p>

<p>That&rsquo;s pretty neat and doesn&rsquo;t do any harm when you properly define your custom rules in a bootstrap file. But you may run into issues when you call a translation method for word X, then add your own rules that affect X and then call the method again. It will be served straight out of the cache and your rules won&rsquo;t match.</p>

<p>You can fix this by calling <code>Inflector::reset()</code> before you apply your rules (this will empty the caches). The next call will then apply your custom rules.</p>

<h3 id="conclusion:80a65fb5d80eeadafeb3cbaa12fa2dd1">Conclusion</h3>

<p>The Inflector is a nice utility library that is used widely in the Lithium core and can easily be used by your application too. It&rsquo;s a fast and extensible way of dealing with dynamic content that needs to be pluralized, singularized, slugged and so on.</p>

<p>Finally, it does not have any external dependencies so you can even use the Inflector in your own libraries or frameworks.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">04 Dec 2010</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Introducing-Fixtures-for-Lithium/" class="post-title">Introducing Fixtures for Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>When you write tests for your classes (and you should), you may run into the problem that you create large arrays of test data in your code. Consider the following example:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #000000">array(</span>
    <span style="color: #C41A16">&#39;post1&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array(</span>
        <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;My First Post&#39;</span><span style="color: #000000">,</span>
        <span style="color: #C41A16">&#39;content&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;First Content...&#39;</span>
    <span style="color: #000000">),</span>
    <span style="color: #C41A16">&#39;post2&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array(</span>
        <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;My Second Post&#39;</span><span style="color: #000000">,</span>
        <span style="color: #C41A16">&#39;content&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Also some foobar text&#39;</span>
    <span style="color: #000000">),</span>
    <span style="color: #C41A16">&#39;post3&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array(</span>
        <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;My Third Post&#39;</span><span style="color: #000000">,</span>
        <span style="color: #C41A16">&#39;content&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;I like to write some foobar foo too&#39;</span>
    <span style="color: #000000">)</span>
<span style="color: #000000">);</span>

<span style="color: #000000">$this-&gt;assertEqual($expected</span><span style="color: #633820">[</span><span style="color: #1C01CE">0</span><span style="color: #633820">]</span><span style="color: #000000">,</span> <span style="color: #000000">Post::first());</span>
<span style="color: #177500">/* more tests down here */</span>
</pre></div>

<p>This creates a nested array of test data where each inner array mocks a <code>post</code> stored in the database. If we have to do this more than once (maybe in an other test we insert this data into the database to test validations), we may put the snippet in the <code>setUp()</code> method. A better approach would be to move this code in fixture files. The <code>li3_fixtures</code> plugin tries to help you with that and provides a simple and convenient approach to integrate fixtures in your tests.</p>

<p>Before we can use the plugin, we need to install it first. <code>li3_fixtures</code> doesn&rsquo;t have any dependencies, so this is straightforward. Note that for now you need a rad-dev.org-account to clone the repository.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$ </span><span style="color: #A90D91">cd</span> /path/to/app/libraries
<span style="color: #000000">$ </span>git clone code@rad-dev.org:li3_fixtures.git
<span style="color: #000000">$ </span>mkdir /path/to/app/tests/fixtures
</pre></div>

<p>Now we need to tell our app to use the plugin, so fire up your editor and modify your <code>app/config/bootstrap/libraries.php</code>.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Libraries::add(</span><span style="color: #C41A16">&#39;li3_fixtures&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>After that, we can create a sample fixture file in <code>app/tests/fixtures/posts.json</code>. Currently only json-files are supported, but xml-support is planned.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">{
    &quot;post1&quot;: {
        &quot;title&quot;: &quot;My First Post&quot;,
        &quot;body&quot;: &quot;First Content...&quot;
    },
    &quot;post2&quot;: {
        &quot;title&quot;: &quot;My Second Post&quot;,
        &quot;body&quot;: &quot;Also some foobar text&quot;
    },
    {
        &quot;title&quot;: &quot;My Third Post&quot;,
        &quot;body&quot;: &quot;I like to write some foobar foo too&quot;
    }
}
</pre></div>

<p>Now that we have our fixture file in place, lets see how the <code>$this-&gt;assertEqual()</code> looks like (don&rsquo;t forget to use the <code>li3_fixtures</code> plugin with <code>use li3_fixtures\test\Fixture;</code>):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$fixtures</span> <span style="color: #000000">=</span> <span style="color: #000000">Fixture::load(</span><span style="color: #C41A16">&#39;Post&#39;</span><span style="color: #000000">);</span>
<span style="color: #000000">$this-&gt;assertEqual($fixtures-&gt;first(),</span> <span style="color: #000000">Post::first());</span>
</pre></div>

<p>By convention, your <code>$model</code> in <code>Fixture::load($model)</code>well be lowercased and pluralized by the Inflector (so &lsquo;Post&rsquo; loads &lsquo;posts.json&rsquo;). The <code>load</code>-method also takes an optional argument where you can override various default settings like the extension or location of the fixture-file.</p>

<p>As you can see, your test code is significantly smaller and easier to read. You may also notice the <code>first()</code>-method here. <code>li3_fixtures</code> makes use of the built in <code>lithium\util\Collection</code> class, which provides a powerful set of collection management methods like <code>first()</code>, <code>next()</code> or <code>prev()</code>. Check out the <code>lithium\util\Collection</code> documentation for more info on that.</p>

<p>The project can be found at <a href="http://rad-dev.org/li3_fixtures">rad-dev.org/li3_fixtures</a> and is maintained by me, so if you have any comments or questions, feel free to ask comment here or contact me directly.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">23 Nov 2010</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Write-your-own-Helper-with-Lithium/" class="post-title">Write your own Helper with Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Lithium comes with two helpers out of the box. The Form-Helper and the Html-Helper. Both are great and help you to make your View-Code more flexible, maintainable and easier to read.</p>

<p>But what do you do when you need a functionality that they don&rsquo;t provide? Right, you write your own. Let&rsquo;s imagine you want to tell your blog-readers how many posts you have stored in your database. In our first iteration our code might look like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">We</span> <span style="color: #000000">have</span> <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #A90D91">count</span>(<span style="color: #000000">$posts</span>) <span style="color: #633820">?&gt;</span> <span style="color: #000000">posts</span> <span style="color: #000000">stored</span> <span style="color: #A90D91">in</span> <span style="color: #000000">the</span> <span style="color: #000000">database</span>.
</pre></div>

<p>Looks great so far, but our code doesn&rsquo;t cover the case when we have only one post stored. Let&rsquo;s fix that:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">We</span> <span style="color: #000000">have</span> <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #A90D91">count</span>(<span style="color: #000000">$posts</span>) <span style="color: #633820">?&gt;</span> 
<span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">if</span>(<span style="color: #A90D91">count</span>(<span style="color: #000000">$posts</span>) <span style="color: #000000">!=</span> <span style="color: #1C01CE">1</span>)<span style="color: #000000">:</span> <span style="color: #633820">?&gt;</span>
    <span style="color: #000000">posts</span>
<span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">else</span><span style="color: #000000">:</span> <span style="color: #633820">?&gt;</span>
    <span style="color: #000000">post</span>
<span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">endif</span>; <span style="color: #633820">?&gt;</span>
<span style="color: #000000">stored</span> <span style="color: #A90D91">in</span> <span style="color: #000000">the</span> <span style="color: #000000">database</span>.
</pre></div>

<p>This works, but looks ugly and makes our View more complicated and messy (leaving aside that the above code is a bit verbose). To fix that, we write a custom <code>Word-Helper</code> that abstracts the count-stuff for our view.</p>

<p>Thankfully, the li3-developers thought about that and provide us with everything we need to get started. Lithium also automatically loads our helper if we want to access it. Let&rsquo;s assume that we want to call the helper with <code>$this-&gt;word-&gt;pluralize(count($posts), 'post')</code>.</p>

<p>We all love tests, so let&rsquo;s start with them first. We create a new <code>WordTest.php</code> (in <code>app/tests/cases/extensions/helper</code>) and add a some test cases.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">app\tests\cases\extensions\helper</span>;
<span style="color: #A90D91">use</span> <span style="color: #000000">app\extensions\helper\Word</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">WordTest</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\test\Unit</span> {
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">setUp</span>() {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">word</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Word</span>();
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testPluralize</span>() {
        <span style="color: #000000">$singular</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;post&#39;</span>;

        <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;1 post&#39;</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">word</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">pluralize</span>(<span style="color: #1C01CE">1</span>, <span style="color: #000000">$singular</span>));

        <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;0 posts&#39;</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">word</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">pluralize</span>(<span style="color: #1C01CE">0</span>, <span style="color: #000000">$singular</span>));

        <span style="color: #000000">$expected</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;2 posts&#39;</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">assertEqual</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">word</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">pluralize</span>(<span style="color: #1C01CE">2</span>, <span style="color: #000000">$singular</span>));
    }
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If we run the tests (<code>http://yourblog.com/test/app/tests/cases/extensions/helper/WordTest</code>), they will fail (as expected). In the <code>setUp</code>-method we try to instantiate the Word-Helper, but it doesn&rsquo;t exist yet. The <code>testPluralize</code>-method tests three different calls of our <code>Word::pluralize()</code> Helper-Method. To make our tests go green, we finally create our <code>Word</code>-Helper (in <code>app/extensions/helper/Word.php</code>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">app\extensions\helper</span>;
<span style="color: #A90D91">use</span> <span style="color: #000000">lithium\util\Inflector</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Word</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\template\Helper</span> {
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">pluralize</span>(<span style="color: #000000">$count</span>, <span style="color: #000000">$word</span>) {      
        <span style="color: #000000">$word</span> <span style="color: #000000">=</span> (<span style="color: #000000">$count</span> <span style="color: #000000">!=</span> <span style="color: #1C01CE">1</span> <span style="color: #000000">?</span> <span style="color: #000000">Inflector::</span><span style="color: #836C28">pluralize</span>(<span style="color: #000000">$word</span>) <span style="color: #000000">:</span> <span style="color: #000000">$word</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$count.</span><span style="color: #C41A16">&quot; &quot;</span><span style="color: #000000">.$word</span>;
    }
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Now re-run your tests - they should succeed. If they don&rsquo;t, please check that your files are named correctly and you don&rsquo;t have any typos in them.</p>

<p>Now it&rsquo;s time to call our brand-new helper from our view. Thanks to the <code>autoloading</code> feature, it&rsquo;s dead easy:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">We</span> <span style="color: #000000">have</span> <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">word</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">pluralize</span>(<span style="color: #A90D91">count</span>(<span style="color: #000000">$posts</span>), <span style="color: #C41A16">&#39;post&#39;</span>); <span style="color: #633820">?&gt;</span> <span style="color: #000000">stored</span> <span style="color: #A90D91">in</span> <span style="color: #000000">the</span> <span style="color: #000000">database</span>.
</pre></div>

<p>That&rsquo;s it - you&rsquo;ve just created your own View-Helper! If you have any questions or suggestions, feel free to comment below.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">20 Nov 2010</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Add-an-RSS-Feed-to-your-blog-with-Lithium/" class="post-title">Add an RSS-Feed to your blog with Lithium</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Adding an RSS-Feed to your blog with li3 is really straightforward, because all the infrastructure you need is already at your fingertips. I assume that you already have some posts stored in your database, you serve them to your users via <code>/posts</code> and the new RSS-File should be accessible via <code>/posts.rss</code>.</p>

<p>First, we need to tell Lithium that we want to add another Media-Type to our application. Add the following to your <code>app/config/bootstrap/media.php</code>-File (and don&rsquo;t forget to uncomment it in <code>app/config/bootstrap.php</code>). You can also comment the other code out in this file if you don&rsquo;t need it.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">use</span> <span style="color: #000000">lithium\net\http\Media;</span>
<span style="color: #000000">Media::type(</span><span style="color: #C41A16">&#39;rss&#39;</span><span style="color: #000000">,</span> <span style="color: #C41A16">&#39;application/rss+xml&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>Next, let&rsquo;s add a link to our <code>default.html.php</code>-Layout so that our feed shows up in the browser.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">html</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">link</span>(<span style="color: #C41A16">&#39;RSS-Feed&#39;</span>, <span style="color: #C41A16">&#39;/posts.rss&#39;</span>, <span style="color: #A90D91">array</span>(<span style="color: #C41A16">&#39;type&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;rss&#39;</span>)); <span style="color: #633820">?&gt;</span>
</pre></div>

<p>Before we start to create our RSS-Views, check that your <code>PostsController::index()</code>-Method looks something like this and returns one or more posts to the View.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">index</span>() {
    <span style="color: #000000">$posts</span> <span style="color: #000000">=</span> <span style="color: #000000">Post::all</span>(<span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;order&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;created&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;DESC&#39;</span>)));
    <span style="color: #A90D91">return</span> <span style="color: #000000">compact</span>(<span style="color: #C41A16">&#39;posts&#39;</span>);
}
</pre></div>

<p>Alright, first create a new <code>default.rss.php</code>-Layout (in <code>app/views/layouts</code>):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">echo</span> <span style="color: #C41A16">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&#39;</span>; <span style="color: #633820">?&gt;</span>
    <span style="color: #000000">&lt;rss</span> <span style="color: #836C28">version=</span><span style="color: #C41A16">&quot;2.0&quot;</span><span style="color: #000000">&gt;</span>
        <span style="color: #000000">&lt;channel&gt;</span>
            <span style="color: #000000">&lt;title&gt;</span>My cool Blog<span style="color: #000000">&lt;/title&gt;</span>
            <span style="color: #000000">&lt;description&gt;</span>A short description about my blog.<span style="color: #000000">&lt;/description&gt;</span>
            <span style="color: #000000">&lt;link&gt;</span>http://exampleblog.com/<span style="color: #000000">&lt;/link&gt;</span>
            <span style="color: #000000">&lt;lastBuildDate&gt;</span><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #A90D91">date</span>(<span style="color: #C41A16">&#39;D, d M Y g:i:s O&#39;</span>); <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/lastBuildDate&gt;</span>
            <span style="color: #000000">&lt;pubDate&gt;</span><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #A90D91">date</span>(<span style="color: #C41A16">&#39;D, d M Y g:i:s O&#39;</span>); <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/pubDate&gt;</span>
            <span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">content</span>(); <span style="color: #633820">?&gt;</span>
        <span style="color: #000000">&lt;/channel&gt;</span>
    <span style="color: #000000">&lt;/rss&gt;</span>
</pre></div>

<p>The previous code is just basic RSS-Markup. Feel free to add a custom title, description, link and so on. The <code>lastBuildDate</code> and <code>pubDate</code> are generated dynamically. <code>&lt;?= $this-&gt;content(); ?&gt;</code> will render our <code>posts</code>-View which we&rsquo;ll add now. Insert the following code in <code>app/views/posts/index.rss.php</code>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">    <span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">foreach</span>(<span style="color: #000000">$posts</span> <span style="color: #A90D91">As</span> <span style="color: #000000">$post</span>)<span style="color: #000000">:</span> <span style="color: #633820">?&gt;</span>
    <span style="color: #000000">&lt;item&gt;</span>
        <span style="color: #000000">&lt;title&gt;</span><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$post-&gt;</span><span style="color: #836C28">title</span>; <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/title&gt;</span>
        <span style="color: #000000">&lt;description&gt;</span><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$post-&gt;</span><span style="color: #836C28">teaser</span>; <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/description&gt;</span>
        <span style="color: #000000">&lt;link&gt;</span><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">html</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">link</span>(<span style="color: #000000">$post-&gt;</span><span style="color: #836C28">title</span>, <span style="color: #A90D91">array</span>(<span style="color: #C41A16">&#39;Posts::show&#39;</span>, <span style="color: #C41A16">&#39;slug&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$post-&gt;</span><span style="color: #836C28">slug</span>)); <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/link&gt;</span>
        <span style="color: #000000">&lt;guid</span> <span style="color: #836C28">isPermaLink=</span><span style="color: #C41A16">&quot;true&quot;</span><span style="color: #000000">&gt;</span>http://exampleblog.com/<span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #000000">$post-&gt;</span><span style="color: #836C28">slug</span> <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/guid&gt;</span>
        <span style="color: #000000">&lt;pubDate&gt;</span><span style="color: #633820">&lt;?</span><span style="color: #000000">=</span> <span style="color: #A90D91">date</span>(<span style="color: #C41A16">&#39;D, d M Y g:i:s O&#39;</span>, <span style="color: #000000">$post-&gt;</span><span style="color: #836C28">created</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">sec</span>); <span style="color: #633820">?&gt;</span><span style="color: #000000">&lt;/pubDate&gt;</span>
    <span style="color: #000000">&lt;/item&gt;</span>
    <span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">endforeach</span>; <span style="color: #633820">?&gt;</span>
</pre></div>

<p>You may need to modify the attributes according to your database schema. If you need help on this, feel free to contact me or ask in #li3 on FreeNode.</p>

<p>That&rsquo;s it! You&rsquo;ve added an RSS-Feed to your blog. You can now click the RSS-Icon in your browser or render it directly with <code>http://exampleblog.com/posts.rss</code>. BTW: that&rsquo;s exactly how I did it for this blog, so I hope that it should work for you too!</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/tags/php/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 3 of 4</span>
    
      <a href="/tags/php/page/4/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
		<li>&copy; Michael Nitschinger 2010-2016</li>
        </ul>
    </div>
</div>
<script src="http://nitschinger.at//js/all.min.js"></script>

        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
