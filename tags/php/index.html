<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Php &middot; daschl writes. sometimes.</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.15" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Php &middot; daschl writes. sometimes.">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Php &middot; daschl writes. sometimes.">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://nitschinger.at//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="daschl writes. sometimes." href="http://nitschinger.at//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://nitschinger.at/">daschl writes. sometimes.</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/daschl"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/daschl "><i class="fa fa-github-alt"></i> github</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="http://nitschinger.at//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">06 Aug 2013</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Useful-Couchbase-Resources-Blog-Posts/" class="post-title">Useful Couchbase Resources &amp; Blog Posts</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>The following list is a convenient way to get access to lots of resources, blog posts and material that have been shared throughout the past months. I tried to separate them by area, but of course lots of them overlap to some extent.</p>

<p>They are sorted by date (so you&rsquo;ll find the most recent ones on top) and include the author where possible. Be aware that some of the older articles may already be outdated  or not 100% accurate.</p>

<p>I&rsquo;ll try to update this page as new articles get published, so it may pay off to come back here from time to time and check out the topmost ones. If you want to see your article included, post them in the comments!</p>

<h2 id="starting-out:76a11daebb48e304a92800ea720c7bd4">Starting Out</h2>

<ul>
<li><a href="http://www.couchbase.com/docs/couchbase-manual-2.1.0/">Official Couchbase Server 2.1 Manual</a>: The official manual and a good starting point for all kinds of general-purpose and architectural questions.</li>
<li><a href="http://www.couchbase.com/docs/couchbase-devguide-2.1.0/">Couchbase Server 2.1 Developer Guide</a>: The developer guide is particularly useful for developers that are new to document modeling and general app-related questions.</li>
<li><a href="http://www.couchbase.com/communities">The Community Portal</a>: Starting point for all SDK-related questions and links.</li>
<li>2013-04-24 <a href="http://blog.couchbase.com/top-10-things-ops-sys-admin-must-know-about-couchbase">Top 10 things an Ops / Sys admin must know about Couchbase</a>: Ten short rules that sys admins that maintain Couchbase clusters should keep in mind.</li>
<li>2012-07-06 <a href="http://tugdualgrall.blogspot.co.at/2012/07/couchbase-101-install-store-and-query.html">Couchbase 101 : Install, Store and Query Data (tgrall)</a>: A very basic introduction for people starting out, teaching the very basics in a hands-on fashion.</li>
</ul>

<h2 id="installation-infrastructure:76a11daebb48e304a92800ea720c7bd4">Installation &amp; Infrastructure</h2>

<ul>
<li><a href="http://www.couchbase.com/docs/couchbase-manual-2.1.0/couchbase-getting-started.html">Official Installation Guide for 2.1</a>: The official installation guide, read this before installing on production systems.</li>
<li>2013-08-05 <a href="http://trondn.blogspot.no/2013/08/running-couchbase-211-on-smartos.html">Running Couchbase 2.1.1 on SmartOS (trondn)</a>: Learn how to - step by step - compile and run a Couchbase cluster on SmartOS. This is for all the Solaris fans out there!</li>
<li>2013-07-22 <a href="http://blog.couchbase.com/deploying-couchbase-chef">Deploying Couchbase with Chef (ketakigangal)</a>: If you use Chef to automate your infrastructure, this blog post shows you how to integrate Couchbase with it.</li>
<li>2013-07-11 <a href="http://tugdualgrall.blogspot.co.at/2013/07/deploy-your-nodecouchbase-application.html">Deploy your Node/Couchbase application to the cloud with Clever Cloud (tgrall)</a>: You&rsquo;ll learn how to deploy your Node.JS app with Couchbase onto &ldquo;clever cloud&rdquo;, a PaaS provider.</li>
<li>2013-06-27 <a href="http://www.ebruakagunduz.com/2013/06/nagios-plugin-to-monitor-couchbase.html?spref=tw">Nagios plugin to monitor Couchbase (Ebru Akagündüz)</a>: If you are using Nagios to monitor your infrastructure, this post shows you how to integrate Couchbase with a single plugin.</li>
<li>2013-05-31 <a href="http://tugdualgrall.blogspot.co.at/2013/05/create-couchbase-cluster-in-one-command.html">Create a Couchbase cluster in less than a minute with Ansible (tgrall)</a>: Create a Couchbase cluster automatically with Ansible, a systems automation framework like chef.</li>
<li>2013-05-27 <a href="http://nitschinger.at/A-Couchbase-Cluster-in-Minutes-with-Vagrant-and-Puppet">A Couchbase Cluster in Minutes with Vagrant and Puppet (daschl)</a>: If you want to setup a 4 node cluster with couchbase in minutes, this blog post shows you how to do it.</li>
</ul>

<h2 id="document-design-data-import-export:76a11daebb48e304a92800ea720c7bd4">Document Design &amp; Data Import/Export</h2>

<ul>
<li>2013-07-18 <a href="http://tugdualgrall.blogspot.co.at/2013/07/how-to-implement-document-versioning.html">How to implement Document Versioning with Couchbase (tgrall)</a>: See how to implement document versioning by using a key-based approach. Uses the Java SDK, but can be adapted for all languages.</li>
<li>2013-07-08 <a href="http://dev.theladders.com/2013/07/denormalize-the-datas-for-great-good">Denormalize the Datas for Great Good (John Connolly)</a>: See how TheLadders benefited from denormalizing its dataset and using Couchbase, greatly reducing their response times.</li>
<li>2013-07-03 <a href="http://tugdualgrall.blogspot.co.at/2013/07/sql-to-nosql-importing-data-from-rdbms.html">SQL to NoSQL : Copy your data from MySQL to Couchbase (tgrall)</a>: A Java-based tool to import data from a SQL database into Couchbase.</li>
</ul>

<h2 id="views:76a11daebb48e304a92800ea720c7bd4">Views</h2>

<ul>
<li>2013-07-25 <a href="http://blog.couchbase.com/caching-queries-couchbase-high-performance">Caching queries in Couchbase for high performance (Alexis Roos)</a>: Learn how to cache view results for better performance.</li>
<li>2013-07-12 <a href="http://blog.couchbase.com/calculating-average-document-size-documents-stored-couchbase">Calculating average document size of documents stored in Couchbase. (Alexis Roos)</a>: With a simple map and a custom reduce function, one can easily calculate the average document size in the bucket.</li>
<li>2013-06-14 <a href="http://avsej.net/2013/analyzing-binary-data-in-couchbase">Analyzing Binary Data in Couchbase (avsej)</a>: Shows how to access binary (non-json) data from a View. Uses ruby to store the data, but can be adapted to any language.</li>
<li>2013-02-18 <a href="http://tugdualgrall.blogspot.co.at/2013/02/how-to-get-latest-document-by-datetime.html">How to get the latest document by date/time field (tgrall)</a>: A simple example on how to sort View-data based on a timestamp.</li>
<li>2013-02-13 <a href="http://tugdualgrall.blogspot.co.at/2013/02/introduction-to-collated-views-with.html">Introduction to Collated Views with Couchbase 2.0 (tgrall)</a>: Views can also be used to output &ldquo;master/detail&rdquo;-like scenarios. This post shows how.</li>
</ul>

<h2 id="java-sdk-jvm:76a11daebb48e304a92800ea720c7bd4">Java SDK &amp; JVM</h2>

<ul>
<li><a href="http://www.couchbase.com/communities/java/getting-started">Getting Started &amp; Download</a>: The official &ldquo;Getting Started&rdquo; page for the Java SDK. Introduction, Tutorial and Downloads.</li>
<li>2013-05-16 <a href="http://nitschinger.at/Logging-with-the-Couchbase-Java-Client">Logging with the Couchbase Java Client (daschl)</a>: An in-depth post about how to correctly configure logging for the Java SDK (and the underlying spymemcached library).</li>
<li>2013-04-17 <a href="http://nitschinger.at/Couchbase-Java-SDK-Internals">Couchbase Java SDK Internals (daschl)</a>: A very detailed post about the inner workings of the Java SDK. Recommended for advanced users who want to understand more of the internals.</li>
<li>2012-12-30 <a href="http://tugdualgrall.blogspot.co.at/2012/12/couchbase-101-create-views-mapreduce.html">Couchbase 101: Create views (MapReduce) from your Java application (tgrall)</a>: How to create views and design documents directly from the Java SDK.</li>
<li>2012-11-05 <a href="http://tugdualgrall.blogspot.co.at/2012/11/couchbase-create-large-dataset-using.html">Couchbase : Create a large dataset using Twitter and Java (tgrall)</a>: Feed data from Twitter directly into your Couchbase cluster through the Java SDK.</li>
<li>2012-04-26 <a href="http://nitschinger.at/Accessing-Couchbase-from-Scala">Accessing Couchbase from Scala (daschl)</a>: How to access the Couchbase Java SDK from the Scala programing language.</li>
</ul>

<h2 id="net:76a11daebb48e304a92800ea720c7bd4">.NET</h2>

<ul>
<li><a href="http://www.couchbase.com/communities/net/getting-started">Getting Started &amp; Download</a>: The official &ldquo;Getting Started&rdquo; page for the .NET SDK. Introduction, Tutorial and Downloads.</li>
<li>2013-06-14 <a href="http://vimeo.com/68378224">Video: Code-First NoSQL with .NET and Couchbase (John Zablocki)</a>: A video where John Zablocki gives an introduction into NoSQL development and especially with Couchbase.</li>
<li>2013-03-06 <a href="http://blog.couchbase.com/net-couchbase-client-instrumentation-aspnet-and-glimpse">.NET Couchbase Client Instrumentation with ASP.NET and Glimpse (John Zablocki)</a>: See how to get your Couchbase server-side logging errors easily displayed in the browser console. Very helpful during development.</li>
<li>2013-02-01 <a href="http://blog.couchbase.com/moving-no-schema-stack-c-and-dynamic-types">Moving No Schema up the Stack with C# and Dynamic Types (John Zablocki)</a>: This blog post shows how to store schemaless data with both dictionaries and C#&rsquo;s dynamic typing.</li>
<li>2013-01-04 <a href="http://blog.couchbase.com/xdcr-aspnet-and-nancy">XDCR with ASP.NET and Nancy (John Zablocki)</a>: Learn how to build an XDCR endpoint (like ElasticSearch integration) and read the data through our XDCR mechanisms.</li>
<li>2012-10-23 <a href="http://blog.couchbase.com/using-c-domain-objects-define-couchbase-views">Using C# Domain Objects to Define Couchbase Views (John Zablocki)</a>: How to automatically create DesignDocuments based of C# domain objects.</li>
<li>2012-10-05 <a href="http://blog.couchbase.com/new-visual-studio-code-snippets-net-couchbase-client-library">New Visual Studio Code Snippets for the .NET Couchbase Client Library (John Zablocki)</a>: A collection of helpful snippets in the day-to-day development process.</li>
<li>2012-09-20 <a href="http://blog.couchbase.com/strongly-typed-views-net-client-library">Strongly Typed Views with the .NET Client Library (John Zablocki)</a>: Learn how to map View responses directly onto domain objects.</li>
<li>2012-08-01 <a href="http://blog.couchbase.com/introducing-couchbase-aspnet-outputcache-provider">Introducing the Couchbase ASP.NET OutputCache Provider (John Zablocki)</a>: A short post on how to use Couchbase for easy caching in the ASP.NET environment.</li>
</ul>

<h2 id="php:76a11daebb48e304a92800ea720c7bd4">PHP</h2>

<p>(Note: some of these posts are outdated in the way that currently the &ldquo;way to go&rdquo; when installing the PHP SDK is through PECL. See the the <a href="http://www.couchbase.com/communities/php/getting-started">Getting Started &amp; Download</a> guide for more information.)</p>

<ul>
<li><a href="http://www.couchbase.com/communities/php/getting-started">Getting Started &amp; Download</a>: The official &ldquo;Getting Started&rdquo; page for the PHP SDK. Introduction, Tutorial and Downloads.</li>
<li>2013-04-02  <a href="http://trondn.blogspot.co.at/2013/04/couchbase-php-xampp-and-windows.html">Couchbase, PHP, XAMPP and Windows (trondn)</a>: A short post on how to use the PHP SDK from Microsoft Windows.</li>
<li>2013-04-01 <a href="http://trondn.blogspot.co.at/2013/04/building-couchbase-php-driver-on-ubuntu.html">Building Couchbase PHP driver on Ubuntu (trondn)</a>: Learn how to build the Couchbase driver on Ubuntu and use it in a simple program.</li>
<li>2013-02-04 <a href="http://trondn.blogspot.co.at/2013/02/accessing-couchbase-from-php-on-your-mac.html">Accessing Couchbase from PHP on your Mac! (trondn)</a> Building and running the SDK on your Mac is easy, learn how to do it in this post.</li>
<li>2012-11-01 <a href="http://trondn.blogspot.co.at/2012/11/building-php-extension-for-couchbase-on.html">Building the PHP extension for Couchbase on Microsoft Windows! (trondn)</a>: Learn how to compile the SDK on Windows using Visual Studio 2008.</li>
<li>2012-06-25 <a href="http://nitschinger.at/How-to-store-PHP-sessions-in-Couchbase">How to store PHP sessions in Couchbase (daschl)</a>: This post shows how to store PHP sessions in Couchbase using different mechanims (not only the official SDK).</li>
<li>2012-06-21 <a href="http://nitschinger.at/Using-Couchbase-as-a-flexible-session-store">Using Couchbase as a flexible session store (daschl)</a>: With Couchbase Server 2.0, JSON data and Views, its easy to run metrics over your sessions and identify user behavior. Learn how in this post.</li>
</ul>

<h2 id="c-go:76a11daebb48e304a92800ea720c7bd4">C &amp; Go</h2>

<ul>
<li><a href="http://www.couchbase.com/communities/c/getting-started">Getting Started &amp; Download with the C SDK</a>: The official &ldquo;Getting Started&rdquo; page for the C SDK. Introduction, Tutorial and Downloads.</li>
<li><a href="https://github.com/couchbaselabs/go-couchbase">Official Go Client Repository</a>: The Go repository with code and simple examples.</li>
</ul>

<h2 id="ruby:76a11daebb48e304a92800ea720c7bd4">Ruby</h2>

<ul>
<li><a href="http://www.couchbase.com/communities/ruby/getting-started">Getting Started &amp; Download</a>: The official &ldquo;Getting Started&rdquo; page for the Ruby SDK. Introduction, Tutorial and Downloads.</li>
<li>2013-02-23 <a href="http://avsej.net/links/2013/couchbase-and-rails/">Couchbase and Rails Talk (avsej)</a>: A presentation by our lead Ruby SDK developer on how to integrate it with Ruby on Rails.</li>
<li>2013-02-11 <a href="http://blog.couchbase.com/using-couchbase-ruby-gem-eventmachine">Using Couchbase Ruby Gem with EventMachine (avsej)</a>: This post shows how to use the Ruby SDK together with the high performance EventMachine (custom protocols and performance for TCP/IP) gem.</li>
</ul>

<h2 id="node-js:76a11daebb48e304a92800ea720c7bd4">Node.JS</h2>

<ul>
<li>2013-03-06 <a href="http://tugdualgrall.blogspot.co.at/2013/03/easy-application-development-with.html">Easy application development with Couchbase, Angular and Node (tgrall)</a>: Storing Ideas and Votes in Couchbase with Angular and NodeJS.</li>
<li>2013-01-04 <a href="http://tugdualgrall.blogspot.co.at/2013/01/getting-started-with-couchbase-and.html">Getting started with Couchbase and node.js on Windows (tgrall)</a>: How to install and use the NodeJS Couchbase client library on Windows.</li>
<li>2012-11-13 <a href="http://tugdualgrall.blogspot.co.at/2012/11/building-chat-application-using-nodejs.html">Building a chat application using Node.js and Couchbase (tgrall)</a>: A nice chat application using Couchbase, NodeJS and socket.io for &ldquo;real time&rdquo; feeling.</li>
<li>2012-09-24 <a href="http://tugdualgrall.blogspot.co.at/2012/09/create-simple-nodejs-and-couchbase.html">Create a Simple Node.js and Couchbase application&hellip; on OS X (tgrall)</a> A simple (but maybe outdated) tutorial on how to use the NodeJS driver from OSX.</li>
</ul>

<h2 id="python:76a11daebb48e304a92800ea720c7bd4">Python</h2>

<ul>
<li><a href="http://www.couchbase.com/communities/python/getting-started">Getting Started &amp; Download</a>: The official &ldquo;Getting Started&rdquo; page for the Python SDK. Introduction, Tutorial and Downloads.</li>
<li>2013-06-21 <a href="http://mnunberg.github.io/2013/python-extension-windows-binaries">Python Extension Windows Binaries (mnunberg)</a>: A tale by our maintainer of the Python SDK on how to upload Windows binaries to PyPi.</li>
<li>2013-05-30 <a href="http://blog.couchbase.com/whats-python-couchbase-sdk">What&rsquo;s up with the Python Couchbase SDK (volker)</a>: A rundown of the latest changes on the Python SDK.</li>
</ul>

<h2 id="ecosystem:76a11daebb48e304a92800ea720c7bd4">Ecosystem</h2>

<ul>
<li>2013-07-31 <a href="http://www.ortussolutions.com/blog/couchbase-cluster-setup-orm-secondary-cache-introduction">Couchbase: Cluster Setup + ORM Secondary Cache Introduction (Brad Wood)</a>: Using ColdFusion and looking for a secondary cache implementation? Look no further.</li>
<li>2013-07-22 <a href="http://blog.jeroenreijn.com/2013/07/visitor-analysis-with-couchbase-elasticsearch.html">Real-time visitor analysis with Couchbase, Elasticsearch and Kibana (Jeroen Reijn)</a>: A great post on a customer&rsquo;s use case for real-time visitor analysis.</li>
</ul>

<h2 id="troubleshooting:76a11daebb48e304a92800ea720c7bd4">Troubleshooting</h2>

<ul>
<li><a href="http://www.couchbase.com/docs/couchbase-manual-2.1.0/couchbase-troubleshooting.html">Official troubleshooting Guide</a>: The best place to start if something goes wrong on the server and you don&rsquo;t know why.</li>
<li>2012-12-26 <a href="http://tugdualgrall.blogspot.co.at/2012/12/what-to-do-if-your-couchbase-server.html">What to do if your Couchbase Server does not start? (tgrall)</a>: If you have troubles getting older Couchbase Server 2.0 versions to run on Windows, this post is for you.</li>
</ul>

<h2 id="fun-stuff:76a11daebb48e304a92800ea720c7bd4">Fun Stuff</h2>

<ul>
<li><a href="https://github.com/couchbaselabs/DeveloperDay">Example code for lots of SDKs and Languages</a>: Our DeveloperDay material with hands-on code examples to try and learn.</li>
<li>2013-06-18 <a href="http://nitschinger.at/Fun-with-Couchbase-Views-and-Message-Pack">Fun with Couchbase Views and MessagePack (daschl)</a>: While JSON is tried and true, with a little twiggling and some fun you can get Couchbase Views to speak MessagePack!</li>
<li>2013-04-29 <a href="http://tugdualgrall.blogspot.co.at/2013/04/screencast-fun-with-couchbase-mapreduce.html">Screencast : Fun with Couchbase, MapReduce and Twitter (tgrall)</a>: A Screencast on importing Twitter data into Couchbase and analyzing it on the fly through Views.</li>
</ul>

<p>Last Updated: 2013-08-06 (daschl)</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">19 Feb 2013</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/A-Journey-on-Avoiding-Nulls-in-PHP/" class="post-title">A Journey on Avoiding Nulls in PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Let&rsquo;s face it: nulls are a hassle and lead to exceptions and inconsistent application state. <a href="http://en.wikipedia.org/wiki/Tony_Hoare">Tony Hoare</a>, the inventor of QuickSort, even calls it his <a href="http://qconlondon.com/london-2009/presentation/Null+References:+The+Billion+Dollar+Mistake">billion dollar mistake</a>.</p>

<p>While every developer has kind of accepted their existence, they are suddenly there when we&rsquo;d desperately need them to not show up. How often did you write<code>if($obj === null)</code> in your PHP code? Can&rsquo;t there be a better, more elegant and fault-tolerant solution to the problem?</p>

<p>It turns out that for example in <a href="http://www.scala-lang.org/">Scala</a>, you can avoid nulls by using the <a href="http://www.scala-lang.org/api/current/index.html#scala.Option">Option</a> class. It allows you to express in a clear way that the result of a - lets say - method can either be good (a reference to a valid object) or bad. In PHP, bad often means null. Scala then consequently provides method to access this object safely. You as the developer can choose at which point you want to get the value out, either by accessing it directly (and catching exceptions) or provide a sensible default value.</p>

<p>In Scala, you write code like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">/* An option with a value */
val a: Option[Int] = Some(5)
/* An option with no value */
val b: Option[Int] = None

/* Returns 5 */
a.getOrElse(0)
/* Returns 10 */
b.getOrElse(10)
</pre></div>

<p>You can also use helpful methods like <code>isDefined()</code> to peek into the object and see whats going on at runtime. All this is much more expressive than juggling around with a possible <code>null</code> value.</p>

<p>Java has the same issues as PHP, and it hurt Google so much that they integrated the concept of an <a href="http://code.google.com/p/guava-libraries/wiki/UsingAndAvoidingNullExplained">Optional</a> directly into the core of their <a href="http://code.google.com/p/guava-libraries/">Google Guava</a> Java library collection. I really like their code and use it in my Java projects, so I decided it would be an interesting project to port this to PHP. Since PHP isn&rsquo;t a statically typed language like Java, concepts like generics have been removed and some methods renamed (they look more like Scala&rsquo;s now), but in essence its the same.</p>

<h2 id="usage:d2267bd319f6db001a379c1a12ddc220">Usage</h2>

<p>Before digging into how it works, let&rsquo;s look at how we can use it. We only need to work with three classes called <code>Optional</code>, <code>Present</code> and <code>Absent</code>. <code>Optional</code> is the base class, <code>Present</code> and <code>Absent</code> inherit from it and provide the method bodies for their appropriate behavior.</p>

<p>The main idea is to fail fast when null is discovered and afterwards have a safe way of working with our value. Creating a <code>Optional</code> works through the static <code>of</code> method. We then have a range of methods available to inspect and fetch the output:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$possible</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">of</span>(<span style="color: #1C01CE">5</span>);
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">isPresent</span>()); <span style="color: #177500">// bool(true)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">get</span>()); <span style="color: #177500">// int(5)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrElse</span>(<span style="color: #1C01CE">99</span>)); <span style="color: #177500">// int(5)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrNull</span>()); <span style="color: #177500">// int(5)</span>
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If we&rsquo;re trying to call <code>of</code> with <code>null</code>, a <code>NullPointerException</code> is raised immediately. We can use the <code>fromNullable</code> method to handle this case safely:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$possible</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">of</span>(<span style="color: #A90D91">null</span>); <span style="color: #177500">// Throws &#39;NullPointerException&#39; with message &#39;Unallowed null in reference found.&#39;</span>
<span style="color: #000000">$possible</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #A90D91">null</span>);
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">isPresent</span>()); <span style="color: #177500">// bool(false)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">get</span>()); <span style="color: #177500">// Throws IllegalStateException</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrElse</span>(<span style="color: #1C01CE">99</span>)); <span style="color: #177500">// int(99)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrNull</span>()); <span style="color: #177500">// NULL</span>
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>We can even check the equality of the contained Optionals:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$val1</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #1C01CE">5</span>);
<span style="color: #000000">$val2</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #1C01CE">4</span>);
<span style="color: #000000">$val3</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #1C01CE">4</span>);

<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$val1-&gt;</span><span style="color: #836C28">equals</span>(<span style="color: #000000">$val2</span>)); <span style="color: #177500">// bool(false)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$val2-&gt;</span><span style="color: #836C28">equals</span>(<span style="color: #000000">$val3</span>)); <span style="color: #177500">// bool(true)</span>
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Now this simple examples are easy to grasp and this is a good thing. It&rsquo;s not about complexity here, it&rsquo;s about making it obvious that a value may or may not be null and handling it appropriately.</p>

<p>If you&rsquo;re accessing a method of a library, you need to check the return value every time if it&rsquo;s null to make sure you&rsquo;re not in an invalid state. If it&rsquo;s clear that the library is returning an instance of <code>Optional</code>, you know what to expect and how to deal with it appropriately.</p>

<h2 id="implementation:d2267bd319f6db001a379c1a12ddc220">Implementation</h2>

<p>Let&rsquo;s look at how this implemented.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">abstract</span> <span style="color: #A90D91">class</span> <span style="color: #3F6E75">Optional</span> {

    <span style="color: #A90D91">private</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>() {}

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * Returns an instance with no contained reference.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">absent</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">Absent::</span><span style="color: #836C28">instance</span>();
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * Returns an Optional instance containing the given non-null reference.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">of</span>(<span style="color: #000000">$reference</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Present</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">checkNotNull</span>(<span style="color: #000000">$reference</span>));
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * If reference is non-null, returns an Optional instance containing</span>
<span style="color: #C41A16">     * that reference; otherwise returns Absent.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">fromNullable</span>(<span style="color: #000000">$reference</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$reference</span> <span style="color: #000000">===</span> <span style="color: #A90D91">null</span> <span style="color: #000000">?</span> <span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">absent</span>() <span style="color: #000000">:</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Present</span>(<span style="color: #000000">$reference</span>);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">isPresent</span>();
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">get</span>();
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrElse</span>(<span style="color: #000000">$defaultValue</span>);
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrNull</span>();
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">equals</span>(<span style="color: #000000">$object</span>);

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * Make sure the passed reference is not null.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">checkNotNull</span>(<span style="color: #000000">$reference</span>, <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>) {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$message</span> <span style="color: #000000">===</span> <span style="color: #A90D91">null</span>) {
            <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;Unallowed null in reference found.&quot;</span>;
        }

        <span style="color: #A90D91">if</span>(<span style="color: #000000">$reference</span> <span style="color: #000000">===</span> <span style="color: #A90D91">null</span>) {
            <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">NullPointerException</span>(<span style="color: #000000">$message</span>);
        }
        <span style="color: #A90D91">return</span> <span style="color: #000000">$reference</span>;
    }


}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>This abstract class defines all of the methods we&rsquo;ll implement in <code>Present</code> and <code>Absent</code>, as well as all the static methods that you can call directly (especially the <code>of</code> and <code>fromNullable</code> methods). Note that in the appropriate places, <code>checkNotNull</code> is called which will throw a <code>NullPointerException</code> if a null is found. This adheres to the fail fast principle.</p>

<p>Now let&rsquo;s implement the <code>Absent</code> class, which represents the state where no reference is present (for example a null was passed in through <code>fromNullable</code>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Absent</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Optional</span> {

    <span style="color: #A90D91">private</span> <span style="color: #A90D91">static</span> <span style="color: #000000">$instance</span>;

    <span style="color: #A90D91">private</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>() {}

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">isPresent</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">get</span>() {
        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">IllegalStateException</span>(<span style="color: #C41A16">&quot;Optional-&gt;get() cannot be called on an absent value&quot;</span>);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrElse</span>(<span style="color: #000000">$defaultValue</span>) {
        <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;use Optional-&gt;orNull() instead of Optional-&gt;or(null)&quot;</span>;
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">checkNotNull</span>(<span style="color: #000000">$defaultValue</span>, <span style="color: #000000">$message</span>);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrNull</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">null</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">equals</span>(<span style="color: #000000">$object</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$object</span> <span style="color: #000000">===</span> <span style="color: #000000">$this</span>;
    }

    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">instance</span>() {
        <span style="color: #A90D91">if</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::$instance</span> <span style="color: #000000">==</span> <span style="color: #A90D91">null</span>) {
            <span style="color: #A90D91">return</span> <span style="color: #A90D91">static</span><span style="color: #000000">::$instance</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Absent</span>();
        }
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">static</span><span style="color: #000000">::$instance</span>;
    }

}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>The <code>$instance</code> variable is managed here through the singleton pattern. We only need one instance of <code>Absent</code>, this saves memory and CPU time. The other methods just implement the expected behaviour of something that is not available.</p>

<p>Finally, we can implement the <code>Present</code> class, which actually stores our instance if available.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Present</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Optional</span> {

    <span style="color: #A90D91">private</span> <span style="color: #000000">$reference</span>;

    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>(<span style="color: #000000">$reference</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span> <span style="color: #000000">=</span> <span style="color: #000000">$reference</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">isPresent</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">true</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">get</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrElse</span>(<span style="color: #000000">$defaultValue</span>) {
        <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;use Optional-&gt;orNull() instead of Optional-&gt;or(null)&quot;</span>;
        <span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">checkNotNull</span>(<span style="color: #000000">$defaultValue</span>, <span style="color: #000000">$message</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrNull</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span>;
    }


    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">equals</span>(<span style="color: #000000">$object</span>) {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$object</span> <span style="color: #000000">instanceof</span> <span style="color: #000000">Present</span>) {
            <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span> <span style="color: #000000">===</span> <span style="color: #000000">$object-&gt;</span><span style="color: #836C28">get</span>();
        }
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
    }
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>It looks the same as the <code>Absent</code> class, but manages to return our instance if necessary and implements the <code>equals</code> method to actually check with the given object.</p>

<p>Edit: Rasmus Schultz pointed out that he uses the ternary operator for lightweight null checks, you may want to <a href="http://blog.mindplay.dk/2013/02/the-or-else-operator-in-php-53.html">check out</a> his post too!</p>

<h2 id="summary:d2267bd319f6db001a379c1a12ddc220">Summary</h2>

<p>As you can see, the adoption of the <code>Optional</code> pattern can greatly increase the expressiveness of your code, by consequently avoiding null and its associated pitfalls. It also makes your code less error-prone, because you can&rsquo;t stumble upon nulls when using this pattern consequently.</p>

<p>This is kind of an experimental implementation, but I think putting this together in a utility library could drive the adoption in the PHP community. I&rsquo;m curious what you think about the concept and if it makes sense for you and your applications!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">30 Jan 2013</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Benchmarking-Cache-Transcoders-in-PHP/" class="post-title">Benchmarking Cache Transcoders in PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="motivation:1588be44ecdc8dc6ecb17e0152c89754">Motivation</h2>

<p>Storing PHP objects (or simpler data types like arrays) in caches always requires some kind of transformation. You need a way of encoding/decoding data so that it can be stored and loaded properly. In most languages, this process is known as object <a href="http://en.wikipedia.org/wiki/Serialization">serialization</a>. PHP provides a mechanism for this out of the box, but in this article we&rsquo;ll also look at <a href="http://pecl.php.net/package/igbinary">igbinary</a> as a drop-in replacement for the default serializer. We also compare the results to object transcoding based on <a href="http://json.org/">JSON</a>, which is not really an object serialization mechanism but commonly used as a data chache structure which has its own benefits and drawbacks.</p>

<p>As always, please take this benchmarks with a grain of salt. Don&rsquo;t take the absolute numbers as a reference, look at the differences and run the benchmarks in your environment to get accurate results that apply to your scenarios. If you spot any flaws in what is shown here, please point it out in the comments. This blog post is not some kind of &ldquo;advertising&rdquo; for a special mechanism and all different transcoders are discussed with their benefits and drawbacks.</p>

<p>If you want to compare your results to mine, I&rsquo;m using a MacBook Pro on Mac OS X 10.8.2 with the 2.3 GHz i7 and 16GB RAM. I&rsquo;m using PHP 5.4.11 (through <a href="https://github.com/josegonzalez/homebrew-php">homebrew-php</a>) instead of the shipped 5.3.</p>

<h2 id="the-php-serializer:1588be44ecdc8dc6ecb17e0152c89754">The PHP Serializer</h2>

<p>Out of the box, PHP provides a serialization mechanism on top of the <a href="http://php.net/manual/de/function.serialize.php">serialize</a> and <a href="http://www.php.net/manual/de/function.unserialize.php">unserialize</a> methods. By applying this method on a variable, it gets encoded to a byte stream and neither the type nor the structure gets lost (you can&rsquo;t store <a href="http://www.php.net/manual/en/language.types.resource.php">resources</a>).</p>

<p>So, let&rsquo;s look at a simple and a more complex example on how the transformation looks like:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Person</span> {
    <span style="color: #A90D91">private</span> <span style="color: #000000">$name</span>;

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>(<span style="color: #000000">$name</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">name</span> <span style="color: #000000">=</span> <span style="color: #000000">$name</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getName</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">name</span>;
    }
}

<span style="color: #000000">$simple</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(<span style="color: #C41A16">&quot;key&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;value&quot;</span>);
<span style="color: #000000">$complex</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Person</span>(<span style="color: #C41A16">&quot;Michael&quot;</span>);

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If we&rsquo;re calling <code>serialize()</code> on both variables, the output (as a string representation) looks like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$simpleSerialized</span> <span style="color: #000000">=</span> <span style="color: #A90D91">serialize</span>(<span style="color: #000000">$simple</span>);
<span style="color: #000000">$complexSerialized</span> <span style="color: #000000">=</span> <span style="color: #A90D91">serialize</span>(<span style="color: #000000">$complex</span>);

<span style="color: #177500">// string(28) &quot;a:1:{s:3:&quot;key&quot;;s:5:&quot;value&quot;;}&quot;</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #A90D91">serialize</span>(<span style="color: #000000">$simple</span>));

<span style="color: #177500">// string(51) &quot;O:6:&quot;Person&quot;:1:{s:12:&quot;\000Person\000name&quot;;s:7:&quot;Michael&quot;;}&quot;</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #A90D91">serialize</span>(<span style="color: #000000">$complex</span>));
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>While the resulting string is not designed for readability, you can clearly see that some metadata is added in order to make the unserialization possible. For example, the <code>key</code> string is serialized to <code>s:3:&quot;key&quot;</code> where the <code>s</code> means <code>string</code> and <code>3</code> is the string length. Also, <code>a</code> points to an <code>array</code> and <code>O</code> to an <code>object</code>.</p>

<p>We can now <code>unserialize()</code> the values and work with them as if they&rsquo;ve never been stored somewhere else:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$simpleUnserialized</span> <span style="color: #000000">=</span> <span style="color: #A90D91">unserialize</span>(<span style="color: #000000">$simpleSerialized</span>);
<span style="color: #000000">$complexUnserialized</span> <span style="color: #000000">=</span> <span style="color: #A90D91">unserialize</span>(<span style="color: #000000">$complexSerialized</span>);

<span style="color: #177500">// array(1) {&#39;key&#39; =&gt; string(5) &quot;value&quot;}</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$simpleUnserialized</span>);

<span style="color: #177500">// string(7) &quot;Michael&quot;</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$complexUnserialized-&gt;</span><span style="color: #836C28">getName</span>());
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>In practice, two characteristics are important: size of the serialized value and performance. While from a developer perspective performance is fun to explore, the size of the serialized object is what matters most. Performance differences are only measurable when running it in a loop with lots of iterations, while in practice you may only work with a few objects at a time per request.</p>

<p>Let&rsquo;s use a common caching scenario: imagine we&rsquo;re caching entity responses from an ORM framework like <a href="http://www.doctrine-project.org/">Doctrine</a>. Here is a blog post class that will be filled with life:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">BlogPost</span> {

    <span style="color: #A90D91">private</span> <span style="color: #000000">$title</span>;
    <span style="color: #A90D91">private</span> <span style="color: #000000">$teaser</span>;
    <span style="color: #A90D91">private</span> <span style="color: #000000">$author</span>;
    <span style="color: #A90D91">private</span> <span style="color: #000000">$body</span>;

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>(<span style="color: #000000">$title</span>, <span style="color: #000000">$teaser</span>, <span style="color: #000000">$author</span>, <span style="color: #000000">$body</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">title</span> <span style="color: #000000">=</span> <span style="color: #000000">$title</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">teaser</span> <span style="color: #000000">=</span> <span style="color: #000000">$teaser</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">author</span> <span style="color: #000000">=</span> <span style="color: #000000">$author</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span> <span style="color: #000000">=</span> <span style="color: #000000">$body</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getTitle</span>() { <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">title</span>; }
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getTeaser</span>() { <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">teaser</span>; }
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getAuthor</span>() { <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">author</span>; }
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getBody</span>() { <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span>; }

}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Please take this with a grain of salt, because since JSON transcoding is not able to store a 1:1 representation like <code>serialize</code>, we need to work around that a bit. More details and discussion will be provided in the JSON section.</p>

<p>Assume that a blog post with content has around 10k characters and about 10kb in size, lets create a crafted blog post:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$randomString</span> <span style="color: #000000">=</span> <span style="color: #A90D91">function</span> (<span style="color: #000000">$length</span>) {
    <span style="color: #000000">$chars</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 .&quot;</span>;    
    <span style="color: #000000">$str</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;&quot;</span>;
    <span style="color: #A90D91">for</span>( <span style="color: #000000">$i</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>; <span style="color: #000000">$i</span> <span style="color: #000000">&lt;</span> <span style="color: #000000">$length</span>; <span style="color: #000000">$i++</span> ) {
        <span style="color: #000000">$str</span> <span style="color: #000000">.=</span> <span style="color: #000000">$chars</span>[<span style="color: #A90D91">rand</span>(<span style="color: #1C01CE">0</span>, <span style="color: #A90D91">strlen</span>(<span style="color: #000000">$chars</span>)<span style="color: #000000">-</span><span style="color: #1C01CE">1</span>)];
    }
    <span style="color: #A90D91">return</span> <span style="color: #000000">$str</span>;
};

<span style="color: #000000">$title</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;How to measure caching transcoders&quot;</span>;
<span style="color: #000000">$teaser</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;This is a much longer introduction on how to measure caching transcoders. Feel free to post your own findings.&quot;</span>;
<span style="color: #000000">$author</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;daschl&quot;</span>;
<span style="color: #000000">$body</span> <span style="color: #000000">=</span> <span style="color: #000000">$randomString</span>(<span style="color: #1C01CE">10000</span>);

<span style="color: #000000">$post</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">BlogPost</span>(<span style="color: #000000">$title</span>, <span style="color: #000000">$teaser</span>, <span style="color: #000000">$author</span>, <span style="color: #000000">$body</span>);
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Now run <code>serialize</code> and <code>unserialize</code> in loops to measure performance as well as determine the resulting size of the object:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$iterations</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">10000</span>;
<span style="color: #000000">$start</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;$iterations</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$serialized</span> <span style="color: #000000">=</span> <span style="color: #A90D91">serialize</span>(<span style="color: #000000">$post</span>);
}
<span style="color: #000000">$end</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);

<span style="color: #A90D91">echo</span> <span style="color: #C41A16">&quot;Size: &quot;</span> <span style="color: #000000">.</span> <span style="color: #A90D91">strlen</span>(<span style="color: #000000">$serialized</span>) <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;\n&quot;</span>;
<span style="color: #A90D91">echo</span> (<span style="color: #000000">$end</span> <span style="color: #000000">-</span> <span style="color: #000000">$start</span>) <span style="color: #000000">*</span> <span style="color: #1C01CE">1000</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;Milliseconds\n&quot;</span>;
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>On my machine, to serialize 10000 objects it took about 33 milliseconds. The length of the resulting object (its string representation) is 10297 characters. This is kind of expected because the bulk of the object is the long article body. Before start comparing, we can already make one observation: its pretty fast. Now, let&rsquo;s move on to igbinary serialization and see how these results compare.</p>

<h2 id="serializing-with-igbinary:1588be44ecdc8dc6ecb17e0152c89754">Serializing with igbinary</h2>

<p>The <a href="http://pecl.php.net/package/igbinary">igbinary</a> extension was developed as a drop-in replacement for the default PHP serializer. Instead of storing the serialized object as a text, it is stored as binary data. You can install it either through PECL or compile it from source, either way before running the tests make sure you have the <code>igbinary</code> extension enabled:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">michael@daschlbook ~ $ php -m | grep igbinary
igbinary
</pre></div>

<p>Instead of using <code>serialize</code> or <code>unserialize</code>, igbinary provides us with appropriate <code>igbinary_serialize</code> and <code>igbinary_unserialize</code> functions. Now we can apply the same microbenchmark and see the results:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$iterations</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">10000</span>;
<span style="color: #000000">$start</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;$iterations</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$serialized</span> <span style="color: #000000">=</span> <span style="color: #000000">igbinary_serialize</span>(<span style="color: #000000">$post</span>);
}
<span style="color: #000000">$end</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);

<span style="color: #A90D91">echo</span> <span style="color: #C41A16">&quot;Size: &quot;</span> <span style="color: #000000">.</span> <span style="color: #A90D91">strlen</span>(<span style="color: #000000">$serialized</span>) <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;\n&quot;</span>;
<span style="color: #A90D91">echo</span> (<span style="color: #000000">$end</span> <span style="color: #000000">-</span> <span style="color: #000000">$start</span>) <span style="color: #000000">*</span> <span style="color: #1C01CE">1000</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;Milliseconds\n&quot;</span>;
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>With default settings, to serialize 10000 objects with igbinary it took 678 milliseconds. The length of the resulting object is 10244 characters. If you compare it with the default serialization mechanism, that is 20 times slower and the resulting object isn&rsquo;t much smaller either. Bummer - or not? Let&rsquo;s look at why this is happening.</p>

<p>Let&rsquo;s look at a different workload. Let&rsquo;s create a data structure which consist of 30 smaller blog posts and measure the statistics for both again (only doing 1000 iterations instead of 10000):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$posts</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>();
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;</span><span style="color: #1C01CE">30</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$posts</span>[] <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">BlogPost</span>(<span style="color: #000000">$title</span>, <span style="color: #000000">$teaser</span>, <span style="color: #000000">$author</span>, <span style="color: #000000">$randomString</span>(<span style="color: #1C01CE">50</span>));
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>The results are more interesting: on my machine igbinary takes about 95 milliseconds while serialize needs only 41 milliseconds. Now it&rsquo;s just 2 times slower. But here comes the important part: the resulting size of igbinary is 2385 characters, while serialize is 10467 characters! That&rsquo;s about 5 times smaller. Note that this gap increases the larger your PHP object gets (not in terms of long character strings but speaking of complexity like methods).</p>

<p>Note that the igbinary docs say you should set <code>igbinary.compact_strings</code> to <code>Off</code> to increase performance, but there was no real measurable difference in my testings.</p>

<p>There is one more thing we haven&rsquo;t compared: deserializing of previously serialized objects. We can take the same code from above, use the serialized part as input and measure the timings once again (not that we don&rsquo;t need to measure the size of the resulting object because we&rsquo;re creating a &ldquo;live&rdquo; object again):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$posts</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>();
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;</span><span style="color: #1C01CE">30</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$posts</span>[] <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">BlogPost</span>(<span style="color: #000000">$title</span>, <span style="color: #000000">$teaser</span>, <span style="color: #000000">$author</span>, <span style="color: #000000">$randomString</span>(<span style="color: #1C01CE">50</span>));
}

<span style="color: #000000">$serializedIgbinary</span> <span style="color: #000000">=</span> <span style="color: #000000">igbinary_serialize</span>(<span style="color: #000000">$posts</span>);
<span style="color: #000000">$serializedClassic</span> <span style="color: #000000">=</span> <span style="color: #A90D91">serialize</span>(<span style="color: #000000">$posts</span>);

<span style="color: #000000">$iterations</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">1000</span>;
<span style="color: #000000">$start</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;$iterations</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$unserialized</span> <span style="color: #000000">=</span> <span style="color: #000000">igbinary_unserialize</span>(<span style="color: #000000">$serializedIgbinary</span>);
}
<span style="color: #000000">$end</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);

<span style="color: #A90D91">echo</span> (<span style="color: #000000">$end</span> <span style="color: #000000">-</span> <span style="color: #000000">$start</span>) <span style="color: #000000">*</span> <span style="color: #1C01CE">1000</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;Milliseconds\n&quot;</span>;

<span style="color: #000000">$start</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;$iterations</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$unserialized</span> <span style="color: #000000">=</span> <span style="color: #A90D91">unserialize</span>(<span style="color: #000000">$serializedClassic</span>);
}
<span style="color: #000000">$end</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);

<span style="color: #A90D91">echo</span> (<span style="color: #000000">$end</span> <span style="color: #000000">-</span> <span style="color: #000000">$start</span>) <span style="color: #000000">*</span> <span style="color: #1C01CE">1000</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;Milliseconds\n&quot;</span>;
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>This is giving us very interesting results: igbinary takes 65 milliseconds while classic unserialize needs 82 milliseconds! So igbinary is faster here. This is pretty good news, because in practice you will need to unserialize (speak &ldquo;fetch from cache&rdquo;) much more often than to serialize (speak &ldquo;store in cache&rdquo;). That&rsquo;s the whole point of a cache.</p>

<p>Before we move on to JSON, I think it&rsquo;s fair to say that igbinary wins this comparison. Most of the time you want to store complex PHP objects and fetch them out fast and quickly. Of course it has the overhead of installing it as an extension, but since it&rsquo;s a drop-in replacement you can change your mind later (but take this with a grain of salt because you can only unserialize what was serialized with igbinary and vice versa - so you&rsquo;d need to fetch and restore them).</p>

<p>Finally, when you are storing very long strings in objects, both have pretty much the same overhead (because you can&rsquo;t &ldquo;compact&rdquo; this long string very well). One workaround may be to compress and decompress the string as needed, using a mixture of gzip and base64 encoding. When serializing PHP objects, you can use the <a href="http://www.php.net/manual/en/language.oop5.magic.php#object.sleep">__sleep</a> and <a href="http://www.php.net/manual/en/language.oop5.magic.php#object.wakeup">__wakeup</a> methods to perform these kind of transformations.</p>

<p>Adding these two methods to our <code>BlogPost</code> class results in a 20% saving when using the 10k random string again:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__sleep</span>() {
    <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span> <span style="color: #000000">=</span> <span style="color: #A90D91">gzdeflate</span>(<span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span>, <span style="color: #1C01CE">9</span>);
    <span style="color: #A90D91">return</span> <span style="color: #A90D91">array</span>(<span style="color: #C41A16">&#39;title&#39;</span>, <span style="color: #C41A16">&#39;teaser&#39;</span>, <span style="color: #C41A16">&#39;author&#39;</span>, <span style="color: #C41A16">&#39;body&#39;</span>);
}

<span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__wakeup</span>() {
    <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span> <span style="color: #000000">=</span> <span style="color: #A90D91">gzinflate</span>(<span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span>);
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Note that compressing takes time too, so measure if it makes sense in your case and the space savings are good enough. You also need the <code>zblib</code> extension to make this work properly.</p>

<h2 id="transcoding-on-top-of-json:1588be44ecdc8dc6ecb17e0152c89754">Transcoding on top of JSON</h2>

<p>First of all, JSON has not the same characteristics as serialization. This is just because JSON only supports a subset of the available data types that PHP supports and therefore encoding/decoding takes some extra steps on the application side. So why are we comparing it here? Well, JSON is used very often for storing data in caches. Not only is it human readable, it can also be used in combination with other languages and applications. Using JSON allows you to store cache information from a Java backend and use it in your PHP application. That doesn&rsquo;t work with traditional serialization approaches.</p>

<p>If you need a primer on JSON and PHP, <a href="http://nitschinger.at/Handling-JSON-like-a-boss-in-PHP">read</a> my other article first. PHP allows you to transcode all objects (except resources) through the <a href="http://www.php.net/manual/en/function.json-encode.php">json_encode</a> and <a href="http://www.php.net/manual/en/function.json-decode.php">json_decode</a> functions. Private and protected variables are not converted, so we either need to make them public or provide a custom method that exports a storable object structure. While we&rsquo;re at it, we can provide a static factory method that initializes our BlogPost from the returned JSON string:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">toJson</span>() {
    <span style="color: #A90D91">return</span> <span style="color: #A90D91">array</span>(
        <span style="color: #C41A16">&#39;title&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">title</span>,
        <span style="color: #C41A16">&#39;teaser&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">teaser</span>,
        <span style="color: #C41A16">&#39;author&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">author</span>,
        <span style="color: #C41A16">&#39;body&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">body</span>
    );
}

<span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">fromJson</span>(<span style="color: #000000">$json</span>) {
    <span style="color: #000000">$d</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_decode</span>(<span style="color: #000000">$json</span>, <span style="color: #A90D91">true</span>);
    <span style="color: #A90D91">return</span> <span style="color: #A90D91">new</span> <span style="color: #000000">BlogPost</span>(<span style="color: #000000">$d</span>[<span style="color: #C41A16">&#39;title&#39;</span>], <span style="color: #000000">$d</span>[<span style="color: #C41A16">&#39;teaser&#39;</span>], <span style="color: #000000">$d</span>[<span style="color: #C41A16">&#39;author&#39;</span>], <span style="color: #000000">$d</span>[<span style="color: #C41A16">&#39;body&#39;</span>]);
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Note that the <code>toJson()</code> method returns a simple representation of the object, which is much less complicated than a full serialization approach. Let&rsquo;s run our benchmark again:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$post</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">BlogPost</span>(<span style="color: #000000">$title</span>, <span style="color: #000000">$teaser</span>, <span style="color: #000000">$author</span>, <span style="color: #000000">$randomString</span>(<span style="color: #1C01CE">10000</span>));
<span style="color: #000000">$post</span> <span style="color: #000000">=</span> <span style="color: #000000">$post-&gt;</span><span style="color: #836C28">toJson</span>();

<span style="color: #000000">$iterations</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">10000</span>;
<span style="color: #000000">$start</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);
<span style="color: #A90D91">for</span>(<span style="color: #000000">$i=</span><span style="color: #1C01CE">0</span>;<span style="color: #000000">$i&lt;$iterations</span>;<span style="color: #000000">$i++</span>) {
    <span style="color: #000000">$encoded</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$post</span>);
}
<span style="color: #A90D91">echo</span> <span style="color: #C41A16">&quot;Size: &quot;</span> <span style="color: #000000">.</span> <span style="color: #A90D91">strlen</span>(<span style="color: #000000">$serialized</span>) <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;\n&quot;</span>;
<span style="color: #000000">$end</span> <span style="color: #000000">=</span> <span style="color: #A90D91">microtime</span>(<span style="color: #A90D91">true</span>);

<span style="color: #A90D91">echo</span> (<span style="color: #000000">$end</span> <span style="color: #000000">-</span> <span style="color: #000000">$start</span>) <span style="color: #000000">*</span> <span style="color: #1C01CE">1000</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&quot;Milliseconds\n&quot;</span>;
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>On my machine it takes 1.7 seconds (!) to complete the encoding. The resulting object size is 10196 bytes which is comparable to our earlier measurements (again, the large value dominates here). Testing it against complex objects is not interesting because we can&rsquo;t restore them anyway without further modifications. Running <code>json_decode</code> on the encoded object also takes around 1.5 seconds, so there is no major difference here.</p>

<p>Personally, I&rsquo;d expected to have JSON transcoding to perform better, but again normally you don&rsquo;t run 10k iterations in a row. When you break it down to 10 encodings they take about 1 millisecond which is okay for most scenarios (given we encode a really large objects with a few kb here). Smaller objects like user sessions will encode much faster.</p>

<p>Edit: a friendly reader on <a href="http://www.reddit.com/r/PHP/comments/17kcy3/benchmarking_cache_transcoders_in_php/">reddit</a> pointed out that you can (and should) use the <a href="http://www.php.net/manual/en/class.jsonserializable.php">JsonSerializable interface</a> instead of rolling your own method name like <code>toJson()</code>. Thanks!</p>

<p>Edit2: another reader pointed out that naming a method <code>toJson()</code> which does not return JSON but an array is misleading. I agree, so if you adapt this approach in your environment choose a better name like <code>prepareForJson()</code>, <code>toArray()</code> or use the <code>JsonSerializable</code> Interface as shown above.</p>

<h2 id="conclusion:1588be44ecdc8dc6ecb17e0152c89754">Conclusion</h2>

<p>After running these microbenchmarks, my conclusion is that when you need object serialization, go with igbinary. It provides good enough serialization performance and huge wins on object sizes. Decoding performance is also much better than out-ouf-the-box serialization. If you need interoperability with other applications or if you don&rsquo;t want to limit yourself to serialized PHP blobs, go with JSON. JSON requires much more hand wiring but you&rsquo;ll gain a lot of flexibility.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Jan 2013</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Caching-Doctrine-Entities-with-Couchbase/" class="post-title">Caching Doctrine Entities with Couchbase</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="motivation:cf67ea8c1c378f2ec2474b9e0692d877">Motivation</h2>

<p>As part of our ongoing efforts to make Couchbase more integrated with frameworks and libraries, we added caching support for the <a href="http://www.doctrine-project.org/">Doctrine ORM</a>. Recently, the pull request has been merged into the master branch and is scheduled to be published along with the <a href="http://doctrine-project.org/jira/browse/DCOM/fixforversion/10327">2.4</a> release.</p>

<p>Caching can either be used standalone (through the API provided by <a href="http://www.doctrine-project.org/projects/common.html">doctrine/common</a>) or integrated with the ORM functionality. We&rsquo;ll look at both variants through simple examples, a good documentation can also be found <a href="http://docs.doctrine-project.org/en/latest/reference/caching.html">here</a>. Note that at the time of writing, the CouchbaseCache is not mentioned as a caching driver because the documentation still needs to be updated.</p>

<p>Since 2.4 has not been released yet, we need to work against the <code>2.4.x-dev</code> branch. We&rsquo;ll be using <a href="http://getcomposer.org/">Composer</a> to fetch our dependencies, so just need change the version number if you want to pin it down to 2.4 later.</p>

<h2 id="simple-caching:cf67ea8c1c378f2ec2474b9e0692d877">Simple Caching</h2>

<p>Our first example shows how the caching API can be used directly. If you are familiar with the Couchbase API, you may think that it&rsquo;s more or less just a different API with the same (and maybe less) semantics, but the point is that it uses the Doctrine Cache API interface and as a result you can switch between different caching implementations very easily.</p>

<p>Create a directory called <code>couchbase-doctrine-simple</code> with the following <code>composer.json</code> inside:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">{
    &quot;require&quot;: {
        &quot;doctrine/common&quot;: &quot;2.4.x-dev&quot;,
        &quot;ext-couchbase&quot;: &quot;1.1.x&quot;
    }
}
</pre></div>

<p>This installs the <a href="https://packagist.org/packages/doctrine/common">doctrine/common</a> package and also makes sure that we have the <code>couchbase.so</code> extension in place. If you haven&rsquo;t installed the Couchbase PHP extension already, head over to the <a href="http://www.couchbase.com/develop/php/current">official website</a> and install it based on the tutorial and the docs.</p>

<p>Create a <code>index.php</code> with the following content (we&rsquo;ll break up the code afterwards):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #177500">// 0: Composer Autoloader</span>
<span style="color: #A90D91">require</span> <span style="color: #C41A16">&#39;vendor/autoload.php&#39;</span>;

<span style="color: #177500">// 1: Open the Couchbase Connection</span>
<span style="color: #000000">$couchbase</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #C41A16">&quot;127.0.0.1&quot;</span>, <span style="color: #C41A16">&quot;&quot;</span>, <span style="color: #C41A16">&quot;&quot;</span>, <span style="color: #C41A16">&quot;default&quot;</span>);

<span style="color: #177500">// 2: Instantiate the Driver &amp; Inject the Connection</span>
<span style="color: #000000">$cacheDriver</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">\Doctrine\Common\Cache\CouchbaseCache</span>();
<span style="color: #000000">$cacheDriver-&gt;</span><span style="color: #836C28">setCouchbase</span>(<span style="color: #000000">$couchbase</span>);

<span style="color: #177500">// 3: Execute your commands!</span>
<span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;my-cache-item&quot;</span>;

<span style="color: #A90D91">if</span>(<span style="color: #000000">!$cacheDriver-&gt;</span><span style="color: #836C28">contains</span>(<span style="color: #000000">$key</span>)) {
    <span style="color: #000000">$cacheDriver-&gt;</span><span style="color: #836C28">save</span>(<span style="color: #000000">$key</span>, <span style="color: #C41A16">&quot;my_data&quot;</span>);
} <span style="color: #A90D91">else</span> {
    <span style="color: #A90D91">echo</span> <span style="color: #000000">$cacheDriver-&gt;</span><span style="color: #836C28">fetch</span>(<span style="color: #000000">$key</span>);
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>First, we need to bootstrap the composer autoloader so we don&rsquo;t have to write all <code>require</code> statements on our own. The next thing we need to do is actually connect to the Couchbase cluster:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">// 1: Open the Couchbase Connection
$<span style="color: #000000">couchbase</span> = new Couchbase(&quot;127.0.0.1&quot;, &quot;&quot;, &quot;&quot;, &quot;default&quot;);
</pre></div>

<p>Here, we&rsquo;re connecting to a node in the cluster which points at <code>localhost</code>, but you can pass in an array of nodes as well. We connect to the <code>default</code> bucket, which has no password. Now that we have our connection established, we can instantiate the cache driver and inject our Couchbase client:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">// 2: Instantiate the Driver &amp; Inject the Connection
$<span style="color: #000000">cacheDriver</span> = new \Doctrine\Common\Cache\CouchbaseCache();
$<span style="color: #000000">cacheDriver</span>-&gt;setCouchbase($<span style="color: #000000">couchbase</span>);
</pre></div>

<p>From here on, the API is the same for all cache drivers. The following code checks if the cache contains a key. If it is present, it prints out the document but if it isn&rsquo;t it creates a new one. This is a very simple example but shows how you can start to use Couchbase caching in your own projects with just a few lines of bootstrapping!</p>

<p>Aside from these three methods, there is also a <code>delete</code> method available. Finally, you can pass an optional third param on <code>save</code> with a <code>$lifeTime</code> so that the cache item vanishes automatically.</p>

<p>Since Couchbase Server doesn&rsquo;t care what you store, you can also save and fetch any kind of datatype (aside from resources):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$<span style="color: #000000">cacheDriver</span>-&gt;save($<span style="color: #000000">key</span>, array(&#39;foo&#39; =&gt; &#39;bar&#39;));
var_dump($<span style="color: #000000">cacheDriver</span>-&gt;fetch($<span style="color: #000000">key</span>));
</pre></div>

<p>Note that when you use the driver at this level, try to store JSON strings when you can (use <code>json_encode</code>/<code>json_decode</code> on your datastructures) This way you can take advantage of the brand new view engine inside Couchbase Server 2.0. You can always just store serialized objects as well (like we need to do with ORM integration) since for Couchbase Server it&rsquo;s just a byte stream.</p>

<p>We can now build on this foundation and see how this works with ORM integration.</p>

<h2 id="orm-integration:cf67ea8c1c378f2ec2474b9e0692d877">ORM Integration</h2>

<p>Create a new directory called <code>couchbase-doctrine-orm</code> with the following <code>composer.json</code>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">{
    &quot;require&quot;: {
        &quot;doctrine/orm&quot;: &quot;2.4.x-dev&quot;,
        &quot;doctrine/dbal&quot;: &quot;2.4.x-dev&quot;,
        &quot;doctrine/common&quot;: &quot;2.4.x-dev&quot;,
        &quot;ext-couchbase&quot;: &quot;1.1.x&quot;
    },
    &quot;autoload&quot;: {
        &quot;psr-0&quot;: {
            &quot;Entities&quot;: &quot;src/&quot;
        }
    }
}
</pre></div>

<p>This time our <code>composer.json</code> file is a little bit longer, because we need to define all of our dependencies by hand (since we don&rsquo;t want to work against the stable release). Since we need to define Doctrine Entities we pass the composer autoloader the custom directory (<code>src/</code>).</p>

<p>The next thing we need is our actual entity that we want to manage through Doctrine. Go ahead and create a <code>Person.php</code> file inside the <code>src/Entities</code> directory with the following content:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>

<span style="color: #A90D91">namespace</span> <span style="color: #000000">Entities</span>;

<span style="color: #C41A16">/** @Entity */</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Person</span> {

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * @Id @Column(type=&quot;integer&quot;) @GeneratedValue(strategy=&quot;AUTO&quot;)</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">private</span> <span style="color: #000000">$id</span>;

    <span style="color: #C41A16">/** @Column(type=&quot;string&quot;) */</span>
    <span style="color: #A90D91">private</span> <span style="color: #000000">$firstname</span>;

    <span style="color: #C41A16">/** @Column(type=&quot;string&quot;) */</span>
    <span style="color: #A90D91">private</span> <span style="color: #000000">$lastname</span>;

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">setFirstname</span>(<span style="color: #000000">$firstname</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">firstname</span> <span style="color: #000000">=</span> <span style="color: #000000">$firstname</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getFirstname</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">firstname</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">setLastname</span>(<span style="color: #000000">$lastname</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">lastname</span> <span style="color: #000000">=</span> <span style="color: #000000">$lastname</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getLastname</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">lastname</span>;
    }

}

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>This is a very simple Doctrine Entity that has some properties and also a autogenerated <code>ID</code> field. I&rsquo;m going to use <a href="http://www.sqlite.org/">SQLite</a> in the following example, but feel free to use MySQL or any other relational database that you have available.</p>

<p>To wire everything together, we&rsquo;re going to create a <code>index.php</code> file in the root directory of the project. Again, here is the full content and we&rsquo;re going to break it apart afterwards:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #177500">// Composer autoloader.</span>
<span style="color: #000000">$loader</span> <span style="color: #000000">=</span> <span style="color: #A90D91">require</span> <span style="color: #C41A16">&#39;vendor/autoload.php&#39;</span>;

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * Initialize Couchbase &amp; the Cache.</span>
<span style="color: #C41A16"> */</span>
<span style="color: #000000">$couchbase</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #C41A16">&quot;127.0.0.1&quot;</span>, <span style="color: #C41A16">&quot;&quot;</span>, <span style="color: #C41A16">&quot;&quot;</span>, <span style="color: #C41A16">&quot;default&quot;</span>);
<span style="color: #000000">$cacheDriver</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">\Doctrine\Common\Cache\CouchbaseCache</span>();
<span style="color: #000000">$cacheDriver-&gt;</span><span style="color: #836C28">setCouchbase</span>(<span style="color: #000000">$couchbase</span>);


<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * Initialize the Entity Manager.</span>
<span style="color: #C41A16"> */</span>
<span style="color: #000000">$paths</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(<span style="color: #000000">__DIR__</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&#39;/src/Entities/&#39;</span>);
<span style="color: #000000">$isDevMode</span> <span style="color: #000000">=</span> <span style="color: #A90D91">true</span>;
<span style="color: #000000">$dbParams</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(
    <span style="color: #C41A16">&#39;driver&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pdo_sqlite&#39;</span>,
    <span style="color: #C41A16">&#39;user&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;root&#39;</span>,
    <span style="color: #C41A16">&#39;password&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;&#39;</span>,
    <span style="color: #C41A16">&#39;path&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">__DIR__</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&#39;/cbexample.sqlite&#39;</span>
);

<span style="color: #000000">$config</span> <span style="color: #000000">=</span> <span style="color: #000000">\Doctrine\ORM\Tools\Setup::</span><span style="color: #836C28">createAnnotationMetadataConfiguration</span>(<span style="color: #000000">$paths</span>, <span style="color: #000000">$isDevMode</span>, <span style="color: #A90D91">null</span>, <span style="color: #000000">$cacheDriver</span>);
<span style="color: #000000">$em</span> <span style="color: #000000">=</span> <span style="color: #000000">\Doctrine\ORM\EntityManager::</span><span style="color: #836C28">create</span>(<span style="color: #000000">$dbParams</span>, <span style="color: #000000">$config</span>);

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * Work with our Entities.</span>
<span style="color: #C41A16"> */</span>
<span style="color: #000000">$person</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">\Entities\Person</span>();
<span style="color: #000000">$person-&gt;</span><span style="color: #836C28">setFirstname</span>(<span style="color: #C41A16">&quot;Michael&quot;</span>);
<span style="color: #000000">$person-&gt;</span><span style="color: #836C28">setLastname</span>(<span style="color: #C41A16">&quot;Nitschinger&quot;</span>);

<span style="color: #000000">$em-&gt;</span><span style="color: #836C28">persist</span>(<span style="color: #000000">$person</span>);
<span style="color: #000000">$em-&gt;</span><span style="color: #836C28">flush</span>();

<span style="color: #177500">// Query with Result Cache</span>
<span style="color: #000000">$query</span> <span style="color: #000000">=</span> <span style="color: #000000">$em-&gt;</span><span style="color: #836C28">createQuery</span>(<span style="color: #C41A16">&#39;select p from Entities\Person p&#39;</span>);
<span style="color: #000000">$query-&gt;</span><span style="color: #836C28">useResultCache</span>(<span style="color: #A90D91">true</span>);
<span style="color: #000000">$results</span> <span style="color: #000000">=</span> <span style="color: #000000">$query-&gt;</span><span style="color: #836C28">getResult</span>();

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Since this may be a lot to grasp, let&rsquo;s break it into smaller sized chunks.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$<span style="color: #000000">couchbase</span> = new Couchbase(&quot;127.0.0.1&quot;, &quot;&quot;, &quot;&quot;, &quot;default&quot;);
$<span style="color: #000000">cacheDriver</span> = new \Doctrine\Common\Cache\CouchbaseCache();
$<span style="color: #000000">cacheDriver</span>-&gt;setCouchbase($<span style="color: #000000">couchbase</span>);
</pre></div>

<p>After our bootstrapping the autoloader, we&rsquo;re initializing the cache driver. You already know what this means because we&rsquo;ve used the same code in the simple example before.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$paths</span> <span style="color: #000000">=</span> <span style="color: #000000">array(__DIR__</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&#39;/src/Entities/&#39;</span><span style="color: #000000">);</span>
<span style="color: #000000">$isDevMode</span> <span style="color: #000000">=</span> <span style="color: #000000">true;</span>
<span style="color: #000000">$dbParams</span> <span style="color: #000000">=</span> <span style="color: #000000">array(</span>
    <span style="color: #C41A16">&#39;driver&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;pdo_sqlite&#39;</span><span style="color: #000000">,</span>
    <span style="color: #C41A16">&#39;user&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;root&#39;</span><span style="color: #000000">,</span>
    <span style="color: #C41A16">&#39;password&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;&#39;</span><span style="color: #000000">,</span>
    <span style="color: #C41A16">&#39;path&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">__DIR__</span> <span style="color: #000000">.</span> <span style="color: #C41A16">&#39;/cbexample.sqlite&#39;</span>
<span style="color: #000000">);</span>

<span style="color: #000000">$config</span> <span style="color: #000000">=</span> <span style="color: #000000">\Doctrine\ORM\Tools\Setup::createAnnotationMetadataConfiguration($paths,</span> <span style="color: #000000">$isDevMode,</span> <span style="color: #000000">null,</span> <span style="color: #000000">$cacheDriver);</span>
<span style="color: #000000">$em</span> <span style="color: #000000">=</span> <span style="color: #000000">\Doctrine\ORM\EntityManager::create($dbParams,</span> <span style="color: #000000">$config);</span>
</pre></div>

<p>The <code>\Doctrine\ORM\EntityManager</code> is one of the major building blocks inside Doctrine and needs to be initialized accordingly. Therefore, we need to provide it a valid configuration. Here we&rsquo;re going to use annotations (as seen on the Doctrine Entity, but you can also do it through XML or YAML). We also need to provide our database connection and the path to the entities. The important part here is that we pass the <code>$cacheDriver</code> to the factory method. This automatically initializes our <code>CouchbaseCache</code> to be used for all kinds of caching (Query, Metadata and Result caching).</p>

<p>Now we can go ahead and create a record:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$<span style="color: #000000">person</span> = new \Entities\Person();
$<span style="color: #000000">person</span>-&gt;setFirstname(&quot;Michael&quot;);
$<span style="color: #000000">person</span>-&gt;setLastname(&quot;Nitschinger&quot;);

$<span style="color: #000000">em</span>-&gt;persist($<span style="color: #000000">person</span>);
$<span style="color: #000000">em</span>-&gt;flush();
</pre></div>

<p>Afterwards, we can fetch it back through a query:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$<span style="color: #000000">query</span> = $<span style="color: #000000">em</span>-&gt;createQuery(&#39;select p from Entities\Person p&#39;);
$<span style="color: #000000">query</span>-&gt;useResultCache(true);
$<span style="color: #000000">results</span> = $<span style="color: #000000">query</span>-&gt;getResult();
</pre></div>

<p>Note that we explicitely tell it to cache this query result for us (by default, result caching won&rsquo;t be used). If open the browser and point it to your Couchbase Server 2.0 management UI, you can see that Doctrine did create lots of documents behind the scenes. These are subsequently used to boost your application performance.</p>

<h2 id="summary:cf67ea8c1c378f2ec2474b9e0692d877">Summary</h2>

<p>As you can see, using Couchbase as a Cache for Doctrine is not hard. You just need to initialize it and pass it into the configuration. From this point on, everything happens behind the scenes. And don&rsquo;t forget that you not only get exceptional performance, but also persistence, scalability and all the cool stuff that Couchbase Server provides out of the box.</p>

<p>If you have any questions or input, please let me know in the comments! Finally, thanks to <a href="https://twitter.com/Ocramius">Marco Pivetta</a> for helping me debug an <a href="https://github.com/doctrine/common/pull/240">issue</a> with ORM integration!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">07 Jul 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Announcing-the-Vienna-PHP-User-Group/" class="post-title">Announcing the Vienna PHP User Group</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve been looking for a decent PHP user group here in Vienna for some time. Sadly, I haven&rsquo;t found even a bad one. Now, I&rsquo;m trying to change this: meet <a href="http://viennaphp.org/">viennaphp.org</a>.</p>

<p>My goal is to create a friendly, welcoming and informative user group that allows beginners and experts alike to share their experiences, opinions and knowledge. I have always met great people when I worked with the open-source community and I think lots of people around here would benefit from it too.</p>

<p>So, what next? The first thing we need to do is identify a bunch of developers (including you) that is willing to help me bootstrap the user group. I think the best way to do this is to first gather online and then meet for a beer or two and discuss what we can do next.</p>

<p>Afterwards, I think it&rsquo;s time to find a location where we have the appropriate equipment available to do live presentations and sessions. So, if you know a place where we could do this, I&rsquo;d love to get in touch with you. Also, it would be awesome if someone is willing to sponsor food or drinks, but I think this could be handled at a later point.</p>

<p>Currently, the web site is pretty basic, but I&rsquo;m planning to add a wiki and a twitter feed so we can interact better. At the moment, you can follow <a href="https://twitter.com/ViennaPHP">@ViennaPHP</a> and tweet with the <a href="https://twitter.com/search/%23viennaphp">#viennaphp</a> hashtag.</p>

<p>Vienna PHP developers, unite!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">25 Jun 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/How-to-store-PHP-sessions-in-Couchbase/" class="post-title">How to store PHP sessions in Couchbase</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>My <a href="http://nitschinger.at/Using-Couchbase-as-a-flexible-session-store">last post</a> about storing sessions in Couchbase was more of a general overview on what&rsquo;s possible. This post builds on the foundations and principles discussed and shows you various ways to store PHP sessions in Couchbase. We start out simple by using the built-in <code>session</code> ini -directives, then head over to the brand new <a href="http://php.net/manual/en/class.sessionhandlerinterface.php">SessionHandlerInterface</a> introduced in PHP 5.4 and finally implement it completely on our own. We&rsquo;ll see how both the complexity and flexibility increase during each of our approaches. In the end it&rsquo;s up to you which method seems appropriate for your use-case.</p>

<h2 id="session-handler-and-memcached:70348acea5ad0f0c153f019a522d6d11">session_handler and memcached</h2>

<p>This approach has one big advantage: it&rsquo;s dead easy to setup and use. Let&rsquo;s tackle the good parts first and then discuss the weaknesses of this approach.</p>

<p>We are using the protocol-compatible nature of Couchbase and let the built-in <code>memcached</code> session handler do the job for us. So the first thing we need to do (apart from installing Couchbase) is install the <code>php5-memcached</code> extension. If you&rsquo;re on a debian-based system it&rsquo;s as easy as running</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$ </span>sudo aptitude install php5-memcached
</pre></div>

<p>If you want to make sure that the extension is correctly installed, check the module on the command line:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$ </span>php -m | grep mem
memcached
</pre></div>

<p>Now we need to tell PHP to use the <code>memcached</code> session handler and where it should save the data. To do this, we need to modify the <code>php.ini</code> file accordingly. I&rsquo;m using <a href="http://httpd.apache.org/">Apache</a> on <a href="http://www.ubuntu.com/">Ubuntu</a>, so my <code>php.ini</code> is located under <code>/etc/php5/apache2/php.ini</code>. Find and replace the following settings with their new values:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">[Session]</span>
<span style="color: #836C28">session.save_handler</span> <span style="color: #000000">=</span> <span style="color: #C41A16">memcached</span>
<span style="color: #836C28">session.save_path</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;localhost:11211&quot;</span>
</pre></div>

<p>Of course, you want to replace <code>localhost</code> with a different address if Couchbase is not running on your local machine. Couchbase uses <code>11211</code> as its <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-network-ports.html">data port</a>, just like memcached. Now we have everything in place, restart the server to get it up and running:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$ </span>sudo service apache2 restart
</pre></div>

<p>The infrastructure is in place, so we can now start working with the session store through the <code>$_SESSION</code> superglobal. Here is a short script that shows how you can work with it:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>

<span style="color: #177500">// Start the session.</span>
<span style="color: #A90D91">session_start</span>();

<span style="color: #177500">// Dump the session to the screen.</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$_SESSION</span>);

<span style="color: #177500">// Define some data to store.</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">User</span> { <span style="color: #A90D91">public</span> <span style="color: #000000">$firstname</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;hoo&quot;</span>; }
<span style="color: #000000">$user</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">User</span>();

<span style="color: #177500">// Store it in the session object.</span>
<span style="color: #000000">$_SESSION</span>[<span style="color: #C41A16">&#39;user&#39;</span>] <span style="color: #000000">=</span> <span style="color: #000000">$user</span>;
<span style="color: #000000">$_SESSION</span>[<span style="color: #C41A16">&#39;randomStuff&#39;</span>] <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(<span style="color: #1C01CE">1</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;blue&#39;</span>, <span style="color: #C41A16">&#39;couchbase&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;rocks&#39;</span>);

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>This is not rocket science and exactly the way you&rsquo;d handle sessions through the interface provided by PHP. Check out the <a href="http://php.net/manual/en/reserved.variables.session.php">documentation</a> if you haven&rsquo;t used it yet.</p>

<p>So, how does PHP store the data in Couchbase? The first thing to note is that all your session data is stored in the <code>default</code> bucket and uses a binary format (like how it would be stored in memcached). If you inspect the output from our example above, you can see that the user object is actually stored as an object so PHP uses the built-in serializer (if not configured differently) to store the session data. If you look in the bucket, you can see a key like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">memc.sess.key.a6sgl1oldchknlsj8mc3c37b11
</pre></div>

<p>The first part is the prefix and the cryptic string at the end is the PHP session identifier which is carried along by the client through a cookie. If you fire up firebug or chrome and inspect the headers, you can see the corresponding <code>PHPSESSID</code>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Cookie:PHPSESSID=a6sgl1oldchknlsj8mc3c37b11;</span>
</pre></div>

<p>The stored document looks like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">{</span>
&quot;_id&quot;: &quot;memc.sess.key.a6sgl1oldchknlsj8mc3c37b11&quot;,
&quot;_rev&quot;: &quot;10-000003794c342b870000009800000000&quot;,
&quot;$<span style="color: #000000">flags</span>&quot;: 0,
&quot;$<span style="color: #000000">expiration</span>&quot;: 0,
&quot;$<span style="color: #000000">att_reason</span>&quot;: &quot;invalid_json&quot;
}
</pre></div>

<p>Since the data is not stored in JSON format, you can&rsquo;t inspect it from the Couchbase GUI directly. So why did I include it here anyway? Look at the <code>$expiration</code> key. It is important to note that we don&rsquo;t specify an expiration time here, because this is handled through PHP. So if you want to change the expiration time you have to change the appropriate setting using the <code>session.cache_expire</code> directive. This is different to the approach we&rsquo;ll cover at the end of the article where we implement everything on our own and don&rsquo;t rely on those built-in features.</p>

<p>This approach is very simple and may suit your needs perfectly, but it comes with some limitations that you need to keep in mind.</p>

<p>Since the data is not stored in JSON format, you can&rsquo;t use the awesome map/reduce querying mechanisms that Couchbase 2.0 provides. Also, you can&rsquo;t change the bucket or key-names. Another problem is that you can&rsquo;t make use of the automatic, dynamic reconfiguration mechanisms provided by Couchbase. So if the server at the ip-address goes down, PHP won&rsquo;t be able to store sessions in the cluster anymore. Couchbase provides an optional component called <a href="http://www.couchbase.com/docs/moxi-manual-1.8/moxi-introduction.html">Moxi</a> that acts as a proxy between your client and the couchbase cluster and is able to handle such situations. So if you&rsquo;re not able to use the approaches shown in the rest of this post you definitely need to take a look at it!</p>

<h2 id="more-flexibility-through-the-sessionhandlerinterface:70348acea5ad0f0c153f019a522d6d11">More flexibility through the SessionHandlerInterface</h2>

<p>PHP 5.4 provides a brand new interface called <a href="http://www.php.net/manual/en/class.sessionhandlerinterface.php">SessionHandlerInterface</a> through which we can implement our own session handler. This way, we can use the familiar and built-in <code>$_SESSION</code> superglobal and make use of the advanced Couchbase functionality.</p>

<p>We need to implement the following interface:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">SessionHandlerInterface <span style="color: #000000">{</span>
    abstract public bool close ( void )
    abstract public bool destroy ( string $<span style="color: #000000">session_id</span> )
    abstract public bool gc ( string $<span style="color: #000000">maxlifetime</span> )
    abstract public bool open ( string $<span style="color: #000000">save_path</span> , string $<span style="color: #000000">session_id</span> )
    abstract public string read ( string $<span style="color: #000000">session_id</span> )
    abstract public bool write ( string $<span style="color: #000000">session_id</span> , string $<span style="color: #000000">session_data</span> )
}
</pre></div>

<p>The following implementation is not meant to be used 1:1 in production, since I haven&rsquo;t tested every aspect of it. Nevertheless it should give you an idea on how such a implementation may look like. Note that you need to have the <code>php-ext-couchbase</code> extension installed. If you are not sure on how to do this, see my post about <a href="http://nitschinger.at/Getting-Started-with-Couchbase-and-PHP">Getting Started with Couchbase and PHP</a>. You can also find a github gist <a href="https://gist.github.com/2986942">here</a>.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16">* A reference implementation of a custom Couchbase session handler.</span>
<span style="color: #C41A16">*/</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">CouchbaseSessionHandler</span> <span style="color: #A90D91">implements</span> <span style="color: #000000">SessionHandlerInterface</span> {

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Holds the Couchbase connection.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_connection</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * The Couchbase host and port.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_host</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * The Couchbase bucket name.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_bucket</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * The prefix to be used in Couchbase keynames.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_keyPrefix</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;session:&#39;</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Define a expiration time of 10 minutes.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_expire</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">600</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Set the default configuration params on init.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>(<span style="color: #000000">$host</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;127.0.0.1:8091&#39;</span>, <span style="color: #000000">$bucket</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;default&#39;</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_host</span> <span style="color: #000000">=</span> <span style="color: #000000">$host</span>;
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_bucket</span> <span style="color: #000000">=</span> <span style="color: #000000">$bucket</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Open the connection to Couchbase (called by PHP on `session_start()`)</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">open</span>(<span style="color: #000000">$savePath</span>, <span style="color: #000000">$sessionName</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_host</span>, <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_bucket</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span> <span style="color: #000000">?</span> <span style="color: #A90D91">true</span> <span style="color: #000000">:</span> <span style="color: #A90D91">false</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Close the connection. Called by PHP when the script ends.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">close</span>() {
        <span style="color: #A90D91">unset</span>(<span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span>);
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">true</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Read data from the session.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">read</span>(<span style="color: #000000">$sessionId</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;
        <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">get</span>(<span style="color: #000000">$key</span>);

        <span style="color: #A90D91">return</span> <span style="color: #000000">$result</span> <span style="color: #000000">?:</span> <span style="color: #A90D91">null</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Write data to the session.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">write</span>(<span style="color: #000000">$sessionId</span>, <span style="color: #000000">$sessionData</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;
        <span style="color: #A90D91">if</span>(<span style="color: #A90D91">empty</span>(<span style="color: #000000">$sessionData</span>)) {
            <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
        }

        <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">set</span>(<span style="color: #000000">$key</span>, <span style="color: #000000">$sessionData</span>, <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_expire</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$result</span> <span style="color: #000000">?</span> <span style="color: #A90D91">true</span> <span style="color: #000000">:</span> <span style="color: #A90D91">false</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Delete data from the session.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">destroy</span>(<span style="color: #000000">$sessionId</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;
        <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">delete</span>(<span style="color: #000000">$key</span>);

        <span style="color: #A90D91">return</span> <span style="color: #000000">$result</span> <span style="color: #000000">?</span> <span style="color: #A90D91">true</span> <span style="color: #000000">:</span> <span style="color: #A90D91">false</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Run the garbage collection.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">gc</span>(<span style="color: #000000">$maxLifetime</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">true</span>;
    }

}

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>It&rsquo;s not that complex as it may look like in the first place. At the top of the class we&rsquo;re defining and initializing some variables that hold our configuration. We don&rsquo;t have to do this, but this way we&rsquo;re getting a bit more flexibility and can pass custom settings through the constructor.</p>

<p>The <code>open</code> method takes two arguments (according to the interface definition), one for the <code>savePath</code> and one for the <code>sessionName</code>. These arguments correspond to the <code>ini</code>-settings, but we ignore them and make use of our configuration variables passed through the constructor. Inside the <code>open</code> method we initialize the connection to Couchbase and store the connection resource in a protected variable for later use.</p>

<p>The <code>close</code> method is called when the PHP-script ends. We just unset the resource, since there is nothing more to do in our case. If you use a file storage engine you&rsquo;d want to close the file-handle here.</p>

<p>From now on, we always get the <code>sessionId</code> passed as an argument. The <code>read</code> method takes it and adds zhr <code>keyPrefix</code> we&rsquo;ved defined to the beginning of the string. It then tries to read the record from Couchbase and returns it when it&rsquo;s found. Note that we return <code>null</code> here, but since <code>$_SESSION</code> is an array, you&rsquo;ll always work with (empty) arrays on the caller-side.</p>

<p>The <code>write</code> method gets the payload as an additional argument since we need to store it somewhere. Note that the data is already serialized, so don&rsquo;t try to use <code>json_encode</code> or something like this before storing it in Couchbase (that&rsquo;s what I did and then wondered what the hell is wrong unless someone on IRC pointed out that you can&rsquo;t control the serialization mechanism on your own here). As a result, the <code>read</code> method expects the serialized data as a string and fails silently if you return something else.</p>

<p>The <code>destroy</code> method should not contain any surprises, we just delete the document based on the key if it exists. The <code>gc</code> method is not used here, because Couchbase handles the garbage collection for us. If you store your data in files, you want to clean up old sessions here.</p>

<p>Now we can use our handler and do some work with it:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$handler</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">CouchbaseSessionHandler</span>();

<span style="color: #A90D91">session_set_save_handler</span>(<span style="color: #000000">$handler</span>, <span style="color: #A90D91">true</span>);
<span style="color: #A90D91">session_start</span>();

<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$_SESSION</span>);

<span style="color: #000000">$_SESSION</span>[<span style="color: #C41A16">&#39;foo&#39;</span>] <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>;
<span style="color: #000000">$_SESSION</span>[<span style="color: #C41A16">&#39;data&#39;</span>] <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(
    <span style="color: #C41A16">&#39;couchbase&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;rocks&#39;</span>
);
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>On the first load, the <code>$_SESSION</code> variable is of course empty. When you reload the page, you should see output like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">array(2) { &#39;foo&#39; =&gt; NULL &#39;data&#39; =&gt; array(1) { &#39;couchbase&#39; =&gt; string(5) &quot;rocks&quot; } }
</pre></div>

<p>In the Couchbase GUI, we can see that a key has been added to the <code>default</code> bucket named something like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">session:a6sgl1oldchknlsj8mc3c37b11</span>
</pre></div>

<p>Couchbase provides a handy tool on the command line to inspect our documents - it&rsquo;s called <code>cbc</code>. We can use it to fetch the contents of our key and peek inside:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$ </span>cbc cat session:a6sgl1oldchknlsj8mc3c37b11
<span style="color: #C41A16">&quot;session:a6sgl1oldchknlsj8mc3c37b11&quot;</span> Size <span style="color: #1C01CE">45</span> Flags 0x0 CAS 0x9d394b19130a0000
foo|N;data|a:1:<span style="color: #000000">{</span>s:9:<span style="color: #C41A16">&quot;couchbase&quot;</span>;s:5:<span style="color: #C41A16">&quot;rocks&quot;</span>;<span style="color: #000000">}</span>
</pre></div>

<p>You can see that the PHP session handler still stores the data in a serialized way (you can also <code>var_dump()</code> the content of the <code>$sessionData</code> variable handed over to our <code>write()</code> method to see the serialized data string).</p>

<p>This approach is a huge leap forward because it let&rsquo;s us shape the interaction with Couchbase the way we want it to (and we can leverage all commands from the Couchbase PHP-SDK instead of just using a subset provided by the memcached extension). Also, we use the expiration mechanism provided by Couchbase and don&rsquo;t have to handle it ourselves. Finally, by using the <code>php-ext-couchbase</code> SDK, we don&rsquo;t need to use Moxi anymore because this is all handled for us underneath by the <code>libcouchbase</code> C library. There is only one limitation left: we still can&rsquo;t use map/reduce functionality because the documents aren&rsquo;t stored in JSON format. To accomplish this, we&rsquo;re getting rid of the PHP session handler altogether and implement it for ourselves.</p>

<p>Chances are that you&rsquo;re still using PHP 5.3 or lower. If this is the case, you want to either use the <a href="http://at.php.net/manual/en/class.sessionhandler.php">old way</a> to define your session handler or just read on (because the method described below isn&rsquo;t bound to a specific PHP version).</p>

<h2 id="implementing-it-on-our-own:70348acea5ad0f0c153f019a522d6d11">Implementing it on our own</h2>

<p>When we implement the session handling mechanism on our own, we can reuse all insights from above and also use <a href="http://nitschinger.at/Handling-JSON-like-a-boss-in-PHP">JSON</a> instead of the PHP object serialization. Imagine we&rsquo;re writing yet another PHP framework (don&rsquo;t do that&hellip;) and define a session interface like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">framework\sessions</span>;

<span style="color: #A90D91">interface</span> <span style="color: #000000">SessionHandler</span> {
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">read</span>(<span style="color: #000000">$sessionId</span>);
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">write</span>(<span style="color: #000000">$sessionId</span>, <span style="color: #000000">$data</span>);
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">delete</span>(<span style="color: #000000">$sessionId</span>);
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">check</span>(<span style="color: #000000">$sessionId</span>);
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>The <code>read</code>, <code>write</code> and <code>delete</code> methods should be clear what they&rsquo;re doing. The <code>check</code> method checks if the given key is found in the session store.</p>

<p>Here&rsquo;s again the full implementation, we&rsquo;ll talk it through afterwards:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">framework\sessions</span>;

<span style="color: #A90D91">use</span> <span style="color: #000000">Couchbase</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">CouchbaseSessionHandler</span> <span style="color: #A90D91">implements</span> <span style="color: #000000">SessionHandler</span> {

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Holds the Couchbase connection.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_connection</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>;
    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * The prefix to be used in Couchbase keynames.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_keyPrefix</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;session:&#39;</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Define a expiration time of 10 minutes.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_expire</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">600</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Currently in development mode? Used for view loading.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$_development</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>;

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Connect to Couchbase.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>(<span style="color: #000000">$host</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;127.0.0.1:8091&#39;</span>, <span style="color: #000000">$bucket</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;default&#39;</span>, <span style="color: #000000">$dev</span> <span style="color: #000000">=</span> <span style="color: #A90D91">true</span>) {
            <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_development</span> <span style="color: #000000">=</span> <span style="color: #000000">$dev</span>;
            <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #000000">$host</span>, <span style="color: #000000">$bucket</span>);
            <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span> <span style="color: #000000">?</span> <span style="color: #A90D91">true</span> <span style="color: #000000">:</span> <span style="color: #A90D91">false</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Read the document for the given `sessionId`.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">read</span>(<span style="color: #000000">$sessionId</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;

        <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">get</span>(<span style="color: #000000">$key</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$data</span> <span style="color: #000000">?</span> <span style="color: #A90D91">json_decode</span>(<span style="color: #000000">$data</span>, <span style="color: #A90D91">true</span>) <span style="color: #000000">:</span> <span style="color: #A90D91">null</span>;
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Write the data.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">write</span>(<span style="color: #000000">$sessionId</span>, <span style="color: #000000">$data</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;
        <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #000000">$data</span> <span style="color: #000000">+</span> <span style="color: #A90D91">array</span>(<span style="color: #C41A16">&#39;type&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;session&#39;</span>);

        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">set</span>(<span style="color: #000000">$key</span>, <span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$data</span>), <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_expire</span>);
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Delete the data for the given `sessionId`.</span>
<span style="color: #C41A16">    */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">delete</span>(<span style="color: #000000">$sessionId</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;

        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">delete</span>(<span style="color: #000000">$key</span>);
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">    * Check if a document exists.</span>
<span style="color: #C41A16">    **/</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">check</span>(<span style="color: #000000">$sessionId</span>) {
        <span style="color: #000000">$key</span> <span style="color: #000000">=</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_keyPrefix</span> <span style="color: #000000">.</span> <span style="color: #000000">$sessionId</span>;
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connection</span><span style="color: #000000">-&gt;</span><span style="color: #836C28">get</span>(<span style="color: #000000">$key</span>) <span style="color: #000000">?</span> <span style="color: #A90D91">true</span> <span style="color: #000000">:</span> <span style="color: #A90D91">false</span>;
    }

}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>This implementation is pretty basic and should give you just an idea what&rsquo;s possible. Since we&rsquo;re storing JSON in Couchbase, you can get fancy and implement the <code>read</code> and <code>check</code> method not only on the <code>sessionId</code> level, but also do fine-grained inspection of the keys inside the JSON document.</p>

<p>The code provided here is very similar to the example above, with only minor changes. The first one is that we open the connection on <code>__construct</code> and don&rsquo;t have a <code>gc</code> method since we don&rsquo;t need it here. Inside <code>read</code> and <code>write</code> we make use of <code>json_encode</code> and <code>json_decode</code> to convert the PHP payload into JSON. The <code>check</code> method works in a similar fashion to <code>read</code> but returns <code>true/false</code> instead of the actual data.</p>

<p>Let&rsquo;s run some code against our implementation:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">use</span> <span style="color: #000000">framework\sessions\CouchbaseSessionHandler</span>;

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16">* Init the Handler.</span>
<span style="color: #C41A16">*/</span>
<span style="color: #000000">$handler</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">CouchbaseSessionHandler</span>();

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16">* Generate a Session ID for testing purposes.</span>
<span style="color: #C41A16">*/</span>
<span style="color: #000000">$sessionId</span> <span style="color: #000000">=</span> <span style="color: #A90D91">uniqid</span>();

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16">* Store and retreive.</span>
<span style="color: #C41A16">*/</span>
<span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(<span style="color: #C41A16">&#39;couchbase&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;rocks&#39;</span>);

<span style="color: #177500">// Write some data</span>
<span style="color: #000000">$handler-&gt;</span><span style="color: #836C28">write</span>(<span style="color: #000000">$sessionId</span>, <span style="color: #000000">$data</span>);

<span style="color: #177500">// Returns the array</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$handler-&gt;</span><span style="color: #836C28">read</span>(<span style="color: #000000">$sessionId</span>));

<span style="color: #177500">// Returns true</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$handler-&gt;</span><span style="color: #836C28">check</span>(<span style="color: #000000">$sessionId</span>));

<span style="color: #177500">// Delete the document</span>
<span style="color: #000000">$handler-&gt;</span><span style="color: #836C28">delete</span>(<span style="color: #000000">$sessionId</span>);

<span style="color: #177500">// Returns NULL</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$handler-&gt;</span><span style="color: #836C28">read</span>(<span style="color: #000000">$sessionId</span>));

<span style="color: #177500">// Returns false</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$handler-&gt;</span><span style="color: #836C28">check</span>(<span style="color: #000000">$sessionId</span>));

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If you comment out the <code>delete</code> part you can see that the document is stored as JSON in Couchbase. On the next request, you don&rsquo;t need the <code>write</code> call anymore since the data is loaded directly from Couchbase.</p>

<p>As a side note, my original idea was to implement a <code>clear</code> method that deletes all stored session documents. This is a perfect use-case for a view, but since the PHP extension with view support is still in a developer preview, <a href="http://www.couchbase.com/issues/browse/PCBC-76">something went wrong</a>. When this issue is resolved I&rsquo;ll write another blog post focusing on handling views. If you want to implement the <code>clear</code> method now, you can workaround <code>memcached</code>-style and maintain a separate document that just holds all keys of the current sessions. You can load this one and then delete all fetched keys.</p>

<h2 id="final-thoughts:70348acea5ad0f0c153f019a522d6d11">Final thoughts</h2>

<p>There are lots of possibilities on how you can use Couchbase to store your PHP sessions. If you just want to switch to Couchbase on the backend and don&rsquo;t want to touch your code at all, the first option is for you. If you&rsquo;ve used the built-in PHP session handling mechanisms and want to switch to a much more powerful storage engine, the second method may be a good fit. Finally, if you&rsquo;re using a PHP framework that uses its own adapters the last method provides the most flexibility and can be modified to suit all your needs.</p>

<p>Feel free to share your opinions below!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">21 Jun 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Using-Couchbase-as-a-flexible-session-store/" class="post-title">Using Couchbase as a flexible session store</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>This post shows you how you can use the <a href="http://www.couchbase.com">Couchbase 2.0 server</a> as a flexible session store. What do I mean by flexible? Well, the combination of a highly scalable key-value store and the possibility to query your data through views allows you to gain unique insight inside your data in near realtime.</p>

<p>Let&rsquo;s look at some obstacles that we as application developers face and then see how we may solve them through Couchbase and its functionality. Of course, there are lots of ways to solve the same problem domain and the solutions provided here may not fit your problem as good as another technology/stack/software. I&rsquo;d love to hear your opinions on this if you have a more elegant or flexible approach with a similar technology.</p>

<h2 id="introduction:512f62c3475e795b4e119166c489818f">Introduction</h2>

<p>The root of all session storage problems is that most web applications need to store some kind of state across pages and HTTP is by design <a href="http://en.wikipedia.org/wiki/Stateless_protocol">stateless</a>. Therefore, we need to use some of the solutions that were invented to fill exactly this gap.</p>

<p>As a developer, you can choose between storing session data either on the client-side or on the server-side. The client-side usually is a synonym for <a href="http://en.wikipedia.org/wiki/HTTP_cookie">cookies</a>, but new technologies like <a href="http://www.html5rocks.com/en/tutorials/offline/storage/">HTML 5 client-side storage</a> slowly emerge. Since cookies are stored on the client-side, they are not under complete control of the application and are therefore a possible security issue (and have size limitations that may be too small for your requirements). Solutions like <a href="http://nitschinger.at/Session-Encryption-with-Lithium">encryption</a> and <a href="http://en.wikipedia.org/wiki/HMAC">HMAC</a> exist, but still they lack the dynamic part of backend databases.</p>

<p>On the server-side, you can usually choose between either a storage mechanism provided by your language/application server or a standalone software. For example, PHP provides a <a href="http://www.php.net/manual/en/reserved.variables.session.php">$_SESSION</a> superglobal that stores data across requests.  In Java, you can work with <a href="http://docs.oracle.com/cd/E17802_01/webservices/webservices/docs/1.6/api/javax/servlet/http/HttpSession.html">HttpSession</a> objects that allow you to do the same. All these mechanisms have one limitation: they are bound to the application container/webserver where the application is executed (therefore, they are called &ldquo;sticky&rdquo;). This means that when we need to use more than one application server to scale out at the same time and a <a href="http://haproxy.1wt.eu/">proxy</a> (or load balancer) routes the requests randomly, it is possible that application server 1 has no idea what sessions are active on application server 2. As a result, a user may be logged out on the next request.</p>

<p>To overcome this issue, we need to refactor the session handling part out of the application server into a standalone software. This allows our application servers to read and write from a central session store and as a result all of them share the same session state.</p>

<p>One of the oldest and most used software solutions is <a href="http://memcached.org/">memcached</a>. Memcached was developed by <a href="http://www.danga.com/">Danga Interactive</a> to remedy the scalability issues at <a href="http://www.livejournal.com/">LiveJournal</a>. It provides a distributed memory object caching system that has a key-based lookup mechanism and is fast because all data is stored in-memory. While memcached is amazing, it has one major limitation: it doesn&rsquo;t persist the data on disk, so if one server goes down it may take some time to prime the cache again (called warm-up time).</p>

<p>Some developers identified the additional need and started a full protocol-compatible project that was eventually called <a href="http://en.wikipedia.org/wiki/Membase">Membase</a>. Aside from disk persistence, Membase provided more functionality like replication and live cluster reconfiguration. In 2011, Membase merged with CouchOone (the main driver behind <a href="http://couchdb.apache.org/">Apache CouchDB</a>) to form <a href="http://www.couchbase.com/">Couchbase</a>. Couchbase 1.8 is basically a renamed and slightly enhanced version of Membase, while Couchbase 2.0 (currently in developer preview release) adds incremental map/reduce, distributed indexing and cross-cluster replication.</p>

<p>That&rsquo;s the short story on the origins of Couchbase. Note that there are lots of other awesome projects out there that help you achieve similar results, with <a href="http://redis.io/">Redis</a>, <a href="http://www.mongodb.org/">MongoDB</a> or <a href="http://wiki.basho.com/">Riak</a> as the more prominent ones. Espcially Redis provides more powerful data structures on top of the &ldquo;key/value&rdquo; pattern and is definitely worth a look.</p>

<h2 id="implementation:512f62c3475e795b4e119166c489818f">Implementation</h2>

<p>The most simple use case that all session stores need to fulfill is - of course - to store and read session data in a very performant way. Most of the time, a unique session identifier is used as the key and some arbitrary payload as the value (for example usernames, ids or other related data).</p>

<p>Note that this post aims to be a SDK-independent introduction to the topic, and the exact syntax may vary a bit from SDK to SDK (I&rsquo;m using PHP here, but the syntax is nearly identical for the other SDKs). As the Couchbase API is similar to memcached, you should feel right at home if you&rsquo;ve used it already (at least for the basic commands).</p>

<p>Couchbase provides you with <code>get</code> and <code>set</code> methods to read and store a value identified by a unique key. The key should be a string and the value preferably a JSON object. You can also store serialized or binary data, but you then loose the ability to query it through views. On the <code>set</code>-command, you can also pass in an optional expiration time, which comes in handy if you want to expire sessions automatically. Here&rsquo;s an example to store a session document:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$user</span> <span style="color: #000000">=</span> <span style="color: #000000">array(</span>
    <span style="color: #C41A16">&#39;username&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;daschl&#39;</span><span style="color: #000000">,</span>
    <span style="color: #C41A16">&#39;fullname&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Michael Nitschinger&#39;</span>
<span style="color: #000000">);</span>
<span style="color: #000000">$document</span> <span style="color: #000000">=</span> <span style="color: #000000">json_encode($user);</span>
<span style="color: #000000">$couchbase-&gt;set(</span><span style="color: #C41A16">&#39;user:1234&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">$document,</span> <span style="color: #000000">60);</span>
</pre></div>

<p>This stores the given JSON document with the key <code>user:1234</code> and a expiry time of 60 seconds in Couchbase. If you provide a expiry time that is larger than 30 days, Couchbase assumes that you pass in a unix timestamp (as a result, you can also pass absolute timestamps instead of relative ones).</p>

<p>To read it back afterwards, you can use the <code>get</code> method:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$couchbase-&gt;get(</span><span style="color: #C41A16">&#39;user:1234&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>If you want to delete the key (for example to destroy the session), you can just remove the key:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$couchbase-&gt;delete(</span><span style="color: #C41A16">&#39;user:1234&#39;</span><span style="color: #000000">);</span>
</pre></div>

<p>You can also just &ldquo;touch&rdquo; the document, so that the expiry key will be refreshed:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">$couchbase-&gt;touch(</span><span style="color: #C41A16">&#39;user:1234&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">60);</span>
</pre></div>

<p>Of course that&rsquo;s just the simplest use case, but it is often enough to start with. If you&rsquo;re curious, you can also <a href="http://www.couchbase.com/docs/couchbase-sdk-php-1.1/api-reference-summary.html">look into</a> <code>getMulti</code> and <code>setMulti</code> to fetch more keys at the same time. One thing to remember is that when you specify an expiration time the key will only be deleted on the next fetch and not automatically. If you have a large batch of keys that you want to remove you need some kind of background script that touches them and makes sure they are actually deleted. Note that you can also wait for the Couchbase background job to delete the expired keys for you which runs every hour by default.</p>

<p>Now, all of this can be done with nearly every key/value store out there (let&rsquo;s leave the other capabilities like replication and persistence out for now). Since CouchOne merged with Membase, Couchbase 2.0 includes a key feature of CouchDB: accessing your data through views.</p>

<p>Let&rsquo;s assume we want to write an admin dashboard that allows us to monitor some of our application KPIs to help us understand the current load it is facing. To achieve this, we want to graph the following information in realtime:</p>

<ul>
<li>How many users are currently active on the website.</li>
<li>How many users are currently logged in.</li>
<li>All users that come from Vienna/Austria (since our website sells local food here in Austria).</li>
</ul>

<p>In order to achieve this, we need some way to differentiate if a user is just visiting the website or is logged in. Also, we need to store the location from where he is coming. Since this a more-or-less SDK-agnostic post, here are some hints how this could be done:</p>

<p>When an anonymous user requests our website, we initiate a session that identifies him by his ip-address and does a lookup of his location based on some external information (for example the <a href="http://www.maxmind.com/app/geolite">MaxMind GeoLite database</a>). We store a session identifier in a cookie and the following document in Couchbase:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">// Key: user:&lt;SESSION-IDENTIFIER&gt;
{
    &quot;namespace&quot;: &quot;sessions&quot;,
    &quot;type&quot;: &quot;anonymous&quot;,
    &quot;lastSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;firstSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;remoteAddress&quot;: &quot;&lt;ipaddr&gt;&quot;,
    &quot;location&quot;: &quot;Vienna/Austria&quot;
}
</pre></div>

<p>If the user is logged in, we can clear the old session and instantiate a new one with more details about our user:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">// Key: user:&lt;SESSION-IDENTIFIER&gt;
{
    &quot;namespace&quot;: &quot;sessions&quot;,
    &quot;type&quot;: &quot;user&quot;,
    &quot;userID&quot;: &quot;&lt;userID&gt;&quot;,
    &quot;lastSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;firstSeen&quot;: &quot;&lt;timestamp&gt;&quot;,
    &quot;remoteAddress&quot;: &quot;&lt;ipaddr&gt;&quot;,
    &quot;location&quot;: &quot;Vienna/Austria&quot;,
    &quot;name&quot;: &quot;&lt;full name&gt;&quot;
}
</pre></div>

<p>The whole store, delete and update calls can be done with the basic methods described above, but what I want to concentrate on are the views. If you want to follow along, here is a short PHP script that populates the default bucket with some data to work with:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
    <span style="color: #177500">// Open the Connection</span>
    <span style="color: #000000">$couchbase</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #C41A16">&quot;127.0.0.1:8091&quot;</span>);

    <span style="color: #177500">// Create some fake data with random hashes to simulate session identifiers.</span>
    <span style="color: #000000">$data</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(
        <span style="color: #C41A16">&#39;68ea304124beaa7e648cc1327d793b0a&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">array</span>(
            <span style="color: #C41A16">&#39;namespace&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;sessions&#39;</span>,
            <span style="color: #C41A16">&#39;type&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;anonymous&#39;</span>,
            <span style="color: #C41A16">&#39;lastSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>(),
            <span style="color: #C41A16">&#39;firstSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>(),
            <span style="color: #C41A16">&#39;remoteAddress&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;192.168.0.1&#39;</span>,
            <span style="color: #C41A16">&#39;location&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Vienna/Austria&#39;</span>
        ),
        <span style="color: #C41A16">&#39;6254b64d554a88b629bdbfc507d8c267&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">array</span>(
            <span style="color: #C41A16">&#39;namespace&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;sessions&#39;</span>,
            <span style="color: #C41A16">&#39;type&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;anonymous&#39;</span>,
            <span style="color: #C41A16">&#39;lastSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>(),
            <span style="color: #C41A16">&#39;firstSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>()<span style="color: #000000">-</span><span style="color: #1C01CE">3600</span>,
            <span style="color: #C41A16">&#39;remoteAddress&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;10.10.10.10&#39;</span>,
            <span style="color: #C41A16">&#39;location&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Berlin/Germany&#39;</span>
        ),
        <span style="color: #C41A16">&#39;6148bae4fad02c0edfd7dbd8d54d79f1&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">array</span>(
            <span style="color: #C41A16">&#39;namespace&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;sessions&#39;</span>,
            <span style="color: #C41A16">&quot;type&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;user&quot;</span>,
            <span style="color: #C41A16">&quot;userID&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;1234&quot;</span>,
            <span style="color: #C41A16">&#39;lastSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>()<span style="color: #000000">-</span><span style="color: #1C01CE">7200</span>,
            <span style="color: #C41A16">&#39;firstSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>()<span style="color: #000000">-</span><span style="color: #1C01CE">7800</span>,
            <span style="color: #C41A16">&quot;remoteAddress&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;1.2.3.4&quot;</span>,
            <span style="color: #C41A16">&quot;location&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;Rome/Italy&quot;</span>,
            <span style="color: #C41A16">&quot;name&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;Luigi Manfrotto&quot;</span>
        ),
        <span style="color: #C41A16">&#39;4aeb265e299c41450dd6af813d0bef97&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">array</span>(
            <span style="color: #C41A16">&#39;namespace&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;sessions&#39;</span>,
            <span style="color: #C41A16">&quot;type&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;user&quot;</span>,
            <span style="color: #C41A16">&quot;userID&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;1104&quot;</span>,
            <span style="color: #C41A16">&#39;lastSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>(),
            <span style="color: #C41A16">&#39;firstSeen&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">time</span>(),
            <span style="color: #C41A16">&quot;remoteAddress&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;2.3.4.5&quot;</span>,
            <span style="color: #C41A16">&quot;location&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;Vienna/Austria&quot;</span>,
            <span style="color: #C41A16">&quot;name&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;Hans Huber&quot;</span>
        )
    );

    <span style="color: #177500">// Store the documents in Couchbase</span>
    <span style="color: #A90D91">foreach</span>(<span style="color: #000000">$data</span> <span style="color: #A90D91">as</span> <span style="color: #000000">$hash</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$document</span>) {
        <span style="color: #000000">$couchbase-&gt;</span><span style="color: #836C28">set</span>(<span style="color: #C41A16">&quot;user:$hash&quot;</span>, <span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$document</span>));
    }
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Now that we have four documents to work with, we can start creating views from the Couchbase GUI. Head over to the &ldquo;Views&rdquo; section and click on &ldquo;Create Development View&rdquo;. The way Couchbase works is that you write your view queries in development mode on a subset of your documents and when you&rsquo;re finished you can publish them to production. Since we have only four documents in the bucket, it won&rsquo;t make any difference here.</p>

<p>The name of our design document is <code>_design/dev_sessions</code> and the first view is called <code>active</code>. This one will return all currently logged in users:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">function</span> (<span style="color: #000000">doc</span>) {
    <span style="color: #A90D91">if</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">namespace</span> <span style="color: #000000">==</span> <span style="color: #C41A16">&#39;sessions&#39;</span>) {
        <span style="color: #000000">emit</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">_id</span>, <span style="color: #000000">doc</span>);
    }
}
</pre></div>

<p>If you save it and click <code>Show Results</code>, then you&rsquo;ll see all four documents below that got matched. You can also click on the URI string above <code>?connection_timeout=60000&amp;limit=10&amp;skip=0</code> to see the actual response in your browser. But what if we just want the total number of users logged in? We can use a built-in reduce function for that. In the &ldquo;Reduce&rdquo; textarea to the right just enter <code>_count</code>. If you click save and then show the results again, you can see that we just got one document back with no key and just <code>4</code> as the value.</p>

<p>The nice thing here is that we can pass <code>reduce=true/false</code> as a param and then get either the full response back or just the aggregated version. So this query gives us all active users on the website. Let&rsquo;s write another view that just returns the logged in users:</p>

<p>Modify the view like here and then click <code>Save As...</code> and name it <code>logged_in</code>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">function</span> (<span style="color: #000000">doc</span>) {
    <span style="color: #A90D91">if</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">namespace</span> <span style="color: #000000">==</span> <span style="color: #C41A16">&#39;sessions&#39;</span> <span style="color: #000000">&amp;&amp;</span> <span style="color: #000000">doc</span>.<span style="color: #000000">type</span> <span style="color: #000000">==</span> <span style="color: #C41A16">&#39;user&#39;</span>) {
        <span style="color: #000000">emit</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">_id</span>, <span style="color: #000000">doc</span>);
    }
}
</pre></div>

<p>The reduce function can be reused in the same way. As you can see, with just a bit more code in JavaScript we have another view that just returns the logged in users. Now we want to display a third diagram that displays all users from <code>Vienna/Austria</code>. This time, we want to differentiate between anonymous and logged in users so that they can be displayed in two distinct graphs. Our map function may look like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">function</span> (<span style="color: #000000">doc</span>) {
    <span style="color: #A90D91">if</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">namespace</span> <span style="color: #000000">==</span> <span style="color: #C41A16">&#39;sessions&#39;</span> <span style="color: #000000">&amp;&amp;</span> <span style="color: #000000">doc</span>.<span style="color: #000000">location</span> <span style="color: #000000">==</span> <span style="color: #C41A16">&#39;Vienna/Austria&#39;</span>) {
        <span style="color: #000000">emit</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">type</span>, <span style="color: #1C01CE">1</span>);
    }
}
</pre></div>

<p>Every time we find a document with the correct location, we emit a document with the key of either <code>anonymous</code> or <code>user</code>. As values we supply a value of <code>1</code> since we can reuse that in our reduce function. The reduce function is again the built in <code>_count</code> function, but this time we pass an additional param <code>group_level</code> with a value of <code>1</code> to our query. This way, Couchbase aggregates our data and returns a document like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">// Params: ?group_level=1&amp;reduce=true&amp;connection_timeout=60000&amp;limit=10&amp;skip=0
{
    &quot;rows&quot;: [
        {&quot;key&quot;:&quot;anonymous&quot;,&quot;value&quot;:1},
        {&quot;key&quot;:&quot;user&quot;,&quot;value&quot;:1}
    ]
}
</pre></div>

<p>If we insert another <code>user</code> document the counter would display <code>2</code>. If we don&rsquo;t use the grouping level setting, Couchbase would just return the total amount of documents emitted.</p>

<p>All of these views assumed that we have some kind of realtime polling to our backend, because the results didn&rsquo;t include grouping by a distinct timestamp. In order to load a graph with meaningful results for the last hour, we can return it aggregated by timestamp (we can reuse the same <code>_count</code> reduce function and the level 1 grouping):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">function</span> (<span style="color: #000000">doc</span>) {
    <span style="color: #A90D91">if</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">namespace</span> <span style="color: #000000">==</span> <span style="color: #C41A16">&#39;sessions&#39;</span>) {
        <span style="color: #000000">emit</span>(<span style="color: #000000">doc</span>.<span style="color: #000000">lastSeen</span>, <span style="color: #1C01CE">1</span>);
    }
}
</pre></div>

<p>An example output would look like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">// Params: ?group_level=1&amp;connection_timeout=60000&amp;limit=10&amp;skip=0
{
    &quot;rows&quot;:[
        {&quot;key&quot;:1339997680,&quot;value&quot;:1},
        {&quot;key&quot;:1340004880,&quot;value&quot;:3}
    ]
}
</pre></div>

<p>Now, if we have record for the last year in our database it won&rsquo;t make much sense to fetch them all on every request. If you look one entry below the <code>group_level</code> param, you&rsquo;ll find <code>startkey</code> and <code>endkey</code> options. With these two you can provide a timerange to fetch the results.</p>

<h2 id="performance:512f62c3475e795b4e119166c489818f">Performance</h2>

<p>I know that synthetic benchmarks never provide reproducible results in production environments, but they provide at least a rough estimation on how the application may be able to perform under certain conditions.</p>

<p>Thankfully, <a href="http://trondn.blogspot.co.at/">Trond Norbye</a> added a nice little program to <a href="http://www.couchbase.com/develop/c/next">libcouchbase</a> that allows you to generate load on your Couchbase server and then analyze the response times directly on the console (of course you can get real-time metrics from the Couchbase GUI as well). The program is called <code>pillowfight</code> and is distributed with the source of libcouchbase. It stores a bunch of keys (1000 by default) and then runs &ldquo;mget&rdquo; operations on them and measures the time they need to get returned. In order to run it, you need to compile it from source (which I&rsquo;ll show in a later post but it&rsquo;s not that hard if you are used to compiling on unix-based systems).</p>

<p>On my middle-class Dell notebook with an average processor (Core2 Duo P8700), 4 gigs of RAM and a SSD drive, 90% of the keys return in about 70 microseconds. If I look at the Couchbase GUI for my bucket, I can see that my instance runs somewhere between 10.000 and 12.000 operations per second. I recommend you to run this program on your dev machine just for fun and to get a feeling how it performs. It is also a handy way to generate a constant load on your Couchbase instances and add a large number of keys in an easy way (you can find more params with the -? switch).</p>

<p>If you ran the program, it would be cool to share your results in the comments below.</p>

<h2 id="wrapping-up:512f62c3475e795b4e119166c489818f">Wrapping Up</h2>

<p>From both its history and current feature set, chances are that Couchbase is a possible solution to your session store needs. It provides you with both fast and flexible querying mechanisms and is capable to scale up to more nodes with just a few clicks if you need it to. There are definitely other good storage systems out there (like redis), so make sure to dig deeper into the concepts to find out if Couchbase is right for your application.</p>

<p>As Couchbase 2.0 comes closer and closer to the final release, I think it&rsquo;s a good time to look into the system and see what it&rsquo;s capable of. Also, if you need any help I found that the guys behind Couchbase are very friendly and helpful. You can also ping me via twitter if you like!</p>

<p>If you&rsquo;re just getting your feet wet with Couchbase, I also have two introductory posts on <a href="http://nitschinger.at/Getting-Started-with-Couchbase-and-PHP">PHP</a> and <a href="http://nitschinger.at/Accessing-Couchbase-from-Scala">Scala</a> that you may find helpful!</p>

<p>Finally, kudos to <a href="http://twitter.com/ingenthr">@ingenthr</a> for reviewing this post and providing valuable insight into Couchbase.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">06 Jun 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Handling-JSON-like-a-boss-in-PHP/" class="post-title">Handling JSON like a boss in PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>There are already lots of tutorials out there on handling JSON with PHP, but most of them don&rsquo;t go much deeper than throwing an array against <a href="http://php.net/manual/en/function.json-encode.php">json_encode</a> and hoping for the best. This article aims to be a solid introduction into JSON and how to handle it correctly in combination with PHP. Also, readers who don&rsquo;t use PHP as their programming language can benefit from the first part that acts as a general overview on JSON.</p>

<p>JSON (JavaScript Object Notation) is a data exchange format that is both lightweight and human-readable (like XML, but without the bunch of markup around your actual payload). Its syntax is a subset of the JavaScript language that was standardized in <a href="http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf">1999</a>. If you want to find out more, visit the <a href="http://www.json.org/">official website</a>.</p>

<p>The cool thing about JSON is that you can handle it natively in JavaScript, so it acts as the perfect glue between server- and client-side application logic. Also, since the syntactical overhead (compared to XML) is very low, you need to transfer less bytes of ther wire. In modern web stacks, JSON has pretty much replaced <a href="http://en.wikipedia.org/wiki/XML">XML</a> as the de-factor payload format (aside from the Java world I suppose) and client side application frameworks like <a href="http://backbonejs.org/">backbone.js</a> make heavy use of it inside the model layer.</p>

<p>Before we start handling JSON in PHP, we need to take a short look at the JSON specification to understand how it is implemented and what&rsquo;s possible.</p>

<h2 id="introducing-json:a3d5483349c0d950e081bf899405ed60">Introducing JSON</h2>

<p>Since JSON is a subset of the JavaScript language, it shares all of its language constructs with its parent. In JSON, you can store unordered key/value combinations in objects or use arrays to preserve the order of values. This makes it easy to parse and to read, but also has some limitations. Since JSON only defines a small amount of data types, you can&rsquo;t transmit types like dates natively (you can, but you need to transform them into a string or a unix timestamp as an integer).</p>

<p>So, what datatypes does JSON support? It all boils down to strings, numbers, booleans and null. Of course, you can also supply objects or arrays as values.</p>

<p>Here&rsquo;s a example JSON document:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">{
    &quot;title&quot;: &quot;A cool blog post&quot;,
    &quot;clicks&quot;: 4000,
    &quot;children&quot;: null,
    &quot;published&quot;: true,
    &quot;comments&quot;: [
        {
            &quot;author&quot;: &quot;Mister X&quot;,
            &quot;message&quot;: &quot;A really cool posting&quot;
        },
        {
            &quot;author&quot;: &quot;Misrer Y&quot;,
            &quot;message&quot;: &quot;It&#39;s me again!&quot;
        }
    ]
}
</pre></div>

<p>It contains basically everything that you can express through JSON. As you can see no dates, regexes or something like that. Also, you need to make sure that your whole JSON document is encoded in <a href="http://en.wikipedia.org/wiki/UTF-8">UTF-8</a>. We&rsquo;ll see later how to ensure that in PHP. Due to this shortcomings (and for other good reasons) <a href="http://bsonspec.org/">BSON</a>(Binary JSON) was developed. It was designed to be more space-efficient and provides traversability and extensions like the date type. Its most prominent use case is <a href="http://www.mongodb.org/">MongoDB</a>, but honestly I never came across it somewhere else. I recommend you to take a short look at the specification if you have some time left, since I find it very educating.</p>

<p>Since PHP has a richer type handling than JSON, you need to prepare yourself to write some code on both ends to transform the correct information apart from the obligatory encoding/decoding step. For example, if you want to transport date objects, you need to think if you can just send a unix timestamp over the wire or maybe use a preformatted date string (like <a href="http://php.net/manual/en/function.strftime.php">strftime</a>).</p>

<h2 id="encoding-json-in-php:a3d5483349c0d950e081bf899405ed60">Encoding JSON in PHP</h2>

<p>Some years ago, JSON support was provided through the <a href="http://pecl.php.net/package/json">json pecl extension</a>. Since PHP 5.2, it is included in the core directly, so if you use a recent PHP version you should have no trouble using it.</p>

<p>Note: If you run an older version of PHP than 5.3, I recommend you to upgrade anyway. PHP 5.3 is the oldest version that is currently supported and with the latest PHP <a href="http://www.php.net/archive/2012.php#id2012-02-02-1">security bugs</a> found I would consider it critical to upgrade as soon as possible.</p>

<p>Back to JSON. With <a href="http://php.net/manual/en/function.json-encode.php">json_encode</a>, you can translate anything that is UTF-8 encoded (except resources) from PHP into a JSON string. As a rule of thumb, everything except pure arrays (in PHP this means arrays with an ordered, numerical index) is converted into an object with keys and values.</p>

<p>The method call is easy and looks like the following:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">    json_encode(mixed $<span style="color: #000000">value</span>, int $<span style="color: #000000">options</span> = 0);
</pre></div>

<p>An integer for options you might ask? Yup, that&rsquo;s called a <a href="http://en.wikipedia.org/wiki/Mask_(computing">bitmask</a>). We&rsquo;ll cover them in a separate part a little bit later. Since these bitmask options change the way the data is encoded, for the following examples assume that we use defaults and don&rsquo;t provide custom params.</p>

<p>Let&rsquo;s start with the basic types first. Since its so easy to grasp, here&rsquo;s the code with short comments on what was translated:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #177500">// Returns: [&quot;Apple&quot;,&quot;Banana&quot;,&quot;Pear&quot;]</span>
<span style="color: #A90D91">json_encode</span>(<span style="color: #A90D91">array</span>(<span style="color: #C41A16">&quot;Apple&quot;</span>, <span style="color: #C41A16">&quot;Banana&quot;</span>, <span style="color: #C41A16">&quot;Pear&quot;</span>));

<span style="color: #177500">// Returns: {&quot;4&quot;:&quot;four&quot;,&quot;8&quot;:&quot;eight&quot;}</span>
<span style="color: #A90D91">json_encode</span>(<span style="color: #A90D91">array</span>(<span style="color: #1C01CE">4</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;four&quot;</span>, <span style="color: #1C01CE">8</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;eight&quot;</span>));

<span style="color: #177500">// Returns: {&quot;apples&quot;:true,&quot;bananas&quot;:null}</span>
<span style="color: #A90D91">json_encode</span>(<span style="color: #A90D91">array</span>(<span style="color: #C41A16">&quot;apples&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">true</span>, <span style="color: #C41A16">&quot;bananas&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #A90D91">null</span>));
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>How your arrays are translated depends on your indexes used. You can also see that <code>json_encode</code> takes care of the correct type conversion, so <code>booleans</code> and <code>null</code> are not transformed into strings but use their correct type. Let&rsquo;s now look into objects:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">User</span> {
    <span style="color: #A90D91">public</span> <span style="color: #000000">$firstname</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;&quot;</span>;
    <span style="color: #A90D91">public</span> <span style="color: #000000">$lastname</span>  <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;&quot;</span>;
    <span style="color: #A90D91">public</span> <span style="color: #000000">$birthdate</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;&quot;</span>;
}

<span style="color: #000000">$user</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">User</span>();
<span style="color: #000000">$user-&gt;</span><span style="color: #836C28">firstname</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;foo&quot;</span>;
<span style="color: #000000">$user-&gt;</span><span style="color: #836C28">lastname</span>  <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;bar&quot;</span>;

<span style="color: #177500">// Returns: {&quot;firstname&quot;:&quot;foo&quot;,&quot;lastname&quot;:&quot;bar&quot;}</span>
<span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$user</span>);

<span style="color: #000000">$user-&gt;</span><span style="color: #836C28">birthdate</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">DateTime</span>();

<span style="color: #177500">/* Returns:</span>
<span style="color: #177500">    {</span>
<span style="color: #177500">        &quot;firstname&quot;:&quot;foo&quot;,</span>
<span style="color: #177500">        &quot;lastname&quot;:&quot;bar&quot;,</span>
<span style="color: #177500">        &quot;birthdate&quot;: {</span>
<span style="color: #177500">            &quot;date&quot;:&quot;2012-06-06 08:46:58&quot;,</span>
<span style="color: #177500">            &quot;timezone_type&quot;:3,</span>
<span style="color: #177500">            &quot;timezone&quot;:&quot;Europe\/Berlin&quot;</span>
<span style="color: #177500">        }</span>
<span style="color: #177500">    }</span>
<span style="color: #177500">*/</span>
<span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$user</span>);
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Objects are inspected and their public attributes are converted. This happens recursively, so in the example above the public attributes of the <a href="http://at2.php.net/manual/en/datetime.construct.php">DateTime</a> object are also translated into JSON. This is a handy trick if you want to easly transmit datetimes over JSON, since the client-side can then operate on both the actual time and the timezone.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">User</span> {
    <span style="color: #A90D91">public</span> <span style="color: #000000">$pub</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;Mister X.&quot;</span>;
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$pro</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;hidden&quot;</span>;
    <span style="color: #A90D91">private</span> <span style="color: #000000">$priv</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;hidden too&quot;</span>;

    <span style="color: #A90D91">public</span> <span style="color: #000000">$func</span>;
    <span style="color: #A90D91">public</span> <span style="color: #000000">$notUsed</span>;

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>() {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">func</span> <span style="color: #000000">=</span> <span style="color: #A90D91">function</span>() {
            <span style="color: #A90D91">return</span> <span style="color: #C41A16">&quot;Foo&quot;</span>;
        };
    }
}

<span style="color: #000000">$user</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">User</span>();

<span style="color: #177500">// Returns: {&quot;pub&quot;:&quot;Mister X.&quot;,&quot;func&quot;:{},&quot;notUsed&quot;:null}</span>
<span style="color: #A90D91">echo</span> <span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$user</span>);
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Here, you can see that only public attributes are used. Not initialized variables are translated to <code>null</code> while closures that are bound to a public attribute are encoded with an empty object (as of PHP 5.4, there is no option to prevent public closures to be translated).</p>

<h3 id="the-option-bitmasks:a3d5483349c0d950e081bf899405ed60">The $option bitmasks</h3>

<p>Bitmasks are used to set certain flags on or off in a function call. This language pattern is commonly used in C and since PHP is written in C this concept made it up to some PHP function arguments as well. It&rsquo;s easy to use: if you want to set an option, just pass the constant as an argument. If you want to combine two or more options, combine them with the bitwise OR operation <code>|</code>. So, a call to json_encode may look like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #177500">// Returns: {&quot;0&quot;:&quot;Starsky &amp; Hutch&quot;,&quot;1&quot;:123456}</span>
<span style="color: #A90D91">json_encode</span>(<span style="color: #A90D91">array</span>(<span style="color: #C41A16">&quot;Starsky &amp; Hutch&quot;</span>, <span style="color: #C41A16">&quot;123456&quot;</span>), <span style="color: #000000">JSON_NUMERIC_CHECK</span> <span style="color: #000000">|</span> <span style="color: #000000">JSON_FORCE_OBJECT</span>);
<span style="color: #633820">?&gt;</span>
</pre></div>

<p><code>JSON_FORCE_OBJECT</code> forces the array to be translated into an object and <code>JSON_NUMERIC_CHECK</code> converts string-formatted numbers to actual numbers. You can find all bitmasks (constants) <a href="http://php.net/manual/en/json.constants.php">here</a>. Note that most of the constants are available since PHP 5.3 and some of them were added in 5.4. Most of them deal with how to convert characters like <code>&lt; &gt;</code>, <code>&amp;</code> or <code>&quot;&quot;</code>. PHP 5.4 provides a <code>JSON_PRETTY_PRINT</code> constant that may you help during development since it uses whitespace to format the output (since it adds character overhead, I won&rsquo;t enable it in production of course).</p>

<h2 id="decoding-json-in-php:a3d5483349c0d950e081bf899405ed60">Decoding JSON in PHP</h2>

<p>Decoding JSON is as simple as encoding it. PHP provides you a handy <a href="http://php.net/manual/de/function.json-decode.php">json_decode</a> function that handles everything for you. If you just pass a valid JSON string into the method, you get an object of type <code>stdClass</code> back. Here&rsquo;s a short example:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$string</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;{&quot;foo&quot;: &quot;bar&quot;, &quot;cool&quot;: &quot;attr&quot;}&#39;</span>;
<span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_decode</span>(<span style="color: #000000">$string</span>);

<span style="color: #177500">// Result: object(stdClass)#1 (2) { [&quot;foo&quot;]=&gt; string(3) &quot;bar&quot; [&quot;cool&quot;]=&gt; string(4) &quot;attr&quot; }</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$result</span>);

<span style="color: #177500">// Prints &quot;bar&quot;</span>
<span style="color: #A90D91">echo</span> <span style="color: #000000">$result-&gt;</span><span style="color: #836C28">foo</span>;

<span style="color: #177500">// Prints &quot;attr&quot;</span>
<span style="color: #A90D91">echo</span> <span style="color: #000000">$result-&gt;</span><span style="color: #836C28">cool</span>;
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If you want to get an associative array back instead, set the second parameter to true:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$string</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;{&quot;foo&quot;: &quot;bar&quot;, &quot;cool&quot;: &quot;attr&quot;}&#39;</span>;
<span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_decode</span>(<span style="color: #000000">$string</span>, <span style="color: #A90D91">true</span>);

<span style="color: #177500">// Result: array(2) { [&quot;foo&quot;]=&gt; string(3) &quot;bar&quot; [&quot;cool&quot;]=&gt; string(4) &quot;attr&quot; }</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$result</span>);

<span style="color: #177500">// Prints &quot;bar&quot;</span>
<span style="color: #A90D91">echo</span> <span style="color: #000000">$result</span>[<span style="color: #C41A16">&#39;foo&#39;</span>];

<span style="color: #177500">// Prints &quot;attr&quot;</span>
<span style="color: #A90D91">echo</span> <span style="color: #000000">$result</span>[<span style="color: #C41A16">&#39;cool&#39;</span>];
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If you expect a very large nested JSON document, you can limit the recursion depth to a certain level. The function will return <code>null</code> and stops parsing if the document is deeper than the given depth.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$string</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;{&quot;foo&quot;: {&quot;bar&quot;: {&quot;cool&quot;: &quot;value&quot;}}}&#39;</span>;
<span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_decode</span>(<span style="color: #000000">$string</span>, <span style="color: #A90D91">true</span>, <span style="color: #1C01CE">2</span>);

<span style="color: #177500">// Result: null</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$result</span>);
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>The last argument works the same as in json_encode, but there is only one bitmask supported currently (which allows you to convert bigints to strings and is only available from PHP 5.4 upwards).We&rsquo;ve been working with valid JSON strings until now (aside fromt the <code>null</code> depth error). The next part shows you how to deal with errors.</p>

<h2 id="error-handling-and-testing:a3d5483349c0d950e081bf899405ed60">Error-Handling and Testing</h2>

<p>If the JSON value could not be parsed or a nesting level deeper than the given (or default) depth is found, NULL is returned from json_decode. This means that no exception is raised by json_encode/json_deocde directly.</p>

<p>So how can we identify the cause of the error? The json_last_error function helps here. <a href="http://at2.php.net/manual/en/function.json-last-error.php">json_last_error</a> returns an integer error code that can be one of the following constants (taken from <a href="http://at2.php.net/manual/en/function.json-last-error.php">here</a>):</p>

<ul>
<li>JSON_ERROR_NONE: No error has occurred.</li>
<li>JSON_ERROR_DEPTH: The maximum stack depth has been exceeded.</li>
<li>JSON_ERROR_STATE_MISMATCH: Invalid or malformed JSON.</li>
<li>JSON_ERROR_CTRL_CHAR: Control character error, possibly incorrectly encoded.</li>
<li>JSON_ERROR_SYNTAX: Syntax error.</li>
<li>JSON_ERROR_UTF8: Malformed UTF-8 characters, possibly incorrectly encoded (since PHP 5.3.3).</li>
</ul>

<p>With those information at hand, we can write a quick parsing helper method that raises a descriptive exception when an error is found.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">JsonHandler</span> {

    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #000000">$_messages</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(
        <span style="color: #000000">JSON_ERROR_NONE</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;No error has occurred&#39;</span>,
        <span style="color: #000000">JSON_ERROR_DEPTH</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;The maximum stack depth has been exceeded&#39;</span>,
        <span style="color: #000000">JSON_ERROR_STATE_MISMATCH</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Invalid or malformed JSON&#39;</span>,
        <span style="color: #000000">JSON_ERROR_CTRL_CHAR</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Control character error, possibly incorrectly encoded&#39;</span>,
        <span style="color: #000000">JSON_ERROR_SYNTAX</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Syntax error&#39;</span>,
        <span style="color: #000000">JSON_ERROR_UTF8</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;Malformed UTF-8 characters, possibly incorrectly encoded&#39;</span>
    );

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">encode</span>(<span style="color: #000000">$value</span>, <span style="color: #000000">$options</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>) {
        <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$value</span>, <span style="color: #000000">$options</span>);

        <span style="color: #A90D91">if</span>(<span style="color: #000000">$result</span>)  {
            <span style="color: #A90D91">return</span> <span style="color: #000000">$result</span>;
        }

        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">RuntimeException</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::$_messages</span>[<span style="color: #A90D91">json_last_error</span>()]);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">decode</span>(<span style="color: #000000">$json</span>, <span style="color: #000000">$assoc</span> <span style="color: #000000">=</span> <span style="color: #A90D91">false</span>) {
        <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">json_decode</span>(<span style="color: #000000">$json</span>, <span style="color: #000000">$assoc</span>);

        <span style="color: #A90D91">if</span>(<span style="color: #000000">$result</span>) {
            <span style="color: #A90D91">return</span> <span style="color: #000000">$result</span>;
        }

        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">RuntimeException</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::$_messages</span>[<span style="color: #A90D91">json_last_error</span>()]);
    }

}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>We can now use the exception testing function <a href="http://nitschinger.at/A-primer-on-PHP-exceptions">from the last post about exception handling</a> to test if our exception works correctly.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #177500">// Returns &quot;Correctly thrown&quot;</span>
<span style="color: #000000">assertException</span>(<span style="color: #C41A16">&quot;Syntax error&quot;</span>, <span style="color: #A90D91">function</span>() {
    <span style="color: #000000">$string</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&#39;{&quot;foo&quot;: {&quot;bar&quot;: {&quot;cool&quot;: NONUMBER}}}&#39;</span>;
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">JsonHandler::decode</span>(<span style="color: #000000">$string</span>);
});
</pre></div>

<p>Note that since PHP 5.3.3, there is a <code>JSON_ERROR_UTF8</code> error returned when an invalid UTF-8 character is found in the string. This is a strong indication that a different charset than UTF-8 is used. If the incoming string is not under your control, you can use the <a href="http://at2.php.net/manual/en/function.utf8-encode.php">utf8_encode</a> function to convert it into utf8.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span> <span style="color: #A90D91">echo</span> <span style="color: #A90D91">utf8_encode</span>(<span style="color: #A90D91">json_encode</span>(<span style="color: #000000">$payload</span>)); <span style="color: #633820">?&gt;</span>
</pre></div>

<p>I&rsquo;ve been using this in the past to convert data loaded from a legacy MSSQL database that didn&rsquo;t use UTF-8.</p>

<h2 id="summary:a3d5483349c0d950e081bf899405ed60">Summary</h2>

<p>JSON is a convenient, readable and easy to use data exchange format that seems to replace XML as the de-facto standard on the web. PHP has everything you need already built in and provides various configuration options if you use a recent version (&gt; 5.3).</p>

<p>You should now be able to understand JSON, how to interact with it through PHP and how to handle possible errors. Happy encoding!</p>

<p>(By the way, you may also want to check out my primer about <a href="http://nitschinger.at/A-primer-on-PHP-exceptions">Exceptions in PHP</a>!)</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">22 May 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/A-primer-on-PHP-exceptions/" class="post-title">A primer on PHP exceptions</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="preface:461468f58b117b97d7e43b7161cf60a9">Preface</h1>

<p>Exceptions are and should be an integral part of any general purpose programming language. PHP introduced them long ago (with the release of PHP 5 or 5.1), but it still seems that many of the concepts are not fully understood or ignored by the community. This post aims to be a solid introduction to exception architecture, handling and testing. At the end of the post you should be able to know when to raise an exception and how it should look like.</p>

<p>Of course, there are many opinions on a topic like this. If you have constructive feedback, feel free to comment below. Let&rsquo;s get started!</p>

<h1 id="architecture-best-practices:461468f58b117b97d7e43b7161cf60a9">Architecture &amp; Best-Practices</h1>

<p>Here&rsquo;s a golden rule: use exceptions for what their name says: exceptional situations. Don&rsquo;t use exceptions to control the flow of your application logic (like substituting if-statements or to control loops). This not only leads to confusion, but also my slow down your code.</p>

<p>Edit: Due to some confusions on <a href="http://www.reddit.com/r/PHP/comments/tz5jw/a_primer_on_php_exceptions/">reddit</a>, I think I need to clarify what exceptional situations are. When they occur, your code/request normally can&rsquo;t continue correctly. So, if your database is not ready and you rely on it, you can&rsquo;t continue. If you validate a form and a validation for the &ldquo;username&rdquo; field fails, you can continue and present the user with an error message tied to that form field. This depends heavily on your use case, but I hope you get the point.</p>

<p>In PHP, you have no way of finding out what exceptions the called method may throw if it isn&rsquo;t documented somewhere or you can look at the code (in contrast, Java provides an explicit &ldquo;throws&rdquo; notation in the method definiton). So if you want to make sure that your code catches everything, you need to catch exceptions from the &ldquo;Exception&rdquo; class (in PHP, all exceptions need to have the &ldquo;Exception&rdquo; class or a descendant of it).</p>

<p>Here&rsquo;s another tip that might come in handy if you develop code that includes third-party libraries: make sure to &ldquo;normalize&rdquo; your exceptions as soon as possible. This allows you to handle them better up the stack. What do I mean by that? Consider the following example:</p>

<p>You are writing a database abstraction layer (not that there aren&rsquo;t already enough&hellip;) and you need to integrate third party extensions that handle the lowlevel/protocol stuff. We want to implement two databases: &ldquo;Foobase&rdquo; and &ldquo;BarSQL&rdquo;. When each driver fails to open a connection (for example, we&rsquo;ve provided an invalid hostname), it raises an exception. Foobase raises an  &ldquo;FoobaseConnectionException&rdquo; and BarSQL raises an &ldquo;InvalidHostnameException&rdquo;. This is a nightmare to handle up the stack if we want to log them accordingly or write those exceptions to a third-party logging service. Here&rsquo;s what you can do: catch them early and raise a &ldquo;normalized&rdquo; exception like &ldquo;NetworkException&rdquo; with the actual exception as the message. We&rsquo;ll see later how to do this.</p>

<p>While providing different exception classes for different situations is fine, make sure not to over engineer it. In my opinion, you should plan your exception classes like you plan the overall architecture of your library. This way, you&rsquo;re also forced to think about all possible exceptional situations that may occur and give you a hint or two where you should be careful. Also, it is often a good idea to refactor dangerous code in their own helper methods so they can be better tested and don&rsquo;t mess up the rest of your code.</p>

<p>After a bit of theory, let&rsquo;s get to something more practical. How does the exception class hierarchy in PHP look like?</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">- Exception
    - ErrorException
    - LogicException
        - BadFunctionCallException
            - BadMethodCallException
        - DomainException
        - InvalidArgumentException
        - LengthException
        - OutOfRangeException
    - RuntimeException
        - OutOfBoundsException
        - OverflowException
        - RangeException
        - UnderflowException
        - UnexpectedValueException
</pre></div>

<p>At the root of the class hierachy, we have the <a href="http://us.php.net/manual/en/class.exception.php">Exception</a> class. All exceptions have to inherit from it (or a subclass), otherwise you can&rsquo;t throw it. Down the hierachy, we have the <a href="http://us.php.net/manual/en/class.errorexception.php">ErrorException</a>, the <a href="http://us.php.net/manual/en/class.logicexception.php">LogicException</a> and the <a href="http://us.php.net/manual/en/class.runtimeexception.php">RuntimeException</a>. The <code>ErrorException</code> is used to transform errors into exceptions (we&rsquo;ll see later how). The other ones are the top two exception objects in the <a href="http://us.php.net/manual/en/book.spl.php">SPL</a> hierachy. All other built-in exceptions inhiert from one of them. I won&rsquo;t describe them here, since their names are pretty expressive. Just make sure to throw one of them if they fit your needs. Don&rsquo;t try to invent similar ones when they are already defined. This helps you to keep your exception architecture clean and focused.</p>

<p>All built-in exception classes don&rsquo;t use a specific namespace (most of them were introduced before PHP 5.3), but you can namespace them similar to normal classes. You&rsquo;re forced to do this if you use a standard like <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-0.md">PSR-0</a>. For example, <a href="http://lithify.me">Lithium</a> has the following exception defined:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">lithium\net\http</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">RoutingException</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\RuntimeException</span> {
    <span style="color: #A90D91">protected</span> <span style="color: #000000">$code</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">500</span>;
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>You can infer from the context that it has something to do with a <code>Router</code> and is thrown during runtime. The <code>Router</code> class who throws it is placed in the same namespace. Notice how the <code>RuntimeException</code> is prefixed with a backslash - this indicates that we want to use a class from the &ldquo;root&rdquo; namespace. The method who uses is looks like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">namespace</span> <span style="color: #000000">lithium\net\http</span>;
<span style="color: #A90D91">use</span> <span style="color: #000000">lithium\net\http\RoutingException</span>;

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Router</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">\lithium\core\StaticObject</span> {   
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">match</span>(<span style="color: #000000">$url</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(), <span style="color: #000000">$context</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>, <span style="color: #A90D91">array</span> <span style="color: #000000">$options</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>()) {
        <span style="color: #177500">// ...</span>
        <span style="color: #177500">// code that handles url matching...</span>
        <span style="color: #177500">// ...</span>
        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">RoutingException</span>(<span style="color: #C41A16">&quot;No parameter match found for URL `{</span><span style="color: #000000">$url</span><span style="color: #C41A16">}`.&quot;</span>);
    }
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>PHP doesn&rsquo;t provide a way to define what kind exceptions may be thrown, so make sure to document them correctly. Most documentation tools like <a href="http://www.phpdoc.org/">phpDocumentor</a> provide a <code>@throws</code> annotation. For example:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">MyClass</span> {

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * This method just throws an exception.</span>
<span style="color: #C41A16">     *</span>
<span style="color: #C41A16">     * @throws RuntimeException</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">foo</span>() {
        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">RuntimeException</span>(<span style="color: #C41A16">&quot;Ooops...&quot;</span>);
    }

}
<span style="color: #633820">?&gt;</span>
</pre></div>

<h1 id="php-syntax:461468f58b117b97d7e43b7161cf60a9">PHP Syntax</h1>

<p>We&rsquo;ve already seen the basic syntax of throwing exceptions, but here is the formal method definition:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">throw new Exception($<span style="color: #000000">message</span>, $<span style="color: #000000">code</span>, $<span style="color: #000000">previous</span>);
</pre></div>

<p>All arguments are optional, but you should at least provide a descriptive message. The <code>code</code> argument is an arbitary error code that you can provide. For example, you can define your own codes or use them with HTTP status codes. If you are rethrowing a exception, you can also provide the instance through the <code>previous</code> argument. This way, both exceptions get raised to the calling method.</p>

<p>After throwing it, you need to catch it somewhere. PHP provides the familiar try/catch construct, but without a <code>finally</code> block like in Java.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">try <span style="color: #000000">{</span>
    $<span style="color: #000000">object</span> = new IThrowExceptions();
} catch(Exception $<span style="color: #000000">e</span>) <span style="color: #000000">{</span>
    echo &quot;Caught &quot; . $<span style="color: #000000">e</span>-&gt;getMessage();
}
</pre></div>

<p>The code inside the <code>try</code> block is evaluated, and if an exception is thrown the <code>catch</code> block tries to handle it. If the exception can&rsquo;t be handled, it bubbles up the stack. If the exception doesn&rsquo;t get handled in your code, PHP terminates. If you expect different exceptions to be thrown, you can catch more than one at the same time:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">try <span style="color: #000000">{</span>
    $<span style="color: #000000">foo</span> = new Foo();
    $<span style="color: #000000">foo</span>-&gt;bar();
} catch(InvalidArgumentException $<span style="color: #000000">e</span>) <span style="color: #000000">{</span>
    echo &quot;Just InvalidArgumentExceptions&quot;;
} catch(RuntimeException $<span style="color: #000000">e</span>) <span style="color: #000000">{</span>
    echo &quot;Just RuntimeExceptions&quot;;
} catch(Exception $<span style="color: #000000">e</span>) <span style="color: #000000">{</span>
    echo &quot;I catch everything&quot;;
}
</pre></div>

<p>The last <code>catch(Exception $e)</code> is used when no previous catch succeeded. Make sure to go from special to general, because when you move the <code>Exception</code> block to the top, the exception would never sink down to the <code>RuntimeException</code>.</p>

<p>Alright, let&rsquo;s get back to our example from the beginning. Imagine we get a lot of custom exceptions that all have the same meaning. We want to normalize them, so that only one specific type bubbles up the stack. In our example, no matter what kind of exception we receive during <code>_connect</code>, we want to throw a <code>NetworkException</code>. It&rsquo;s pretty easy to rethrow the exception:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * Our custom Exceptions.</span>
<span style="color: #C41A16"> */</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">FoobaseConnectException</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Exception</span> {}
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">BarSQLException</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Exception</span> {}
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">NetworkException</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Exception</span> {}

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * A sample parent datasource.</span>
<span style="color: #C41A16"> */</span> 
<span style="color: #A90D91">abstract</span> <span style="color: #A90D91">class</span> <span style="color: #3F6E75">Datasource</span> {
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">connect</span>() {
        <span style="color: #A90D91">try</span> {
            <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">_connect</span>();
        } <span style="color: #A90D91">catch</span>(<span style="color: #000000">Exception</span> <span style="color: #000000">$e</span>) {
            <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;Could not connect: &quot;</span> <span style="color: #000000">.</span> <span style="color: #000000">$e-&gt;</span><span style="color: #836C28">getMessage</span>();
            <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">NetworkException</span>(<span style="color: #000000">$message</span>, <span style="color: #000000">$e-&gt;</span><span style="color: #836C28">getCode</span>());
        }
    }
    <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">protected</span> <span style="color: #A90D91">function</span> <span style="color: #000000">_connect</span>();
}

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * Foobase datasource.</span>
<span style="color: #C41A16"> */</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Foobase</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Datasource</span> {
    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">function</span> <span style="color: #000000">_connect</span>() {
            <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">FoobaseConnectException</span>(<span style="color: #C41A16">&quot;Holy moly, no DB available&quot;</span>);
    }
}

<span style="color: #C41A16">/**</span>
<span style="color: #C41A16"> * BarSQL datasource.</span>
<span style="color: #C41A16"> */</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">BarSQL</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Datasource</span> {
    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">function</span> <span style="color: #000000">_connect</span>() {
            <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">BarSQLException</span>(<span style="color: #C41A16">&quot;Y U NO SQL SERVICE?&quot;</span>);
    }
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If you execute the following code, a <code>'NetworkException' with message 'Could not connect: Holy moly, no DB available'</code> is raised:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$foobase</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Foobase</span>();
<span style="color: #000000">$foobase-&gt;</span><span style="color: #836C28">connect</span>();
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>We not only rethrow a different exception, but also incorporate the original message to provide a more detailed error report.</p>

<p>The exception classes provide more accessor-methods like reading the current line or file, check out the docs <a href="http://php.net/manual/de/class.exception.php">here</a>. In our example above we also added our own exception classes. If you like, you can also add methods and call them later (maybe you need custom stack traces or want to add more information to the exception).</p>

<p>The last thing that comes in very handy are error handlers. Recall the <code>ErrorException</code> from the beginning? Here&rsquo;s what you can do with it (taken from <a href="http://us.php.net/manual/en/class.errorexception.php">here</a>):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">function</span> <span style="color: #000000">exception_error_handler</span>(<span style="color: #000000">$errno</span>, <span style="color: #000000">$errstr</span>, <span style="color: #000000">$errfile</span>, <span style="color: #000000">$errline</span> ) {
    <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">ErrorException</span>(<span style="color: #000000">$errstr</span>, <span style="color: #1C01CE">0</span>, <span style="color: #000000">$errno</span>, <span style="color: #000000">$errfile</span>, <span style="color: #000000">$errline</span>);
}
<span style="color: #000000">set_error_handler</span>(<span style="color: #C41A16">&quot;exception_error_handler&quot;</span>);

<span style="color: #177500">/* Trigger exception */</span>
<span style="color: #000000">strpos</span>();
</pre></div>

<p>PHP throws lots of errors and warnings from built-in methods like <code>strpos</code>. The problem is that you can&rsquo;t do anything with them in your code until you translate them into exceptions. That&rsquo;s
why the <code>ErrorException</code> was implemented. Notice how different the constructor is to the <code>Exception</code> class, because it mirrors all variables that are passed to the error handler. This allows
you to capture and handle everything that happens during code execution in a uniform way, being it exceptions or errors.</p>

<h1 id="testing-exceptions:461468f58b117b97d7e43b7161cf60a9">Testing Exceptions</h1>

<p>Testing exceptions may seem daunting at first, since you need to verfiy that your code fails. This usually means that you need to write unit tests with try/catch blocks and then do
some kind of assertion inside the catch-block like this (just assume we have some arbitary <code>assert</code> functions defined):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>

<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Foo</span> {
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">bar</span>() {
        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">RuntimeException</span>(<span style="color: #C41A16">&quot;My Message&quot;</span>, <span style="color: #1C01CE">123</span>);
    }
}

<span style="color: #000000">$foo</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Foo</span>();
<span style="color: #A90D91">try</span> {
    <span style="color: #000000">$foo-&gt;</span><span style="color: #836C28">bar</span>();
} <span style="color: #A90D91">catch</span>(<span style="color: #000000">RuntimeException</span> <span style="color: #000000">$e</span>) {
    <span style="color: #000000">assertEqual</span>(<span style="color: #000000">$e-&gt;</span><span style="color: #836C28">getMessage</span>(), <span style="color: #C41A16">&quot;My Message&quot;</span>);
    <span style="color: #000000">assertEqual</span>(<span style="color: #000000">$e-&gt;</span><span style="color: #836C28">getCode</span>(), <span style="color: #1C01CE">123</span>);
}

<span style="color: #633820">?&gt;</span>
</pre></div>

<p>PHP 5.3 provides us with a very nice addition to the language: <a href="http://php.net/manual/en/functions.anonymous.php">closures</a>. We can write a handy method that lets us test this kind of code very elegantly. Here&rsquo;s a simple helper method:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">function</span> <span style="color: #000000">assertException</span>(<span style="color: #000000">$expected</span>, <span style="color: #000000">$closure</span>) {
    <span style="color: #A90D91">try</span> {
        <span style="color: #000000">$closure</span>();
        <span style="color: #000000">echo</span> <span style="color: #C41A16">&quot;Exception expected, but not thrown&quot;</span>;
    } <span style="color: #A90D91">catch</span> (<span style="color: #000000">Exception</span> <span style="color: #000000">$e</span>) {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$e-&gt;getMessage</span>() <span style="color: #000000">==</span> <span style="color: #000000">$expected</span>) {
            <span style="color: #000000">echo</span> <span style="color: #C41A16">&quot;Correctly thrown&quot;</span>;
        } <span style="color: #A90D91">else</span> {
            <span style="color: #000000">echo</span> <span style="color: #C41A16">&quot;Exception thrown, but with a different message.&quot;</span>;
        }
    }
}
</pre></div>

<p>We run the closure inside the try/catch block and check if the correct message is raised. Now we can test a code snippet like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
    <span style="color: #A90D91">class</span> <span style="color: #3F6E75">Foo</span> {
        <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">bar</span>() {
            <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">RuntimeException</span>(<span style="color: #C41A16">&quot;My Message&quot;</span>, <span style="color: #1C01CE">123</span>);
        }
    }

    <span style="color: #177500">// prints &quot;Correctly Thrown&quot;</span>
    <span style="color: #000000">assertException</span>(<span style="color: #C41A16">&quot;My Message&quot;</span>, <span style="color: #A90D91">function</span>() {
        <span style="color: #000000">$foo</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Foo</span>();
        <span style="color: #000000">$foo-&gt;</span><span style="color: #836C28">bar</span>();
    });
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Of course, in a real test suite you want to replace the <code>echo</code> statements with debug output and add more intelligence. Look <a href="https://github.com/UnionOfRAD/lithium/blob/master/test/Unit.php#L521">here</a> for a practical implementation. This allows you to test exceptions in a natural and convenient way. Here&rsquo;s a real unit test from a <a href="https://github.com/daschl/li3_couchbase">Couchbase datasource for Lithium</a>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">testConnect</span>() {
    <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #000000">$this-&gt;_dbConfig</span>);
    <span style="color: #000000">$this-&gt;assertTrue</span>(<span style="color: #000000">$result-&gt;isConnected</span>());
    <span style="color: #000000">$this-&gt;assertTrue</span>(<span style="color: #000000">is_string</span>(<span style="color: #000000">$result-&gt;connection-&gt;getVersion</span>()));

    <span style="color: #000000">$this-&gt;assertException</span>(<span style="color: #C41A16">&#39;/Unknown host/&#39;</span>, <span style="color: #A90D91">function</span>() {
        <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Couchbase</span>(<span style="color: #000000">array</span>(<span style="color: #C41A16">&#39;host&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&#39;invalidHostname&#39;</span>));
    });
}
</pre></div>

<p>You can see that the exception assertion is integrated tightly after the normal tests and no try/catch blocks are used. Pretty neat, right?</p>

<p>Edit: David Thalmann thankfully pointed out that you can also test exceptions through annotations on your test methods. <a href="http://www.phpunit.de/manual/3.7/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.exceptions">Here&rsquo;s</a> how to do that in <a href="http://www.phpunit.de">PHPUnit</a>.</p>

<h1 id="wrapping-up:461468f58b117b97d7e43b7161cf60a9">Wrapping Up</h1>

<p>While exceptions are part of nearly every language, using them correctly and not throwing something just for the sake of it is not easy and requires some thought. Make sure to think of your exceptions while you design the API, test and document them correctly. A lot of frameworks do a very good job on this, so keep your eyes open and prepare yourself to learn something new.</p>

<p>Remember: You gotta catch em&rsquo; all!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">10 May 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/Writing-a-simple-lexer-in-PHP/" class="post-title">Writing a simple lexer in PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h1 id="introduction:2b33965f6a73c85faf8445219846fbab">Introduction</h1>

<p>A lot of developers avoid writing parsers because they think it&rsquo;s pretty hard to do so. Writing an efficient parser for a general purpose language (like PHP, Ruby, Java,&hellip;) is hard, but fortunately, most of the time we don&rsquo;t need that much complexity. Typically we just want to parse input coming from config files or from a specific problem domain (expressed through DSLs). DSLs (Domain Specific Languages) are pretty cool, because they allow you to express logic and flow in a very specific and convenient way for a limited set of tasks.</p>

<p>For example, if you want to map a Route in Lithium to a controller/action, it looks like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">Router::connect(</span><span style="color: #C41A16">&#39;/login&#39;</span><span style="color: #000000">,</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;Sessions::add&#39;</span><span style="color: #000000">));</span>
</pre></div>

<p>Pretty short, but we can do better. Consider the following DSL syntax I just made up:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">map /login -&gt; Sessions::add
</pre></div>

<p>By using a notation like this, it is easer to grasp what&rsquo;s going on, because we can avoid all the PHP specifics like its array or method syntax. Another benefit is that someone who can write a DSL file doesn&rsquo;t need to know the underlying language which implements it. If a Java-guy likes our language, he can write a parser for it as well and the DSL doesn&rsquo;t need to change at all. In our example it doesn&rsquo;t make sense, but the <a href="https://github.com/cucumber/gherkin">Gherkin</a> DSL for behaviour driven development has been ported to various languages. The original implementation was done in Ruby for the <a href="http://cukes.info/">Cucumber</a> project and the <a href="http://behat.org/">Behat</a> project ported it over to PHP.</p>

<p>Okay, back to our example. This is cool, but how can we transform the latter line, so that it executes our original PHP command? We can either explode it by whitespace and then mess around finding the correct keywords. Or, we can write write an interpreter. A compiler (or interpreter) normally consists mainly of two things: a lexer and a parser. The lexer transforms the raw source into a stream of tokens on which the parser operates on. A parser is normally described by a formal notation like <a href="http://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_Form">EBNF</a> or something along that lines and knows what to do when a specific stream of tokens is found.</p>

<p>Let&rsquo;s take our example from above. The <code>map /login -&gt; Sessions::add</code> may be translated into the following token stream by the lexer (for the sake of simplicity we just display them as tuples):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">&lt;T_MAP, &quot;map&quot;&gt;
&lt;T_URL, &quot;/login&quot;&gt;
&lt;T_BLOCKSTART, &quot;-&gt;&quot;&gt;
&lt;T_IDENTIFIER, &quot;Sessions::add&quot;&gt;
</pre></div>

<p>The parser can parse the following notation (note that this is not EBNF, I&rsquo;ve added regex in <code>[]</code> to keep it simple):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">&lt;whitespace&gt;     := [\s]
&lt;map&gt;            := &quot;map&quot;
&lt;url&gt;            := [a-z/]
&lt;blockstart&gt;     := &quot;-&gt;&quot;
&lt;identifier&gt;     := [a-zA-Z0-9:]
&lt;mapBlock&gt;       := &lt;map&gt; &lt;whitespace&gt;* &lt;url&gt;+ &lt;whitespace&gt;* &lt;blockstart&gt; &lt;whitespace&gt;* &lt;identifier&gt;+
</pre></div>

<p>Every rule identified by a <code>:=</code>is called a production rule. I leave the parsing part for a later post, because that would be too much for a single posting. Nevertheless, you can see that if the parser finds a <code>mapBlock</code>(which consists of smaller production rules), it knows the <code>identifier</code> and can transform it into the appropriate <code>Router::connect()</code> call.</p>

<p>Note that is up to you if you ignore whitespace in your lexer. This depends on design decisions like if you want to use significant whitespace or not. If you parse it as a separate token, make sure your parser is intelligent enough to skip them later.</p>

<p>Enough theory, let&rsquo;s get started with the lexer.</p>

<h1 id="implementation:2b33965f6a73c85faf8445219846fbab">Implementation</h1>

<p>The basic idea is that we match a list of regexes against the current line. If one of them matches, we store that token and advance our offset to the first character after the match. If no token is found and we are not yet at the end of the line, raise an exception (because something invalid is in front of our offset).</p>

<p>Let&rsquo;s stick with the example already mentioned above. We want to create tokens for an input file like <code>map /login -&gt; Sessions::add</code> or <code>root -&gt; Pages::home</code>.</p>

<p>The <code>root</code> command maps the <code>/</code>URL (like <code>Router::connect('/', array('Pages::home'));</code> in Lithium). The first thing we need is an array of <a href="http://en.wikipedia.org/wiki/Terminal_and_nonterminal_symbols#Terminal_symbols">terminal symbols</a> that map to token identifiers.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Lexer</span> {
    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #000000">$_terminals</span> <span style="color: #000000">=</span> <span style="color: #A90D91">array</span>(
        <span style="color: #C41A16">&quot;/^(root)/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_ROOT&quot;</span>,
        <span style="color: #C41A16">&quot;/^(map)/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_MAP&quot;</span>,
        <span style="color: #C41A16">&quot;/^(\s+)/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_WHITESPACE&quot;</span>,
        <span style="color: #C41A16">&quot;/^(\/[A-Za-z0-9\/:]+[^\s])/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_URL&quot;</span>,
        <span style="color: #C41A16">&quot;/^(-&gt;)/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_BLOCKSTART&quot;</span>,
        <span style="color: #C41A16">&quot;/^(::)/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_DOUBLESEPARATOR&quot;</span>,
        <span style="color: #C41A16">&quot;/^(\w+)/&quot;</span> <span style="color: #000000">=&gt;</span> <span style="color: #C41A16">&quot;T_IDENTIFIER&quot;</span>,
    );
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Now, let&rsquo;s implement a <code>run</code> method that accepts an array of source lines and returns an array of tokens. It calls the helper <code>_match</code> method that performs the actual matching and raises an exception if no token was found.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">run</span>(<span style="color: #000000">$source</span>) {
    <span style="color: #000000">$tokens</span> <span style="color: #000000">=</span> <span style="color: #000000">array</span>();

    <span style="color: #000000">foreach</span>(<span style="color: #000000">$source</span> <span style="color: #000000">as</span> <span style="color: #000000">$number</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$line</span>) {            
        <span style="color: #000000">$offset</span> <span style="color: #000000">=</span> <span style="color: #1C01CE">0</span>;
        <span style="color: #A90D91">while</span>(<span style="color: #000000">$offset</span> <span style="color: #000000">&lt;</span> <span style="color: #000000">strlen</span>(<span style="color: #000000">$line</span>)) {
            <span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #A90D91">static</span><span style="color: #000000">::_match</span>(<span style="color: #000000">$line</span>, <span style="color: #000000">$number</span>, <span style="color: #000000">$offset</span>);
            <span style="color: #A90D91">if</span>(<span style="color: #000000">$result</span> <span style="color: #000000">===</span> <span style="color: #A90D91">false</span>) {
                <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Exception</span>(<span style="color: #C41A16">&quot;Unable to parse line &quot;</span> . (<span style="color: #000000">$line+</span><span style="color: #1C01CE">1</span>) . <span style="color: #C41A16">&quot;.&quot;</span>);
            }
            <span style="color: #000000">$tokens</span><span style="color: #633820">[]</span> <span style="color: #000000">=</span> <span style="color: #000000">$result</span>;
            <span style="color: #000000">$offset</span> <span style="color: #000000">+=</span> <span style="color: #000000">strlen</span>(<span style="color: #000000">$result</span><span style="color: #633820">[</span><span style="color: #C41A16">&#39;match&#39;</span><span style="color: #633820">]</span>);
        }
    }

    <span style="color: #A90D91">return</span> <span style="color: #000000">$tokens</span>;
}
</pre></div>

<p>Note that how we advance the offset further every iteration and work towards the end of the string. To get the full picture, here&rsquo;s the <code>_match</code> helper method.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">_match</span>(<span style="color: #000000">$line</span>, <span style="color: #000000">$number</span>, <span style="color: #000000">$offset</span>) {
    <span style="color: #000000">$string</span> <span style="color: #000000">=</span> <span style="color: #000000">substr</span>(<span style="color: #000000">$line</span>, <span style="color: #000000">$offset</span>);

    <span style="color: #000000">foreach</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::$_terminals</span> <span style="color: #000000">as</span> <span style="color: #000000">$pattern</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$name</span>) {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">preg_match</span>(<span style="color: #000000">$pattern</span>, <span style="color: #000000">$string</span>, <span style="color: #000000">$matches</span>)) {
            <span style="color: #A90D91">return</span> <span style="color: #000000">array</span>(
                <span style="color: #C41A16">&#39;match&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$matches</span><span style="color: #633820">[</span><span style="color: #1C01CE">1</span><span style="color: #633820">]</span>,
                <span style="color: #C41A16">&#39;token&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$name</span>,
                <span style="color: #C41A16">&#39;line&#39;</span> <span style="color: #000000">=&gt;</span> <span style="color: #000000">$number+</span><span style="color: #1C01CE">1</span>
            );
        }
    }

    <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
}
</pre></div>

<p>We use the <code>preg_match</code> method to check if one of our pattern matches the current string. If you look closely, you can see that all of our regexes start at the beginning of the line (<code>^</code>) and
are enclosed (<code>()</code>) so we can find them exactly at the beginning and get the inner content. We also store the current line, because we need it in our parser and to display helpful error messages.</p>

<p>Let&rsquo;s run our lexer with some example input:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$input</span> <span style="color: #000000">=</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;root -&gt; Foo::bar&#39;</span><span style="color: #000000">);</span>
<span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Lexer::run($input);</span>
<span style="color: #000000">var_dump($result);</span>
</pre></div>

<p>We should get the following output:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">array
  0 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39;root&#39; (length=4)
      &#39;token&#39; =&gt; string &#39;T_ROOT&#39; (length=6)
      &#39;line&#39; =&gt; int 1
  1 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39; &#39; (length=1)
      &#39;token&#39; =&gt; string &#39;T_WHITESPACE&#39; (length=12)
      &#39;line&#39; =&gt; int 1
  2 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39;-&gt;&#39; (length=2)
      &#39;token&#39; =&gt; string &#39;T_BLOCKSTART&#39; (length=12)
      &#39;line&#39; =&gt; int 1
  3 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39; &#39; (length=1)
      &#39;token&#39; =&gt; string &#39;T_WHITESPACE&#39; (length=12)
      &#39;line&#39; =&gt; int 1
  4 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39;Foo&#39; (length=3)
      &#39;token&#39; =&gt; string &#39;T_IDENTIFIER&#39; (length=12)
      &#39;line&#39; =&gt; int 1
  5 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39;::&#39; (length=2)
      &#39;token&#39; =&gt; string &#39;T_DOUBLESEPARATOR&#39; (length=17)
      &#39;line&#39; =&gt; int 1
  6 =&gt; 
    array
      &#39;match&#39; =&gt; string &#39;bar&#39; (length=3)
      &#39;token&#39; =&gt; string &#39;T_IDENTIFIER&#39; (length=12)
      &#39;line&#39; =&gt; int 1
</pre></div>

<p>We got a stream of tokens that represents our source file. Let&rsquo;s run it with invalid input:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #000000">$input</span> <span style="color: #000000">=</span> <span style="color: #000000">array(</span><span style="color: #C41A16">&#39;root -&gt; ?invalid&#39;</span><span style="color: #000000">);</span>
<span style="color: #000000">$result</span> <span style="color: #000000">=</span> <span style="color: #000000">Lexer::run($input);</span>
</pre></div>

<p>This raises an exception with the message <code>Unable to parse line 1.</code>.</p>

<h1 id="wrapping-up:2b33965f6a73c85faf8445219846fbab">Wrapping Up</h1>

<p>One thing you need to be aware of is that you need to place your token regex in the correct order - namely from special to general. If we put the <code>T_IDENTIFIER</code> before <code>T_ROOT</code>, the <code>root</code> keyword would always be matched as an identifier. While I haven&rsquo;t tried it out yet,<a href="https://twitter.com/#!/nikita_ppv">Nikita Popov</a> <a href="http://nikic.github.com/2011/10/23/Improving-lexing-performance-in-PHP.html">points out</a> that compiling all regexes into a big one leads to better performance.</p>

<p>Writing a simple lexer is not hard and (in my opinion) very flexible. If you need more  in your DSL, just add new regex &lt;-&gt; token mappings. I&rsquo;d recommend to start with a small amount of tokens and writing unit-tests for each of them. If you add more tokens, add more unit tests, so you can be sure that your rules don&rsquo;t override each other and everything still works as expected.</p>

<p>As always, if you have feedback, ideas or improvements, let me know!</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 1 of 4</span>
    
      <a href="/tags/php/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
		<li>&copy; Michael Nitschinger 2010-2016</li>
        </ul>
    </div>
</div>
<script src="http://nitschinger.at//js/all.min.js"></script>

        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
