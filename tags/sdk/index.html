<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdk &middot; daschl writes. sometimes.</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.40.3" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Sdk &middot; daschl writes. sometimes.">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Sdk &middot; daschl writes. sometimes.">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://nitschinger.at/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="daschl writes. sometimes." href="https://nitschinger.at/index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title">
                <a href="https://nitschinger.at">daschl writes. sometimes.</a>
            </h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/daschl">
                        <i class="fa fa-twitter"></i> Twitter</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/daschl">
                        <i class="fa fa-github-alt"></i> github</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://nitschinger.at/index.xml">
                        <i class="fa fa-rss"></i> rss</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="https://nitschinger.at/imprint">Imprint</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">07 Nov 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/New-Features-in-the-Couchbase-Java-Client-1-1-dp4/" class="post-title">New Features in the Couchbase Java Client 1.1-dp4</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="introduction">Introduction</h2>

<p>The latest <a href="http://www.couchbase.com/develop/java/next">Java Developer Preview (dp4)</a> is hot off the press, and therefore I thought it would be a good idea to show you how to use some of the brand-new features that are now available. This post will show you how to use the new <code>ComplexKey</code> class for view queries and also how to create and delete buckets directly from your SDK.</p>

<p>First, we added a very flexible way of providing parameters to view queries. The idea is that, instead of having to deal with JSON strings on your own, you can pass in Java objects and the appropriate JSON string will be created for you. While it may not sound like a big deal first, this also frees you from the worries about encoding it properly so that it can be transferred over HTTP. Before we dig into the inner workings, lets first start with a basic example on how to create a view query.</p>

<p>Every time you query a view, you need to create a <code>Query</code> and a <code>View</code> object. The <code>View</code> both  object defines the name of the design document and the view, and the <code>Query</code> object allows you to control the params that you can supply with the query.</p>

<pre><code>View myview = client.getView(&quot;designdoc&quot;, &quot;viewname&quot;);
</code></pre>

<p>Instead of creating the <code>View</code> object directly, you use the <code>getView()</code> method on the client object. It is important to know that the SDK actually fetches view information from the server and will throw an exception if either the design document name or the view name are not found. An exception typically looks like this:</p>

<pre><code>com.couchbase.client.protocol.views.InvalidViewException: Could not load view &quot;viewname&quot; for design doc &quot;designdoc&quot;
</code></pre>

<p>Now that we have our view created, let&rsquo;s instantiate a query object:</p>

<pre><code>Query myquery = new Query();
</code></pre>

<p>If you don&rsquo;t specify anything else, the query object will work with the default settings. This means that no reduce function will be used and the full documents are not included. If you want to change these settings (or others), the <code>Query</code> instance provides setter methods for all of them. If you want to find out more, look at the SDK documentation or at the <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-querying-rest-api.html">Couchbase Server manual</a>. Basically, you can control everything that you could too while querying a view from the Couchbase UI. Here are some examples:</p>

<pre><code>// Include the full documents as well
myquery.setIncludeDocs(true);

// Enable the reduce function
myquery.setReduce(true);

// Set the group level
myquery.setGroupLevel(2);
</code></pre>

<p>Note that it doesn&rsquo;t make sense to include the full documents and run the reduce phase, since you don&rsquo;t have document references left after the reduce phase. If you try to set both to true, the SDK complains with the following exception:</p>

<pre><code>// query.setReduce(true); query.setIncludeDocs(true);
java.lang.UnsupportedOperationException: Reduced views don't contain documents
</code></pre>

<p>Also, if your view doesn&rsquo;t contain a reduce function and you set <code>reduce</code> to <code>true</code>, you&rsquo;ll see the following:</p>

<pre><code>// query.setReduce(true); on a view with no reduce function defined.
java.lang.RuntimeException: This view doesn't contain a reduce function
</code></pre>

<h2 id="querying-with-complexkeys">Querying with ComplexKeys</h2>

<p>Enough with exceptions, here comes the fun part: some query setter methods not only accept boolean or string arguments, they also allow instances of <code>ComplexKey</code>. <code>ComplexKey</code> takes care of translating your Java objects (or primitives) to their appropriate <a href="http://json.org/">JSON</a> representation. Here is a list of the query methods who support it:</p>

<ul>
<li>setKey(ComplexKey): Return only documents that match the specified key.</li>
<li>setKeys(ComplexKey): Return only documents that match each of keys specified within the given array.</li>
<li>setRange(ComplexKey, ComplexKey): Returns records in the given key range.</li>
<li>setRangeStart(ComplexKey): Return records with a value equal to or greater than the specified key.</li>
<li>setRangeEnd(ComplexKey): Stop returning records when the specified key is reached.</li>
</ul>

<p>An instance of a <code>ComplexKey</code> object is obtained through the static <code>of</code> factory method. When the query object is accessed during the view query, the <code>toJSON()</code> method is called on it and as a result the JSON string is generated. Here are some examples:</p>

<pre><code>// JSON Result: 100
ComplexKey.of(100);

// JSON Result: &quot;Hello&quot;
ComplexKey.of(&quot;Hello&quot;);

// JSON Result: [&quot;Hello&quot;, &quot;World&quot;]
ComplexKey.of(&quot;Hello&quot;, &quot;World&quot;);

// JSON Result: [1349360771542,1]
ComplexKey.of(new Date().getTime(), 1);
</code></pre>

<p>This means that you don&rsquo;t have to deal with building the proper JSON strings for yourself (and make sure the escaping is correct). All methods except <code>setRange()</code> expect exactly one instance of ComplexKey. For example, if you emit keys with a unix timestamp and you want to fetch all records until now, you could do it like so:</p>

<pre><code>Query query = new Query();
query.setRangeEnd(ComplexKey.of(new Date().getTime()));
</code></pre>

<p>When converted to a string to send it over the wire, it would look like this: <code>?endkey=1349361137738</code>. This makes it also very easy to create a full range query:</p>

<pre><code>long now = new Date().getTime();
long tomorrow = now + 86400;
Query query = new Query();
query.setRange(ComplexKey.of(now), ComplexKey.of(tomorrow));
</code></pre>

<p>This converts to <code>?startkey=1349362647742&amp;endkey=1349362734142</code> on the wire.</p>

<h2 id="bucket-management-through-the-clustermanager">Bucket management through the ClusterManager</h2>

<p>Until now, you&rsquo;d have to <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-admin-web-console-data-buckets.html">create and delete buckets</a> either manually through the Couchbase UI or by using the REST API directly. With the addition of the <code>ClusterManager</code>, it is now possible to mange your buckets directly through the SDK, be it for testing purposes or to automatically create them when your code is deployed to a new environment. This can be especially useful if you want to automate bucket management in a staging or CI environment.</p>

<p>The management API is not accessible through <code>CouchbaseClient</code>, but through the <code>ClusterManager</code> class. This is because the <code>CouchbaseClient</code> is bound to a specific bucket and was not designed for management purposes like this. Instead, you create a new instance of the <code>ClusterManager</code> class and pass it a list of URIs and the admin user name and password.</p>

<pre><code>List&lt;URI&gt; uris = new LinkedList&lt;URI&gt;();
uris.add(URI.create(&quot;http://127.0.0.1:8091/pools&quot;));
ClusterManager manager = new ClusterManager(uris, &quot;Administrator&quot;, &quot;password&quot;);

// .. your code

manager.shutdown();
</code></pre>

<p>You can now create and delete buckets (of type <code>Couchbase</code> or <code>Memcached</code>). You can also list all available buckets in the Couchbase cluster or flush the bucket (if flush is enabled). Here are some examples:</p>

<pre><code>// Create the default bucket with a 100MB memory limit and 0 replicas.
manager.createDefaultBucket(BucketType.COUCHBASE, 100, 0);

// Create a bucket with authentication.
manager.createSaslBucket(BucketType.COUCHBASE, &quot;saslbucket&quot;, 100, 0, &quot;password&quot;);

// Get a list of all buckets in the cluster.
List&lt;String&gt; buckets = manager.listBuckets();

// Delete a bucket
manager.deleteBucket(&quot;saslbucket&quot;);

// Check if a bucket named &quot;mybucket&quot; exists in the cluster:
List&lt;String&gt; buckets = manager.listBuckets();
assertTrue(buckets.contains(&quot;mybucket&quot;));

// Flush the &quot;default&quot; bucket if flush is enabled
manager.flushBucket(&quot;default&quot;);
</code></pre>

<p>Note that creating, deleting and flushing may take some time (from milliseconds to seconds, depending on the cluster load). You can either wait a few seconds before you move on (with a Thread.sleep()), or you can wait until <code>listBuckets()</code> contains your created bucket. There is also a callback-approach (which the client library uses internally to minimize waiting times during tests), but this involves more code on the application side.</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>This post showed you two brand-new features shipped with the 1.1-dp4 release.</p>

<p>While you can still use string-based keys to run range or key queries, the <code>ComplexKey</code> class hopefully provides a convenient addition to your tool belt. While also useful for primitives and single objects, it makes it much more convenient to create JSON arrays or objects since you don&rsquo;t have to deal with brackets and escaping yourself.</p>

<p>The <code>ClusterManager</code> gives you the flexibility to manage your buckets directly from the SDK to avoid separate HTTP calls or even manual interaction through the UI.</p>

<p>The full release notes are available <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/couchbase-sdk-java-rn_1-1-0d.html">here</a>. As always, we&rsquo;re curious what you say about this and if you encounter bugs or know how to enhance it even more, feel free to comment below, create a ticket or post in the forums!</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">12 Mar 2012</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://nitschinger.at/Getting-Started-with-Couchbase-and-PHP/" class="post-title">Getting Started with Couchbase and PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p><a href="http://www.couchbase.com/">Couchbase</a> is a simple, fast and elastic document-oriented database. It is the product of a merge between the companies behind Memcached (Membase) and CouchDB. The current version is 1.8 and the 2.0 version is already in a developer preview release. If you haven&rsquo;t heard much about Couchbase yet, start at the <a href="http://www.couchbase.com/webinar/couchbase-server-2.0-overview">Couchbase Webinar Series</a>, which will get you up to speed. The full manual is available <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/index.html">here</a>.</p>

<p>As there were a lot of merges, renamings and releases, it was pretty hard to follow up with the current/best database version and SDK to use for your project. Now as the dust has settled a bit, here&rsquo;s what I&rsquo;ve come up with:</p>

<p>Couchbase 2.0 will be the next major version and is already pretty stable, so I&rsquo;ll jump straight onto it and skip 1.8. When it comes to PHP SDKs, you should either use the more feature-complete <a href="https://github.com/couchbaselabs/php-couchbase">php-couchbase</a> SDK (which is based on pecl/memcached) or work the brand new <a href="https://github.com/couchbaselabs/php-ext-couchbase">php-ext-couchbase</a> extension. Note that it doesn&rsquo;t support working with views currently, but according to <a href="https://twitter.com/#!/janl">janl</a> this will be available in a few days. He also mentioned that this extension is the
future way of interacting with Couchbase, so it is definitely worth a look.</p>

<p>The rest of this post guides you through the installation process of both Couchbase and the PHP SDKs.</p>

<h2 id="installing-couchbase">Installing Couchbase</h2>

<p>The easiest way to install Couchbase is through a precompiled binary for Ubuntu, RedHat, Windows or Mac OS X. You can find all of them
<a href="http://www.couchbase.com/download">here</a>. The installation process is really straightforward: you first need to install the binary and
then configure Couchbase from a web interface. I recommend you to watch the webinar starting from minute 7 <a href="http://www.couchbase.com/webinar/couchbase-server-2.0-overview">here</a>, where Perry Krug describes the necessary steps in detail. For the purpose of this post, you can just stick with the default settings.</p>

<pre><code>$ sudo dpkg -i couchbase-server-community_x86_2.0.0-dev-preview-3.deb
</code></pre>

<p>After the installation, you should have a Couchbase instance listening on <code>127.0.0.1:8091</code>.</p>

<h2 id="installing-php-ext-couchbase">Installing php-ext-couchbase</h2>

<p>The new PHP SDK ships as a PHP extension, so we need to compile it. Make sure you have both the build tools (like <code>build-essentials</code>) and the PHP development packages (<code>php5-dev php-pear</code>) installed. You also need to install <code>libssl0.9.8</code>. On Ubuntu it looks like this:</p>

<pre><code>$ sudo aptitude install libssl0.9.8 php5-dev php-pear
</code></pre>

<p>The extension also depends on the <code>libcouchbase</code> library, which can be installed through the Couchbase repository (for more information on this, look <a href="http://www.couchbase.com/develop/c/current">here</a>).</p>

<p>Add this to your <code>/etc/apt/sources.list</code>:</p>

<pre><code># Ubuntu 11.10 Oneiric Ocelot (Debian unstable)
deb http://packages.couchbase.com/ubuntu oneiric oneiric/main
</code></pre>

<p>Then, import the key, update your repositories and install the package:</p>

<pre><code>$ wget -O- http://packages.couchbase.com/ubuntu/couchbase.key | sudo apt-key add -
$ sudo aptitude update &amp;&amp; sudo aptitude install libcouchbase-dev
</code></pre>

<p>Now, we need to <a href="https://github.com/couchbaselabs/php-ext-couchbase/zipball/master">download</a> the extension and build it.</p>

<pre><code>$ unzip couchbaselabs-php-ext-couchbase-2680b64.zip
$ cd couchbaselabs-php-ext-couchbase-2680b64

$ phpize
$ ./configure
$ make
$ sudo make install
  Installing shared extensions:     /usr/lib/php5/20090626+lfs/
</code></pre>

<p>The last thing we need to do is create a new <code>couchbase.ini</code> file in <code>/etc/php5/conf.d</code> with the following content:</p>

<pre><code>extension=couchbase.so
</code></pre>

<p>Now we can see that the couchbase extension is installed correctly:</p>

<pre><code>$ php -m | grep couch
couchbase
</code></pre>

<p>Of course you&rsquo;ll need to restart your webserver or your fastcgi processes too.</p>

<h2 id="installing-php-couchbase">Installing php-couchbase</h2>

<p>If you want to work with the current stable SDK, you need to download the code from the <a href="https://github.com/couchbaselabs/php-couchbase">php-couchbase</a> repository. This SDK extends the <code>memcached</code> extension, which you can install directly through apt:</p>

<pre><code>$ sudo aptitude install php5-memcached
</code></pre>

<p>Documentation for the PHP 1.1 SDK can be found <a href="http://www.couchbase.com/docs/couchbase-sdk-php-1.1/getting-started.html">here</a>.</p>

<p>Note that for the rest of this post I&rsquo;ll use the API provided by the <code>php-ext-couchbase</code> extension, but the one for <code>php-couchbase</code> shouldn&rsquo;t be much different.</p>

<h2 id="basic-usage">Basic Usage</h2>

<p>Historically, communication with CouchDB was done over pure HTTP while memcached provided a custom protocol. Couchbase uses both methods, depending on the task you want to accomplish. Create, update and delete actions are done through the <code>memcached</code> protocol. If you want to read data, you can do that either based on the key (through the memcached protocol) or on a view (through HTTP). Thankfully, the SDK abstracts this away from you, but its always good if you know whats going on under the hood.</p>

<p>You can access the API through an object-oriented interface or directly through their exported functions. I couldn&rsquo;t find any online documentation for now, but here&rsquo;s the function list from the source-code:</p>

<pre><code>/* {{{ couchbase_functions[]
*/
static zend_function_entry couchbase_functions[] = {
    PHP_FE(couchbase_connect, arginfo_connect)
    PHP_FE(couchbase_add, arginfo_add)
    PHP_FE(couchbase_set, arginfo_set)
    PHP_FE(couchbase_set_multi, arginfo_set_multi)
    PHP_FE(couchbase_replace, arginfo_replace)
    PHP_FE(couchbase_prepend, arginfo_prepend)
    PHP_FE(couchbase_append, arginfo_append)
    PHP_FE(couchbase_cas, arginfo_cas)
    PHP_FE(couchbase_get, arginfo_get)
    PHP_FE(couchbase_get_multi, arginfo_get_multi)
    PHP_FE(couchbase_get_delayed, arginfo_get_delayed)
    PHP_FE(couchbase_fetch, arginfo_fetch)
    PHP_FE(couchbase_fetch_all, arginfo_fetch_all)
    PHP_FE(couchbase_increment, arginfo_increment)
    PHP_FE(couchbase_decrement, arginfo_decrement)
    PHP_FE(couchbase_get_stats, arginfo_get_stats)
    PHP_FE(couchbase_delete, arginfo_delete)
    PHP_FE(couchbase_flush, arginfo_flush)
    PHP_FE(couchbase_get_result_code, arginfo_result_code)
    PHP_FE(couchbase_set_option, arginfo_set_option)
    PHP_FE(couchbase_get_option, arginfo_get_option)
    PHP_FE(couchbase_version, arginfo_version)
    {NULL, NULL, NULL}
};
</code></pre>

<p>The <a href="https://github.com/couchbaselabs/php-ext-couchbase/tree/master/tests">test cases</a> also provide vital information on how to use the API.</p>

<p>Let&rsquo;s create 10 JSON documents and store them in Couchbase:</p>

<pre><code>&lt;?php

$connection = new Couchbase(&quot;127.0.0.1:8091&quot;);

for($i=0;$i&lt;10;$i++) {
    $doc = array(
        'title' =&gt; &quot;This is Post $i&quot;
    );
    $connection-&gt;set(&quot;post_$i&quot;, json_encode($doc));
}

?&gt;
</code></pre>

<p>You can view your stored documents instantly through the GUI (<a href="http://localhost:8091/index.html#sec=documents&amp;bucketName=default">http://localhost:8091/index.html#sec=documents&amp;bucketName=default</a>). Now we can retrieve all documents again by their keys:</p>

<pre><code>&lt;?php

$connection = new Couchbase(&quot;127.0.0.1:8091&quot;);

echo &quot;&lt;ul&gt;&quot;;
for($i=0;$i&lt;10;$i++) {
    $post = json_decode($connection-&gt;get(&quot;post_$i&quot;));
    echo &quot;&lt;li&gt;&quot; . $post-&gt;title .  &quot;&lt;/li&gt;&quot;;
}
echo &quot;&lt;/ul&gt;&quot;;

?&gt;
</code></pre>

<p>Note that we need to encode/decode our JSON documents by hand, because in Couchbase you can store pretty much what you want in a document.</p>

<p>There are lots of other things that can be explored, but for now you should have a Couchbase instance up and running and you can start to explore it on your own!</p>

<p>&rdquo;&lsquo;Edit 1:&ldquo;&rsquo;
Jan <a href="https://twitter.com/#!/janl/status/179166150205259776">pointed out</a> that they don&rsquo;t recommend php-couchbase at this point as the extension will gain all functionality soon. Thanks!</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; Michael Nitschinger 2010-2018</li>
        </ul>
    </div>
</div>
<script src="https://nitschinger.at/js/all.min.js"></script>
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-19686689-1', 'auto');
    ga('send', 'pageview');
    ga('set', 'anonymizeIp', true);
</script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
