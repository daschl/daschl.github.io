<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Logging on daschl writes. sometimes.</title>
    <link>http://nitschinger.at/tags/logging/</link>
    <description>Recent content in Logging on daschl writes. sometimes.</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Thu, 16 May 2013 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://nitschinger.at/tags/logging/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Logging with the Couchbase Java Client</title>
      <link>http://nitschinger.at/Logging-with-the-Couchbase-Java-Client/</link>
      <pubDate>Thu, 16 May 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Logging-with-the-Couchbase-Java-Client/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;There is a huge variety in logging frameworks for Java, and its hard to please everyone. To understand how logging is currently handled in the SDK, we have to go back a few years. As you may know, the SDK depends on the &lt;a href=&#34;https://code.google.com/p/spymemcached/&#34;&gt;spymemcached&lt;/a&gt; library and therefore also inherits its logging mechanisms. Back in the days when &lt;a href=&#34;https://twitter.com/dlsspy&#34;&gt;@dustin&lt;/a&gt; wrote spy, there was no good abstraction for logging available (like SLF4J), so he wrote his own. Nowadays things have changed, but spy still inherits this legacy.&lt;/p&gt;

&lt;p&gt;At the time of writing, the SDK supports logging to a simple default logger (logs to STDERR from INFO level up), &lt;a href=&#34;http://logging.apache.org/log4j/1.2/&#34;&gt;Log4J&lt;/a&gt; and the SunLogger (java.util.logging). In the upcoming 2.9.0 release of spymemcached, it will also support the SLF4J logging facade where you can plug in your own implementation. The next version of the SDK (most likely 1.1.7) will depend on spy 2.9, so you&amp;rsquo;ll also get the benefits there.&lt;/p&gt;

&lt;p&gt;Before we dig into the concepts, here are the supported Log Levels (defined by &lt;code&gt;net.spy.memcached.compat.log.Level&lt;/code&gt;):&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;TRACE (with 2.9)&lt;/li&gt;
&lt;li&gt;DEBUG&lt;/li&gt;
&lt;li&gt;INFO&lt;/li&gt;
&lt;li&gt;WARN&lt;/li&gt;
&lt;li&gt;ERROR&lt;/li&gt;
&lt;li&gt;FATAL&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Keep in mind that different loggers implement different levels, so for some of them a mapping needs top happen. This will be noted during the descriptions of each implementation.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;ll now look at the different logging mechanisms available and how you can configure them. SLF4J will be covered towards the end.&lt;/p&gt;

&lt;h2 id=&#34;switching-logging&#34;&gt;Switching Logging&lt;/h2&gt;

&lt;p&gt;If you don&amp;rsquo;t change anything, the default logger will be used. This mechanism just prints log messages to STDERR (from INFO level upwards). Chances are that you want to integrate the SDK with the same logging library that you use as well. The LoggerFactory inside spy decides at construction which one to choose, based on a system property. So you can either change this programmatically or through a param to the &lt;code&gt;java&lt;/code&gt; command.&lt;/p&gt;

&lt;p&gt;If you want to use the Log4JLogger programmatically, do it this way (before initializing the &lt;code&gt;CouchbaseClient&lt;/code&gt; object):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.Log4JLogger&amp;quot;);
System.setProperties(systemProperties);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Of course, you need to add the Log4J JAR to your CLASSPATH to make it work (as we&amp;rsquo;ll see later). Alternatively, you can set it this way on the comman dline:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;java -Dnet.spy.log.LoggerImpl=net.spy.memcached.compat.log.Log4JLogger ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we know how to enable the different implementations, let&amp;rsquo;s look at them in greater detail.&lt;/p&gt;

&lt;h2 id=&#34;the-simple-default-logger&#34;&gt;The Simple Default Logger&lt;/h2&gt;

&lt;p&gt;If you don&amp;rsquo;t change anything, the SDK will use the DefaultLogger (net.spy.memcached.compat.log.DefaultLogger). This logger has no dependencies and prints every log message that is INFO level or higher (INFO, WARN, ERROR and FATAL) to the systems STDERR. Since the STDERR is covered by most IDEs automatically, you&amp;rsquo;ll also see them in the console output window.&lt;/p&gt;

&lt;p&gt;Since its so simple, you can&amp;rsquo;t customize this behavior. Every log message gets timestamped as well (the format is &lt;code&gt;yyyy-MM-dd HH:mm:ss.SSS&lt;/code&gt;). Connecting to Couchbase commonly looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;2013-05-07 12:28:41.852 INFO com.couchbase.client.CouchbaseConnection:  Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
2013-05-07 12:28:41.862 INFO com.couchbase.client.CouchbaseConnection:  Connection state changed for sun.nio.ch.SelectionKeyImpl@3d9360e2
2013-05-07 12:28:41.887 INFO com.couchbase.client.ViewConnection:  Added localhost to connect queue
2013-05-07 12:28:41.888 INFO com.couchbase.client.CouchbaseClient:  viewmode property isn&#39;t defined. Setting viewmode to production mode
2013-05-07 12:28:41.986 INFO com.couchbase.client.CouchbaseConnection:  Shut down Couchbase client
2013-05-07 12:28:41.991 INFO com.couchbase.client.ViewConnection:  Node localhost has no ops in the queue
2013-05-07 12:28:41.992 INFO com.couchbase.client.ViewNode:  I/O reactor terminated for localhost
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So the format is always: &lt;code&gt;&amp;lt;timestamp&amp;gt; &amp;lt;level&amp;gt; &amp;lt;classname&amp;gt; &amp;lt;message&amp;gt;&lt;/code&gt;. Remeber that DEBUG messages or so will not be logged, so you won&amp;rsquo;t see them with the DefaultLogger.&lt;/p&gt;

&lt;h2 id=&#34;the-sunlogger-java-util-logging&#34;&gt;The SunLogger (java.util.logging)&lt;/h2&gt;

&lt;p&gt;The SunLogger also doesn&amp;rsquo;t introduce additional dependencies, since it depends on the &lt;code&gt;java.util.logging&lt;/code&gt; implementation. The &lt;code&gt;java.util.logging.Level&lt;/code&gt; enum defines the following levels: ALL, CONFIG, FINEST, FINER, FINE, INFO, WARNING, SEVERE and OFF. Since this does not map well to our defined Levels, here is the mapping that happens:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;TRACE to FINEST (with 2.9)&lt;/li&gt;
&lt;li&gt;DEBUG to FINE&lt;/li&gt;
&lt;li&gt;INFO to INFO&lt;/li&gt;
&lt;li&gt;WARN to WARNING&lt;/li&gt;
&lt;li&gt;ERROR to SEVERE&lt;/li&gt;
&lt;li&gt;FATAL to SEVERE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Without any further changes, the SunLogger also prints from INFO level upwards like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;May 7, 2013 12:42:16 PM com.couchbase.client.CouchbaseProperties setPropertyFile
INFO: Could not load properties file &amp;quot;cbclient.properties&amp;quot; because: File not found with system classloader.
May 7, 2013 12:42:16 PM net.spy.memcached.MemcachedConnection createConnections
INFO: Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
May 7, 2013 12:42:16 PM net.spy.memcached.MemcachedConnection handleIO
INFO: Connection state changed for sun.nio.ch.SelectionKeyImpl@4ce2cb55
May 7, 2013 12:42:16 PM com.couchbase.client.ViewConnection createConnections
INFO: Added localhost to connect queue
May 7, 2013 12:42:16 PM com.couchbase.client.CouchbaseClient &amp;lt;init&amp;gt;
INFO: viewmode property isn&#39;t defined. Setting viewmode to production mode
May 7, 2013 12:42:16 PM com.couchbase.client.CouchbaseConnection run
INFO: Shut down Couchbase client
May 7, 2013 12:42:16 PM com.couchbase.client.ViewConnection shutdown
INFO: Node localhost has no ops in the queue
May 7, 2013 12:42:16 PM com.couchbase.client.ViewNode$1 run
INFO: I/O reactor terminated for localhost
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you want to change the log level to DEBUG and lower, you can do it like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Logger.getLogger(&amp;quot;com.couchbase.client&amp;quot;).setLevel(Level.FINEST);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now there is one more thing you need to do if you want to print all debug messages to the console. You set the logging level correctly, but the &lt;code&gt;ConsoleHandler&lt;/code&gt; is not set to debug yet (so most likely you will pay the price for debug logging, but won&amp;rsquo;t actually see anything in your IDE).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;for(Handler h : Logger.getLogger(&amp;quot;com.couchbase.client&amp;quot;).getParent().getHandlers()) {
    if(h instanceof ConsoleHandler) {
        h.setLevel(Level.FINEST);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, here is a full example on how to use the &lt;code&gt;SunLogger&lt;/code&gt; and get all Debug messages on the console.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.SunLogger&amp;quot;);
System.setProperties(systemProperties);

Logger logger = Logger.getLogger(&amp;quot;com.couchbase.client&amp;quot;);
logger.setLevel(Level.FINEST);
for(Handler h : logger.getParent().getHandlers()) {
    if(h instanceof ConsoleHandler){
        h.setLevel(Level.FINEST);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then just go ahead and create your &lt;code&gt;CouchbaseClient&lt;/code&gt; object, you will see detailed output like this (trimmed here):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: Received an update, notifying reconfigurables about a com.couchbase.client.vbucket.config.Bucketcom.couchbase.client.vbucket.config.Bucket@3d77949
May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: Received an update, notifying reconfigurables about a com.couchbase.client.vbucket.config.Bucketcom.couchbase.client.vbucket.config.Bucket@4e927aef
May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: It says it is default and it&#39;s talking to /pools/default/bucketsStreaming/default?bucket_uuid=adfff22b70e09fafaa26ca37b7e05e9d
May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: It says it is default and it&#39;s talking to /pools/default/bucketsStreaming/default?bucket_uuid=adfff22b70e09fafaa26ca37b7e05e9d
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;log4j&#34;&gt;Log4J&lt;/h2&gt;

&lt;p&gt;Most people will need more flexibility, and Log4J was (and still is) standard in lots of applications. The SDK provides support for Log4J as well. To make it work, you first need to set the instance correctly:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.Log4JLogger&amp;quot;);
System.setProperties(systemProperties);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now if you run this, you&amp;rsquo;ll get an error that some of the Log4J classes can not be found. This is not a surprise, because its not on the classpath. Let&amp;rsquo;s fix this by adding it accordingly. If you use maven, add the &lt;code&gt;log4j.log4j&lt;/code&gt; dependency (current version is 1.2.17). You can also just download the JAR and add it to the CLASSPATH as needed.&lt;/p&gt;

&lt;p&gt;Now if we run it again, we get another error:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;log4j:WARN No appenders could be found for logger (com.couchbase.client.vbucket.ConfigurationProviderHTTP).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;One way to fix this is to get a correct &lt;code&gt;log4j.xml&lt;/code&gt; configuration file into our CLASSPATH, but to make it work quickly Log4J provides a &lt;code&gt;BasicConfigurator&lt;/code&gt;. Right after the system property configurations, add this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;org.apache.log4j.BasicConfigurator.configure();
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you run it with the code change applied, you will see that we get nicely printed log messages. You can also see that they show up straight from the DEBUG level (and even contain information from which thread they got logged):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;69 [main] INFO com.couchbase.client.CouchbaseConnection  - Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
70 [main] DEBUG com.couchbase.client.vbucket.VBucketNodeLocator  - Updating nodesMap in VBucketNodeLocator.
73 [main] DEBUG com.couchbase.client.vbucket.VBucketNodeLocator  - Adding node with hostname 127.0.0.1:11210.
74 [main] DEBUG com.couchbase.client.vbucket.VBucketNodeLocator  - Node added is {QA sa=localhost/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=8}.
74 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG com.couchbase.client.CouchbaseConnection  - Done dealing with queue.
74 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG com.couchbase.client.CouchbaseConnection  - Selecting with delay of 0ms
79 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG com.couchbase.client.CouchbaseConnection  - Selected 1, selected 1 keys
79 [Memcached IO over
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can control the logging levels through the usual Log4J mechanisms. I won&amp;rsquo;t go into detail about them here, so please &lt;a href=&#34;http://logging.apache.org/log4j/1.2/manual.html&#34;&gt;check out&lt;/a&gt; their official documentation (for example on how to use the &lt;code&gt;PropertyConfigurator&lt;/code&gt; instead).&lt;/p&gt;

&lt;p&gt;Speaking of Log4J, &lt;a href=&#34;https://twitter.com/zooldk&#34;&gt;Steffen Larsen&lt;/a&gt; implemented a &lt;a href=&#34;https://github.com/zooldk/log4j-couchbase&#34;&gt;Log4J appender&lt;/a&gt; to store logs in Couchbase (instead of a file)!&lt;/p&gt;

&lt;h2 id=&#34;the-new-facade-slf4j&#34;&gt;The new Facade: SLF4J&lt;/h2&gt;

&lt;p&gt;Not binding the application to a specific logging library is always a good idea. SLF4J is a facade for various pluggable logging frameworks behind it. So you can choose the logging implementation during runtime, be it &lt;a href=&#34;http://logback.qos.ch/&#34;&gt;logback&lt;/a&gt;, Log4J or others. Since we already tried Log4J, let&amp;rsquo;s make SLF4J work with Logback, one of the other very common log frameworks out there.&lt;/p&gt;

&lt;p&gt;Note that SLF4J support will be available in the 1.9.0 release of spymemcached and therefore also in one of the next releases of the Couchbase Java SDK.&lt;/p&gt;

&lt;p&gt;First, we need to configure it accordingly:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.SLF4JLogger&amp;quot;);
System.setProperties(systemProperties);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, we need to include two JARs into our classpath. The first one is the SLF4J facade API and the other one is our logging framework of choice. The facade API package is called &lt;code&gt;slf4j-api&lt;/code&gt; (this package always needs to be in place) and since we want to use logback we need to include the &lt;code&gt;logback-classic&lt;/code&gt; JAR. Note that this is not specific to the SDK, you can find this information &lt;a href=&#34;http://logback.qos.ch/manual/introduction.html&#34;&gt;here&lt;/a&gt;. If you use maven, you can use this snippet:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependency&amp;gt;
  &amp;lt;groupId&amp;gt;org.slf4j&amp;lt;/groupId&amp;gt;
  &amp;lt;artifactId&amp;gt;slf4j-api&amp;lt;/artifactId&amp;gt;
  &amp;lt;version&amp;gt;1.7.5&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&amp;lt;dependency&amp;gt;
  &amp;lt;groupId&amp;gt;ch.qos.logback&amp;lt;/groupId&amp;gt;
  &amp;lt;artifactId&amp;gt;logback-classic&amp;lt;/artifactId&amp;gt;
  &amp;lt;version&amp;gt;1.0.12&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;SLF4J will automatically pick up our logback implementation, so the logs will look like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;13:25:43.692 [main] INFO  c.c.client.CouchbaseConnection - Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
13:25:43.694 [main] DEBUG c.c.c.vbucket.VBucketNodeLocator - Updating nodesMap in VBucketNodeLocator.
13:25:43.697 [main] DEBUG c.c.c.vbucket.VBucketNodeLocator - Adding node with hostname 127.0.0.1:11210.
13:25:43.697 [main] DEBUG c.c.c.vbucket.VBucketNodeLocator - Node added is {QA sa=localhost/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=8}.
13:25:43.698 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Done dealing with queue.
13:25:43.699 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Selecting with delay of 0ms
13:25:43.702 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Selected 1, selected 1 keys
13:25:43.703 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Handling IO for:  sun.nio.ch.SelectionKeyImpl@48ff2413 (r=false, w=false, c=true, op={QA sa=localhost/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=8})
13:25:43.703 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] INFO  c.c.client.CouchbaseConnection - Connection state changed for sun.nio.ch.SelectionKeyImpl@48ff2413
13:25:43.713
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, they also include DEBUG level logging here. If you don&amp;rsquo;t include the logging implementation during runtime, SLF4J will complain at startup:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;SLF4J: Failed to load class &amp;quot;org.slf4j.impl.StaticLoggerBinder&amp;quot;.
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you want to learn how to configure logback, &lt;a href=&#34;http://logback.qos.ch/manual/configuration.html&#34;&gt;look here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Once you know the abstraction in spymemcached and how it works, switching logging implementations is easy and straightforward. If you work with one of the Couchbase people to report errors, please try to include output with DEBUG turned on, because this includes lots of useful information that can be used to determine the failure sources.&lt;/p&gt;

&lt;p&gt;With the SLF4J facade added in the next spy release (2.9), you will be able to plug every large logging framework out there into the SDK. Let us know if you see a use case not covered with these mechanisms or if you have other comments on this.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>