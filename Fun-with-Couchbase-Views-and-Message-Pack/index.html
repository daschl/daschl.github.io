
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fun With Couchbase Views and MessagePack - Nitschinger.at</title>
  <meta name="author" content="Michael Nitschinger">

  
  <meta name="description" content="Alright, before we start I have to admit that this is a little bit of a hack. Not that it doesn&rsquo;t work, but of course Couchbase Server 2.0 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://daschl.github.io/Fun-with-Couchbase-Views-and-Message-Pack">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/posts.rss" rel="alternate" title="Nitschinger.at" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Nitschinger.at</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/posts.rss" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:daschl.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fun With Couchbase Views and MessagePack</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-18T14:49:48+02:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://daschl.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Alright, before we start I have to admit that this is a little bit of a hack. Not that it doesn&rsquo;t work, but of course Couchbase Server 2.0 officially only supports JSON documents to be queried through Views. In addition to that, it is not so much known that you have access to all the other documents through Base64 encoding. Recently, <a href="http://avsej.net/2013/analyzing-binary-data-in-couchbase/">Sergey</a> showed us how to very easily analyze binary data in Couchbase Views and this brought me on the idea to take it one step further.</p>

<p>In this blog post we&rsquo;re going to store <a href="http://msgpack.org/">MessagePack</a> formatted data in Couchbase and then make its content available to Views (and allow us to query it). Note that you don&rsquo;t need to patch Couchbase for this, its just a snippet of JavaScript code that you need to include in your map function. We&rsquo;ll be using Java on the client side here, but nearly every combination of our official SDKs and MessagePack modules works for this.</p>

<h2>Storing the Data</h2>

<p>In order to store something meaningful we can query later, let&rsquo;s create a Maven project with all needed dependencies. Note that I&rsquo;m assuming you have a Couchbase Server installation running and are familiar with the Couchbase Java SDK (at least a little bit). Also I won&rsquo;t cover the View fundamentals since this is a little advanced topic.</p>

<p>Here are the required dependencies to start with the fun:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>couchbase<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>couchbase-client<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>1.1.7<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.msgpack<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>msgpack<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>0.6.7<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, don&rsquo;t forget that the Couchbase SDK lives in its own repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;repository&gt;</span>
</span><span class='line'>  <span class="nt">&lt;id&gt;</span>couchbase<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>  <span class="nt">&lt;name&gt;</span>Couchbase Maven Repository<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>  <span class="nt">&lt;url&gt;</span>http://files.couchbase.com/maven2/<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>  <span class="nt">&lt;snapshots&gt;</span>
</span><span class='line'>      <span class="nt">&lt;enabled&gt;</span>false<span class="nt">&lt;/enabled&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/snapshots&gt;</span>
</span><span class='line'><span class="nt">&lt;/repository&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we can create a simple script that connects to Couchbase, creates some HashMaps with meaningful content, encodes them with the MessagePack encoder and stores them in the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">com.couchbase.client.CouchbaseClient</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.msgpack.MessagePack</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Connect to Couchbase</span>
</span><span class='line'>    <span class="n">CouchbaseClient</span> <span class="n">cb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CouchbaseClient</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="s">&quot;http://127.0.0.1:8091/pools&quot;</span><span class="o">)),</span> <span class="s">&quot;default&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Init MessagePack</span>
</span><span class='line'>    <span class="n">MessagePack</span> <span class="n">msgpack</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessagePack</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Create a few Documents with some content</span>
</span><span class='line'>    <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">user1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">user1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Michael&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">user1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;Nitschinger&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">user2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">user2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Matt&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">user2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;Ingenthron&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">user3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">user3</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Sergey&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">user3</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;Avseyev&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Encode and store them</span>
</span><span class='line'>    <span class="n">cb</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;user:michael&quot;</span><span class="o">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">user1</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>    <span class="n">cb</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;user:matt&quot;</span><span class="o">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">user2</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>    <span class="n">cb</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;user:sergey&quot;</span><span class="o">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">user3</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Close the Connection</span>
</span><span class='line'>    <span class="n">cb</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only new part to Couchbase folks is the &ldquo;MessagePack&rdquo; code. You create a new instance of <code>MessagePack</code> and then pass the data to the <code>write</code> method. I&rsquo;m not an expert on this library, but it looks like you can also make it work with generic POJOs, which would be something to look into if you model an actual application with it.</p>

<h2>Querying the Data</h2>

<p>Now if we run the code, we&rsquo;ll see that three documents have been persisted, but they show up as binary. That&rsquo;s because its not JSON and kind of expected. Now, go create a View on your bucket and start out with an empty map function like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you query it, you&rsquo;ll see the document keys emitted like <code>gqhsYXN0bmFtZadBdnNleWV2qWZpcnN0bmFtZaZTZXJnZXk</code>, which is <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> encoding. Now, let&rsquo;s change the view function a bit and use the built-in <code>decodeBase64</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">emit</span><span class="p">(</span><span class="nx">decodeBase64</span><span class="p">(</span><span class="nx">doc</span><span class="p">),</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now your output looks more like <code>[130,168,108,97,115,116,110,97,109,...121]</code>, which is the native format of MessagePack! You would also see the same output if you take the result of <code>msgpack.write()</code> and print out the byte array properly.</p>

<p>The first step is done, we have direct access to the stored data. Now we need to decode it. The good news is that there is a JavaScript library for MessagePack, but it doesn&rsquo;t work out of the box with our view code. The library does lots of browser stuff which we don&rsquo;t have in the environment. <a href="https://raw.github.com/msgpack/msgpack-javascript/master/msgpack.js">here</a> is the link to the original library.</p>

<p>Now, after some fiddling with the code and removing unneeded parts (but actually not changing how it works), I ended up with something that works. You can go ahead and grab the full snippet <a href="https://gist.github.com/daschl/5796263">here</a>. Personally, I prefer to have my map functions short and sweet, so here is the same code, but <a href="https://gist.github.com/daschl/5796268">minified</a>.</p>

<p>Now, we can plug this code into our map function and use the method to decode our data on the fly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/*!{id:msgpack.js,ver:1.05,license:&quot;MIT&quot;,author:&quot;uupaa.js@gmail.com&quot;}*/</span>
</span><span class='line'>    <span class="cm">/* Modified by @daschl and @avsej to strip out whats not needed */</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">msgunpack</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">function</span> <span class="nx">k</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">g</span><span class="p">,</span><span class="nx">d</span><span class="p">,</span><span class="nx">e</span><span class="p">,</span><span class="nx">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">f</span><span class="p">,</span><span class="nx">h</span><span class="p">,</span><span class="nx">c</span><span class="o">=</span><span class="nx">m</span><span class="p">;</span><span class="nx">d</span><span class="o">=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="mi">224</span><span class="o">&lt;=</span><span class="nx">d</span><span class="p">)</span><span class="k">return</span> <span class="nx">d</span><span class="o">-</span><span class="mi">256</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="mi">192</span><span class="o">&gt;</span><span class="nx">d</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="mi">128</span><span class="o">&gt;</span><span class="nx">d</span><span class="p">)</span><span class="k">return</span> <span class="nx">d</span><span class="p">;</span><span class="mi">144</span><span class="o">&gt;</span><span class="nx">d</span><span class="o">?</span><span class="p">(</span><span class="nx">b</span><span class="o">=</span><span class="nx">d</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="nx">d</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="o">:</span><span class="mi">160</span><span class="o">&gt;</span><span class="nx">d</span><span class="o">?</span><span class="p">(</span><span class="nx">b</span><span class="o">=</span><span class="nx">d</span><span class="o">-</span><span class="mi">144</span><span class="p">,</span><span class="nx">d</span><span class="o">=</span><span class="mi">144</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="nx">b</span><span class="o">=</span><span class="nx">d</span><span class="o">-</span><span class="mi">160</span><span class="p">,</span><span class="nx">d</span><span class="o">=</span><span class="mi">160</span><span class="p">)}</span><span class="k">switch</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">case</span> <span class="mi">192</span><span class="o">:</span><span class="k">return</span> <span class="kc">null</span><span class="p">;</span><span class="k">case</span> <span class="mi">194</span><span class="o">:</span><span class="k">return</span><span class="o">!</span><span class="mi">1</span><span class="p">;</span><span class="k">case</span> <span class="mi">195</span><span class="o">:</span><span class="k">return</span><span class="o">!</span><span class="mi">0</span><span class="p">;</span><span class="k">case</span> <span class="mi">202</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">],</span><span class="nx">f</span><span class="o">=</span><span class="nx">b</span><span class="o">&gt;&gt;</span><span class="mi">23</span><span class="o">&amp;</span><span class="mi">255</span><span class="p">,</span><span class="nx">h</span><span class="o">=</span><span class="nx">b</span><span class="o">&amp;</span><span class="mi">8388607</span><span class="p">,</span><span class="o">!</span><span class="nx">b</span><span class="o">||</span><span class="mi">2147483648</span><span class="o">===</span><span class="nx">b</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">255</span><span class="o">===</span><span class="nx">f</span><span class="o">?</span><span class="nx">h</span><span class="o">?</span><span class="kc">NaN</span><span class="o">:</span><span class="kc">Infinity</span><span class="o">:</span><span class="p">(</span><span class="nx">b</span><span class="o">&amp;</span><span class="mi">2147483648</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">h</span><span class="o">|</span><span class="mi">8388608</span><span class="p">)</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">f</span><span class="o">-</span><span class="mi">127</span><span class="o">-</span><span class="mi">23</span><span class="p">);</span><span class="k">case</span> <span class="mi">203</span><span class="o">:</span><span class="nx">b</span><span class="o">=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="nx">d</span><span class="o">=</span><span class="nx">b</span><span class="o">&amp;</span><span class="mi">2147483648</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">f</span><span class="o">=</span><span class="nx">b</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="o">&amp;</span><span class="mi">2047</span><span class="p">;</span><span class="nx">h</span><span class="o">=</span><span class="nx">b</span><span class="o">&amp;</span><span class="mi">1048575</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="o">||</span><span class="mi">2147483648</span><span class="o">===</span><span class="nx">b</span><span class="p">)</span><span class="k">return</span> <span class="nx">a</span><span class="o">+=</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="mi">2047</span><span class="o">===</span><span class="nx">f</span><span class="p">)</span><span class="k">return</span> <span class="nx">a</span><span class="o">+=</span><span class="mi">4</span><span class="p">,</span><span class="nx">h</span><span class="o">?</span><span class="kc">NaN</span><span class="o">:</span><span class="kc">Infinity</span><span class="p">;</span><span class="nx">b</span><span class="o">=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">return</span><span class="p">(</span><span class="nx">d</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nx">h</span><span class="o">|</span><span class="mi">1048576</span><span class="p">)</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">f</span><span class="o">-</span><span class="mi">1023</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="nx">b</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">f</span><span class="o">-</span><span class="mi">1023</span><span class="o">-</span><span class="mi">52</span><span class="p">));</span><span class="k">case</span> <span class="mi">207</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">],</span><span class="mi">4294967296</span><span class="o">*</span><span class="nx">b</span><span class="o">+</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">case</span> <span class="mi">206</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span><span class="k">case</span> <span class="mi">205</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">;</span><span class="k">case</span> <span class="mi">204</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">case</span> <span class="mi">211</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">],</span><span class="nx">b</span><span class="o">&amp;</span><span class="mi">128</span><span class="o">?-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="mi">72057594037927936</span><span class="o">*</span><span class="p">(</span><span class="nx">b</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span>
</span><span class='line'>    <span class="mi">281474976710656</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="mi">1099511627776</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="mi">4294967296</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="mi">16777216</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="mi">65536</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="mi">256</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">^</span><span class="mi">255</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="mi">72057594037927936</span><span class="o">*</span><span class="nx">b</span><span class="o">+</span><span class="mi">281474976710656</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="mi">1099511627776</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="mi">4294967296</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="mi">65536</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="mi">256</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">case</span> <span class="mi">210</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">],</span><span class="mi">2147483648</span><span class="o">&gt;</span><span class="nx">b</span><span class="o">?</span><span class="nx">b</span><span class="o">:</span><span class="nx">b</span><span class="o">-</span><span class="mi">4294967296</span><span class="p">;</span><span class="k">case</span> <span class="mi">209</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">=</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">],</span><span class="mi">32768</span><span class="o">&gt;</span><span class="nx">b</span><span class="o">?</span><span class="nx">b</span><span class="o">:</span><span class="nx">b</span><span class="o">-</span><span class="mi">65536</span><span class="p">;</span><span class="k">case</span> <span class="mi">208</span><span class="o">:</span><span class="k">return</span> <span class="nx">b</span><span class="o">=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">],</span><span class="mi">128</span><span class="o">&gt;</span><span class="nx">b</span><span class="o">?</span><span class="nx">b</span><span class="o">:</span><span class="nx">b</span><span class="o">-</span><span class="mi">256</span><span class="p">;</span><span class="k">case</span> <span class="mi">219</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span>
</span><span class='line'>    <span class="mi">16</span><span class="p">);</span><span class="k">case</span> <span class="mi">218</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">case</span> <span class="mi">160</span><span class="o">:</span><span class="nx">f</span><span class="o">=</span><span class="p">[];</span><span class="nx">d</span><span class="o">=</span><span class="nx">a</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">g</span><span class="o">=</span><span class="nx">d</span><span class="o">+</span><span class="nx">b</span><span class="p">;</span><span class="nx">d</span><span class="o">&lt;</span><span class="nx">g</span><span class="p">;)</span><span class="nx">e</span><span class="o">=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">],</span><span class="nx">f</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">128</span><span class="o">&gt;</span><span class="nx">e</span><span class="o">?</span><span class="nx">e</span><span class="o">:</span><span class="mi">224</span><span class="o">&gt;</span><span class="nx">e</span><span class="o">?</span><span class="p">(</span><span class="nx">e</span><span class="o">&amp;</span><span class="mi">31</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">);</span><span class="nx">a</span><span class="o">=</span><span class="nx">d</span><span class="p">;</span><span class="k">return</span> <span class="mi">10240</span><span class="o">&gt;</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span><span class="nx">l</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">f</span><span class="p">)</span><span class="o">:</span><span class="nx">n</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span><span class="k">case</span> <span class="mi">223</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span><span class="k">case</span> <span class="mi">222</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">case</span> <span class="mi">128</span><span class="o">:</span><span class="k">for</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="p">{};</span><span class="nx">b</span><span class="o">--</span><span class="p">;){</span><span class="nx">g</span><span class="o">=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">-</span><span class="mi">160</span><span class="p">;</span><span class="nx">f</span><span class="o">=</span><span class="p">[];</span><span class="nx">d</span><span class="o">=</span><span class="nx">a</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">g</span><span class="o">=</span><span class="nx">d</span><span class="o">+</span><span class="nx">g</span><span class="p">;</span><span class="nx">d</span><span class="o">&lt;</span><span class="nx">g</span><span class="p">;)</span><span class="nx">e</span><span class="o">=</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">],</span><span class="nx">f</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">128</span><span class="o">&gt;</span><span class="nx">e</span><span class="o">?</span><span class="nx">e</span><span class="o">:</span><span class="mi">224</span><span class="o">&gt;</span><span class="nx">e</span><span class="o">?</span><span class="p">(</span><span class="nx">e</span><span class="o">&amp;</span><span class="mi">31</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">d</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">);</span><span class="nx">a</span><span class="o">=</span><span class="nx">d</span><span class="p">;</span><span class="nx">h</span><span class="p">[</span><span class="nx">l</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">f</span><span class="p">)]</span><span class="o">=</span><span class="nx">k</span><span class="p">()}</span><span class="k">return</span> <span class="nx">h</span><span class="p">;</span><span class="k">case</span> <span class="mi">221</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span><span class="mi">16777216</span><span class="o">*</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span><span class="k">case</span> <span class="mi">220</span><span class="o">:</span><span class="nx">b</span><span class="o">+=</span>
</span><span class='line'>    <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="nx">c</span><span class="p">[</span><span class="o">++</span><span class="nx">a</span><span class="p">];</span><span class="k">case</span> <span class="mi">144</span><span class="o">:</span><span class="k">for</span><span class="p">(</span><span class="nx">f</span><span class="o">=</span><span class="p">[];</span><span class="nx">b</span><span class="o">--</span><span class="p">;)</span><span class="nx">f</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">k</span><span class="p">());</span><span class="k">return</span> <span class="nx">f</span><span class="p">}}</span><span class="kd">function</span> <span class="nx">n</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">a</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">d</span><span class="p">){}</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="p">[],</span><span class="nx">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">f</span><span class="o">=</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">h</span><span class="o">=</span><span class="nx">p</span><span class="p">;</span><span class="nx">b</span><span class="o">&lt;</span><span class="nx">f</span><span class="p">;</span><span class="o">++</span><span class="nx">b</span><span class="p">)</span><span class="nx">e</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span><span class="o">=</span><span class="nx">h</span><span class="p">[</span><span class="nx">a</span><span class="p">[</span><span class="nx">b</span><span class="p">]];</span><span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="p">{},</span><span class="nx">p</span><span class="o">=</span><span class="p">{},</span><span class="nx">m</span><span class="o">=</span><span class="p">[],</span><span class="nx">a</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">l</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">;</span><span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">){</span><span class="kd">var</span> <span class="nx">d</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">===</span><span class="k">typeof</span> <span class="nx">g</span><span class="p">){</span><span class="nx">d</span><span class="o">=</span><span class="p">[];</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nx">g</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span><span class="nx">b</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="nx">f</span><span class="p">;</span><span class="nx">f</span><span class="o">=</span><span class="nx">e</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">g</span><span class="o">=</span><span class="nx">f</span><span class="o">%</span><span class="mi">8</span><span class="p">;</span><span class="nx">g</span><span class="o">--</span><span class="p">;)</span><span class="o">++</span><span class="nx">b</span><span class="p">,</span><span class="nx">d</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span><span class="o">=</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="nx">b</span><span class="p">]];</span><span class="k">for</span><span class="p">(</span><span class="nx">g</span><span class="o">=</span><span class="nx">f</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">;</span><span class="nx">g</span><span class="o">--</span><span class="p">;)</span><span class="nx">d</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]],</span><span class="nx">j</span><span class="p">[</span><span class="nx">e</span><span class="p">[</span><span class="o">++</span><span class="nx">b</span><span class="p">]])}</span><span class="k">else</span> <span class="nx">d</span><span class="o">=</span><span class="nx">g</span><span class="p">;</span><span class="nx">m</span><span class="o">=</span><span class="nx">d</span><span class="p">;</span><span class="nx">a</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="k">return</span> <span class="nx">k</span><span class="p">()}}();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">msgunpack</span><span class="p">(</span><span class="nx">decodeBase64</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">emit</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This map function decodes our MessagePack data and just emits the value with key &ldquo;firstname&rdquo;. Once you query this view, you&rsquo;ll see stuff like this emitted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">total_rows</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">rows</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;user:matt&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Matt&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">value</span><span class="o">:</span> <span class="kc">null</span>
</span><span class='line'>  <span class="p">},{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;user:michael&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Michael&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">value</span><span class="o">:</span> <span class="kc">null</span>
</span><span class='line'>  <span class="p">},{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;user:sergey&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Sergey&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">value</span><span class="o">:</span> <span class="kc">null</span>
</span><span class='line'>  <span class="p">}]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Isn&rsquo;t that lovely? We can now query this view from our Java SDK and use the MessagePack decoding facilities to retrieve the full documents as needed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// Query View</span>
</span><span class='line'><span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">getView</span><span class="o">(</span><span class="s">&quot;designname&quot;</span><span class="o">,</span> <span class="s">&quot;viewname&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">ViewResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="k">new</span> <span class="n">Query</span><span class="o">().</span><span class="na">setIncludeDocs</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Iterate and load full documents</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="n">ViewRow</span> <span class="n">row</span> <span class="o">:</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msgpack</span><span class="o">.</span><span class="na">read</span><span class="o">((</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">row</span><span class="o">.</span><span class="na">getDocument</span><span class="o">()));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the console, you&rsquo;ll see the full document content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span><span class="s2">&quot;lastname&quot;</span><span class="o">:</span><span class="s2">&quot;Ingenthron&quot;</span><span class="p">,</span><span class="s2">&quot;firstname&quot;</span><span class="o">:</span><span class="s2">&quot;Matt&quot;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="s2">&quot;lastname&quot;</span><span class="o">:</span><span class="s2">&quot;Nitschinger&quot;</span><span class="p">,</span><span class="s2">&quot;firstname&quot;</span><span class="o">:</span><span class="s2">&quot;Michael&quot;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="s2">&quot;lastname&quot;</span><span class="o">:</span><span class="s2">&quot;Avseyev&quot;</span><span class="p">,</span><span class="s2">&quot;firstname&quot;</span><span class="o">:</span><span class="s2">&quot;Sergey&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, feel free to use all the well-known query mechanisms for Views.</p>

<h2>Benefits, anyone?</h2>

<p>Now one could argue that this is nice to play around with, but what do I actually gain from it? Arguably, there is more work included for the developer, and maybe for the Server side as well.</p>

<p>MessagePack makes bold claims that its faster and smaller than JSON, so lets try to verify this in our environment.</p>

<p>To verify the size argument, let&rsquo;s go ahead and create 1M docs with a &ldquo;reasonable&rdquo; size and store them both through JSON and MessagePack. Since the overhead for each document is static inside Couchbase Server, we can very easily see how much RAM is used to hold the documents and conclude on the size difference (which is what matters at the end).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">numdocs</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span>
</span><span class='line'><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Michael&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;Nitschinger&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">,</span> <span class="mi">25</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;loggedIn&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numdocs</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">cb</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;user:&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">user</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For 1M documents on my machine with Couchbase Server 2.0, the amount of RAM used is 166MB. Now, let&rsquo;s do the same with JSON. I&rsquo;m going to use <a href="https://code.google.com/p/google-gson/">Google GSON</a> to convert the HashMap:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">numdocs</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span>
</span><span class='line'><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Michael&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;Nitschinger&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;age&quot;</span><span class="o">,</span> <span class="mi">25</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;loggedIn&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numdocs</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">cb</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;user:&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">user</span><span class="o">)).</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After inserting those 1M JSON records, Couchbase Server reported exactly 198MB of RAM used! So the difference is 32MB (1/5th of the total data size), or 32 byte per document. That pays off if you have lots of records in your cluster! After doubling the content of the HashMap and storing twice as many documents (2M) MessagePack is ahead of raw JSON by around 96MB. That&rsquo;s another 400K documents you could store (one document is around 230 bytes compared to 285 with raw JSON).</p>

<p>Of course, YMMV depending on the number and size of the documents. I&rsquo;m curious if you could do the same runs on your real workload and see by how much you could improve.</p>

<p>Now, before we talk about RAW encoding/decoding performance, we also need to look into the overhead involved on the server side. Storing and retreiving documents is not slower than any other document, because the server doesn&rsquo;t need to do anything special. The only overhead I can think of is that during index creation, more CPU will be consumed because you execute more JavaScript logic. I guess this CPU overhead increases with the document sizes, but I don&rsquo;t have any actual numbers to share here. Personally, I&rsquo;d use the <a href="">sizing</a> guidelines for Views and maybe add some more CPU just to be safe. It&rsquo;s important to note that at query time, you won&rsquo;t see a difference between JSON and MessagePack, because the index is already created.</p>

<p>Congratulations if you followed to this point! As a bonus, we&rsquo;ll look into the raw encoding/decoding performance of JSON and MessagePack on the JVM. Since there are lots of JSON libraries out there, we&rsquo;re going to use <a href="http://jackson.codehaus.org/">Jackson</a> and Google GSON. Benchmarking on the JVM is not a trivial task, so I&rsquo;ll do my best to keep it objective and we&rsquo;re going to use <a href="https://code.google.com/p/caliper/">Google Caliper</a> to handle things like JVM warmup. Make sure to add everything to your <code>pom.xml</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.msgpack<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>msgpack<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>0.6.7<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.2.4<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.google.caliper<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>caliper<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>1.0-beta-1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.google.code.java-allocation-instrumenter<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>java-allocation-instrumenter<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.2.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this simple benchmark, we are only testing smaller and slightly larger <code>HashMap</code>s. I know that this test is not conclusive, but it should give you a starting point from where you can do your own research.</p>

<p>To write a Caliper benchmark, you need to extend the <code>Benchmark</code> class from the caliper package. its as simple as this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncodingBenchmark</span> <span class="kd">extends</span> <span class="n">Benchmark</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">MessagePack</span> <span class="n">msgpack</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessagePack</span><span class="o">();</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">smallMap</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">largeMap</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">smallMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">smallMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Foo&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">smallMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">smallMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">largeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname&quot;</span><span class="o">,</span> <span class="s">&quot;Foo&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname1&quot;</span><span class="o">,</span> <span class="s">&quot;Foo&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname1&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active1&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname2&quot;</span><span class="o">,</span> <span class="s">&quot;Foo&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname2&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active2&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;firstname3&quot;</span><span class="o">,</span> <span class="s">&quot;Foo&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lastname3&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">largeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;active3&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeMessagePackSmall</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">msgpack</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">smallMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeGoogleGsonSmall</span><span class="o">(</span><span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">smallMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeJacksonSmall</span><span class="o">(</span><span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">smallMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeJsonSmartSmall</span><span class="o">(</span><span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">smallMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeMessagePackLarge</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">msgpack</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">largeMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeGoogleGsonLarge</span><span class="o">(</span><span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">largeMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">timeJacksonLarge</span><span class="o">(</span><span class="kt">int</span> <span class="n">reps</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reps</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">largeMap</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, we create our converter instances (for MessagePack, GSON and Jackson) and the HashMaps. All the runs in this benchmark are executed by Caliper. We need to modify our <code>main</code> class to load the wrapper:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">business.MsgpackBenchmark</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.caliper.runner.CaliperMain</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">CaliperMain</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">EncodingBenchmark</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if you run this in your IDE, you&rsquo;ll see some logging going on:</p>

<pre><code>Experiment selection: 
  Instruments:   [allocation, micro]
  User parameters:   {}
  Virtual machines:  [default]
  Selection type:    Full cartesian product

This selection yields 12 experiments.
Starting experiment 1 of 12: {instrument=allocation, method=GoogleGsonLarge, vm=default, parameters={}}
Complete!
Starting experiment 2 of 12: {instrument=allocation, method=GoogleGsonSmall, vm=default, parameters={}}
Complete!
Starting experiment 3 of 12: {instrument=allocation, method=JacksonLarge, vm=default, parameters={}}
Complete!
Starting experiment 4 of 12: {instrument=allocation, method=JacksonSmall, vm=default, parameters={}}
Complete!
...
Starting experiment 11 of 12: {instrument=micro, method=MessagePackLarge, vm=default, parameters={}}
Complete!
Starting experiment 12 of 12: {instrument=micro, method=MessagePackSmall, vm=default, parameters={}}
Complete!

Execution complete: 7.058m.
Collected 162 measurements from:
  2 instrument(s)
  1 virtual machine(s)
  6 benchmark(s)
Results have been uploaded. View them at: https://microbenchmarks.appspot.com/runs/f25820e0-08dd-43f8-833e-e44847400f19
</code></pre>

<p>Once finished, Caliper even uploaded your results to a webpage (so make sure to have internet connection)! Note that if you see &ldquo;GC errors&rdquo; during your runs, it may be good to retry and if they still persist, consider increasing your heap size a bit. I don&rsquo;t know for how long the data is held on the web page, but <a href="https://microbenchmarks.appspot.com/runs/f25820e0-08dd-43f8-833e-e44847400f19#r:scenario.benchmarkSpec.methodName">here</a> are my results.</p>

<p>At least in my benchmarks I found that libraries like Jackson outperform MessagePack by a large amount when encoding <code>HashMap</code>s. Maybe it&rsquo;s different with other data types and sizes though.</p>

<h2>Summary</h2>

<p>I hope this blog post was a fun introduction and showed what&rsquo;s possible with Couchbase Server 2.0 and its new View engine. I found that MessagePack really saves you a good amount of bytes on the wire (and on the server), but is much slower on the JVM when it comes to encoding data (here <code>HashMap</code>s).</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Michael Nitschinger</span></span>

      








  


<time datetime="2013-06-18T14:49:48+02:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/couchbase/'>couchbase</a>, <a class='category' href='/blog/categories/messagepack/'>messagepack</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://daschl.github.io/Fun-with-Couchbase-Views-and-Message-Pack" data-via="daschl" data-counturl="http://daschl.github.io/Fun-with-Couchbase-Views-and-Message-Pack" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/A-Couchbase-Cluster-in-Minutes-with-Vagrant-and-Puppet" title="Previous Post: A Couchbase Cluster in Minutes with Vagrant and Puppet">&laquo; A Couchbase Cluster in Minutes with Vagrant and Puppet</a>
      
      
        <a class="basic-alignment right" href="/Printing-JVM-generated-Assembler-on-Mac-OS-X" title="Next Post: Printing JVM generated Assembler on Mac OS X">Printing JVM generated Assembler on Mac OS X &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/Using-JMH-for-Java-Microbenchmarking">Using JMH for Java Microbenchmarking</a>
      </li>
    
      <li class="post">
        <a href="/What-s-new-in-the-Couchbase-Java-SDK-1-2">What's New in the Couchbase Java SDK 1.2</a>
      </li>
    
      <li class="post">
        <a href="/Using-the-Reactor-Processor-for-High-Performance-TCP">Using the Reactor Processor for High-Performance TCP</a>
      </li>
    
      <li class="post">
        <a href="/Useful-Couchbase-Resources-Blog-Posts">Useful Couchbase Resources & Blog Posts</a>
      </li>
    
      <li class="post">
        <a href="/Printing-JVM-generated-Assembler-on-Mac-OS-X">Printing JVM Generated Assembler on Mac OS X</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Michael Nitschinger -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'daschl';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://daschl.github.io/Fun-with-Couchbase-Views-and-Message-Pack';
        var disqus_url = 'http://daschl.github.io/Fun-with-Couchbase-Views-and-Message-Pack';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
