<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Journey on Avoiding Nulls in PHP &middot; daschl writes. sometimes.</title>

    <meta name="description" content="What about avoiding nulls completely in your PHP application? Inspired by Scala and Google Guava, this post shows you how to do it in PHP.">

    <meta name="generator" content="Hugo 0.15" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="A Journey on Avoiding Nulls in PHP &middot; daschl writes. sometimes.">
    <meta name="twitter:description" content="What about avoiding nulls completely in your PHP application? Inspired by Scala and Google Guava, this post shows you how to do it in PHP.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="A Journey on Avoiding Nulls in PHP &middot; daschl writes. sometimes.">
    <meta property="og:description" content="What about avoiding nulls completely in your PHP application? Inspired by Scala and Google Guava, this post shows you how to do it in PHP.">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://nitschinger.at//css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="daschl writes. sometimes." href="http://nitschinger.at//index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://nitschinger.at/">daschl writes. sometimes.</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
                <li class="nav-item">
                    <a class="pure-button" href="http://nitschinger.at//index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                <h1 class="content-subhead">19 Feb 2013</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://nitschinger.at/A-Journey-on-Avoiding-Nulls-in-PHP/" class="post-title">A Journey on Avoiding Nulls in PHP</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Let&rsquo;s face it: nulls are a hassle and lead to exceptions and inconsistent application state. <a href="http://en.wikipedia.org/wiki/Tony_Hoare">Tony Hoare</a>, the inventor of QuickSort, even calls it his <a href="http://qconlondon.com/london-2009/presentation/Null+References:+The+Billion+Dollar+Mistake">billion dollar mistake</a>.</p>

<p>While every developer has kind of accepted their existence, they are suddenly there when we&rsquo;d desperately need them to not show up. How often did you write<code>if($obj === null)</code> in your PHP code? Can&rsquo;t there be a better, more elegant and fault-tolerant solution to the problem?</p>

<p>It turns out that for example in <a href="http://www.scala-lang.org/">Scala</a>, you can avoid nulls by using the <a href="http://www.scala-lang.org/api/current/index.html#scala.Option">Option</a> class. It allows you to express in a clear way that the result of a - lets say - method can either be good (a reference to a valid object) or bad. In PHP, bad often means null. Scala then consequently provides method to access this object safely. You as the developer can choose at which point you want to get the value out, either by accessing it directly (and catching exceptions) or provide a sensible default value.</p>

<p>In Scala, you write code like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">/* An option with a value */
val a: Option[Int] = Some(5)
/* An option with no value */
val b: Option[Int] = None

/* Returns 5 */
a.getOrElse(0)
/* Returns 10 */
b.getOrElse(10)
</pre></div>

<p>You can also use helpful methods like <code>isDefined()</code> to peek into the object and see whats going on at runtime. All this is much more expressive than juggling around with a possible <code>null</code> value.</p>

<p>Java has the same issues as PHP, and it hurt Google so much that they integrated the concept of an <a href="http://code.google.com/p/guava-libraries/wiki/UsingAndAvoidingNullExplained">Optional</a> directly into the core of their <a href="http://code.google.com/p/guava-libraries/">Google Guava</a> Java library collection. I really like their code and use it in my Java projects, so I decided it would be an interesting project to port this to PHP. Since PHP isn&rsquo;t a statically typed language like Java, concepts like generics have been removed and some methods renamed (they look more like Scala&rsquo;s now), but in essence its the same.</p>

<h2 id="usage:d2267bd319f6db001a379c1a12ddc220">Usage</h2>

<p>Before digging into how it works, let&rsquo;s look at how we can use it. We only need to work with three classes called <code>Optional</code>, <code>Present</code> and <code>Absent</code>. <code>Optional</code> is the base class, <code>Present</code> and <code>Absent</code> inherit from it and provide the method bodies for their appropriate behavior.</p>

<p>The main idea is to fail fast when null is discovered and afterwards have a safe way of working with our value. Creating a <code>Optional</code> works through the static <code>of</code> method. We then have a range of methods available to inspect and fetch the output:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$possible</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">of</span>(<span style="color: #1C01CE">5</span>);
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">isPresent</span>()); <span style="color: #177500">// bool(true)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">get</span>()); <span style="color: #177500">// int(5)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrElse</span>(<span style="color: #1C01CE">99</span>)); <span style="color: #177500">// int(5)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrNull</span>()); <span style="color: #177500">// int(5)</span>
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>If we&rsquo;re trying to call <code>of</code> with <code>null</code>, a <code>NullPointerException</code> is raised immediately. We can use the <code>fromNullable</code> method to handle this case safely:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$possible</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">of</span>(<span style="color: #A90D91">null</span>); <span style="color: #177500">// Throws &#39;NullPointerException&#39; with message &#39;Unallowed null in reference found.&#39;</span>
<span style="color: #000000">$possible</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #A90D91">null</span>);
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">isPresent</span>()); <span style="color: #177500">// bool(false)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">get</span>()); <span style="color: #177500">// Throws IllegalStateException</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrElse</span>(<span style="color: #1C01CE">99</span>)); <span style="color: #177500">// int(99)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$possible-&gt;</span><span style="color: #836C28">getOrNull</span>()); <span style="color: #177500">// NULL</span>
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>We can even check the equality of the contained Optionals:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #000000">$val1</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #1C01CE">5</span>);
<span style="color: #000000">$val2</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #1C01CE">4</span>);
<span style="color: #000000">$val3</span> <span style="color: #000000">=</span> <span style="color: #000000">Optional::</span><span style="color: #836C28">fromNullable</span>(<span style="color: #1C01CE">4</span>);

<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$val1-&gt;</span><span style="color: #836C28">equals</span>(<span style="color: #000000">$val2</span>)); <span style="color: #177500">// bool(false)</span>
<span style="color: #A90D91">var_dump</span>(<span style="color: #000000">$val2-&gt;</span><span style="color: #836C28">equals</span>(<span style="color: #000000">$val3</span>)); <span style="color: #177500">// bool(true)</span>
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>Now this simple examples are easy to grasp and this is a good thing. It&rsquo;s not about complexity here, it&rsquo;s about making it obvious that a value may or may not be null and handling it appropriately.</p>

<p>If you&rsquo;re accessing a method of a library, you need to check the return value every time if it&rsquo;s null to make sure you&rsquo;re not in an invalid state. If it&rsquo;s clear that the library is returning an instance of <code>Optional</code>, you know what to expect and how to deal with it appropriately.</p>

<h2 id="implementation:d2267bd319f6db001a379c1a12ddc220">Implementation</h2>

<p>Let&rsquo;s look at how this implemented.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">abstract</span> <span style="color: #A90D91">class</span> <span style="color: #3F6E75">Optional</span> {

    <span style="color: #A90D91">private</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>() {}

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * Returns an instance with no contained reference.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">absent</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">Absent::</span><span style="color: #836C28">instance</span>();
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * Returns an Optional instance containing the given non-null reference.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">of</span>(<span style="color: #000000">$reference</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Present</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">checkNotNull</span>(<span style="color: #000000">$reference</span>));
    }

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * If reference is non-null, returns an Optional instance containing</span>
<span style="color: #C41A16">     * that reference; otherwise returns Absent.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">fromNullable</span>(<span style="color: #000000">$reference</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$reference</span> <span style="color: #000000">===</span> <span style="color: #A90D91">null</span> <span style="color: #000000">?</span> <span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">absent</span>() <span style="color: #000000">:</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Present</span>(<span style="color: #000000">$reference</span>);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">isPresent</span>();
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">get</span>();
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrElse</span>(<span style="color: #000000">$defaultValue</span>);
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrNull</span>();
    <span style="color: #A90D91">public</span> <span style="color: #A90D91">abstract</span> <span style="color: #A90D91">function</span> <span style="color: #000000">equals</span>(<span style="color: #000000">$object</span>);

    <span style="color: #C41A16">/**</span>
<span style="color: #C41A16">     * Make sure the passed reference is not null.</span>
<span style="color: #C41A16">     */</span>
    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">checkNotNull</span>(<span style="color: #000000">$reference</span>, <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #A90D91">null</span>) {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$message</span> <span style="color: #000000">===</span> <span style="color: #A90D91">null</span>) {
            <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;Unallowed null in reference found.&quot;</span>;
        }

        <span style="color: #A90D91">if</span>(<span style="color: #000000">$reference</span> <span style="color: #000000">===</span> <span style="color: #A90D91">null</span>) {
            <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">NullPointerException</span>(<span style="color: #000000">$message</span>);
        }
        <span style="color: #A90D91">return</span> <span style="color: #000000">$reference</span>;
    }


}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>This abstract class defines all of the methods we&rsquo;ll implement in <code>Present</code> and <code>Absent</code>, as well as all the static methods that you can call directly (especially the <code>of</code> and <code>fromNullable</code> methods). Note that in the appropriate places, <code>checkNotNull</code> is called which will throw a <code>NullPointerException</code> if a null is found. This adheres to the fail fast principle.</p>

<p>Now let&rsquo;s implement the <code>Absent</code> class, which represents the state where no reference is present (for example a null was passed in through <code>fromNullable</code>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Absent</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Optional</span> {

    <span style="color: #A90D91">private</span> <span style="color: #A90D91">static</span> <span style="color: #000000">$instance</span>;

    <span style="color: #A90D91">private</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>() {}

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">isPresent</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">get</span>() {
        <span style="color: #A90D91">throw</span> <span style="color: #A90D91">new</span> <span style="color: #000000">IllegalStateException</span>(<span style="color: #C41A16">&quot;Optional-&gt;get() cannot be called on an absent value&quot;</span>);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrElse</span>(<span style="color: #000000">$defaultValue</span>) {
        <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;use Optional-&gt;orNull() instead of Optional-&gt;or(null)&quot;</span>;
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">checkNotNull</span>(<span style="color: #000000">$defaultValue</span>, <span style="color: #000000">$message</span>);
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrNull</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">null</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">equals</span>(<span style="color: #000000">$object</span>) {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$object</span> <span style="color: #000000">===</span> <span style="color: #000000">$this</span>;
    }

    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">static</span> <span style="color: #A90D91">function</span> <span style="color: #000000">instance</span>() {
        <span style="color: #A90D91">if</span>(<span style="color: #A90D91">static</span><span style="color: #000000">::$instance</span> <span style="color: #000000">==</span> <span style="color: #A90D91">null</span>) {
            <span style="color: #A90D91">return</span> <span style="color: #A90D91">static</span><span style="color: #000000">::$instance</span> <span style="color: #000000">=</span> <span style="color: #A90D91">new</span> <span style="color: #000000">Absent</span>();
        }
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">static</span><span style="color: #000000">::$instance</span>;
    }

}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>The <code>$instance</code> variable is managed here through the singleton pattern. We only need one instance of <code>Absent</code>, this saves memory and CPU time. The other methods just implement the expected behaviour of something that is not available.</p>

<p>Finally, we can implement the <code>Present</code> class, which actually stores our instance if available.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #633820">&lt;?php</span>
<span style="color: #A90D91">class</span> <span style="color: #3F6E75">Present</span> <span style="color: #A90D91">extends</span> <span style="color: #000000">Optional</span> {

    <span style="color: #A90D91">private</span> <span style="color: #000000">$reference</span>;

    <span style="color: #A90D91">protected</span> <span style="color: #A90D91">function</span> <span style="color: #000000">__construct</span>(<span style="color: #000000">$reference</span>) {
        <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span> <span style="color: #000000">=</span> <span style="color: #000000">$reference</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">isPresent</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">true</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">get</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrElse</span>(<span style="color: #000000">$defaultValue</span>) {
        <span style="color: #000000">$message</span> <span style="color: #000000">=</span> <span style="color: #C41A16">&quot;use Optional-&gt;orNull() instead of Optional-&gt;or(null)&quot;</span>;
        <span style="color: #A90D91">static</span><span style="color: #000000">::</span><span style="color: #836C28">checkNotNull</span>(<span style="color: #000000">$defaultValue</span>, <span style="color: #000000">$message</span>);
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span>;
    }

    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">getOrNull</span>() {
        <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span>;
    }


    <span style="color: #A90D91">public</span> <span style="color: #A90D91">function</span> <span style="color: #000000">equals</span>(<span style="color: #000000">$object</span>) {
        <span style="color: #A90D91">if</span>(<span style="color: #000000">$object</span> <span style="color: #000000">instanceof</span> <span style="color: #000000">Present</span>) {
            <span style="color: #A90D91">return</span> <span style="color: #000000">$this-&gt;</span><span style="color: #836C28">reference</span> <span style="color: #000000">===</span> <span style="color: #000000">$object-&gt;</span><span style="color: #836C28">get</span>();
        }
        <span style="color: #A90D91">return</span> <span style="color: #A90D91">false</span>;
    }
}
<span style="color: #633820">?&gt;</span>
</pre></div>

<p>It looks the same as the <code>Absent</code> class, but manages to return our instance if necessary and implements the <code>equals</code> method to actually check with the given object.</p>

<p>Edit: Rasmus Schultz pointed out that he uses the ternary operator for lightweight null checks, you may want to <a href="http://blog.mindplay.dk/2013/02/the-or-else-operator-in-php-53.html">check out</a> his post too!</p>

<h2 id="summary:d2267bd319f6db001a379c1a12ddc220">Summary</h2>

<p>As you can see, the adoption of the <code>Optional</code> pattern can greatly increase the expressiveness of your code, by consequently avoiding null and its associated pitfalls. It also makes your code less error-prone, because you can&rsquo;t stumble upon nulls when using this pattern consequently.</p>

<p>This is kind of an experimental implementation, but I think putting this together in a utility library could drive the adoption in the PHP community. I&rsquo;m curious what you think about the concept and if it makes sense for you and your applications!</p>

                    </div>
                    
                </section>
            </div>
            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
		<li>&copy; Michael Nitschinger 2010-2016</li>
        </ul>
    </div>
</div>
<script src="http://nitschinger.at//js/all.min.js"></script>

        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
