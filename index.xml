<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>daschl writes. sometimes.</title>
    <link>http://nitschinger.at/index.xml</link>
    <description>Recent content on daschl writes. sometimes.</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Fri, 28 Oct 2016 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://nitschinger.at/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Text Analysis in Rust - Tokenization</title>
      <link>http://nitschinger.at/Text-Analysis-in-Rust-Tokenization/</link>
      <pubDate>Fri, 28 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Text-Analysis-in-Rust-Tokenization/</guid>
      <description>

&lt;p&gt;I work for &lt;a href=&#34;http://www.couchbase.com/&#34;&gt;Couchbase&lt;/a&gt; where we are currently developing full text search capabilities based on &lt;a href=&#34;blevesearch.com&#34;&gt;bleve&lt;/a&gt;. Bleve is implemented in &lt;a href=&#34;golang.org&#34;&gt;go&lt;/a&gt; and inspired by &lt;a href=&#34;http://lucene.apache.org/core/&#34;&gt;Apache Lucene&lt;/a&gt;, the reference implementation when it comes to full text search. While I am not directly involved in developing bleve I was curious about how it works internally and did take a look at the analyzers it provides.&lt;/p&gt;

&lt;p&gt;Analyzers take your free form text and turn it into tokens which can then be used for indexing or queries. Since I know our team is currently at work doing performance optimizations in all places I wanted to take a stab at implementing similar analyzers in &lt;a href=&#34;https://www.rust-lang.org/&#34;&gt;Rust&lt;/a&gt; and see how they perform in comparison.&lt;/p&gt;

&lt;p&gt;Analyzers typically consist of a tokenizer which slices a string into tokens and zero or more transformers which modify them subsequently (changing them, dropping them,&amp;hellip;). A very common use case is to take some text, tokenize (&amp;ldquo;split&amp;rdquo;) it by whitespace and then afterwards lowercase all tokens. This blog post only covers tokenizers, but transformers are planned for another post.&lt;/p&gt;

&lt;p&gt;If you are only interested in how Rust is &lt;strong&gt;3 times as fast&lt;/strong&gt; as the go equivalent in our microbenchmarks, check out the last section. If you are curious about the implementation details, read on.&lt;/p&gt;

&lt;p&gt;When I think about tokenizers and transformers the first thing that comes to mind in Rust are &lt;a href=&#34;https://doc.rust-lang.org/book/iterators.html&#34;&gt;Iterators&lt;/a&gt;. If we let our tokenizer implement the &lt;a href=&#34;https://doc.rust-lang.org/beta/std/iter/trait.Iterator.html&#34;&gt;Iterator&lt;/a&gt; trait we can make use of all the flexibility and high-level programming Rust provides without compromising performance.&lt;/p&gt;

&lt;h2 id=&#34;tokenizers-and-tokens&#34;&gt;Tokenizers and Tokens&lt;/h2&gt;

&lt;p&gt;So lets define our &lt;code&gt;Tokenizer&lt;/code&gt; as a trait which emits an &lt;code&gt;Iterator&lt;/code&gt; of &lt;code&gt;Tokens&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;trait&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Tokenizer&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; {
    &lt;span style=&#34;color: #C41A16&#34;&gt;/// A Tokenizer always needs to produce an Iterator of Tokens.&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TokenIter:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Iterator&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;Item&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token&amp;gt;&lt;/span&gt;;

    &lt;span style=&#34;color: #C41A16&#34;&gt;/// Takes the input string and tokenizes it based on the implementations rules.&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;tokenize&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;input:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Self::TokenIter&lt;/span&gt;;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note: I can&amp;rsquo;t wait for &lt;a href=&#34;https://github.com/rust-lang/rust/issues/34511&#34;&gt;impl Traits&lt;/a&gt; to land when it also supports trait functions, then this would clean up the declarations even further.&lt;/p&gt;

&lt;p&gt;Lets take a first stab at the &lt;code&gt;Token&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;term:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;String&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;start_offset:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;position:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;Token&lt;/code&gt; contains the &lt;code&gt;term&lt;/code&gt; sliced by the tokenizer and also related metadata like its absolute start offset in bytes as well as the relative position of the token in the stream. We need this information down the road for indexing and querying.&lt;/p&gt;

&lt;p&gt;One problem with this approach is that the &lt;code&gt;String&lt;/code&gt; implicitly performs a heap allocation, and when we are slicing hundreds or thousands of small tokens we are allocating lots of small chunks on the heap.&lt;/p&gt;

&lt;p&gt;The first idea to avoid this is using a &lt;code&gt;&amp;amp;str&lt;/code&gt; instead, but we potentially need to modify the term and then we are back at heap allocations (as an exercise for the reader, using &lt;a href=&#34;https://doc.rust-lang.org/std/borrow/enum.Cow.html&#34;&gt;Cow&lt;/a&gt; could also be an option). So, how can we make this more efficient?&lt;/p&gt;

&lt;p&gt;One thing I realized during experimentation and later researching on the web is that when you are tokenizing text you mostly end up with lots of small tokens which maybe are even filtered out in the next step of the process. It would be nice if could stack allocate those small terms and as a fallback perform heap allocation for the rest! It turns out we can do just that, and here is one way:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MAX_STACK_TERM_LEN:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;15&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;enum&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Term&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;Stack&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;ArrayString&amp;lt;&lt;/span&gt;[&lt;span style=&#34;color: #A90D91&#34;&gt;u8&lt;/span&gt;; &lt;span style=&#34;color: #000000&#34;&gt;MAX_STACK_TERM_LEN&lt;/span&gt;]&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt;),
    &lt;span style=&#34;color: #000000&#34;&gt;Heap&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;String&lt;/span&gt;),
}

&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;term:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Term&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;start_offset:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;position:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Woops, our &lt;code&gt;Token&lt;/code&gt; just got a little more complex. Our term is now an &lt;a href=&#34;https://doc.rust-lang.org/book/enums.html&#34;&gt;Enum&lt;/a&gt; which is either a stack allocated &lt;a href=&#34;https://docs.rs/arrayvec/0.3.20/arrayvec/struct.ArrayString.html&#34;&gt;ArrayString&lt;/a&gt; or a heap allocated &lt;a href=&#34;https://doc.rust-lang.org/std/string/struct.String.html&#34;&gt;String&lt;/a&gt;. Note that the &lt;code&gt;ArrayString&lt;/code&gt; implementation comes from the &lt;a href=&#34;https://crates.io/crates/arrayvec&#34;&gt;arrayvec&lt;/a&gt; crate and basically provides string functionality on top of a stack allocated array.&lt;/p&gt;

&lt;p&gt;The nice thing about this is that we are not leaking this implementation detail to the caller, since we can always work with string slices on creation and access:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;impl&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token&lt;/span&gt; {
    &lt;span style=&#34;color: #633820&#34;&gt;#[inline]&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;from_str&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;term:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;start_offset:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;position:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Self&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;Token&lt;/span&gt; {
            &lt;span style=&#34;color: #000000&#34;&gt;term:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token::convert_term&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;term&lt;/span&gt;),
            &lt;span style=&#34;color: #000000&#34;&gt;start_offset:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;start_offset&lt;/span&gt;,
            &lt;span style=&#34;color: #000000&#34;&gt;position:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt;,
        }
    }

    &lt;span style=&#34;color: #633820&#34;&gt;#[inline]&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;convert_term&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;term:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Term&lt;/span&gt; {
        &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;term&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MAX_STACK_TERM_LEN&lt;/span&gt; {
            &lt;span style=&#34;color: #000000&#34;&gt;Term::Stack&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;ArrayString::&amp;lt;&lt;/span&gt;[&lt;span style=&#34;color: #000000&#34;&gt;_&lt;/span&gt;; &lt;span style=&#34;color: #000000&#34;&gt;MAX_STACK_TERM_LEN&lt;/span&gt;]&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;::from&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;term&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;())
        } &lt;span style=&#34;color: #A90D91&#34;&gt;else&lt;/span&gt; {
            &lt;span style=&#34;color: #000000&#34;&gt;Term::Heap&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;term&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;to_string&lt;/span&gt;())
        }
    }

    &lt;span style=&#34;color: #633820&#34;&gt;#[inline]&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;term&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt; {
        &lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;term&lt;/span&gt; {
            &lt;span style=&#34;color: #000000&#34;&gt;Term::Heap&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;ref&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;as_ref&lt;/span&gt;(),
            &lt;span style=&#34;color: #000000&#34;&gt;Term::Stack&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;ref&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;as_ref&lt;/span&gt;(),
        }
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;At this point we&amp;rsquo;ve departed from our go counterpart in two significant ways: we are using an iterator instead of &lt;a href=&#34;https://github.com/blevesearch/bleve/blob/master/analysis/type.go#L61-L67&#34;&gt;operating on a heap allocated array of tokens&lt;/a&gt; and we are using stack allocations for small tokens instead of heap allocating a &lt;a href=&#34;https://github.com/blevesearch/bleve/blob/master/analysis/type.go#L41&#34;&gt;Token&lt;/a&gt; and its term. I don&amp;rsquo;t know if go is doing escape analysis and optimizations in this case, but based on the benchmarks (read on) I don&amp;rsquo;t think so.&lt;/p&gt;

&lt;p&gt;You might wonder why I selected a stack term length of 15 as the point where we start to do heap allocations. There is no fancy math behind it, I just tried tokenizing all kinds of text snippets and found this to be the sweet spot. Try it out for yourself, you&amp;rsquo;ll see that when you are increasing the size by a larger number the whole tokenization gets slower since rust needs to move those huge chunks around on the stack. Oh, and I did pick 15 and not 16 since the &lt;code&gt;ArrayString&lt;/code&gt; needs one byte for internal storage. If you get different numbers I&amp;rsquo;d love to read about it in the comments!&lt;/p&gt;

&lt;p&gt;With all that in place, lets go work on some tokenizers.&lt;/p&gt;

&lt;h2 id=&#34;the-whitespace-character-tokenizers&#34;&gt;The Whitespace &amp;amp; Character Tokenizers&lt;/h2&gt;

&lt;p&gt;A common case in text analysis is splitting on whitespace, but thinking about more generally we probably want to split on all kinds of characters. So lets implement a character tokenizer which takes a function that takes the character as input and decides if it should split or not.&lt;/p&gt;

&lt;p&gt;A quick warning: from here on it gets a bit more complex, so if you just came here for the benchmarks and you don&amp;rsquo;t care about the actual implementation you can safely skip to the next section.&lt;/p&gt;

&lt;p&gt;Here is our &lt;code&gt;CharTokenIter&lt;/code&gt; struct:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CharTokenIter&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;filter:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, (&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;char&lt;/span&gt;))) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;bool&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;input:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;byte_offset:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;char_offset:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;position:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;It takes a &lt;code&gt;filter&lt;/code&gt; which is the function the implementations set when the &lt;code&gt;CharTokenIter&lt;/code&gt; is created. Naturally it also stores a reference to the original &lt;code&gt;input&lt;/code&gt; since it needs to create the tokens from it. Finally three variables are used to keep internal state that we&amp;rsquo;ll see getting populated in a second. &lt;code&gt;byte_offset&lt;/code&gt; stores the absolute offset in bytes of the token term, the &lt;code&gt;char_offset&lt;/code&gt; does the same but it only counts full characters. Finally the &lt;code&gt;position&lt;/code&gt; stores the relative position of the tokens in the stream. If you wonder why we are handling characters and bytes separately, welcome to the world of &lt;a href=&#34;https://en.wikipedia.org/wiki/Unicode&#34;&gt;Unicode&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We can make creating our iterator a bit nicer:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;impl&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CharTokenIter&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;new&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;filter:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, (&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;char&lt;/span&gt;))) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;bool&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;input:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Self&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;CharTokenIter&lt;/span&gt; { &lt;span style=&#34;color: #000000&#34;&gt;filter:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;input:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;byte_offset:&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;char_offset:&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;position:&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt; }
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now, lets get to where the rubber meets the road. We need to implement the &lt;code&gt;Iterator&lt;/code&gt; as specified in the contract, so our function looks like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;impl&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Iterator&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CharTokenIter&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Item&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token&lt;/span&gt;;

    &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;next&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Option&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;Token&amp;gt;&lt;/span&gt; {
    	&lt;span style=&#34;color: #177500&#34;&gt;// ponies and fairy dust in here...&lt;/span&gt;
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The rest of the code snippets that follow go inside the &lt;code&gt;next&lt;/code&gt; function. If we want to satisfy the Iterator semantics, we need to emit a token every time the predicate provided by our &lt;code&gt;filter&lt;/code&gt; matches:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;cidx&lt;/span&gt;, (&lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;)) &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..]
            .&lt;span style=&#34;color: #000000&#34;&gt;char_indices&lt;/span&gt;()
            .&lt;span style=&#34;color: #000000&#34;&gt;enumerate&lt;/span&gt;()
            .&lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;) {
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We are slicing the input string starting at the current &lt;code&gt;byte_offset&lt;/code&gt;, then use &lt;code&gt;char_indices()&lt;/code&gt; on the iterator to also get the character index and then use &lt;code&gt;enumerate()&lt;/code&gt; to get the byte index. Equipped with the actual character and all kinds of offsets, we apply our filter function and if allowed to pass through craft our token and emit it:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt;];
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt;);
&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;chars&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;count&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt;;
&lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You can see that we are not only slicing out the token term but also adjusting the character and byte offsets properly. Now, what is this &lt;code&gt;skipped_bytes&lt;/code&gt; variable about? We&amp;rsquo;ll get to that in a second, but before that we need to cover another case: what happens if no split character is found or there are characters left after the last split character? To handle this, after our loop we need to handle the remainder:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..];
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt;);
    &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt;)
} &lt;span style=&#34;color: #A90D91&#34;&gt;else&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;None&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If our byte offset is equal to the length of the input string we are done (signaled by returning &lt;code&gt;None&lt;/code&gt; to the iterator consumer), but in the other case we need to slice out the remaining bytes and return them as a final token.&lt;/p&gt;

&lt;p&gt;Now that we&amp;rsquo;ve covered this lets get back to the &lt;code&gt;skipped_bytes&lt;/code&gt; thing from before.&lt;/p&gt;

&lt;p&gt;We need to handle one more case: it can happen that more than one filter characters appear right after one another or at the very beginning of the text. Consider splitting on whitespace and the input looks like &lt;code&gt;hello \t\n world!&lt;/code&gt;. You want two tokens &lt;code&gt;hello&lt;/code&gt; and &lt;code&gt;world!&lt;/code&gt; and all the other whitespace should be consumed (accounted for in the byte offset, but not emitted inside an actual token term). To handle this case we keep track of the characters inside our for loop before emitting the token:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #177500&#34;&gt;// Temp variables to account skipping&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;;
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_chars&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;;
&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;cidx&lt;/span&gt;, (&lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;)) &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..]
    .&lt;span style=&#34;color: #000000&#34;&gt;char_indices&lt;/span&gt;()
    .&lt;span style=&#34;color: #000000&#34;&gt;enumerate&lt;/span&gt;()
    .&lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;) {
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len_utf8&lt;/span&gt;();

        &lt;span style=&#34;color: #177500&#34;&gt;// Check and skip chars if needed&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_chars&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt; {
            &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt;;
            &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
            &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt;;
            &lt;span style=&#34;color: #000000&#34;&gt;skipped_chars&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
            &lt;span style=&#34;color: #A90D91&#34;&gt;continue&lt;/span&gt;;
        }

        &lt;span style=&#34;color: #177500&#34;&gt;// Same as before down here&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt;];
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt;);
        &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;chars&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;count&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
        &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
        &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt;;
        &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt;);
    }
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here is the &lt;code&gt;next&lt;/code&gt; function in its full glory:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;next&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Option&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;Token&amp;gt;&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;;
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_chars&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;;
    &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;cidx&lt;/span&gt;, (&lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;)) &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..]
        .&lt;span style=&#34;color: #000000&#34;&gt;char_indices&lt;/span&gt;()
        .&lt;span style=&#34;color: #000000&#34;&gt;enumerate&lt;/span&gt;()
        .&lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;filter&lt;/span&gt;)
        {
            &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len_utf8&lt;/span&gt;();
            &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_chars&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt; {
                &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt;;
                &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
                &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt;;
                &lt;span style=&#34;color: #000000&#34;&gt;skipped_chars&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
                &lt;span style=&#34;color: #A90D91&#34;&gt;continue&lt;/span&gt;;
            }

            &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt;];
            &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt;);
            &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;chars&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;count&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
            &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
            &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bidx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;char_len&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;skipped_bytes&lt;/span&gt;;
            &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt;);
        }

    &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;() {
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;[&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt;..];
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;slice&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;char_offset&lt;/span&gt;, &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;position&lt;/span&gt;);
        &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;byte_offset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;();
        &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;token&lt;/span&gt;)
    } &lt;span style=&#34;color: #A90D91&#34;&gt;else&lt;/span&gt; {
        &lt;span style=&#34;color: #A90D91&#34;&gt;None&lt;/span&gt;
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;How would we implement a &lt;code&gt;Whitespace&lt;/code&gt; tokenizer with this? One might be tempted to match against &lt;code&gt;&#39; &#39;&lt;/code&gt;, but keep in mind that whitespace, when dealing with unicode, can be many more different characters so its best to not hardcode them in a gigantic match clause and instead use a built-in function.&lt;/p&gt;

&lt;p&gt;Here is our &lt;code&gt;WhitespaceTokenizer&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;WhitespaceTokenizer&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;impl&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Tokenizer&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;WhitespaceTokenizer&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TokenIter&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CharTokenIter&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt;;

    &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;tokenize&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #5B269A&#34;&gt;self&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;input:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;&amp;#39;a&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Self::TokenIter&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;CharTokenIter::new&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;is_whitespace&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;input&lt;/span&gt;)
    }
}

&lt;span style=&#34;color: #633820&#34;&gt;#[inline]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;is_whitespace&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;input:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, (&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;char&lt;/span&gt;))) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;bool&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;_&lt;/span&gt;, (&lt;span style=&#34;color: #000000&#34;&gt;_&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;)) &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*input&lt;/span&gt;;
    &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;is_whitespace&lt;/span&gt;()
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We initialize the &lt;code&gt;CharTokenIter&lt;/code&gt; and in use the &lt;a href=&#34;https://doc.rust-lang.org/std/primitive.char.html#method.is_whitespace&#34;&gt;char::is_whitespace()&lt;/a&gt; method to check for a unicode whitespace character. Using it is now pretty simple, consider this test case:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #633820&#34;&gt;#[test]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;should_split_between_words&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;expected&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;vec!&lt;/span&gt;[&lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;), &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;world&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;6&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;)];
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;actually&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;WhitespaceTokenizer&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;tokenize&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;hello world&amp;quot;&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;collect::&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;Vec&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;Token&amp;gt;&amp;gt;&lt;/span&gt;();
    &lt;span style=&#34;color: #000000&#34;&gt;assert_eq!&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;expected&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;actually&lt;/span&gt;);
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This implementation also works with all kinds of unicode characters that may have different byte lengths (and this is where our different tracking of character and byte offsets becomes important):&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #633820&#34;&gt;#[test]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;should_handle_mixed_chars&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;expected&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;vec!&lt;/span&gt;[&lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;abc&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;), &lt;span style=&#34;color: #000000&#34;&gt;Token::from_str&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;abc&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;)];
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;actually&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;WhitespaceTokenizer&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;tokenize&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;abc abc&amp;quot;&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;collect::&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;Vec&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;Token&amp;gt;&amp;gt;&lt;/span&gt;();
    &lt;span style=&#34;color: #000000&#34;&gt;assert_eq!&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;expected&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;actually&lt;/span&gt;);
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Before we move on to benchmarks, lets take a quick look at the corresponding &lt;a href=&#34;https://github.com/blevesearch/bleve/blob/master/analysis/tokenizer/character/character.go&#34;&gt;go implementation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;https://github.com/blevesearch/bleve/blob/master/analysis/tokenizer/character/character.go#L35&#34;&gt;CharacterTokenizer&lt;/a&gt; loops through each &lt;a href=&#34;https://blog.golang.org/strings&#34;&gt;rune&lt;/a&gt; and very similar to our implementation keeps track of all kinds of offsets and slices out terms as needed. The big difference is that it can&amp;rsquo;t do explicit stack allocations and upfront allocates a 1024 element slice for its &lt;code&gt;TokenStream&lt;/code&gt; which would be extended if more tokens are needed.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;https://github.com/blevesearch/bleve/blob/master/analysis/tokenizer/whitespace/whitespace.go#L32&#34;&gt;WhitespaceTokenizer&lt;/a&gt; is also very similar and calls a runtime-provided function that checks if the given rune is a unicode whitespace character or not.&lt;/p&gt;

&lt;h2 id=&#34;benchmarks&#34;&gt;Benchmarks&lt;/h2&gt;

&lt;p&gt;This is what you came for, right? Lets see how our implementation performs in comparison to the go one. To establish a meaningful baseline we need to define a common text corpus that is used for the benchmark.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Edit:&lt;/strong&gt; I forgot to mention the versions used: Rust is at &lt;code&gt;1.14.0-nightly&lt;/code&gt; since the benchmarking tool is unstable and the version of go used is &lt;code&gt;go1.7.1 darwin/amd64&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I copied the text out of the &lt;a href=&#34;https://en.wikipedia.org/wiki/Rust_(programming_language)&#34;&gt;Rust Wikipedia&lt;/a&gt; page that is exact 1000 characters long and contains around 150-160 tokens depending on the type of tokenizer used.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;INPUT:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;&amp;#39;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;str&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt;
    &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;In addition to conventional static typing, before version 0.4, Rust also supported \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     typestates. The typestate system modeled assertions before and after program statements, \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     through use of a special check statement. Discrepancies could be discovered at compile time, \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     rather than when a program was running, as might be the case with assertions in C or C++ \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     code. The typestate concept was not unique to Rust, as it was first introduced in the \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     language NIL. Typestates were removed because in practice they found little use, though the \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     same functionality can still be achieved with branding patterns.&lt;/span&gt;

&lt;span style=&#34;color: #C41A16&#34;&gt;The style changed between \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     0.2, 0.3 and 0.4. Version 0.2 introduced classes for the first time, with version 0.3 adding \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     a number of features including destructors and polymorphism through the use of interfaces. \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     In Rust 0.4, traits were added as a means to provide inheritance; In January 2014, the \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     editor-in-chief of Dr Dobb&amp;#39;s, Andrew Binstock, commented on Rust&amp;#39;s chances to become a \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     competitor to C++.&amp;quot;&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If we split on unicode whitespace, there are exactly 159 tokens.&lt;/p&gt;

&lt;p&gt;Here is our benchmark for rust:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #633820&#34;&gt;#[bench]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bench_whitespace_tokenizer&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;b:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Bencher&lt;/span&gt;) {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;t&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;WhitespaceTokenizer&lt;/span&gt;;
   &lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;iter&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;t&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;tokenize&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;INPUT&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;last&lt;/span&gt;());
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Running with &lt;code&gt;cargo +nightly bench&lt;/code&gt; on my machine (a 2,5GHz i7, OSX, 16GB RAM), rust reports:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test bench_whitespace_tokenizer ... bench:       6,972 ns/iter (+/- 1,148)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It takes 7 microseconds to process 159 tokens, so it can process 23 tokens per microsecond. This translates into roughly 23 million tokens per second. Put differently, with this input text we can tokenize around 136MB/s on a single core.&lt;/p&gt;

&lt;p&gt;Here is our go equivalent in bleve:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;var&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;sampleLargeInput&lt;/span&gt; = []&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;`In addition to conventional static typing, before version 0.4, Rust also supported \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     typestates. The typestate system modeled assertions before and after program statements, \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     through use of a special check statement. Discrepancies could be discovered at compile time, \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     rather than when a program was running, as might be the case with assertions in C or C++ \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     code. The typestate concept was not unique to Rust, as it was first introduced in the \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     language NIL. Typestates were removed because in practice they found little use, though the \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     same functionality can still be achieved with branding patterns.&lt;/span&gt;

&lt;span style=&#34;color: #C41A16&#34;&gt;The style changed between \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     0.2, 0.3 and 0.4. Version 0.2 introduced classes for the first time, with version 0.3 adding \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     a number of features including destructors and polymorphism through the use of interfaces. \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     In Rust 0.4, traits were added as a means to provide inheritance; In January 2014, the \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     editor-in-chief of Dr Dobb&amp;#39;s, Andrew Binstock, commented on Rust&amp;#39;s chances to become a \&lt;/span&gt;
&lt;span style=&#34;color: #C41A16&#34;&gt;     competitor to C++.`&lt;/span&gt;)

&lt;span style=&#34;color: #A90D91&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;BenchmarkTokenizeEnglishText&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*testing&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;B&lt;/span&gt;) {

	&lt;span style=&#34;color: #000000&#34;&gt;tokenizer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;character&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;NewCharacterTokenizer&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;notSpace&lt;/span&gt;)
	&lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;ResetTimer&lt;/span&gt;()

	&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &amp;lt; &lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;N&lt;/span&gt;; &lt;span style=&#34;color: #000000&#34;&gt;i++&lt;/span&gt; {
		&lt;span style=&#34;color: #000000&#34;&gt;tokenizer&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;Tokenize&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;sampleLargeInput&lt;/span&gt;)
	}

}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;It reports:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;BenchmarkTokenizeEnglishText-8   	   50000	     22893 ns/op	   19072 B/op	     171 allocs/op
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So each run takes close to 23 microseconds compared of 7 in Rust! That&amp;rsquo;s roughly three times slower, clocking at
around 7 million tokens per second or 41MB/s per core.&lt;/p&gt;

&lt;p&gt;Why is that? Let&amp;rsquo;s try disabling the stack allocation optimization in rust by setting the &lt;code&gt;MAX_STACK_TERM_LEN&lt;/code&gt; to 0 and rerun the benchmark:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test bench_whitespace_tokenizer ... bench:      10,154 ns/iter (+/- 1,553)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We lost a couple microseconds here, but I think the rest is just LLVM and Rust being really good at optimizing the iterator and loop code (keep in mind we are still stack-allocating the tokens themselves while in go I&amp;rsquo;m pretty sure its heap allocated as well in the big &lt;code&gt;TokenStream&lt;/code&gt; slice).&lt;/p&gt;

&lt;p&gt;Now with any kind of microbenchmarking it is hard to say how the difference will look like on your hardware and dataset. More realistic numbers could be gathered by tokenizing large chunks of for example the Wikipedia dataset and then looking at the overall numbers. Of course your mileage may also vary per machine, so if you are curious please run the benchmarks on your hardware - and please post them in the comments below!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Scheduling Timers on OS X with Rust and Kqueue</title>
      <link>http://nitschinger.at/Scheduling-Timers-on-OS-X-with-Rust-and-Kqueue/</link>
      <pubDate>Wed, 15 Jun 2016 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Scheduling-Timers-on-OS-X-with-Rust-and-Kqueue/</guid>
      <description>

&lt;p&gt;As a more or less POSIX compatible system I would&amp;rsquo;ve expected
&lt;a href=&#34;http://man7.org/linux/man-pages/man2/timer_create.2.html&#34;&gt;timer_create&lt;/a&gt; and
friends to be available on OS X, but it turns out those functions are not
available (at least I couldn&amp;rsquo;t find them after hours of research).&lt;/p&gt;

&lt;p&gt;Looking into alternatives (spoiler: there are not many I think if you want to
work from C/Rust) I settled on &lt;a href=&#34;https://en.wikipedia.org/wiki/Kqueue&#34;&gt;Kqueue&lt;/a&gt;.
It doesn&amp;rsquo;t have all the features that the &lt;code&gt;timer_&lt;/code&gt; functions provide, but for
what I need it seems to be good enough. Also, there are a bunch of crates like
&lt;a href=&#34;https://crates.io/crates/mio&#34;&gt;mio&lt;/a&gt; and &lt;a href=&#34;https://crates.io/crates/nix&#34;&gt;nix&lt;/a&gt;
available that either provide abstractions or use Kqueue already so I had
something to refer to.&lt;/p&gt;

&lt;p&gt;I didn&amp;rsquo;t find documentation or blog posts on this topic so I decided it is
time to write one. This doesn&amp;rsquo;t go into all the details since, frankly, I don&amp;rsquo;t
know all of them yet too. It should be enough to get you started though.&lt;/p&gt;

&lt;h2 id=&#34;a-kqueue-primer&#34;&gt;A Kqueue primer&lt;/h2&gt;

&lt;p&gt;Kqueue is a event notification system originally introduced in FreeBSD and
subsequently supported in many more BSD variants as well as OS X. It can be used
for similar tasks (like handling network connections) as the
&lt;a href=&#34;https://en.wikipedia.org/wiki/Epoll&#34;&gt;epoll&lt;/a&gt; system on Linux or the
&lt;a href=&#34;https://en.wikipedia.org/wiki/Input/output_completion_port&#34;&gt;IOCP&lt;/a&gt; framework on
Windows. You can also schedule timers with it, and this is what we are doing in
this blog post.&lt;/p&gt;

&lt;p&gt;There are two main functions you need to work with:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kqueue&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt;);

&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt;(&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kq&lt;/span&gt;, &lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*changelist&lt;/span&gt;, &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;nchanges&lt;/span&gt;,
    &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*eventlist&lt;/span&gt;, &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;nevents&lt;/span&gt;, &lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;timespec&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*timeout&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;which translate to the following rust signatures (from &lt;code&gt;nix&lt;/code&gt;):&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kqueue&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Result&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;RawFd&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;kq:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;RawFd&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;changelist:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;[&lt;span style=&#34;color: #000000&#34;&gt;KEvent&lt;/span&gt;], &lt;span style=&#34;color: #000000&#34;&gt;eventlist:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; [&lt;span style=&#34;color: #000000&#34;&gt;KEvent&lt;/span&gt;], &lt;span style=&#34;color: #000000&#34;&gt;timeout_ms:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Result&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;kqueue&lt;/code&gt; function translates into a system call and creates a   new kernel
event queue and returns a descriptor. The &lt;code&gt;kevent&lt;/code&gt; function is used to both
register new &lt;code&gt;KEvents&lt;/code&gt; as well as check if any of them are currently pending.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;KEvent&lt;/code&gt; is a generic struct that describes the type of event to monitor
and looks like this in rust (also from &lt;code&gt;nix&lt;/code&gt;):&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;KEvent&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ident:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;uintptr_t&lt;/span&gt;,
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;filter:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;EventFilter&lt;/span&gt;,
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;flags:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;EventFlag&lt;/span&gt;,
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;fflags:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;FilterFlag&lt;/span&gt;,
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;data:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;intptr_t&lt;/span&gt;,
    &lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;udata:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;,
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;ident&lt;/code&gt; holds a value which is used to identify the event. Depending on the
configured filter its type and meaning can change (but is very often a file
descriptor). The &lt;code&gt;filter&lt;/code&gt; is important since it determines the kernel filter to
process this event. For our timers we&amp;rsquo;ll use &lt;code&gt;EventFilter::EVFILT_TIMER&lt;/code&gt;, but
there are many more available. The &lt;code&gt;flags&lt;/code&gt; define which actions to perform
on the given event. The &lt;code&gt;fflags&lt;/code&gt; allow you to configure filter-specific flags,
in our example we won&amp;rsquo;t use them. Finally &lt;code&gt;data&lt;/code&gt; allows to set filter-specific
values and &lt;code&gt;udata&lt;/code&gt; is opaque user-defined data that is passed through the kernel
unchanged.&lt;/p&gt;

&lt;p&gt;Check out &lt;a href=&#34;http://rustdoc.s3-website-us-east-1.amazonaws.com/nix/master/osx/nix/sys/event/index.html&#34;&gt;the docs in nix&lt;/a&gt;
for all the different values on &lt;code&gt;EventFlag&lt;/code&gt;, &lt;code&gt;EventFilter&lt;/code&gt; and &lt;code&gt;FilterFlag&lt;/code&gt;. Also,
the original documentation on &lt;a href=&#34;https://www.freebsd.org/cgi/man.cgi?query=kqueue&#34;&gt;kqueue&lt;/a&gt;
provides lots of insights into the flags and their functionality.&lt;/p&gt;

&lt;p&gt;The last thing you need to know before diving into the actual code is the difference
between &lt;code&gt;changelist&lt;/code&gt; and &lt;code&gt;eventlist&lt;/code&gt;: Both take a slice of &lt;code&gt;KEvents&lt;/code&gt;, but only
&lt;code&gt;eventlist&lt;/code&gt; is mutable.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;changelist&lt;/code&gt; is used to register events with kqueue.&lt;/li&gt;
&lt;li&gt;The &lt;code&gt;eventlist&lt;/code&gt; contains all the events which are currently active at the
time of polling.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Note that the same slice underlying container (like a &lt;code&gt;Vec&lt;/code&gt;) can be used to
 maintain both lists.&lt;/p&gt;

&lt;p&gt;With the basics covered, let&amp;rsquo;s dive into the code.&lt;/p&gt;

&lt;h2 id=&#34;scheduling-timers&#34;&gt;Scheduling Timers&lt;/h2&gt;

&lt;p&gt;Create a new (&lt;code&gt;--bin&lt;/code&gt;) project through &lt;code&gt;cargo&lt;/code&gt; and add &lt;code&gt;nix&lt;/code&gt; as a dependency:&lt;/p&gt;
[dependencies]
nix = &#34;0.6.0&#34;

&lt;p&gt;Add this to the top of your &lt;code&gt;main.rs&lt;/code&gt; file so we have the imports out of the
way:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;nix&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;nix::sys::event::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;KEvent&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;kqueue&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;EventFilter&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;FilterFlag&lt;/span&gt;};
&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;nix::sys::event::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;EV_ADD&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;EV_ENABLE&lt;/span&gt;};
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next, we add a helper function that encapsulates the &lt;code&gt;KEvent&lt;/code&gt; creation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;event&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;id:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;timer:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;isize&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;KEvent&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;KEvent&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;ident:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;id&lt;/span&gt;,
        &lt;span style=&#34;color: #000000&#34;&gt;filter:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;EventFilter::EVFILT_TIMER&lt;/span&gt;,
        &lt;span style=&#34;color: #000000&#34;&gt;flags:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;EV_ADD&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;EV_ENABLE&lt;/span&gt;,
        &lt;span style=&#34;color: #000000&#34;&gt;fflags:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;FilterFlag::empty&lt;/span&gt;(),
        &lt;span style=&#34;color: #000000&#34;&gt;data:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;timer&lt;/span&gt;,
        &lt;span style=&#34;color: #000000&#34;&gt;udata:&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;,
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here the caller passes in the event id as well as the timer in milliseconds. Since
we want to get a timer event we need to use the &lt;code&gt;EventFilter::EVFILT_TIMER&lt;/code&gt; filter.
The &lt;code&gt;EV_ADD | EV_ENABLE&lt;/code&gt; indicates we want to add and enable the timer at the same
time. No flag filters are needed and the &lt;code&gt;data&lt;/code&gt; payload for our timer event is the
time provided by the caller. We also don&amp;rsquo;t set any opaque user data here.&lt;/p&gt;

&lt;p&gt;Inside our &lt;code&gt;main&lt;/code&gt; function we first need to grab a &lt;code&gt;kqueue&lt;/code&gt; and then register
events. We make use of our &lt;code&gt;event&lt;/code&gt; function here and create one event that
runs each second and one that runs every 1.5 seconds:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #177500&#34;&gt;// Initialize the Kqueue&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kq&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kqueue&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;expect&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Could not get kqueue&amp;quot;&lt;/span&gt;);

&lt;span style=&#34;color: #177500&#34;&gt;// Create a Vec&amp;lt;KEvent&amp;gt; with both events&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;changes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;vec!&lt;/span&gt;[&lt;span style=&#34;color: #000000&#34;&gt;event&lt;/span&gt;(&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;1000&lt;/span&gt;), &lt;span style=&#34;color: #000000&#34;&gt;event&lt;/span&gt;(&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color: #1C01CE&#34;&gt;1500&lt;/span&gt;)];

&lt;span style=&#34;color: #177500&#34;&gt;// Register the events in the `changelist`.&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;kq&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;changes&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;as_slice&lt;/span&gt;(), &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; [], &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Kqueue now knows about the events we are interested in, so it&amp;rsquo;s time to run
a loop and poll until they happen:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;loop&lt;/span&gt; {
  &lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;kevent&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;kq&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;[], &lt;span style=&#34;color: #000000&#34;&gt;changes&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;as_mut_slice&lt;/span&gt;(), &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;) {
    &lt;span style=&#34;color: #A90D91&#34;&gt;Ok&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;v&lt;/span&gt;) &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; {
      &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;---&amp;quot;&lt;/span&gt;);
      &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;..&lt;span style=&#34;color: #000000&#34;&gt;v&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Event with ID {:?} triggered&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;changes&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;ident&lt;/span&gt;);
      }
    }
    &lt;span style=&#34;color: #A90D91&#34;&gt;Err&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;panic!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;{:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;), &lt;span style=&#34;color: #177500&#34;&gt;// Panic on Errors&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;_&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; () &lt;span style=&#34;color: #177500&#34;&gt;// Ignore Ok(0),&lt;/span&gt;
  }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We poll &lt;code&gt;kevent&lt;/code&gt; and the &lt;code&gt;changes&lt;/code&gt; slice is updated with the results on each
poll with the &lt;code&gt;eventlist&lt;/code&gt;. &lt;code&gt;kevent&lt;/code&gt; returns either an &lt;code&gt;Err&lt;/code&gt; or &lt;code&gt;Ok&lt;/code&gt; with the
number of events that are available now. Note that &lt;code&gt;Ok(0)&lt;/code&gt; is a special case
that nothing is available, so we move on. If we have at least one event pending
we iterate through all pending events and print their ID.&lt;/p&gt;

&lt;p&gt;So if you run this example what you&amp;rsquo;ll see is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cargo run
       Fresh bitflags v0.4.0
       Fresh semver v0.1.20
       Fresh void v1.0.2
       Fresh cfg-if v0.1.0
       Fresh libc v0.2.12
       Fresh rustc_version v0.1.7
       Fresh nix v0.6.0
       Fresh kqueue-samples v0.1.0
     Running `target/debug/kqueue-samples`
---
Event with ID 1 triggered
---
Event with ID 2 triggered
---
Event with ID 1 triggered
---
Event with ID 1 triggered
Event with ID 2 triggered
---
Event with ID 1 triggered
---
Event with ID 2 triggered
---
^C
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Since our timers fire at different intervals (and occasionally fire together) you
can see that every time the different events are available to process by your
application.&lt;/p&gt;

&lt;p&gt;Of course this is barely scratching the surface of what you can do with &lt;code&gt;kqueue&lt;/code&gt;
but I&amp;rsquo;d like to mention one final thing: as you can see even if you just
registered the events once they fire over and over again. If you want to fire
them just once you can use &lt;code&gt;flags: EV_ADD | EV_ENABLE | EV_ONESHOT&lt;/code&gt; instead.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>First Steps with Rust and JNI</title>
      <link>http://nitschinger.at/First-Steps-with-Rust-and-JNI/</link>
      <pubDate>Fri, 19 Feb 2016 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/First-Steps-with-Rust-and-JNI/</guid>
      <description>&lt;p&gt;The first steps are always the hardest, at least thats how the saying goes. But it turns out that calling into &lt;a href=&#34;http://rust-lang.org/&#34;&gt;Rust&lt;/a&gt; from Java is easier than I originally thought.&lt;/p&gt;

&lt;p&gt;The following blog post shows you how to setup and compile a Rust library which can be called from Java userland. Note that everything you see in this post, while being functional, is very simplistic. Real world JNI has lots of nitty gritty details and pitfalls, but we need to start somewhere right?&lt;/p&gt;

&lt;p&gt;Recently on Hacker News there has been rumor that &lt;a href=&#34;https://www.youtube.com/watch?v=dQw4w9WgXcQ&#34;&gt;adding two integers is slow in java&lt;/a&gt;, so lets try to offload this complex operation into Rust.&lt;/p&gt;

&lt;p&gt;Note that all steps performed in this blog post were done on OSX, but with little adaption they should also work on Linux. Maybe even on Windows, but I&amp;rsquo;m not so sure there since my experience with Windows is very limited. Any recent Rust version should suffice, I&amp;rsquo;m using 1.6.0 stable.&lt;/p&gt;

&lt;p&gt;The first step is to create a &lt;code&gt;cargo&lt;/code&gt; library project:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;~/rust $ cargo new highperf-adder
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Open the generated &lt;code&gt;Cargo.toml&lt;/code&gt; and add &lt;code&gt;libc&lt;/code&gt; as a dependency. When interacting with &lt;a href=&#34;https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/jniTOC.html&#34;&gt;JNI&lt;/a&gt;, Rust needs to dress up a bit to look like C, and &lt;code&gt;libc&lt;/code&gt; helps with that.&lt;/p&gt;

&lt;p&gt;While you&amp;rsquo;re in there, tell &lt;code&gt;cargo&lt;/code&gt; that you want to build the crate as a &lt;code&gt;dylib&lt;/code&gt; and also give it an explicit name:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[lib]
name = &amp;quot;hpa&amp;quot;
crate-type = [&amp;quot;dylib&amp;quot;]

[dependencies]
libc = &amp;quot;0.2.7&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you don&amp;rsquo;t specify that you want a &lt;code&gt;dylib&lt;/code&gt;, it will build a &lt;code&gt;rlib&lt;/code&gt; which is not intended for external use. Also don&amp;rsquo;t use &lt;code&gt;staticlib&lt;/code&gt;, since this fail to link as well.&lt;/p&gt;

&lt;p&gt;To make sure all is well so far we can build the project:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cargo build
Updating registry `https://github.com/rust-lang/crates.io-index`
Compiling libc v0.2.7
Compiling highperf-adder v0.1.0 (file:///Users/michael/rust/highperf-adder)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Instead of diving straight into Rust code, let&amp;rsquo;s work on the Java code first. To keep it simple, create a &lt;code&gt;Adder.java&lt;/code&gt; file in the root of the project directory and add the following code:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;java.nio.file.Path;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;java.nio.file.Paths;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;Adder&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;Path&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Paths.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;target/debug/libhpa.dylib&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;System.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;load&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(p.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;toAbsolutePath&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;toString&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;());&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;native&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;add(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v1,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v2);&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main(String...&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;args)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;System.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;out&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;2 + 3 = &amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Adder.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;));&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Let&amp;rsquo;s break the code up into digestible chunks.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;Path&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Paths.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;target/debug/libhpa.dylib&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;System.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;load&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(p.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;toAbsolutePath&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;toString&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;());&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We need to tell the JVM to pick up our shared library that got built by Rust. If you are running &lt;code&gt;cargo build&lt;/code&gt; with the &lt;code&gt;--release&lt;/code&gt; flag to optimize, make sure to point it towards &lt;code&gt;target/release/libhpa.dylib&lt;/code&gt; instead.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;native&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;add(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v1,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v2);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next up we define all our native methods that we want to call through JNI. It works a little bit like implementing an abstract class, but you are implementing the actual code in Rust intead of Java userland. The name of the method and its calling class will become important in a bit, so if you want to follow along make sure you keep the same names.&lt;/p&gt;

&lt;p&gt;In our case we define one &lt;code&gt;add&lt;/code&gt; method which takes two integers as arguments and returns the result as an integer.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main(String...&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;args)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;System.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;out&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;2 + 3 = &amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Adder.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;));&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;main&lt;/code&gt; method calls our static JNI method and prints the result to &lt;code&gt;stdout&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s run it straight away:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ javac Adder.java 
$ java Adder
Exception in thread &amp;quot;main&amp;quot; java.lang.UnsatisfiedLinkError: Adder.add(II)I
    at Adder.add(Native Method)
    at Adder.main(Adder.java:14)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It compiles without errors, but at runtime it breaks apart. This doesn&amp;rsquo;t come as a huge surprise since we didn&amp;rsquo;t write a single line of Rust code yet. The JVM just tells us it can&amp;rsquo;t link the method we&amp;rsquo;re looking for.&lt;/p&gt;

&lt;p&gt;To fix that, open the &lt;code&gt;src/lib.rs&lt;/code&gt; file and insert the following Rust code:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;libc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;libc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt;};

&lt;span style=&#34;color: #633820&#34;&gt;#[repr(C)]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNINativeInterface&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;reserved0:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;reserved1:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;reserved2:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;reserved3:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #177500&#34;&gt;// much more actually in here for practical JNI code, but not&lt;/span&gt;
    &lt;span style=&#34;color: #177500&#34;&gt;// relevant for this very simple example...&lt;/span&gt;
}

&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNIEnv&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNINativeInterface&lt;/span&gt;;

&lt;span style=&#34;color: #633820&#34;&gt;#[no_mangle]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Java_Adder_add&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;jre:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNIEnv&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;class:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;v1:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;v2:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;v1&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v2&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Alright, so what&amp;rsquo;s going on here?&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #633820&#34;&gt;#[repr(C)]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNINativeInterface&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;reserved0:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;reserved1:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;reserved2:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #000000&#34;&gt;reserved3:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;,
    &lt;span style=&#34;color: #177500&#34;&gt;// ...&lt;/span&gt;
}

&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;type&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNIEnv&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNINativeInterface&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The JVM exports a &lt;code&gt;jni.h&lt;/code&gt; header file which contains its primary interfaces when interacting through JNI. Normally we&amp;rsquo;d write a proper Rust C FFI binding here and keep our code idiomatic, but for now all we need is a pointer to the &lt;code&gt;JNIEnv&lt;/code&gt; (even if we don&amp;rsquo;t actually use it, it gets passed in to our &lt;code&gt;add&lt;/code&gt; method as an argument). If you take a look at the &lt;a href=&#34;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/javavm/export/jni.h#l214&#34;&gt;actual jni.h&lt;/a&gt; you can see that we get away with lots of handwaving for now.&lt;/p&gt;

&lt;p&gt;Btw, how on earth did we know that the JVM expects a method with the signature of &lt;code&gt;fn Java_Adder_add(jre: *mut JNIEnv, class: *const c_void, v1: c_int, v2: c_int) -&amp;gt; c_int&lt;/code&gt;? The answer lies in the &lt;code&gt;javah&lt;/code&gt; command and some conversion of C to Rust. If you run &lt;code&gt;javah Adder&lt;/code&gt; you get a &lt;code&gt;Adder.h&lt;/code&gt; file which looks like:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #177500&#34;&gt;/* DO NOT EDIT THIS FILE - it is machine generated */&lt;/span&gt;
&lt;span style=&#34;color: #633820&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;&amp;lt;jni.h&amp;gt;&lt;/span&gt;&lt;span style=&#34;color: #633820&#34;&gt;&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;/* Header for class Adder */&lt;/span&gt;

&lt;span style=&#34;color: #633820&#34;&gt;#ifndef _Included_Adder&lt;/span&gt;
&lt;span style=&#34;color: #633820&#34;&gt;#define _Included_Adder&lt;/span&gt;
&lt;span style=&#34;color: #633820&#34;&gt;#ifdef __cplusplus&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;C&amp;quot;&lt;/span&gt; {
&lt;span style=&#34;color: #633820&#34;&gt;#endif&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;/*&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt; * Class:     Adder&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt; * Method:    add&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt; * Signature: (II)I&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;JNIEXPORT&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;jint&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNICALL&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Java_Adder_add&lt;/span&gt;
  (&lt;span style=&#34;color: #000000&#34;&gt;JNIEnv&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;jclass&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;jint&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;jint&lt;/span&gt;);

&lt;span style=&#34;color: #633820&#34;&gt;#ifdef __cplusplus&lt;/span&gt;
}
&lt;span style=&#34;color: #633820&#34;&gt;#endif&lt;/span&gt;
&lt;span style=&#34;color: #633820&#34;&gt;#endif&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The important part is this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;JNIEXPORT&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;jint&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNICALL&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Java_Adder_add&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;JNIEnv&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;jclass&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;jint&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;jint&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The type &lt;code&gt;jint&lt;/code&gt; is defined per plattform. For OSX you can find it &lt;a href=&#34;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/macosx/javavm/export/jni_md.h#l33&#34;&gt;here&lt;/a&gt; and it maps to an &lt;code&gt;int&lt;/code&gt;. The rust &lt;code&gt;libc&lt;/code&gt; exports this type through &lt;code&gt;libc::c_int&lt;/code&gt;, which we can utilize in our code. &lt;code&gt;jclass&lt;/code&gt; is a reference type which we ignore for now, since we don&amp;rsquo;t need it.&lt;/p&gt;

&lt;p&gt;All we need to do is add the two numbers and return the result:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #633820&#34;&gt;#[no_mangle]&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;pub&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Java_Adder_add&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;jre:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;JNIEnv&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;class:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_void&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;v1:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;v2:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;c_int&lt;/span&gt; {
    &lt;span style=&#34;color: #000000&#34;&gt;v1&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v2&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Make sure you don&amp;rsquo;t forget the &lt;code&gt;#[no_mangle]&lt;/code&gt; which tells Rust to turn off its name mangling so that there are no issues while linking (try it out and you&amp;rsquo;ll see the &lt;code&gt;UnsatisfiedLinkError&lt;/code&gt; again). Finally its time to compile the &lt;code&gt;crate&lt;/code&gt; once more and run the Java class again. Note that you don&amp;rsquo;t need to recompile the Java code every time you make a change to the Rust code. Just rebuild with cargo and run the Java file again, it will pick up the freshly created &lt;code&gt;dylib&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cargo build
   Compiling libc v0.2.7
   Compiling highperf-adder v0.1.0 (file:///Users/michael/rust/highperf-adder)
src/lib.rs:18:30: 18:33 warning: unused variable: `jre`, #[warn(unused_variables)] on by default
src/lib.rs:18 pub extern fn Java_Adder_add(jre: *mut JNIEnv, class: *const c_void, v1: c_int, v2: c_int) -&amp;gt; c_int {
                                           ^~~
src/lib.rs:18:48: 18:53 warning: unused variable: `class`, #[warn(unused_variables)] on by default
src/lib.rs:18 pub extern fn Java_Adder_add(jre: *mut JNIEnv, class: *const c_void, v1: c_int, v2: c_int) -&amp;gt; c_int {
                                                             ^~~~~
src/lib.rs:18:1: 20:2 warning: function `Java_Adder_add` should have a snake case name such as `java_adder_add`, #[warn(non_snake_case)] on by default
src/lib.rs:18 pub extern fn Java_Adder_add(jre: *mut JNIEnv, class: *const c_void, v1: c_int, v2: c_int) -&amp;gt; c_int {
src/lib.rs:19     v1 + v2
src/lib.rs:20 }
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;$ java Adder
2 + 3 = 5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It works! The warnings from &lt;code&gt;rustc&lt;/code&gt; are there because the rust compiler is as always super correct and tells us we are neither making use of the &lt;code&gt;jre&lt;/code&gt; nor of the &lt;code&gt;class&lt;/code&gt; function arguments. Also, our method signature is not named like idiomatic rust code is. You can turn off those warnings by adding the attributes the compiler suggests.&lt;/p&gt;

&lt;p&gt;I think a crate which abstracts the JNI C FFI would be pretty awesome to abstract the nitty gritty details and to expose a safe, idiomatic Rust API. I&amp;rsquo;m planning to work on that as time permits, let me know if you also want to hack on it. Finally, thanks to &lt;a href=&#34;https://twitter.com/netvlm&#34;&gt;Vladimir Mateev&lt;/a&gt; who &lt;a href=&#34;http://stackoverflow.com/questions/30258427/calling-rust-from-java&#34;&gt;answered&lt;/a&gt; a related question on stackoverflow last year which got me motivated to dive in further.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Binding Threads And Processes to CPUs in Rust</title>
      <link>http://nitschinger.at/Binding-Threads-And-Processes-to-CPUs-in-Rust/</link>
      <pubDate>Thu, 11 Feb 2016 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Binding-Threads-And-Processes-to-CPUs-in-Rust/</guid>
      <description>

&lt;p&gt;In the &lt;a href=&#34;http://nitschinger.at/Discovering-Hardware-Topology-in-Rust&#34;&gt;previous post&lt;/a&gt; I&amp;rsquo;ve introduced the &lt;a href=&#34;https://github.com/daschl/hwloc-rs&#34;&gt;hwloc-rs&lt;/a&gt; library, which allows you to discover and manage hardware topologies. Discovering the capabilities of a machine is insightful, but it gets more interesting if you can perform certain actions based on those insights.&lt;/p&gt;

&lt;p&gt;Binding threads or processes to distinct CPU cores is very important in high performance applications to isolate workloads, keep inter-core messaging latency to a minimum and also to prevent the operating system from relocating your threads between cores as it sees fit. This becomes even more important in &lt;a href=&#34;https://en.wikipedia.org/wiki/Non-uniform_memory_access&#34;&gt;NUMA&lt;/a&gt; architectures, where the memory access latency depends on the memory location relative to the processors (binding memory chunks, while also supported by &lt;code&gt;hwloc&lt;/code&gt; is not covered in this post).&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.open-mpi.org/projects/hwloc/tutorials/20150921-EuroMPI-hwloc-tutorial.pdf&#34;&gt;Example Benchmarks&lt;/a&gt; with &lt;a href=&#34;https://www.open-mpi.org/&#34;&gt;OpenMPI&lt;/a&gt; and &lt;a href=&#34;https://software.intel.com/en-us/intel-mpi-library&#34;&gt;Intel MPI&lt;/a&gt; on a 12-core Xeon E5 show that the throughput and latency vary greatly when passing messages between cores. Between cores on the same NUMA node the latency is around 330ns with a throughput of 4220MiB/s, but once messages need to cross the boundaries between cores in different NUMA nodes the latency shoots up to 590ns and the throughput drops to 3410MiB/s.&lt;/p&gt;

&lt;p&gt;As always with such low-level concerns like this, the APIs differ across operating systems and some platforms don&amp;rsquo;t even support CPU binding at all. This is where &lt;code&gt;hwloc&lt;/code&gt; shines again - it provides us with easy to use abstractions that we can readily use in our rust code. The following blog post explains the different options (checking for support, process binding, thread binding) in greater detail.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc/0.3.0/hwloc/index.html&#34;&gt;docs&lt;/a&gt; provide helpful instructions to get started, but make sure you pick up at least version &lt;code&gt;0.3.0&lt;/code&gt; if you want to try it out:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[dependencies]
hwloc = &amp;quot;0.3.0&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;checking-for-support&#34;&gt;Checking for Support&lt;/h2&gt;

&lt;p&gt;Before even thinking about binding your thread or process to a specific core you need to check whether your target platform supports it. Spoiler: if you are thinking about trying this on OSX, you are out of luck. But this gives us a chance to compare the output of the following code on Linux and OSX:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::Topology&lt;/span&gt;;

&lt;span style=&#34;color: #C41A16&#34;&gt;/// Example on how to check for specific topology support of a feature.&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #177500&#34;&gt;// Check if Process Binding for CPUs is supported&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;CPU Binding (current process) supported: {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;support&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;cpu&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;set_current_process&lt;/span&gt;());
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;CPU Binding (any process) supported: {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;support&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;cpu&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;set_process&lt;/span&gt;());

    &lt;span style=&#34;color: #177500&#34;&gt;// Check if Thread Binding for CPUs is supported&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;CPU Binding (current thread) supported: {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;support&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;cpu&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;set_current_thread&lt;/span&gt;());
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;CPU Binding (any thread) supported: {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;support&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;cpu&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;set_thread&lt;/span&gt;());

    &lt;span style=&#34;color: #177500&#34;&gt;// Debug Print all the Support Flags&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;All Flags:\n{:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;support&lt;/span&gt;());
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;On Linux:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CPU Binding (current process) supported: true
CPU Binding (any process) supported: true
CPU Binding (current thread) supported: true
CPU Binding (any thread) supported: true
All Flags:
TopologyDiscoverySupport { pu: 1 }, TopologyCpuBindSupport { set_thisproc_cpubind: 1, get_thisproc_cpubind: 1, set_proc_cpubind: 1, get_proc_cpubind: 1, set_thisthread_cpubind: 1, get_thisthread_cpubind: 1, set_thread_cpubind: 1, get_thread_cpubind: 1, get_thisproc_last_cpu_location: 1, get_proc_last_cpu_location: 1, get_thisthread_last_cpu_location: 1 }, TopologyMemBindSupport { (omitted) }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On OSX:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CPU Binding (current process) supported: false
CPU Binding (any process) supported: false
CPU Binding (current thread) supported: false
CPU Binding (any thread) supported: false
All Flags:
TopologyDiscoverySupport { pu: 1 }, TopologyCpuBindSupport { set_thisproc_cpubind: 0, get_thisproc_cpubind: 0, set_proc_cpubind: 0, get_proc_cpubind: 0, set_thisthread_cpubind: 0, get_thisthread_cpubind: 0, set_thread_cpubind: 0, get_thread_cpubind: 0, get_thisproc_last_cpu_location: 0, get_proc_last_cpu_location: 0, get_thisthread_last_cpu_location: 0 }, TopologyMemBindSupport { (omitted) }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As a result, the following sections use a (virtual) Linux machine with 4 cores to demonstrate the binding capabilities. To give you some context, here is the &lt;code&gt;lstopo&lt;/code&gt; output of the VM:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ uname -a
Linux vagrant-ubuntu-trusty-64 3.13.0-71-generic #114-Ubuntu SMP Tue Dec 1 02:34:22 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux

$ lstopo -p --no-io
Machine (490MB) + Socket P#0 + L2d (6144KB)
  L1d (32KB) + Core P#0 + PU P#0
  L1d (32KB) + Core P#1 + PU P#1
  L1d (32KB) + Core P#2 + PU P#2
  L1d (32KB) + Core P#3 + PU P#3  
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;the-cpuset&#34;&gt;The CpuSet&lt;/h2&gt;

&lt;p&gt;One important type to know when performing CPU binding operations is the &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc/0.3.0/hwloc/type.CpuSet.html&#34;&gt;CpuSet&lt;/a&gt;. The &lt;code&gt;CpuSet&lt;/code&gt; is just a type alias for a generic &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc/0.3.0/hwloc/struct.Bitmap.html&#34;&gt;Bitmap&lt;/a&gt; which has its bits set according to CPU physical OS indexes.&lt;/p&gt;

&lt;p&gt;You can create a &lt;code&gt;CpuSets&lt;/code&gt; instance too, but in general you will retrieve them through the topology or its objects, then copy/modify it and finally use it for your custom CPU binding. Every bitmap implements the &lt;code&gt;Display&lt;/code&gt; and the &lt;code&gt;Debug&lt;/code&gt; trait (amongst others), so printing their values is often a good idea. The next examples will make heavy use of &lt;code&gt;CpuSets&lt;/code&gt;, so make sure to browse around the API a bit and make yourself familiar with it.&lt;/p&gt;

&lt;h2 id=&#34;process-binding&#34;&gt;Process Binding&lt;/h2&gt;

&lt;p&gt;If your platform supports it as well, &lt;code&gt;hwloc&lt;/code&gt; provides two different ways to bind a process. You can either bind the current process or an arbitrary process identified by its process ID (commonly referred to as &lt;code&gt;pid&lt;/code&gt;).&lt;/p&gt;

&lt;h3 id=&#34;binding-the-current-process&#34;&gt;Binding the Current Process&lt;/h3&gt;

&lt;p&gt;Here is an example which binds the current process to the last core available:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;TopologyObject&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;ObjectType&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;singlify&lt;/span&gt;();

    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Binding before explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Location before explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpu_location&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));

    &lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;set_cpubind&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;) {
        &lt;span style=&#34;color: #A90D91&#34;&gt;Ok&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;_&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Correctly bound to last core&amp;quot;&lt;/span&gt;),
        &lt;span style=&#34;color: #A90D91&#34;&gt;Err&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Failed to bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;)
    }

    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Binding after explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Location after explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpu_location&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));
}

&lt;span style=&#34;color: #C41A16&#34;&gt;/// Helper method to find the last core&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;TopologyObject&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;depth_or_below_for_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_at_depth&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt;);
    &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;last&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;()
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This prints the following on the linux machine:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Cpu Binding before explicit bind: Some(0-3)
Cpu Location before explicit bind: Some(2)
Correctly bound to last core
Cpu Binding after explicit bind: Some(3)
Cpu Location after explicit bind: Some(3)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So let&amp;rsquo;s break it apart a bit. The first thing we need to do is find the &lt;code&gt;CpuSet&lt;/code&gt; for the last core so we have a reference to bind it to. Note that this &lt;code&gt;singlify&lt;/code&gt; call here is useful so that the process does not have a chance of migrating between multiple logical CPUs in the original mask.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;singlify&lt;/span&gt;();

&lt;span style=&#34;color: #177500&#34;&gt;//...&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;TopologyObject&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;depth_or_below_for_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_at_depth&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt;);
    &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;last&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;()
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now that we have our &amp;ldquo;target&amp;rdquo;, we can start binding the current process there. To visualise what&amp;rsquo;s going on, we also print the binding and location for the current process before and after the explicit binding:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Binding before explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));
&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Location before explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpu_location&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));

&lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;set_cpubind&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;) {
    &lt;span style=&#34;color: #A90D91&#34;&gt;Ok&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;_&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Correctly bound to last core&amp;quot;&lt;/span&gt;),
    &lt;span style=&#34;color: #A90D91&#34;&gt;Err&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Failed to bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;)
}

&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Binding after explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));
&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Cpu Location after explicit bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpu_location&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;));
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The current &lt;code&gt;CpuSet&lt;/code&gt; of the process (which you can retrieve through &lt;code&gt;get_cpubind(CPUBIND_PROCESS)&lt;/code&gt;) contains all possibles cores where the operating system might dispatch the process on. In our case it prints &lt;code&gt;0-3&lt;/code&gt; which means all four cores are possible. The call to &lt;code&gt;get_cpu_location()&lt;/code&gt; gives us the current core location, but this can change between subsequent calls as the operating system moves the process around.&lt;/p&gt;

&lt;p&gt;Finally we override the current binding with our custom one (the new &lt;code&gt;CpuSet&lt;/code&gt; only contains the last core rather than all four) and apply some simple matching to make sure the binding didn&amp;rsquo;t fail for some reason. The last &lt;code&gt;println!&lt;/code&gt; calls are just there to visually validate the new binding.&lt;/p&gt;

&lt;h3 id=&#34;binding-an-arbitrary-process&#34;&gt;Binding an Arbitrary Process&lt;/h3&gt;

&lt;p&gt;Binding any process works very similar to binding the current process, but there is one difference - we need to find the &lt;code&gt;pid&lt;/code&gt; of the process we want to bind. This is a little out of scope for this blog post, but since our own process also has a &lt;code&gt;pid&lt;/code&gt; we can use that one for our examples. Unfortunately we need a little bit of unsafe &lt;code&gt;libc&lt;/code&gt; magic there:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;libc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
  &lt;span style=&#34;color: #177500&#34;&gt;//...&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;unsafe&lt;/span&gt; { &lt;span style=&#34;color: #000000&#34;&gt;libc::getpid&lt;/span&gt;() };
  &lt;span style=&#34;color: #177500&#34;&gt;//...&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Once we have our pid, we will reuse the code from the last example to get the last core where we want to bind the process to:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
  &lt;span style=&#34;color: #177500&#34;&gt;//...&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
  &lt;span style=&#34;color: #177500&#34;&gt;//...&lt;/span&gt;
}

&lt;span style=&#34;color: #C41A16&#34;&gt;/// Find the last core&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;TopologyObject&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;depth_or_below_for_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_at_depth&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt;);
    &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;last&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;()
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now we can use the same methods as previously, but with the &lt;code&gt;for_process()&lt;/code&gt; suffix. Here is the full example, again with some debug print statements to visualise what&amp;rsquo;s going on:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;
&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;libc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;TopologyObject&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;ObjectType&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;unsafe&lt;/span&gt; { &lt;span style=&#34;color: #000000&#34;&gt;libc::getpid&lt;/span&gt;() };
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Binding Process with PID {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt;);

    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;singlify&lt;/span&gt;();

    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Before Bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind_for_process&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;());
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Last Known CPU Location: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpu_location_for_process&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;());

    &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;set_cpubind_for_process&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();

    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;After Bind: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind_for_process&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;());
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Last Known CPU Location: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpu_location_for_process&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;pid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_PROCESS&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;());
}

&lt;span style=&#34;color: #C41A16&#34;&gt;/// Find the last core&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;last_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;TopologyObject&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;depth_or_below_for_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_at_depth&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;core_depth&lt;/span&gt;);
    &lt;span style=&#34;color: #000000&#34;&gt;all_cores&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;last&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;()
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If we run this on our linux box, this is the output:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Binding Process with PID 3034
Before Bind: 0-3
Last Known CPU Location: 3
After Bind: 3
Last Known CPU Location: 3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So as long as you have the process ID available and the operating system supports it, you can bind every process to any number of cores you want. This is especially helpful if you need to bind forked processes or if you need to write some kind of babysitter service that needs to keep track and orchestrate a number of processes.&lt;/p&gt;

&lt;h2 id=&#34;thread-binding&#34;&gt;Thread Binding&lt;/h2&gt;

&lt;p&gt;In addition to bind the process as a whole, it is also possible to pin individual threads inside a process to cores. Every thread has a unique thread ID (&lt;code&gt;tid&lt;/code&gt;) which is used to bind a thread to a core.&lt;/p&gt;

&lt;p&gt;The following example will spawn one thread for each core in the system and then bind each thread to one of the cores. Here is the full code in its beauty, we&amp;rsquo;ll break it apart afterwards:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;
&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;libc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;ObjectType&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CpuSet&lt;/span&gt;};
&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;std::thread&lt;/span&gt;;
&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;std::sync::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Arc&lt;/span&gt;,&lt;span style=&#34;color: #000000&#34;&gt;Mutex&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Arc::new&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;Mutex::new&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;()));

    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;num_cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; {
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo_rc&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;clone&lt;/span&gt;();
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo_locked&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo_rc&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;lock&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
        (&lt;span style=&#34;color: #000000&#34;&gt;*topo_locked&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;()
    };
    &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Found {} cores.&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;num_cores&lt;/span&gt;);

    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;handles:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Vec&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;_&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;..&lt;span style=&#34;color: #000000&#34;&gt;num_cores&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;map&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;|i|&lt;/span&gt; {
            &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;child_topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;clone&lt;/span&gt;();
            &lt;span style=&#34;color: #000000&#34;&gt;thread::spawn&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;move&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; {
                &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;unsafe&lt;/span&gt; { &lt;span style=&#34;color: #000000&#34;&gt;libc::pthread_self&lt;/span&gt;() };
                &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;child_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;lock&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();

                &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;before&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind_for_thread&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;);

                &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bind_to&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset_for_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;*locked_topo&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;);

                &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;set_cpubind_for_thread&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;bind_to&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();

                &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;after&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind_for_thread&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;);

                &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Thread {}: Before {:?}, After {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;before&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;after&lt;/span&gt;);
            })
        }).&lt;span style=&#34;color: #000000&#34;&gt;collect&lt;/span&gt;();

        &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;h&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;handles&lt;/span&gt; {
            &lt;span style=&#34;color: #000000&#34;&gt;h&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;join&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
        }
}

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset_for_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topology:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;idx:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CpuSet&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;*topology&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;idx&lt;/span&gt;) {
        &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;val&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;val&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;cpuset&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;(),
        &lt;span style=&#34;color: #A90D91&#34;&gt;None&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;panic!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;No Core found with id {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;idx&lt;/span&gt;)
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Before the binding we need to identify the number of cores - that&amp;rsquo;s an easy task for &lt;code&gt;hwloc&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;num_cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo_rc&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;clone&lt;/span&gt;();
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo_locked&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo_rc&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;lock&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    (&lt;span style=&#34;color: #000000&#34;&gt;*topo_locked&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;()
};
&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Found {} cores.&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;num_cores&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The code finds all cores through &lt;code&gt;objects_with_type(&amp;amp;ObjectType::Core)&lt;/code&gt; and counts them. Note that we need to do use proper rust synchronization mechanisms around our &lt;code&gt;Topology&lt;/code&gt; since we are accessing it from multiple threads in the code.&lt;/p&gt;

&lt;p&gt;The next piece spawns one thread for each core and joins on the main thread to wait until they complete:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;handles:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Vec&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;_&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;..&lt;span style=&#34;color: #000000&#34;&gt;num_cores&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;map&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;|i|&lt;/span&gt; {
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;child_topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;clone&lt;/span&gt;();
        &lt;span style=&#34;color: #000000&#34;&gt;thread::spawn&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;move&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; {
            &lt;span style=&#34;color: #177500&#34;&gt;// do our other stuff&lt;/span&gt;
        })
    }).&lt;span style=&#34;color: #000000&#34;&gt;collect&lt;/span&gt;();

    &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;h&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;handles&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;h&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;join&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
    }
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next up we load the current thread ID through some &lt;code&gt;libc&lt;/code&gt; unsafe magic, lock the &lt;code&gt;Topology&lt;/code&gt; for safety and then read the current &lt;code&gt;CpuSet&lt;/code&gt; for the thread (to print it out later):&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;unsafe&lt;/span&gt; { &lt;span style=&#34;color: #000000&#34;&gt;libc::pthread_self&lt;/span&gt;() };
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;child_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;lock&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();

&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;before&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind_for_thread&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The next part is important:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bind_to&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cpuset_for_core&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;*locked_topo&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;);

&lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;set_cpubind_for_thread&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;bind_to&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;();
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The helper function &lt;code&gt;cpuset_for_core&lt;/code&gt; accepts an integer which represents the thread number (not the &lt;code&gt;tid&lt;/code&gt;) and loops through the cores available on the &lt;code&gt;Topology&lt;/code&gt;. It then returns the right &lt;code&gt;CpuSet&lt;/code&gt; for the given index, so the first thread will be pinned to Core 0, the second one to Core 1 and so forth. Then, we use the &lt;code&gt;set_cpubind_for_thread()&lt;/code&gt; method to bass in the current thread id as well as the &lt;code&gt;CpuSet&lt;/code&gt; to apply and the &lt;code&gt;CPUBIND_THREAD&lt;/code&gt; identifier which is needed.&lt;/p&gt;

&lt;p&gt;Finally we just collect the new binding and then print it out for visualisation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;after&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;locked_topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;get_cpubind_for_thread&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;tid&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;CPUBIND_THREAD&lt;/span&gt;);

&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Thread {}: Before {:?}, After {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;before&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;after&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Running this on our 4-core machine prints:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Found 4 cores.
Thread 0: Before Some(0-3), After Some(0)
Thread 1: Before Some(0-3), After Some(1)
Thread 2: Before Some(0-3), After Some(2)
Thread 3: Before Some(0-3), After Some(3)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Which processes or threads to bind is purely an application concern, but the underlying mechanics are greatly simplified through the &lt;code&gt;hwloc&lt;/code&gt; abstractions. Combining the topology discovery with the CPU binding support allows you to choose the most optimised deployment option at runtime and giving you reasonable fallback options if the most performant way is not supported on the target.&lt;/p&gt;

&lt;p&gt;Looking ahead, the rust binding is pretty much complete on discovery and CPU binding (modulo some advanced APIs that are yet to come), but the big piece missing is memory binding. Since rust itself pretty much abstracts the whole memory management story, it&amp;rsquo;s not as easy as exposing the custom memory allocation functions of &lt;code&gt;hwloc&lt;/code&gt;. I&amp;rsquo;m currently trying to wrap my head around good abstractions for this, so every input is very much appreciated! Please also let me know of any bugs you find or enhancements/clarifications you&amp;rsquo;d like to see in the rust binding.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Discovering Hardware Topology in Rust</title>
      <link>http://nitschinger.at/Discovering-Hardware-Topology-in-Rust/</link>
      <pubDate>Fri, 08 Jan 2016 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Discovering-Hardware-Topology-in-Rust/</guid>
      <description>

&lt;p&gt;Todays programming languages and operation systems provide a bunch of abstraction layers over our hardware. Most of the time this is great, since we can write code quickly and make it run on lots of different machines. The opportunity cost with abstraction is (most of the time) performance and a lack of understanding.&lt;/p&gt;

&lt;p&gt;To get the best performance out of hour hardware, it is important to understand it. Concepts like cache locality matter a lot, especially in modern NUMA architectures. Modern hardware is complex, so understanding it is not easy - and making matters worse its even harder to take advantage of this in our software stacks. For example binding threads or processes to specific cores is different in every operating system, some don&amp;rsquo;t even support it.&lt;/p&gt;

&lt;p&gt;One library which helps with hardware topology discovery and management is &lt;a href=&#34;https://www.open-mpi.org/projects/hwloc/&#34;&gt;hwloc&lt;/a&gt;. The description on the website gives a nice overview:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;The Portable Hardware Locality (hwloc) software package provides a portable abstraction (across OS, versions,
architectures,&amp;hellip;) of the hierarchical topology of modern architectures, including NUMA memory nodes, sockets, shared
caches, cores and simultaneous multithreading. It also gathers various system attributes such as cache and memory
information as well as the locality of I/O devices such as network interfaces, InfiniBand HCAs or GPUs. It primarily aims
at helping applications with gathering information about modern computing hardware so as to exploit it accordingly and
efficiently.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;As a side project I&amp;rsquo;m working on a &lt;a href=&#34;https://github.com/daschl/hwloc-rs&#34;&gt;Rust Binding for hwloc&lt;/a&gt; which you&amp;rsquo;ll get to see in this blogpost. It already supports topology discovery and CPU binding, but only the discovery bit will be covered in this post.&lt;/p&gt;

&lt;p&gt;I assume that you have basic rust skills, if not you want to check out &lt;a href=&#34;https://doc.rust-lang.org/stable/book/&#34;&gt;the book&lt;/a&gt; first. All the examples shown here should work on Linux and OSX, I never tested rust binding on windows (hwloc itself supports windows). If you want to help out adding support for it, that would be awesome!&lt;/p&gt;

&lt;h2 id=&#34;setup&#34;&gt;Setup&lt;/h2&gt;

&lt;p&gt;You need to have rust (for example 1.5.0) installed, as well as the &lt;code&gt;hwloc&lt;/code&gt; C library. Please refer to the &lt;a href=&#34;https://github.com/daschl/hwloc-rs#install-hwloc-on-os-x&#34;&gt;README&lt;/a&gt; for detailed instructions on how to install it. On linux, most of the time you can find recent packages in your package manager, on OSX you want to install it from source. For example, here is all you need to do on OSX:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.open-mpi.org/software/hwloc/v1.11/downloads/hwloc-1.11.2.tar.gz&#34;&gt;Download&lt;/a&gt; the artifact.&lt;/li&gt;
&lt;li&gt;tar -xvzpf hwloc-1.11.2.tar.gz&lt;/li&gt;
&lt;li&gt;cd hwloc-1.11.2&lt;/li&gt;
&lt;li&gt;./configure &amp;amp;&amp;amp; make &amp;amp;&amp;amp; sudo make install&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The next step is to create a rust project which will be runnable from the command line:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;~/rust $ cargo new hwloc-playground --bin
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Go modify your &lt;code&gt;Cargo.toml&lt;/code&gt; and add &lt;code&gt;hwloc&lt;/code&gt; as a dependency:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[dependencies]
hwloc = &amp;quot;0.2.0&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Execute &lt;code&gt;cargo run&lt;/code&gt; to make sure the dependency compiles correctly before we move on:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;~/rust/hwloc-playground $ cargo run
   Compiling winapi-build v0.1.1
   Compiling libc v0.2.4
   Compiling rustc-serialize v0.3.16
   Compiling bitflags v0.3.3
   Compiling pkg-config v0.3.6
   Compiling winapi v0.2.5
   Compiling advapi32-sys v0.1.2
   Compiling kernel32-sys v0.2.1
   Compiling rand v0.3.12
   Compiling errno v0.1.5
   Compiling hwloc v0.2.0
   Compiling num v0.1.29
   Compiling hwloc-playground v0.1.0 (file:///Users/michael/rust/hwloc-playground)
     Running `target/debug/hwloc-playground`
Hello, world!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;hwloc-rs&lt;/code&gt; also provides rustdoc which you can find &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc&#34;&gt;here&lt;/a&gt; for the different versions.&lt;/p&gt;

&lt;h3 id=&#34;cores-and-processing-units&#34;&gt;Cores and Processing Units&lt;/h3&gt;

&lt;p&gt;As a first simple example, we&amp;rsquo;ll find out how many physical cores we have on the machine. This introduces some basic concepts of &lt;code&gt;hwloc&lt;/code&gt;. The full code sample looks like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;ObjectType&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #177500&#34;&gt;// Create a new Topology&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #177500&#34;&gt;// Get all objects with type &amp;quot;Core&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;);

    &lt;span style=&#34;color: #177500&#34;&gt;// Match on the returned Result and print the length if successful.&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; {
        &lt;span style=&#34;color: #A90D91&#34;&gt;Ok&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;There are {} cores on this machine.&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;()),
        &lt;span style=&#34;color: #A90D91&#34;&gt;Err&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;panic!&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;format!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Could not load cores because of: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;))
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Let&amp;rsquo;s break the code apart a bit. The first thing you always need to do is create a &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc/0.2.0/hwloc/struct.Topology.html&#34;&gt;Topology&lt;/a&gt;. The &lt;code&gt;Topology&lt;/code&gt; is your logical representation of the actual mapped hardware.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now that we have the &lt;code&gt;Topology&lt;/code&gt;, we can ask it to return all &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc/0.2.0/hwloc/struct.TopologyObject.html&#34;&gt;TopologyObjects&lt;/a&gt; with a specific &lt;a href=&#34;http://nitschinger.at/hwloc-rs/rustdoc/0.2.0/hwloc/enum.ObjectType.html&#34;&gt;ObjectType&lt;/a&gt;. One type is &lt;code&gt;Core&lt;/code&gt; which maps to a computation unit on the physical hardware (most of the time a CPU Core).&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::Core&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Since not every ObjectType is available on every hardware, it might not be possible to figure out the actual objects. Because of this, the &lt;code&gt;objects_with_type&lt;/code&gt; method returns a &lt;code&gt;Result&amp;lt;Vec&amp;lt;&amp;amp;TopologyObject&amp;gt;, TypeDepthError&amp;gt;&lt;/code&gt;. We can now utilize pattern matching to distinguish between success and error, and if it is successful print out the length of the &lt;a href=&#34;https://doc.rust-lang.org/std/vec/struct.Vec.html#method.len&#34;&gt;Vector&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;Ok&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;There are {} cores on this machine.&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;()),
    &lt;span style=&#34;color: #A90D91&#34;&gt;Err&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;panic!&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;format!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Could not load cores because of: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;))
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If you run the code you should see an output like this (My machine is equipped with an i7 quadcore):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;~/rust/hwloc-playground $ cargo run
   Compiling hwloc-playground v0.1.0 (file:///Users/michael/rust/hwloc-playground)
     Running `target/debug/hwloc-playground`
There are 4 cores on this machine.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hwloc allows you to differentiate between cores and actual processing units. For example if your CPU has hyperthreading enabled, you&amp;rsquo;ll end up with more logical processing units than physical cores. Let&amp;rsquo;s modify the code to print the number of logical processing units instead:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #177500&#34;&gt;// Get all objects with type &amp;quot;PU&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::PU&lt;/span&gt;);

&lt;span style=&#34;color: #177500&#34;&gt;// Match on the returned Result and print the length if successful.&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;match&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cores&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;Ok&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;There are {} processing units on this machine.&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;c&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;len&lt;/span&gt;()),
    &lt;span style=&#34;color: #A90D91&#34;&gt;Err&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;panic!&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;format!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Could not load processing units because of: {:?}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;e&lt;/span&gt;))
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;My i7 indeed has hyperthreading enabled, so this prints:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;~/rust/hwloc-playground $ cargo run
   Compiling hwloc-playground v0.1.0 (file:///Users/michael/rust/hwloc-playground)
     Running `target/debug/hwloc-playground`
There are 8 processing units on this machine.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The library also allows us to walk the topology in tree form, so the logical processing units (&amp;ldquo;PU&amp;rdquo;) are &amp;ldquo;below&amp;rdquo; the actual cores. If we want to determine how many PUs every core has, we can print that as well:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;ObjectType&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #177500&#34;&gt;// Create a new Topology&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #177500&#34;&gt;// Get all objects with type &amp;quot;PU&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pus&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::PU&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;ok&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;expect&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Could not load PUs!&amp;quot;&lt;/span&gt;);

    &lt;span style=&#34;color: #177500&#34;&gt;// Iterate through each PU&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;pus&lt;/span&gt; {
        &lt;span style=&#34;color: #177500&#34;&gt;// Print the PU&amp;#39;s logical index.&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;print!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;PU #{} is on Core &amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;logical_index&lt;/span&gt;());

        &lt;span style=&#34;color: #177500&#34;&gt;// Walk up the parent chain until the Core is found and print its id.&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt;();
        &lt;span style=&#34;color: #A90D91&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; {
            &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;object_type&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ObjectType::Core&lt;/span&gt; {
                &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;{}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;logical_index&lt;/span&gt;());
                &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;None&lt;/span&gt;;
            } &lt;span style=&#34;color: #A90D91&#34;&gt;else&lt;/span&gt; {
                &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt;();
            }
        }
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;First, we load all the processing units:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pus&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::PU&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;ok&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;expect&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Could not load PUs!&amp;quot;&lt;/span&gt;);
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next up, we iterate through each unit and print its logical index:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #177500&#34;&gt;// Iterate through each PU&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;pus&lt;/span&gt; {
    &lt;span style=&#34;color: #177500&#34;&gt;// Print the PU&amp;#39;s logical index.&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;print!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;PU #{} is on Core &amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;logical_index&lt;/span&gt;());

    &lt;span style=&#34;color: #177500&#34;&gt;// ...&lt;/span&gt;
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Finally, we can walk up the tree of parents for each unit until we arrive at the Core level and print out its logical index as well. Notice how easy the walking is with the &lt;code&gt;while let&lt;/code&gt; construct. This works because &lt;code&gt;TopologyObject#parent()&lt;/code&gt; returns an &lt;code&gt;Option&amp;lt;&amp;amp;TopologyOption&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #177500&#34;&gt;// Walk up the parent chain until the Core is found and print its id.&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt;();
&lt;span style=&#34;color: #A90D91&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; {
    &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;object_type&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ObjectType::Core&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;{}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;logical_index&lt;/span&gt;());
        &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;None&lt;/span&gt;;
    } &lt;span style=&#34;color: #A90D91&#34;&gt;else&lt;/span&gt; {
        &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt;();
    }
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;On my machine this prints:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; ~/rust/hwloc-playground $ cargo run
   Compiling hwloc-playground v0.1.0 (file:///Users/michael/rust/hwloc-playground)
     Running `target/debug/hwloc-playground`
PU #0 is on Core 0
PU #1 is on Core 0
PU #2 is on Core 1
PU #3 is on Core 1
PU #4 is on Core 2
PU #5 is on Core 2
PU #6 is on Core 3
PU #7 is on Core 3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can see that each Core has two PUs attached to it.&lt;/p&gt;

&lt;h2 id=&#34;walking-the-tree&#34;&gt;Walking The Tree&lt;/h2&gt;

&lt;p&gt;If you want to understand the topology as a whole, you can walk it in two ways: either level by level (by depth) or in tree form. Here is a full example to walk it by level:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::Topology&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #177500&#34;&gt;// Create a new Topology&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #177500&#34;&gt;// Loop through the complete topology depth.&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;..&lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;depth&lt;/span&gt;() {
		&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;*** Objects at level {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;);

        &lt;span style=&#34;color: #177500&#34;&gt;// Print each object at each level.&lt;/span&gt;
		&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;idx&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;object&lt;/span&gt;) &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topology&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_at_depth&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;iter&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;enumerate&lt;/span&gt;() {
			&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;{}: {}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;idx&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;object&lt;/span&gt;);
		}
	}
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The code iterates through each level until the final topology depth is reached and on each level it prints all the TopologyObjects. This is the result on my machine:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;*** Objects at level 0
0: Machine ()
*** Objects at level 1
0: NUMANode16GB (16GB)
*** Objects at level 2
0: L3 (6144KB)
*** Objects at level 3
0: L2 (256KB)
1: L2 (256KB)
2: L2 (256KB)
3: L2 (256KB)
*** Objects at level 4
0: L1d (32KB)
1: L1d (32KB)
2: L1d (32KB)
3: L1d (32KB)
*** Objects at level 5
0: Core ()
1: Core ()
2: Core ()
3: Core ()
*** Objects at level 6
0: PU ()
1: PU ()
2: PU ()
3: PU ()
4: PU ()
5: PU ()
6: PU ()
7: PU ()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here you can see new ObjectTypes in action. My machine has one NUMANode with 16GB of RAM. Then you can see the L3, L2 and L1 caches, as well as the individual Cores and logical processing units.&lt;/p&gt;

&lt;p&gt;A different way to visualize it is through a tree representation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;TopologyObject&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #177500&#34;&gt;// Create a new Topology&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #177500&#34;&gt;// Print the tree and start at the root&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;*** Printing overall tree&amp;quot;&lt;/span&gt;);
	&lt;span style=&#34;color: #000000&#34;&gt;print_children&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;topo&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;object_at_root&lt;/span&gt;(), &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;);
}

&lt;span style=&#34;color: #177500&#34;&gt;// Print children recursively&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;print_children&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;obj:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;TopologyObject&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;depth:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;) {
    &lt;span style=&#34;color: #177500&#34;&gt;// some padding for the tree print&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;padding&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;std::iter::repeat&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot; &amp;quot;&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;take&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;depth&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;collect::&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;String&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt;();
	&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;{}{}: #{}&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;padding&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;obj&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;obj&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;os_index&lt;/span&gt;());

	&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;..&lt;span style=&#34;color: #000000&#34;&gt;obj&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;arity&lt;/span&gt;() {
		&lt;span style=&#34;color: #000000&#34;&gt;print_children&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;obj&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;children&lt;/span&gt;()[&lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;as&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;], &lt;span style=&#34;color: #000000&#34;&gt;depth&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;);
	}
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We define a method called &lt;code&gt;print_children&lt;/code&gt; which is called recursively:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;print_children&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;topo:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;obj:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;TopologyObject&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;depth:&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;usize&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note the funky padding variable is just there to create a left-padding for the tree view:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;padding&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;std::iter::repeat&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot; &amp;quot;&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;take&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;depth&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;collect::&amp;lt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;String&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt;();
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Running the code above gives the same information but in a different style:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;~/rust/hwloc-playground&lt;/span&gt; &lt;span style=&#34;color: #633820&#34;&gt;$&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;cargo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;run&lt;/span&gt;
   &lt;span style=&#34;color: #000000&#34;&gt;Compiling&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc-playground&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;v0&lt;/span&gt;.&lt;span style=&#34;color: #1C01CE&#34;&gt;1.0&lt;/span&gt; (&lt;span style=&#34;color: #000000&#34;&gt;file:&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;///Users/michael/rust/hwloc-playground)&lt;/span&gt;
     &lt;span style=&#34;color: #000000&#34;&gt;Running&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;`target/debug/hwloc-playground`&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;***&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Printing&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;overall&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;tree&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;Machine&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
 &lt;span style=&#34;color: #000000&#34;&gt;NUMANode16GB&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;16&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;GB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;L3&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;6144&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
   &lt;span style=&#34;color: #000000&#34;&gt;L2&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;256&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;L1d&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;32&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
     &lt;span style=&#34;color: #000000&#34;&gt;Core&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;
   &lt;span style=&#34;color: #000000&#34;&gt;L2&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;256&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;L1d&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;32&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;
     &lt;span style=&#34;color: #000000&#34;&gt;Core&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;
   &lt;span style=&#34;color: #000000&#34;&gt;L2&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;256&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;L1d&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;32&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;
     &lt;span style=&#34;color: #000000&#34;&gt;Core&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;4&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;5&lt;/span&gt;
   &lt;span style=&#34;color: #000000&#34;&gt;L2&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;256&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;L1d&lt;/span&gt; (&lt;span style=&#34;color: #1C01CE&#34;&gt;32&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;KB&lt;/span&gt;)&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;
     &lt;span style=&#34;color: #000000&#34;&gt;Core&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;6&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;PU&lt;/span&gt; ()&lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;#&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;What you can spot here immediately is that each core has its own L2 cache (as well as a L1 data cache) while at the same time they all share the same L3 cache.&lt;/p&gt;

&lt;h2 id=&#34;cpu-caches&#34;&gt;CPU Caches&lt;/h2&gt;

&lt;p&gt;Speaking of caches, it is often quite helpful to know how much memory and cache is available to each core/processing unit. This can be used to aid cpu and memory binding decisions which are concerned with data locality.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s say we want to know how much cache our first logical processing unit has available:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;extern&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;crate&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc&lt;/span&gt;;

&lt;span style=&#34;color: #A90D91&#34;&gt;use&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hwloc::&lt;/span&gt;{&lt;span style=&#34;color: #000000&#34;&gt;Topology&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;ObjectType&lt;/span&gt;};

&lt;span style=&#34;color: #A90D91&#34;&gt;fn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main&lt;/span&gt;() {
    &lt;span style=&#34;color: #177500&#34;&gt;// Create a new Topology&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Topology::new&lt;/span&gt;();

    &lt;span style=&#34;color: #177500&#34;&gt;// Get the first Logical Processing Unit&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;topo&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;objects_with_type&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;&amp;amp;ObjectType::PU&lt;/span&gt;).&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;()[&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;];

	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;pu&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt;();
	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;levels&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;;
	&lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;mut&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;;

    &lt;span style=&#34;color: #177500&#34;&gt;// Walk up the parents and if it is a cache, add up its capacity&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;Some&lt;/span&gt;(&lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;) &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; {
		&lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;object_type&lt;/span&gt;() &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ObjectType::Cache&lt;/span&gt; {
			&lt;span style=&#34;color: #000000&#34;&gt;levels&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;;
			&lt;span style=&#34;color: #000000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;cache_attributes&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;unwrap&lt;/span&gt;().&lt;span style=&#34;color: #000000&#34;&gt;size&lt;/span&gt;;
		}
		&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;p&lt;/span&gt;.&lt;span style=&#34;color: #000000&#34;&gt;parent&lt;/span&gt;();
	}

    &lt;span style=&#34;color: #177500&#34;&gt;// Print out the result&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;println!&lt;/span&gt;(&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;*** Logical processor 0 has {} caches totalling {} KB&amp;quot;&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;levels&lt;/span&gt;, &lt;span style=&#34;color: #000000&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1024&lt;/span&gt;);
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We are using a similar technique as in the examples above, but this time we just add up all the capacity for each cache and then print it out.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; ~/rust/hwloc-playground $ cargo run
     Running `target/debug/hwloc-playground`
*** Logical processor 0 has 3 caches totalling 6432 KB
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This output is not surprising given we have seen the topology before:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;...
  L3 (6144KB): #0
   L2 (256KB): #0
    L1d (32KB): #0
     Core (): #0
      PU (): #0 &amp;lt;----
      PU (): #1
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For a quick crosscheck, this is what OSX shows in its &lt;code&gt;System Report&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Processor Name:	Intel Core i7
Processor Speed:	2,3 GHz
Number of Processors:	1
Total Number of Cores:	4
L2 Cache (per Core):	256 KB
L3 Cache:	6 MB
Memory:	16 GB
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Hwloc and the rust binding provide a very convenient way to identify hardware topology characteristics. While hwloc has much more to offer, this post should have given you an easy introduction and should motivate you discovering your own topologies. In a followup post I&amp;rsquo;ll show you how you can utilize the binding API to perform CPU binding if your OS supports it.&lt;/p&gt;

&lt;p&gt;The rust binding is still in the works and I appreciate all kinds of input. Bug reports, API enhancements or just questions in general are more than welcome!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Debugging Concurrency Issues with OpenJDK Jcstress</title>
      <link>http://nitschinger.at/Debugging-Concurrency-Issues-with-Open-JDK-Jcstress/</link>
      <pubDate>Tue, 27 May 2014 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Debugging-Concurrency-Issues-with-Open-JDK-Jcstress/</guid>
      <description>

&lt;p&gt;I fell in love with the Java Microbenchmarking Harness (&lt;a href=&#34;http://openjdk.java.net/projects/code-tools/jmh/&#34;&gt;JMH&lt;/a&gt;) a few months ago since (in my opinion) it is the only sane way to do microbenchmarks of JVM code right now. I also poked around on their website for other tools they provide, and found that there is another very interesting tool called &lt;a href=&#34;http://openjdk.java.net/projects/code-tools/jcstress/&#34;&gt;jcstress&lt;/a&gt;. It stands for Java Concurrency Stress tests and is used mainly by the OpenJDK people itself to make sure their code works correctly with regards to concurrency.&lt;/p&gt;

&lt;p&gt;As always, you need a motivating factor so today &lt;a href=&#34;https://www.couchbase.com/issues/browse/SPY-170&#34;&gt;a ticket&lt;/a&gt; got opened which reported a race condition inside a utility class in the &lt;a href=&#34;https://code.google.com/p/spymemcached/&#34;&gt;spymemcached&lt;/a&gt; library (which is also used by the Couchbase Java SDK). Before coming up with complicated code that simulates multi-threaded consumers of the API I thought I could just try out &lt;code&gt;jcstress&lt;/code&gt; first.&lt;/p&gt;

&lt;p&gt;TL;DR: I managed to find, fix and verify the concurrency issue. If you want to learn how, read along.&lt;/p&gt;

&lt;p&gt;A short disclaimer: as you can guess, I&amp;rsquo;m far away from an expert on the &lt;code&gt;jcstress&lt;/code&gt; library and there could be information provided here that is plain wrong. The intent of this post is to show you how to set up &lt;code&gt;jcstress&lt;/code&gt; and run your code against it. Also, I&amp;rsquo;d like to thank &lt;a href=&#34;https://twitter.com/shipilev&#34;&gt;Aleksey Shipilv&lt;/a&gt; to help me verify/improve the test and look over it. He also told me that &lt;code&gt;jcstress&lt;/code&gt; is not (yet) ready for a broad public consumption, so your mileage may vary.&lt;/p&gt;

&lt;h1 id=&#34;setup&#34;&gt;Setup&lt;/h1&gt;

&lt;p&gt;As &lt;a href=&#34;http://openjdk.java.net/projects/code-tools/jcstress/&#34;&gt;described&lt;/a&gt; on the website, you need to clone the repository and build the whole thing. Also, make sure to have Java 8 installed for compiling it (I think running with older versions afterwards works).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ hg clone http://hg.openjdk.java.net/code-tools/jcstress/ jcstress
$ cd jcstress/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, go import the maven project in your favorite IDE (&lt;a href=&#34;http://www.jetbrains.com/idea/&#34;&gt;IntelliJ, what else?&lt;/a&gt;). We need to add our own code and tests so that it can be picked up later. You can either add your code under test as a dependency into the &lt;code&gt;pom.xml&lt;/code&gt; file or just copy it over to the project if it is self contained (so it&amp;rsquo;s easier to play and poke around). If you want to follow along, add the &lt;code&gt;StringUtils.java&lt;/code&gt; and the &lt;code&gt;StringUtilsTest.java&lt;/code&gt; files to the &lt;code&gt;com.couchbase.client.tests.util&lt;/code&gt; package:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;com.couchbase.client.tests.util;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;java.util.regex.Matcher;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;java.util.regex.Pattern;&lt;/span&gt;

&lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt; * Utility methods on string objects.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt; */&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;StringUtils&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * A pattern to match on a signed integer value.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Pattern&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;decimalPattern&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Pattern.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;compile&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;^-?\\d+$&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * The matcher for the decimal pattern regex.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Matcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;decimalMatcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;decimalPattern.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;matcher&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * Maximum supported key length.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MAX_KEY_LENGTH&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;250&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * Exception thrown if the input key is too long.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;KEY_TOO_LONG_EXCEPTION&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Key is too long (maxlen = &amp;quot;&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MAX_KEY_LENGTH&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;)&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * Exception thrown if the input key is empty.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;KEY_EMPTY_EXCEPTION&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Key must contain at least one character.&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * Preset the stack traces for the static exceptions.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;KEY_TOO_LONG_EXCEPTION.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;setStackTrace&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;StackTraceElement[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;]);&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;KEY_EMPTY_EXCEPTION.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;setStackTrace&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;StackTraceElement[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;]);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * Private constructor, since this is a purely static class.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;StringUtils()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;UnsupportedOperationException();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * Check if a given string is a JSON object.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     *&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * @param s the input string.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     * @return true if it is a JSON object, false otherwise.&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;     */&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;isJsonObject(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(s&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;null&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;isEmpty&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(s.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;startsWith&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;{&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;s.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;startsWith&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;[&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;true&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;equals&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(s)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;false&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;equals&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(s)&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;null&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;equals&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(s)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;decimalMatcher.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;reset&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(s).&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;matches&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

        &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And the test:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;com.couchbase.client.tests.util;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jcstress.annotations.Actor;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jcstress.annotations.JCStressTest;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jcstress.annotations.State;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jcstress.infra.results.IntResult2;&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;@JCStressTest&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;@State&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;StringUtilsTest&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;@Actor&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;actor1(IntResult2&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;result)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;result.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;r1&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;isJsonObject&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;1234&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;?&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;catch&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(Exception&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ex)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;result.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;r1&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;@Actor&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;actor2(IntResult2&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;result)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;result.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;r2&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;isJsonObject&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;5678&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;?&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;catch&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(Exception&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ex)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #000000&#34;&gt;result.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;r2&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The test uses &lt;code&gt;@Actor&lt;/code&gt; annotations to define the different actors of the system. You can see that both actors access the same static method and put the result (which is abbreviated to a simple true (1) / false (0) pattern) in the &lt;code&gt;IntResult2&lt;/code&gt; object. Both actors share their results and if an exception
is raised we store -1. Now what is that good for?&lt;/p&gt;

&lt;p&gt;We also need to add a description file for our test which sets the expecations on allowed and disallowed value combinations. Note that I tried to add my own .xml file, but somehow it didn&amp;rsquo;t get picked up, so I modified an existing xml (to be specific the &lt;code&gt;resources/org/openjdk/jcstress/desc/atomic-boolean.xml&lt;/code&gt;) and added the following:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;test&lt;/span&gt; &lt;span style=&#34;color: #836C28&#34;&gt;name=&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;com.couchbase.client.tests.util.StringUtilsTest&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;contributed-by&amp;gt;&lt;/span&gt;Michael Nitschinger&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/contributed-by&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;description&amp;gt;&lt;/span&gt;
        Tests the thread-safeness of the StringUtil class.
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/description&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;case&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;match&amp;gt;&lt;/span&gt;[1, 1]&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/match&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;expect&amp;gt;&lt;/span&gt;ACCEPTABLE&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/expect&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;description&amp;gt;&lt;/span&gt;
            Acceptable to see true.
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/description&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/case&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;unmatched&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;expect&amp;gt;&lt;/span&gt;FORBIDDEN&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/expect&amp;gt;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;description&amp;gt;&lt;/span&gt;
            Other cases are not expected. -1 would mean an exception raised.
        &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/description&amp;gt;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/unmatched&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/test&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You can see that the only thing which is acceptable is that both actors always get &lt;code&gt;true&lt;/code&gt; returned, all other combinations are simply forbidden (that is, marked as failure).&lt;/p&gt;

&lt;p&gt;Now that we&amp;rsquo;ve got that set up, we need to compile the thing on the command line through maven:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mvn clean install -pl tests-custom -am
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finally, we run the shaded jar and give it a regex so that only our own test gets picked up:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ java -jar tests-custom/target/jcstress.jar -t &amp;quot;.*StringUtils.*&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The resulting output is as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Java Concurrency Stress Tests
---------------------------------------------------------------------------------
Rev: a119fb6622e3+, built by michael with 1.8.0_05 at 20140527-1040

Burning up to figure out the exact CPU count....... done!

Non-fatal: VM support for online deoptimization is not enabled, tests might miss some issues.
Possible reasons are:
  1) unsupported JDK, only JDK 8+ is supported;
  2) -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI are missing;
  3) the jcstress JAR is not added to -Xbootclasspath/a

Non-fatal: VM support for @Contended is not enabled, tests might run slower.
Possible reasons are:
  1) unsupported JDK, only JDK 8+ is supported;
  2) -XX:-RestrictContended is missing, or the jcstress JAR is not added to -Xbootclasspath/a

FORKED MODE
  Test preset mode: &amp;quot;default&amp;quot;
  Writing the test results to &amp;quot;jcstress.1401180107287&amp;quot;
  Parsing results to &amp;quot;results/&amp;quot;
  Running each test matching &amp;quot;.*StringUtils.*&amp;quot; for 1 forks, 5 iterations, 1000 ms each
  Solo stride size will be autobalanced within [10, 10000] elements
  Hardware threads in use/available: 8/8, no yielding in use.


 (ETA:        n/a) (R: 5.90E+08) (T:   1/1) (F: 1/1) (I: 1/5)   [FAILED] com.couchbase.client.tests.util.StringUtilsTest
                     Observed state     Occurrences        Expectation Interpretation      
                             [1, 1] (    1,889,690)         ACCEPTABLE Acceptable to see true.                                     
                             [0, 1] (          150)          FORBIDDEN Other cases are not expected. -1 would mean an exception ...
                             [1, 0] (          130)          FORBIDDEN Other cases are not expected. -1 would mean an exception ...

 (ETA:   00:00:02) (R: 4.03E+06) (T:   1/1) (F: 1/1) (I: 2/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:   00:00:01) (R: 3.05E+06) (T:   1/1) (F: 1/1) (I: 3/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:   00:00:00) (R: 2.74E+06) (T:   1/1) (F: 1/1) (I: 4/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:        now) (R: 2.60E+06) (T:   1/1) (F: 1/1) (I: 5/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
Reading the results back...
Generating the report...
Look at results/index.html for the complete run results.

Will throw any pending exceptions at this point.
Exception in thread &amp;quot;main&amp;quot; java.lang.AssertionError: TEST FAILURES:
com.couchbase.client.tests.util.StringUtilsTest: Observed forbidden state: [0, 1]
com.couchbase.client.tests.util.StringUtilsTest: Observed forbidden state: [1, 0]

	at org.openjdk.jcstress.infra.grading.ExceptionReportPrinter.parse(ExceptionReportPrinter.java:119)
	at org.openjdk.jcstress.JCStress.run(JCStress.java:134)
	at org.openjdk.jcstress.Main.main(Main.java:85)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The command line output is very descriptive, but you can also open the &lt;code&gt;results/index.html&lt;/code&gt; file for a nicer visualization. We can see that most of the time the output was acceptable, but 280 times we got non-consistent output. In those cases, one of the actors got &lt;code&gt;false&lt;/code&gt; as a response instead of &lt;code&gt;true&lt;/code&gt; pretty bad if you ask me!&lt;/p&gt;

&lt;p&gt;You can look through the code if you want to find the race condition, but for those who are too lazy here is the code fix:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;   /**
    * Exception thrown if the input key is empty.
@@ -112,7 +106,7 @@ public final class StringUtils {

     if (s.startsWith(&amp;quot;{&amp;quot;) || s.startsWith(&amp;quot;[&amp;quot;)
       || &amp;quot;true&amp;quot;.equals(s) || &amp;quot;false&amp;quot;.equals(s)
-      || &amp;quot;null&amp;quot;.equals(s) || decimalMatcher.reset(s).matches()) {
+      || &amp;quot;null&amp;quot;.equals(s) || decimalPattern.matcher(s).matches()) {
       return true;
     }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As it turns out, the &lt;code&gt;matcher&lt;/code&gt; is not thread safe and there is a race condition between resetting the characters and matching them afterwards. If we fix it to always create a new &lt;code&gt;matcher&lt;/code&gt;, the race condition should go away. So let&amp;rsquo;s make the proposed changes and run the test again (don&amp;rsquo;t forget to run &lt;code&gt;mvn clean install -pl tests-custom -am&lt;/code&gt; again since we changed the code):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;*snip*
 (ETA:        n/a) (R: 1.82E+09) (T:   1/1) (F: 1/1) (I: 1/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:   00:00:02) (R: 1.13E+07) (T:   1/1) (F: 1/1) (I: 2/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:   00:00:01) (R: 8.90E+06) (T:   1/1) (F: 1/1) (I: 3/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:   00:00:00) (R: 7.98E+06) (T:   1/1) (F: 1/1) (I: 4/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
 (ETA:        now) (R: 7.61E+06) (T:   1/1) (F: 1/1) (I: 5/5)       [OK] com.couchbase.client.tests.util.StringUtilsTest
Reading the results back...
Generating the report...
Look at results/index.html for the complete run results.

Will throw any pending exceptions at this point.
Done.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Look at that! Our results are now consistent. We can now be confident that our bugfix actually solved the race condition here.&lt;/p&gt;

&lt;p&gt;Give it a shot if you also need to debug concurrency issues in your codebase, but keep in mind that your mileage may vary. Thanks again to &lt;a href=&#34;https://twitter.com/shipilev&#34;&gt;Aleksey Shipilv&lt;/a&gt; for eyeballing the code and giving suggestions.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Bootstrapping from DNS SRV records in Java</title>
      <link>http://nitschinger.at/Bootstrapping-from-DNS-SRV-records-in-Java/</link>
      <pubDate>Wed, 29 Jan 2014 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Bootstrapping-from-DNS-SRV-records-in-Java/</guid>
      <description>&lt;p&gt;I know this topic has a very narrow audience, but I hope that one or two people out there scratching their heads will benefit from it.&lt;/p&gt;

&lt;p&gt;Here&amp;rsquo;s the itch we&amp;rsquo;re trying to scratch: is there an easy way to determine hostnames for - let&amp;rsquo;s say - a database connection? There are many ways to do this, like hardcoding it, providing them through a properties file and so on. All this techniques (maybe aside from fetching it over the network from a central storage) require some modifications on the server once one of the hostnames changes. If you need to maintain a lot of machines, this can get inefficient pretty quickly.&lt;/p&gt;

&lt;p&gt;Now let&amp;rsquo;s step back a second and think about what we&amp;rsquo;re using anyway in our infrastructure: DNS. Until recently I haven&amp;rsquo;t heard of the SRV record that you can use to &amp;ldquo;refer&amp;rdquo; to other hostnames. The nice thing about this is that you can provide more endpoints and even add weights and and priorities. Let&amp;rsquo;s look at an example:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;_cbnodes._tcp.example.com.  0  IN  SRV  20  0  8091  node2.example.com.
_cbnodes._tcp.example.com.  0  IN  SRV  10  0  8091  node1.example.com.
_cbnodes._tcp.example.com.  0  IN  SRV  30  0  8091  node3.example.com.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, based on the &amp;ldquo;_cbnodes._tcp.example.com.&amp;rdquo; service information we get to know that there are three nodes configured that belong to this service. They all listen on port &lt;code&gt;8091&lt;/code&gt;, but have priorities associated with them (10, 20, 30). Lower priorities are considered more important, so you can use that to your advantage. The &lt;code&gt;0&lt;/code&gt; between the priority and the port is the weight. You can use different weights (which are probabilities) to generate some kind of load-balancing behaviour.&lt;/p&gt;

&lt;p&gt;Once this is configured on the DNS server, we can make use of that in our application. Say we want to infer the seed nodes to bootstrap from in our &lt;code&gt;CouchbaseClient&lt;/code&gt;. To make this happen, we need to make use of &lt;a href=&#34;http://en.wikipedia.org/wiki/Java_Naming_and_Directory_Interface&#34;&gt;JNDI&lt;/a&gt;. Let&amp;rsquo;s first create a simple class that will hold those records shown above:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;DnsRecord&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;implements&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Comparable&amp;lt;DnsRecord&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;priority;&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;weight;&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;port;&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;host;&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;DnsRecord(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;priority,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;weight,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;port,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;host)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;priority&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;priority;&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;weight&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;weight;&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;port&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;port;&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;host&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;host.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;replaceAll&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;\\\\.$&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;getPriority()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;priority;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;getWeight()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;weight;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;getPort()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;port;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;getHost()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;host;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;DnsRecord&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;fromString(String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;input)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;String[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;splitted&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;input.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;split&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;DnsRecord(&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;Integer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;parseInt&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(splitted[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;]),&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;Integer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;parseInt&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(splitted[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;]),&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;Integer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;parseInt&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(splitted[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;]),&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;splitted[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;]&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;toString()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;DnsRecord{&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
        &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;priority=&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;priority&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
        &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;, weight=&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;weight&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
        &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;, port=&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;port&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
        &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;, host=&amp;#39;&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;host&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #2300CE&#34;&gt;&amp;#39;\\&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
        &lt;span style=&#34;color: #2300CE&#34;&gt;&amp;#39;}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;compareTo(DnsRecord&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;o)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(getPriority()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;o.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getPriority&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We provide a custom &lt;code&gt;compareTo&lt;/code&gt; method in order to automatically sort each &lt;code&gt;DnsRecord&lt;/code&gt; by priority. The next step is to write a method that allows us to fetch the actual information:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;service&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;_cbnodes._tcp.example.com&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;Hashtable&amp;lt;String,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;env&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Hashtable&amp;lt;String,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&amp;gt;();&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;env.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;put&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;java.naming.factory.initial&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;com.sun.jndi.dns.DnsContextFactory&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;env.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;put&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;java.naming.provider.url&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;dns:&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;DirContext&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ctx&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;InitialDirContext(env);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;Attributes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;attrs&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ctx.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getAttributes&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(service,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;SRV&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;NamingEnumeration&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;servers&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;attrs.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;srv&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;).&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getAll&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;Set&amp;lt;DnsRecord&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;sortedRecords&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TreeSet&amp;lt;DnsRecord&amp;gt;();&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(servers.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;hasMore&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;DnsRecord&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;record&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;DnsRecord.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;fromString&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;((String)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;servers.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;next&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;());&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;sortedRecords.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(record);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now we have a &lt;code&gt;Set&lt;/code&gt; of sorted &lt;code&gt;DnsRecords&lt;/code&gt;, which we can use however we want to. For example, with &lt;a href=&#34;http://couchbase.com&#34;&gt;Couchbase&lt;/a&gt; we can turn them into &lt;code&gt;URI&lt;/code&gt;s:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;List&amp;lt;URI&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;uris&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ArrayList&amp;lt;URI&amp;gt;();&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(DnsRecord&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;record&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;sortedRecords)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;uris.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;URI(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;http://&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;record.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getHost&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;:&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;record.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getPort&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;/pools&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;));&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If you want to play around with the code and don&amp;rsquo;t have DNS SRV records set up, I recommend you to use &lt;code&gt;_xmpp-server._tcp.gmail.com&lt;/code&gt;. It exposes Googles GMail XMPP servers and lets
you try the code without much effort. In case you wonder how to mock that thing correctly, I recommend you to mock the &lt;code&gt;DirContext&lt;/code&gt; like so:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;service&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;_seeds._tcp.couchbase.com&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;BasicAttributes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;basicAttributes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;BasicAttributes(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;BasicAttribute&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;basicAttribute&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;BasicAttribute(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;SRV&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;basicAttribute.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;20 0 8091 node2.couchbase.com.&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;basicAttribute.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;10 0 8091 node1.couchbase.com.&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;basicAttribute.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;30 0 8091 node3.couchbase.com.&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;basicAttribute.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;add&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;40 0 8091 node4.couchbase.com.&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;basicAttributes.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;put&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(basicAttribute);&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;DirContext&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;mockedContext&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;mock(DirContext.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;class&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;when(mockedContext.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getAttributes&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(service,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;SRV&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;}))&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;thenReturn&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(basicAttributes);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The code shown here (and more advanced features) are part of the official Couchbase SDK, so check out the &lt;a href=&#34;https://github.com/couchbase/couchbase-java-client&#34;&gt;codebase&lt;/a&gt; if you want to learn more!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Using JMH for Java Microbenchmarking</title>
      <link>http://nitschinger.at/Using-JMH-for-Java-Microbenchmarking/</link>
      <pubDate>Fri, 22 Nov 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Using-JMH-for-Java-Microbenchmarking/</guid>
      <description>

&lt;p&gt;So before we dive in, let&amp;rsquo;s rule two things out. First, I&amp;rsquo;m not a JVM expert and second, microbenchmarking is hard. The bigger problem is that it isn&amp;rsquo;t only hard but also looks very easy if you start. You put your test code in a loop, use &lt;code&gt;System.nanoTime&lt;/code&gt; or something similar to measure the total time of the run and divide it by the number of runs. Doing it that way, you could very well let your cat estimate the results (mine would do it for proper catnip).&lt;/p&gt;

&lt;p&gt;Larger companies like Google started their own projects to remedy all kinds of pitfalls and libraries like &lt;a href=&#34;https://code.google.com/p/caliper/&#34;&gt;Caliper&lt;/a&gt; popped out of that. Now finally, some fine folks of the OpenJDK team thought they&amp;rsquo;ll do their own and share it for everyone to use. The tool is called &lt;a href=&#34;http://openjdk.java.net/projects/code-tools/jmh/&#34;&gt;jmh&lt;/a&gt; or also known as &amp;ldquo;Java Microbenchmarking Harness&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;In this post I just show you how to get started, but there are still lots of things you need to think about. I really recommend you to watch &lt;a href=&#34;http://vimeo.com/78900556&#34;&gt;the talk by Aleksey Shipilev&lt;/a&gt; which dives into concepts and pitfalls. You can also find the slides &lt;a href=&#34;http://shipilev.net/pub/talks/devoxx-Nov2013-benchmarking.pdf&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;using-jmh&#34;&gt;Using JMH&lt;/h2&gt;

&lt;p&gt;There are a few ways to use it and all of them are explained on the official website linked above. In general, you want to use the self-contained jar and run them on the command line, but there is also an easy way to run them directly out of your IDE - this is what I&amp;rsquo;m showing you in a second. If you just want to run it from the command line, you do it like (but you need to build the jar first):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ java -jar target/microbenchmarks.jar -h
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s start a maven project in our IDE and add the following dependency (mad props to &lt;a href=&#34;https://twitter.com/_godin_/status/403668134206242817&#34;&gt;Evgeny Mandrikov&lt;/a&gt; for putting it on maven central recently):&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.openjdk.jmh&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;jmh-core&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.1&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now let&amp;rsquo;s write a main method that calls the underlying method of JMH so we can run it easily form our IDE:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jmh.Main;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;Start&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main(String...&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;args)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;Main.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;main&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(args);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If we hit run, all we&amp;rsquo;ll see is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;No matching benchmarks. Miss-spelled regexp? Use -v for verbose output.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Which is good, because we know JMH is working and looking for our benchmarks. Let&amp;rsquo;s write an empty one to get a feeling of how it works.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;benchmarks;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jmh.annotations.GenerateMicroBenchmark;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;HelloWorld&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;helloWorld()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;JMH will automatically pick it up from the CLASSPATH and start to run our benchmark. You will see lots of output (forks, warmup runs), but be patient until the end and you&amp;rsquo;ll see something like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Fork: 1 of 1
# Warmup: 20 iterations, 1 s each
# Measurement: 10 iterations, 1 s each
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Throughput, ops/time
# Running: benchmarks.HelloWorld.helloWorld
# Warmup Iteration   1: 3034307.449 ops/ms
# Warmup Iteration   2: 3108187.599 ops/ms
# Warmup Iteration   3: 3117686.141 ops/ms
# Warmup Iteration   4: 3121382.926 ops/ms
# Warmup Iteration   5: 3100218.889 ops/ms
# Warmup Iteration   6: 3117158.492 ops/ms
*** snip ***
Iteration   7: 2906090.682 ops/ms
Iteration   8: 3053047.149 ops/ms
Iteration   9: 3055673.541 ops/ms
Iteration  10: 3113494.893 ops/ms

Result : 3073969.337 (95%) 45679.588 (99%) 65631.592 ops/ms
  Statistics: (min, avg, max) = (2906090.682, 3073969.337, 3120910.177), stdev = 63860.098
  Confidence intervals: 95% [3028289.749, 3119648.926], 99% [3008337.745, 3139600.930]


Benchmark                   Mode Thr     Count  Sec         Mean   Mean error    Units
b.HelloWorld.helloWorld    thrpt   1        10    1  3073969.337    65631.592   ops/ms
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that both the output and the results may look different on your machine. To not fork as often and don&amp;rsquo;t do so many measure runs (for demo purposes), you can apply the following flags for the command in your IDE: &lt;code&gt;-i 10 -f 1&lt;/code&gt;. This will only run one fork and do 10 iterations after warming up. There are dozens of flags you can tune to your needs.&lt;/p&gt;

&lt;h2 id=&#34;benchmarking-real-code&#34;&gt;Benchmarking real code&lt;/h2&gt;

&lt;p&gt;Now all is fun, but let&amp;rsquo;s test some real code. In Spymemcached, before we put a document on the wire we check that the key is not longer than allowed and - for ascii based operations - also check if they do not contain whitespace and so on. The code in question currently looks like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateKey(String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;key,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;boolean&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;binary)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;keyBytes&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;KeyUtil.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getKeyBytes&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(key);&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(keyBytes.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;length&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MemcachedClientIF.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;MAX_KEY_LENGTH&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Key is too long (maxlen = &amp;quot;&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MemcachedClientIF.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;MAX_KEY_LENGTH&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;)&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(keyBytes.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;length&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException(&lt;/span&gt;
        &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Key must contain at least one character.&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(!binary)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #177500&#34;&gt;// Validate the key&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;keyBytes)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(b&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #2300CE&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;#39;\\n&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;#39;\\r&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;IllegalArgumentException(&lt;/span&gt;
            &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Key contains invalid characters:  ``&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;key&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;&amp;#39;&amp;#39;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Let&amp;rsquo;s say we don&amp;rsquo;t care about optimizing it yet, but we want to see how it performs if the &amp;ldquo;binary&amp;rdquo; flag is applied or not. Obviously less work is done but we want to see how that turns out in practice. Let&amp;rsquo;s add the dependency so we can use the static method directly from the code:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;net.spy&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;spymemcached&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;2.10.2&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And write a new benchmark that compares both approaches with variation.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;benchmarks;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;net.spy.memcached.util.StringUtils;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jmh.annotations.GenerateMicroBenchmark;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;KeyBench&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   * 12 chars long&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;SHORT_KEY&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;user:michael&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   * 240 chars long&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;LONG_KEY&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;thisIsAFunkyKeyWith_underscores_AndAlso334&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
      &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;3252545345NumberslthisIsAFunkyKeyWith_underscores_AndAlso3343252545345Numbe&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
      &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;rslthisIsAFunkyKeyWith_underscores_AndAlso3343252545345NumberslthisIsAFunkyK&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
      &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;eyWith_underscores_AndAlso3343252545345Numbersl&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateShortKeyBinary()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(SHORT_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateShortKeyAscii()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(SHORT_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateLongKeyBinary()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(LONG_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateLongKeyAscii()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(LONG_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We also see how the performance differs for long and short keys. The first run we do is with 10 iterations and 1 fork:&lt;/p&gt;

&lt;p&gt;Result : 18093.561 (95%) 65.824 (99%) 94.575 ops/ms
    Statistics: (min, avg, max) = (17920.967, 18093.561, 18240.197), stdev = 92.022
    Confidence intervals: 95% [18027.737, 18159.385], 99% [17998.986, 18188.136]&lt;/p&gt;

&lt;p&gt;Benchmark                             Mode Thr     Count  Sec         Mean   Mean error    Units
  b.KeyBench.validateLongKeyAscii      thrpt   1        10    1     1718.532        8.504   ops/ms
  b.KeyBench.validateLongKeyBinary     thrpt   1        10    1     3632.664       24.579   ops/ms
  b.KeyBench.validateShortKeyAscii     thrpt   1        10    1    13198.597       71.557   ops/ms
  b.KeyBench.validateShortKeyBinary    thrpt   1        10    1    18093.561       94.575   ops/ms&lt;/p&gt;

&lt;p&gt;The first observation we can make is that - without surprise - shorter keys are faster than longer keys. But we can also see that the results are much more consistent for longer keys than shorter ones. So let&amp;rsquo;s grab a coffee (this test took over 10 minutes to complete) and run the results with 20 iterations and 10 forks:&lt;/p&gt;

&lt;p&gt;Result : 17796.673 (95%) 56.110 (99%) 76.699 ops/ms
    Statistics: (min, avg, max) = (17441.465, 17796.673, 17947.702), stdev = 119.891
    Confidence intervals: 95% [17740.563, 17852.783], 99% [17719.974, 17873.371]&lt;/p&gt;

&lt;p&gt;Benchmark                             Mode Thr     Count  Sec         Mean   Mean error    Units
  b.KeyBench.validateLongKeyAscii      thrpt   1       200    1     1719.010        2.160   ops/ms
  b.KeyBench.validateLongKeyBinary     thrpt   1       200    1     3745.221       12.101   ops/ms
  b.KeyBench.validateShortKeyAscii     thrpt   1       200    1    13144.629       16.918   ops/ms
  b.KeyBench.validateShortKeyBinary    thrpt   1       200    1    17886.628       31.513   ops/ms&lt;/p&gt;

&lt;p&gt;We get similar results, but our mean error rate went down which gives us further confidence in our numbers.&lt;/p&gt;

&lt;p&gt;Now here comes the important part: while microbenchmarking definitely helps to find bottlenecks and shows you pointers where to go fix your code, it (I think more importantly) shows you code that you do not need to optimize. Say if the numbers shown above fit our application purpose we can &amp;ldquo;check them off&amp;rdquo; the list and go look somewhere else to optimize.&lt;/p&gt;

&lt;p&gt;Also, if you are running those benchmarks on your notebook (and not on the servers, where you should too), make sure you don&amp;rsquo;t enable power management so your CPUs work full steam during the full runs. Also, close all other programs that are not essential and leave it alone until the benchmark finishes. That way you reduce the probability of other tasks inferring with your benchmark results and helping you to get more consistent ones.&lt;/p&gt;

&lt;h2 id=&#34;further-considerations&#34;&gt;Further Considerations&lt;/h2&gt;

&lt;p&gt;Funny enough, JMH not only makes your microbenchmarks more accurate, I think they are also much easier to write. You don&amp;rsquo;t need to fight with things happening in the JVM and your operating system while the tests run. You can integrate those benchmarks into your CI runs when someone checks in a new piece of code and look at historically accurate performance numbers (for crucial pieces in your codebase).&lt;/p&gt;

&lt;p&gt;One thing I need to tell you before finishing this post. Please go watch the video shown above, since there is still a lot to consider, even with JMH. Also a very good pointer is the examples section located &lt;a href=&#34;http://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/&#34;&gt;here&lt;/a&gt;. You should especially be on the lookout for dead code elimination, and the proper use of black holes in JMH.&lt;/p&gt;

&lt;p&gt;Please share your findings and additions in the comments section below!&lt;/p&gt;

&lt;h2 id=&#34;additional-information&#34;&gt;Additional Information&lt;/h2&gt;

&lt;p&gt;As &lt;a href=&#34;https://twitter.com/shipilev&#34;&gt;Aleksey Shipilv&lt;/a&gt; points out in the comments, there is also a nice Java API that you can use, instead of just proxying &amp;ldquo;main&amp;rdquo; and emulating the command line. Here is an example that shows how to use it. Note that iterating the MAP is optional, but it gives you a code-readable way of the results. If you just call &lt;code&gt;new Runner(opts).run();&lt;/code&gt;, you will see the identical output as above.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;main(String...&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;args)&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;throws&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Exception&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;Options&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;opts&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;OptionsBuilder()&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;include&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;.*&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;warmupIterations&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;measurementIterations&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;jvmArgs&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;-server&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;forks&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;outputFormat&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(OutputFormatType.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;TextReport&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;build&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;Map&amp;lt;BenchmarkRecord,RunResult&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;records&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Runner(opts).&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;run&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(Map.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;Entry&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;BenchmarkRecord,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;RunResult&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;result&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;records.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;entrySet&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;Result&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;r&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;result.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getValue&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getPrimaryResult&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;System.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;out&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;API replied benchmark score: &amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;r.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getScore&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot; &amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;r.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getScoreUnit&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot; over &amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;r.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getStatistics&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getN&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot; iterations&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Also, the constant keys used in the above example are subject to constant optimizations. To work around that, there is the @State annotation for the class and the static fields need to be instance variables. Here is the updated code sample for clarity, the numbers don&amp;rsquo;t change for the purpose of this post.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;package&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;benchmarks;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;net.spy.memcached.util.StringUtils;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jmh.annotations.GenerateMicroBenchmark;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.openjdk.jmh.annotations.State;&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;@State&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;KeyBench&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   * 12 chars long&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;SHORT_KEY&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;user:michael&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color: #177500&#34;&gt;/**&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   * 240 chars long&lt;/span&gt;
&lt;span style=&#34;color: #177500&#34;&gt;   */&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;LONG_KEY&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;thisIsAFunkyKeyWith_underscores_AndAlso334&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
      &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;3252545345NumberslthisIsAFunkyKeyWith_underscores_AndAlso3343252545345Numbe&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
      &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;rslthisIsAFunkyKeyWith_underscores_AndAlso3343252545345NumberslthisIsAFunkyK&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;+&lt;/span&gt;
      &lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;eyWith_underscores_AndAlso3343252545345Numbersl&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateShortKeyBinary()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(SHORT_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateShortKeyAscii()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(SHORT_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateLongKeyBinary()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(LONG_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@GenerateMicroBenchmark&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;validateLongKeyAscii()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;StringUtils.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;validateKey&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(LONG_KEY,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Thanks for pointing it out Aleksey!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>What&#39;s new in the Couchbase Java SDK 1.2</title>
      <link>http://nitschinger.at/What-s-new-in-the-Couchbase-Java-SDK-1-2/</link>
      <pubDate>Fri, 11 Oct 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/What-s-new-in-the-Couchbase-Java-SDK-1-2/</guid>
      <description>

&lt;p&gt;For all users of our Java SDK, we prepared some nice additions for you. This post covers them in detail and shows how you can get more productive.&lt;/p&gt;

&lt;p&gt;Note that this blog post assumes you are running the 1.2.1 release, because there have been some slight changes between 1.2.0 and 1.2.1 that affect for example the listener support and metrics collection.&lt;/p&gt;

&lt;h2 id=&#34;maven-central-distribution&#34;&gt;Maven Central Distribution&lt;/h2&gt;

&lt;p&gt;From the 1.2.0 release forward, the Java SDK is distributed directly from Maven Central. This means that you don&amp;rsquo;t need to include the Couchbase repository anymore. The following maven code is enough to get started (note that the groupId has changed):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependencies&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;com.couchbase.client&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;couchbase-client&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;1.2.1&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
&amp;lt;/dependencies&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This will automatically load the latest spymemcached dependency in as well (for 1.2.0 it&amp;rsquo;s 2.10.0). Before we dig into what has changed, &lt;a href=&#34;http://docs.couchbase.com/couchbase-sdk-java-1.2/#release-notes-for-couchbase-client-library-java-120-ga-13-september-2013&#34;&gt;here&lt;/a&gt; are the release notes for a quick reference.&lt;/p&gt;

&lt;h2 id=&#34;listener-support&#34;&gt;Listener Support&lt;/h2&gt;

&lt;p&gt;Until now, there were two ways to get the result of an asynchronous request. Either by blocking the current thread like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// do an async operation (returns immediately)
OperationFuture&amp;lt;Boolean&amp;gt; setFuture = client.set(&amp;quot;key&amp;quot;, &amp;quot;value&amp;quot;);

// block the current thread
Boolean result = setFuture.get();
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Or to loop on the non-blocking future methods. This is especially helpful if you are dealing with a list of futures.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;List&amp;lt;OperationFuture&amp;lt;Boolean&amp;gt;&amp;gt; futures = new ArrayList&amp;lt;OperationFuture&amp;lt;Boolean&amp;gt;&amp;gt;();
for (int i = 0; i &amp;lt; 100; i++) {
  futures.add(client.set(&amp;quot;key-&amp;quot; + i, &amp;quot;value&amp;quot;));
}

while (!futures.isEmpty()) {
  Iterator&amp;lt;OperationFuture&amp;lt;Boolean&amp;gt;&amp;gt; iter = futures.iterator();
  while (iter.hasNext()) {
    OperationFuture&amp;lt;Boolean&amp;gt; future = iter.next();
    if (future.isDone()) {
      iter.remove();
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now since 1.2.0, there is a new way to deal with responses - adding listeners. The idea is to supply a callback to the future which will be executed once the operation is done. A simple example is shown here:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;OperationFuture&amp;lt;Boolean&amp;gt; setFuture = client.set(&amp;quot;key&amp;quot;, &amp;quot;value&amp;quot;);
setFuture.addListener(new OperationCompletionListener() {
  @Override
  public void onComplete(OperationFuture&amp;lt;?&amp;gt; future) throws Exception {
    System.out.println(future.get());
  }
});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that the &lt;code&gt;.get()&lt;/code&gt; method on the future will not block anymore because the result is already computed. Whatever you put in the callback method will be executed asynchronously on the thread pool. To see how flexible that approach is, let&amp;rsquo;s rewrite the example from above waiting until the 100 futures are done.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;final CountDownLatch latch = new CountDownLatch(100);
for (int i = 0; i &amp;lt; 100; i++) {
  OperationFuture&amp;lt;Boolean&amp;gt; future = client.set(&amp;quot;key-&amp;quot; + i, &amp;quot;value&amp;quot;);
  future.addListener(new OperationCompletionListener() {
    @Override
    public void onComplete(OperationFuture&amp;lt;?&amp;gt; future) throws Exception {
      latch.countDown();
    }
  });
}
latch.await();
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we are using a &lt;a href=&#34;http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CountDownLatch.html&#34;&gt;CountDownLatch&lt;/a&gt; which waits on the current thread as long as it has been counted down a hundred times. Exactly what we need in our situation, but the code is much easier to read. More importantly, its much more flexible because other things like firing off a new request, querying a web service or calculating a result can be done.&lt;/p&gt;

&lt;p&gt;It is also possible to override the default &lt;code&gt;ExecutorService&lt;/code&gt; implementation with a custom one. This may be needed if the default behavior (Basically a upper-bounded cachedThreadPool) does not suite your needs. Also, you should use this approach if you create a bunch of &lt;code&gt;CouchbaseClient&lt;/code&gt; instances so you can share the same service across all of them.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// Create the Builder
CouchbaseConnectionFactoryBuilder builder = new CouchbaseConnectionFactoryBuilder();

// Create a thread pool of 5 fixed threads
ExecutorService service = Executors.newFixedThreadPool(5);
// Set it in the builder
builder.setListenerExecutorService(service);

// Create the instance
CouchbaseClient client = new CouchbaseClient(builder.buildCouchbaseConnection(...));
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;enhanced-profiling-capabilities&#34;&gt;Enhanced Profiling Capabilities&lt;/h2&gt;

&lt;p&gt;Getting insight into a running application is always difficult, so we set out to make it easier for you. We incorporated a library called &lt;a href=&#34;http://metrics.codahale.com/&#34;&gt;metrics&lt;/a&gt; that profiles, depending on the configuration level chosen.&lt;/p&gt;

&lt;p&gt;Before you can use it, you need to add this optional dependency:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.codahale.metrics&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;metrics-core&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;3.0.1&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the builder, there is a method that allows you to activate the the profiler:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CouchbaseConnectionFactoryBuilder builder = new CouchbaseConnectionFactoryBuilder();

// enable metric collection
builder.setEnableMetrics(MetricType.PERFORMANCE);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you look at the &lt;code&gt;MetricType&lt;/code&gt; enumeration you can see that there are three types of values you can choose from: OFF (which keeps metric collection off), PERFORMANCE (which only collects performance-relevant metrics) and DEBUG (which collects all kinds of metrics, including the performance ones). While the metrics library is quite efficient, keep in mind that metric collection takes some resources away from your application.&lt;/p&gt;

&lt;p&gt;By default, the metric information will be printed out on the console every 30 seconds. You can run the following test code from your IDE and see how it looks:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CouchbaseConnectionFactoryBuilder builder = new CouchbaseConnectionFactoryBuilder();
builder.setEnableMetrics(MetricType.PERFORMANCE);

CouchbaseConnectionFactory cf =
  builder.buildCouchbaseConnection(Arrays.asList(new URI(&amp;quot;http://127.0.0.1:8091/pools&amp;quot;)), &amp;quot;default&amp;quot;, &amp;quot;&amp;quot;);

CouchbaseClient client = new CouchbaseClient(cf);

while(true) {
  client.set(&amp;quot;foo&amp;quot;, &amp;quot;bar&amp;quot;);
  Thread.sleep(100);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now wait 30 seconds and you&amp;rsquo;ll see output like this in the console:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  10/8/13 12:04:14 PM ============================================================

  -- Histograms ------------------------------------------------------------------
  [MEM] Average Bytes read from OS per read
               count = 893
                 min = 24
                 max = 24
                mean = 24.00
              stddev = 0.00
              median = 24.00
                75% &amp;lt;= 24.00
                95% &amp;lt;= 24.00
                98% &amp;lt;= 24.00
                99% &amp;lt;= 24.00
              99.9% &amp;lt;= 24.00
  [MEM] Average Bytes written to OS per write
               count = 893
                 min = 38
                 max = 38
                mean = 38.00
              stddev = 0.00
              median = 38.00
                75% &amp;lt;= 38.00
                95% &amp;lt;= 38.00
                98% &amp;lt;= 38.00
                99% &amp;lt;= 38.00
              99.9% &amp;lt;= 38.00
  [MEM] Average Time on wire for operations (s)
               count = 893
                 min = 179
                 max = 1730
                mean = 263.80
              stddev = 75.43
              median = 251.00
                75% &amp;lt;= 280.00
                95% &amp;lt;= 351.90
                98% &amp;lt;= 425.36
                99% &amp;lt;= 559.70
              99.9% &amp;lt;= 1730.00

  -- Meters ----------------------------------------------------------------------
  [MEM] Request Rate: All
               count = 893
           mean rate = 9.92 events/second
       1-minute rate = 9.85 events/second
       5-minute rate = 9.68 events/second
      15-minute rate = 9.63 events/second
  [MEM] Response Rate: All (Failure + Success + Retry)
               count = 893
           mean rate = 9.92 events/second
       1-minute rate = 9.85 events/second
       5-minute rate = 9.68 events/second
      15-minute rate = 9.63 events/second
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I won&amp;rsquo;t go into detail of all these metrics in this blog post, please refer to the documentation for a more complete picture. One more thing I want to show you is that the metrics library is also able to expose these metrics through JMX. All you need to do is set a system property that changes the output mode: &lt;code&gt;net.spy.metrics.reporter.type=jmx&lt;/code&gt;. Other possible settings are &lt;code&gt;csv&lt;/code&gt; and slf4j&lt;code&gt;. If you choose a logger that prints out information at a given interval you can change it by setting&lt;/code&gt;net.spy.metrics.reporter.interval` to anything else than 30.&lt;/p&gt;

&lt;p&gt;So if you put the line &lt;code&gt;System.setProperty(&amp;quot;net.spy.metrics.reporter.type&amp;quot;, &amp;quot;jmx&amp;quot;);&lt;/code&gt; before the code shown above, you can open (for example) jConsole and switch to the MBeans tab of the application. You&amp;rsquo;ll see a &lt;code&gt;metrics&lt;/code&gt; subsection exposed that contains the same metrics as they would show up in the logs.&lt;/p&gt;

&lt;h2 id=&#34;cas-with-timeout&#34;&gt;CAS with Timeout&lt;/h2&gt;

&lt;p&gt;Before 1.2.0, it was not possible in one command to do a &lt;code&gt;cas&lt;/code&gt; update and set a new timeout at the same time. You had to do a second &lt;code&gt;touch&lt;/code&gt; operation which was not efficient nor atomic. Now, the API exposes a new &lt;code&gt;cas()&lt;/code&gt; method that allows you to pass in the timeout at the same time. It is easy to use:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;client.cas(&amp;quot;key&amp;quot;, cas, nexExpiration, value);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The asynchronous variations have been exposed since 1.2.1 as well.&lt;/p&gt;

&lt;h2 id=&#34;initializing-through-properties&#34;&gt;Initializing through Properties&lt;/h2&gt;

&lt;p&gt;One thing that comes in handy if your cluster ip addresses change often is that you can now initialize a &lt;code&gt;CouchbaseClient&lt;/code&gt; object based on system properties. Here is an example:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;System.setProperty(&amp;quot;cbclient.nodes&amp;quot;, &amp;quot;http://127.0.0.1:8091/pools&amp;quot;);
System.setProperty(&amp;quot;cbclient.bucket&amp;quot;, &amp;quot;default&amp;quot;);
System.setProperty(&amp;quot;cbclient.password&amp;quot;, &amp;quot;&amp;quot;);

CouchbaseConnectionFactoryBuilder builder = new CouchbaseConnectionFactoryBuilder();
CouchbaseConnectionFactory cf = builder.buildCouchbaseConnection();
CouchbaseClient client = new CouchbaseClient(cf);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Of course you can set these properties in your application container or during startup, so it&amp;rsquo;s very flexible and not tied into your code directly. Note that if you forget to set one of these properties, the code will warn you like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Exception in thread &amp;quot;main&amp;quot; java.lang.IllegalArgumentException: System property cbclient.nodes not set or empty
    at com.couchbase.client.CouchbaseConnectionFactory.&amp;lt;init&amp;gt;(CouchbaseConnectionFactory.java:160)
    at com.couchbase.client.CouchbaseConnectionFactoryBuilder$2.&amp;lt;init&amp;gt;(CouchbaseConnectionFactoryBuilder.java:318)
    at com.couchbase.client.CouchbaseConnectionFactoryBuilder.buildCouchbaseConnection(CouchbaseConnectionFactoryBuilder.java:318)
    at Main.main(Main.java:33)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:601)
    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:120)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;other-changes&#34;&gt;Other Changes&lt;/h2&gt;

&lt;p&gt;In addition to the enhancements shown above, the release includes - as always - numerous smaller bugfixes. The default poll interval for &lt;code&gt;ReplicateTo&lt;/code&gt; and &lt;code&gt;PersistTo&lt;/code&gt; has been lowered to &lt;code&gt;10ms&lt;/code&gt; to account for performance changes that went into the Couchbase Sever 2.2 release. Also, the client now uses the &lt;code&gt;CRAM-MD5&lt;/code&gt; authentication mechanism automatically if the server supports it (since 2.2 as well).&lt;/p&gt;

&lt;p&gt;These awesome new features should be enough reason to upgrade right now! If anything pops up that doesn&amp;rsquo;t work as expected, please ask customer support or open a ticket &lt;a href=&#34;http://www.couchbase.com/issues/browse/JCBC&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Using the Reactor Processor for High-Performance TCP</title>
      <link>http://nitschinger.at/Using-the-Reactor-Processor-for-High-Performance-TCP/</link>
      <pubDate>Tue, 13 Aug 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Using-the-Reactor-Processor-for-High-Performance-TCP/</guid>
      <description>

&lt;p&gt;First, a disclaimer: the all-new &lt;a href=&#34;https://github.com/reactor/reactor&#34;&gt;Reactor&lt;/a&gt; framework is still under heavy development, but it already provides a very promising basement for applications and libraries that need high throughput and low latency. We at &lt;a href=&#34;http://www.couchbase.com/&#34;&gt;Couchbase&lt;/a&gt; aim to provide the highest throughput at the lowest latency, so it is very critical to build upon an infrastructure that can provide it. Current, we are performing early investigations for a possible &amp;ldquo;next generation Java SDK&amp;rdquo; and Reactor seems very promising so far.&lt;/p&gt;

&lt;p&gt;This blog post shows you how to quickly set up a Processor (we&amp;rsquo;ll see in a minute what that is) that dispatches requests to Consumers (also a very common term in Reactor). In our case, the Consumer is actually a TCP socket. Please note that the actual numbers, while impressive, can&amp;rsquo;t be used for real world measurements. What you&amp;rsquo;ll see here is a raw throughput test to define a baseline what can be expected under ideal conditions. We are also using localhost here to avoid network latency (which is the bottleneck for most network applications).&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;m going to use a Couchbase server as an endpoint, but feel free to use whatever you want instead. The whole API is very generic and the consumers can be exchanged easily.&lt;/p&gt;

&lt;h1 id=&#34;setup&#34;&gt;Setup&lt;/h1&gt;

&lt;p&gt;Before we can get started, all we need to do is include the &lt;code&gt;reactor-tcp&lt;/code&gt; artifact from maven. Now you can do this through gradle, maven, ivy or what you want, but at this point, I would recommend you to check out the &lt;a href=&#34;https://github.com/reactor/reactor&#34;&gt;reactor&lt;/a&gt; project directly from github and build it on your own, so you&amp;rsquo;ll have the latest and greatest code in your local repository:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ git clone https://github.com/reactor/reactor.git
$ cd reactor
$ ./gradlew install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This will download and install everything you need. The next step is to create a maven or gradle project in your IDE, but I&amp;rsquo;ll leave that part up to the reader. The maven dependency you need to include is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;org.projectreactor&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;reactor-tcp&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;1.0.0.BUILD-SNAPSHOT&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Or, for all gradle folks:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dependencies {
    compile &#39;org.projectreactor:reactor-tcp:1.0.0.BUILD-SNAPSHOT&#39;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;the-processor&#34;&gt;The Processor&lt;/h1&gt;

&lt;p&gt;Now, let&amp;rsquo;s get to some actual code. The Processor is a very lightweight abstraction over the &lt;a href=&#34;https://github.com/LMAX-Exchange/disruptor&#34;&gt;LMAX Disruptor&lt;/a&gt; a high performant RingBuffer. A RingBuffer provides much better characteristics than a normal Queue, and the Disruptor is heavily optimized for dispatching tasks in the nanosecond area (which means millions of operations per second). I recommend you to read &lt;a href=&#34;https://github.com/LMAX-Exchange/disruptor/blob/master/docs/Disruptor.docx&#34;&gt;this paper&lt;/a&gt; and also check out talks by &lt;a href=&#34;http://mechanical-sympathy.blogspot.co.at/&#34;&gt;Martin Thompson&lt;/a&gt; if you are interested.&lt;/p&gt;

&lt;p&gt;The basic idea is that we decouple consumers from producers, so that each of them can work on their own pace (not blocking each other) and also benefiting from batching if the producers are faster than the consumers. We&amp;rsquo;ll see why this is particularly important with TCP in a second.&lt;/p&gt;

&lt;p&gt;A &lt;code&gt;Processor&lt;/code&gt; can be created by instantiating a &lt;code&gt;ProcessorSpec&lt;/code&gt; and defining some mandatory options. Then, the &lt;code&gt;Processor&lt;/code&gt; is built for us.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;ProcessorSpec&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;writeProcessor&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ProcessorSpec&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;()&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;dataSupplier&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Supplier&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
		&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;get()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
		  &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer());&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;})&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;consume&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Node(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;127.0.0.1&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;environment))&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note that this &lt;code&gt;Spec&lt;/code&gt; pattern is very common in reactor, as it allows for very easy and yet flexible object creation. There are a few things that we need to cover.&lt;/p&gt;

&lt;p&gt;First, the generic type here is &lt;code&gt;Event&amp;lt;Buffer&amp;gt;&lt;/code&gt;. The producers will wrap the payload (here we use raw &lt;code&gt;Buffers&lt;/code&gt;) in an &lt;code&gt;Event&lt;/code&gt; and the consumers will unwrap and use it properly. The &lt;code&gt;Event&lt;/code&gt; type also allows for headers that can be used for custom routing, but we won&amp;rsquo;t cover that here.&lt;/p&gt;

&lt;p&gt;Second, the &lt;code&gt;dataSupplier&lt;/code&gt; is a speciality of the Disruptor RingBuffer. In order to minimize garbage collection and make effective use of memory layout, we need to pre-allocate our container objects. They will be reused throughout the application and will never be garbage collected.&lt;/p&gt;

&lt;p&gt;Third, through the &lt;code&gt;consume&lt;/code&gt; method we can tell the &lt;code&gt;Processor&lt;/code&gt; who will be notified when new data is added to the RingBuffer. In our case, the &lt;code&gt;Node&lt;/code&gt; represents the TCP client which we&amp;rsquo;ll build in a second.&lt;/p&gt;

&lt;p&gt;Now, how do we write to the Processor? Let&amp;rsquo;s add a simple method that does it for us:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;write(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;data)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Operation&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;op&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;writeProcessor.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;op.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;setData&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(data);&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;op.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;commit&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here, we get a &lt;code&gt;Operation&lt;/code&gt; out of the processor (that wraps our data) and override it with the data that we actually want to store this time. You can see that we are not allocating new objects in the RingBuffer, we just use the old one that has been provided for us. With the &lt;code&gt;commit&lt;/code&gt; method we put it back into the RingBuffer. Actually, behind the scenes, it makes use of Sequences and Barriers inside the RingBuffer, but this is completely hidden from us.&lt;/p&gt;

&lt;p&gt;Here is the full code for the lazy reader:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.core.Environment;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.core.processor.Operation;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.core.processor.Processor;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.core.processor.spec.ProcessorSpec;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.event.Event;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.function.Supplier;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.io.Buffer;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;MessageDispatcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Environment&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;environment;&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Processor&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;writeProcessor;&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MessageDispatcher()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;this&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Environment());&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;MessageDispatcher(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Environment&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;env)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;environment&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;env;&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;writeProcessor&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ProcessorSpec&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;()&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;dataSupplier&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Supplier&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
        &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;get()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
          &lt;span style=&#34;color: #A90D91&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer());&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;})&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;consume&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Node(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;127.0.0.1&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;environment))&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;write(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;data)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Operation&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;op&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;writeProcessor.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;op.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;setData&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(data);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;op.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;commit&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;One final note before we move on: did you spot the &lt;code&gt;Environment&lt;/code&gt; here? This is also a common theme in the Reactor framework. The &lt;code&gt;Environment&lt;/code&gt; is used in many places to signal information about - who would have thought that - the JVM environment. The general recommendation is to create only one &lt;code&gt;Environment&lt;/code&gt; instance per JVM, so we happily pass it around in our small application.&lt;/p&gt;

&lt;h1 id=&#34;the-consumer&#34;&gt;The Consumer&lt;/h1&gt;

&lt;p&gt;Before we get into the nitty-gritty network details, let&amp;rsquo;s add a consumer that just prints out the data that he &amp;ldquo;sees&amp;rdquo;. If you want to try this sample, make sure to change the previous code temporarily from &lt;code&gt;.consume(new Node(...))&lt;/code&gt; to &lt;code&gt;.consume(new EchoConsumer())&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;EchoConsumer&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;implements&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Consumer&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;accept(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bufferEvent)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;System.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;out&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;println&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(Arrays.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;toString&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(bufferEvent.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getData&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;asBytes&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()));&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;accept&lt;/code&gt; method is always called once there is information available on the Processor. Let&amp;rsquo;s add a simple test case to verify that this works:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;org.junit.Test;&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;reactor.io.Buffer;&lt;/span&gt;

&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;MessageDispatcherTest&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@Test&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;echoSomeGarbage()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;MessageDispatcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;dispatcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MessageDispatcher();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;dispatcher.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;write&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(Buffer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;wrap&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Hello World!&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;));&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now if we run this test, we should see &lt;code&gt;[72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100, 33]&lt;/code&gt; printed on the console - great! This is the byte array representation of our wrapped buffer. Of course we could make our lives easier and use &lt;code&gt;Strings&lt;/code&gt; instead of &lt;code&gt;Buffer&lt;/code&gt; in our implementation, but the &lt;code&gt;Buffer&lt;/code&gt; works much better with network communication.&lt;/p&gt;

&lt;p&gt;The next step would be to send the data over the network. Let&amp;rsquo;s replace our Consumer with a more intelligent one. Be aware that the &lt;code&gt;TcpClient&lt;/code&gt; that you&amp;rsquo;ll see doesn&amp;rsquo;t communicate with Java NIO directly - it makes use of the excellent &lt;a href=&#34;http://netty.io/&#34;&gt;Netty&lt;/a&gt; project which provides a convenient and performant wrapper around NIO and OIO (we use NIO here).&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;Node&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;implements&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Consumer&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TcpClient&amp;lt;Buffer,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;client;&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TcpConnection&amp;lt;Buffer,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Node(String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hostname,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Environment&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;env)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TcpClientSpec&amp;lt;Buffer,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&amp;gt;(NettyTcpClient.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;class&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;env&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(env)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;connect&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(hostname,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;11210&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;client.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;open&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;await&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;catch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(InterruptedException&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;e)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;e.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;printStackTrace&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;accept(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bufferEvent)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;Buffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bufferEvent.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getData&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CountDownLatch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;latch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CountDownLatch(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;conn.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;send&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(buf,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Consumer&amp;lt;Boolean&amp;gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;accept(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Boolean&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;success)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;latch.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;countDown&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;latch.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;await&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TimeUnit.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;SECONDS&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;catch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Exception&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ex)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;RuntimeException(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;Something went wrong while waiting :(&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ex);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;While this might seem like a lot of code, it&amp;rsquo;s not so bad. We do two things here. During object construction, we create a new &lt;code&gt;TcpClient&lt;/code&gt; through the &lt;code&gt;TcpClientSpec&lt;/code&gt; (see the Spec again?) and pass it the environment and the socket to connect to. The next thing we need to do is actually open the connection and wait until finished.&lt;/p&gt;

&lt;p&gt;Now that we have an open connection, we can write to it. Since everything is non-blocking in Reactor, so is socket writing. In order to not overwhelm the underlying infrastructure, we have to wait until it is actually finished before moving on to handle the next &lt;code&gt;Event&lt;/code&gt; in the Processor. We do this by using a &lt;code&gt;CountDownLatch&lt;/code&gt;, which will be counted down once the writing has finished. In our simple example we just fail if it took longer than one second. In a real application, one could report errors or retry with Backoff.&lt;/p&gt;

&lt;p&gt;Before we can run that code, we need to add a test case to make it all work.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;Buffer[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;buffers&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer[&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;];&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;@Before&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;initBuffers()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i++)&lt;/span&gt;  &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;Buffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;30&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;((&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x80&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// Magic Byte&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;((&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x09&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// GETQ Opcode&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x03&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// 3 byte keylength (KEY)&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;((&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// Extra Length&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;((&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// data type&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// reserved&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x03&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// total body size&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// Opaque&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x00&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt; &lt;span style=&#34;color: #177500&#34;&gt;// CAS&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;[]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;0x65&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0x6F&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;byte&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)(i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;9&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)});&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;buffers[i]&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;buf;&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;@Test&lt;/span&gt;
&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;giveItSomeLoad()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;MessageDispatcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;dispatcher&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;MessageDispatcher();&lt;/span&gt;

	&lt;span style=&#34;color: #A90D91&#34;&gt;long&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;amountOfOps&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;100000000&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #A90D91&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;long&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;amountOfOps;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;i++)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000000&#34;&gt;dispatcher.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;write&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer(buffers[(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;int&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)(i&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;9&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)]).&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;flip&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;());&lt;/span&gt;
	&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;To actually simulate something real, this test creates ten buffer instances with Couchbase messages. Those familiar with the memcached binary protocol can identify it as a GETQ request. This means it does not return anything when the key is not found (which is what we want, because in this case we want to benchmark the upper limit for write throughput and not concern us with parsing of error responses). Once the data is created, we run a given amount of operations and call the &lt;code&gt;write&lt;/code&gt; method on the &lt;code&gt;MessageDispatcher&lt;/code&gt;.&lt;/p&gt;

&lt;h1 id=&#34;batch-all-the-things&#34;&gt;Batch all the things!&lt;/h1&gt;

&lt;p&gt;If we run this, we get a - very disappointing - number of only 50K ops/s. In addition, we get lots of CPU usage on the Java process (100% and more on a quad core processor here). Why is it so slow? The answer is: network overhead. In our case, we send out 27 byte chunks over the network. With all the TCP, IP and Ethernet headers, there is lots of unnecessary overhead involved that puts down our performance. The answer to that is batching! If our producers are faster than the consumers, we can batch the intermediate data up into a buffer and send it over the wire in one chunk. This will give us a much better goodput ratio.&lt;/p&gt;

&lt;p&gt;To help us with batching the Disruptor and the Processor expose the start end end of a batching phase to our consumer. To get this information, we need to extend from the &lt;code&gt;BatchConsumer&lt;/code&gt; instead of the regular &lt;code&gt;Consumer&lt;/code&gt;. Let&amp;rsquo;s refactor our node and add some batching characteristics:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #ffffff&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #3F6E75&#34;&gt;BatchingNode&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;implements&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;BatchConsumer&amp;lt;Event&amp;lt;Buffer&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TcpClient&amp;lt;Buffer,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;client;&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TcpConnection&amp;lt;Buffer,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;null&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;;&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;writeBuffer;&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;BatchingNode(String&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;hostname,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Environment&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;env)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;client&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TcpClientSpec&amp;lt;Buffer,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer&amp;gt;(NettyTcpClient.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;class&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;env&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(env)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;connect&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(hostname,&lt;/span&gt; &lt;span style=&#34;color: #1C01CE&#34;&gt;11210&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;)&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;get&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;conn&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;client.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;open&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;().&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;await&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;catch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(InterruptedException&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;e)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;e.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;printStackTrace&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;writeBuffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Buffer(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1500&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;start()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;end()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;flush();&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
  &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;accept(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Event&amp;lt;Buffer&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bufferEvent)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;Buffer&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;buf&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;bufferEvent.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;getData&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;

    &lt;span style=&#34;color: #A90D91&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(writeBuffer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;remaining&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;buf.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;remaining&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;())&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;flush();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

    &lt;span style=&#34;color: #000000&#34;&gt;writeBuffer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;append&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(buf);&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

  &lt;span style=&#34;color: #A90D91&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;flush()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CountDownLatch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;latch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;CountDownLatch(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;writeBuffer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;flip&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;conn.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;send&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(writeBuffer,&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Consumer&amp;lt;Boolean&amp;gt;()&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;@Override&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;void&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;accept(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Boolean&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;success)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #000000&#34;&gt;latch.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;countDown&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;});&lt;/span&gt;
    &lt;span style=&#34;color: #A90D91&#34;&gt;try&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #000000&#34;&gt;latch.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;await&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #1C01CE&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;TimeUnit.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;SECONDS&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;catch&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #A90D91&#34;&gt;final&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;Exception&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ex)&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;{&lt;/span&gt;
      &lt;span style=&#34;color: #A90D91&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color: #A90D91&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;RuntimeException(&lt;/span&gt;&lt;span style=&#34;color: #C41A16&#34;&gt;&amp;quot;got ex&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000000&#34;&gt;ex);&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
    &lt;span style=&#34;color: #000000&#34;&gt;writeBuffer.&lt;/span&gt;&lt;span style=&#34;color: #836C28&#34;&gt;clear&lt;/span&gt;&lt;span style=&#34;color: #000000&#34;&gt;();&lt;/span&gt;
  &lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;

&lt;span style=&#34;color: #000000&#34;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The code here is not much different. Note that we refactored the writing part out into the &lt;code&gt;flush&lt;/code&gt; method. In the &lt;code&gt;accept&lt;/code&gt; method, we write to the network if the buffer is full, otherwise we just add it to our write buffer. Note that we also need to &lt;code&gt;flush&lt;/code&gt; if the batching is over (notified through the &lt;code&gt;end&lt;/code&gt; method), otherwise we would potentially keep data around for a longer time than needed (and latency is still important to us).&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s run the test case again&amp;hellip; now we get 500k ops/s with only 40% CPU load on the java process! Now that&amp;rsquo;s what I call an improvement!&lt;/p&gt;

&lt;h1 id=&#34;summary&#34;&gt;Summary&lt;/h1&gt;

&lt;p&gt;This was a very quick introduction into the Processor, just one piece in the very promising Reactor framework. There is so much more to blog about in the future, so stay tuned!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Useful Couchbase Resources &amp; Blog Posts</title>
      <link>http://nitschinger.at/Useful-Couchbase-Resources-Blog-Posts/</link>
      <pubDate>Tue, 06 Aug 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Useful-Couchbase-Resources-Blog-Posts/</guid>
      <description>

&lt;p&gt;The following list is a convenient way to get access to lots of resources, blog posts and material that have been shared throughout the past months. I tried to separate them by area, but of course lots of them overlap to some extent.&lt;/p&gt;

&lt;p&gt;They are sorted by date (so you&amp;rsquo;ll find the most recent ones on top) and include the author where possible. Be aware that some of the older articles may already be outdated  or not 100% accurate.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ll try to update this page as new articles get published, so it may pay off to come back here from time to time and check out the topmost ones. If you want to see your article included, post them in the comments!&lt;/p&gt;

&lt;h2 id=&#34;starting-out&#34;&gt;Starting Out&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/docs/couchbase-manual-2.1.0/&#34;&gt;Official Couchbase Server 2.1 Manual&lt;/a&gt;: The official manual and a good starting point for all kinds of general-purpose and architectural questions.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/docs/couchbase-devguide-2.1.0/&#34;&gt;Couchbase Server 2.1 Developer Guide&lt;/a&gt;: The developer guide is particularly useful for developers that are new to document modeling and general app-related questions.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities&#34;&gt;The Community Portal&lt;/a&gt;: Starting point for all SDK-related questions and links.&lt;/li&gt;
&lt;li&gt;2013-04-24 &lt;a href=&#34;http://blog.couchbase.com/top-10-things-ops-sys-admin-must-know-about-couchbase&#34;&gt;Top 10 things an Ops / Sys admin must know about Couchbase&lt;/a&gt;: Ten short rules that sys admins that maintain Couchbase clusters should keep in mind.&lt;/li&gt;
&lt;li&gt;2012-07-06 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2012/07/couchbase-101-install-store-and-query.html&#34;&gt;Couchbase 101 : Install, Store and Query Data (tgrall)&lt;/a&gt;: A very basic introduction for people starting out, teaching the very basics in a hands-on fashion.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;installation-infrastructure&#34;&gt;Installation &amp;amp; Infrastructure&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/docs/couchbase-manual-2.1.0/couchbase-getting-started.html&#34;&gt;Official Installation Guide for 2.1&lt;/a&gt;: The official installation guide, read this before installing on production systems.&lt;/li&gt;
&lt;li&gt;2013-08-05 &lt;a href=&#34;http://trondn.blogspot.no/2013/08/running-couchbase-211-on-smartos.html&#34;&gt;Running Couchbase 2.1.1 on SmartOS (trondn)&lt;/a&gt;: Learn how to - step by step - compile and run a Couchbase cluster on SmartOS. This is for all the Solaris fans out there!&lt;/li&gt;
&lt;li&gt;2013-07-22 &lt;a href=&#34;http://blog.couchbase.com/deploying-couchbase-chef&#34;&gt;Deploying Couchbase with Chef (ketakigangal)&lt;/a&gt;: If you use Chef to automate your infrastructure, this blog post shows you how to integrate Couchbase with it.&lt;/li&gt;
&lt;li&gt;2013-07-11 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/07/deploy-your-nodecouchbase-application.html&#34;&gt;Deploy your Node/Couchbase application to the cloud with Clever Cloud (tgrall)&lt;/a&gt;: You&amp;rsquo;ll learn how to deploy your Node.JS app with Couchbase onto &amp;ldquo;clever cloud&amp;rdquo;, a PaaS provider.&lt;/li&gt;
&lt;li&gt;2013-06-27 &lt;a href=&#34;http://www.ebruakagunduz.com/2013/06/nagios-plugin-to-monitor-couchbase.html?spref=tw&#34;&gt;Nagios plugin to monitor Couchbase (Ebru Akagndz)&lt;/a&gt;: If you are using Nagios to monitor your infrastructure, this post shows you how to integrate Couchbase with a single plugin.&lt;/li&gt;
&lt;li&gt;2013-05-31 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/05/create-couchbase-cluster-in-one-command.html&#34;&gt;Create a Couchbase cluster in less than a minute with Ansible (tgrall)&lt;/a&gt;: Create a Couchbase cluster automatically with Ansible, a systems automation framework like chef.&lt;/li&gt;
&lt;li&gt;2013-05-27 &lt;a href=&#34;http://nitschinger.at/A-Couchbase-Cluster-in-Minutes-with-Vagrant-and-Puppet&#34;&gt;A Couchbase Cluster in Minutes with Vagrant and Puppet (daschl)&lt;/a&gt;: If you want to setup a 4 node cluster with couchbase in minutes, this blog post shows you how to do it.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;document-design-data-import-export&#34;&gt;Document Design &amp;amp; Data Import/Export&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;2013-07-18 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/07/how-to-implement-document-versioning.html&#34;&gt;How to implement Document Versioning with Couchbase (tgrall)&lt;/a&gt;: See how to implement document versioning by using a key-based approach. Uses the Java SDK, but can be adapted for all languages.&lt;/li&gt;
&lt;li&gt;2013-07-08 &lt;a href=&#34;http://dev.theladders.com/2013/07/denormalize-the-datas-for-great-good&#34;&gt;Denormalize the Datas for Great Good (John Connolly)&lt;/a&gt;: See how TheLadders benefited from denormalizing its dataset and using Couchbase, greatly reducing their response times.&lt;/li&gt;
&lt;li&gt;2013-07-03 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/07/sql-to-nosql-importing-data-from-rdbms.html&#34;&gt;SQL to NoSQL : Copy your data from MySQL to Couchbase (tgrall)&lt;/a&gt;: A Java-based tool to import data from a SQL database into Couchbase.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;views&#34;&gt;Views&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;2013-07-25 &lt;a href=&#34;http://blog.couchbase.com/caching-queries-couchbase-high-performance&#34;&gt;Caching queries in Couchbase for high performance (Alexis Roos)&lt;/a&gt;: Learn how to cache view results for better performance.&lt;/li&gt;
&lt;li&gt;2013-07-12 &lt;a href=&#34;http://blog.couchbase.com/calculating-average-document-size-documents-stored-couchbase&#34;&gt;Calculating average document size of documents stored in Couchbase. (Alexis Roos)&lt;/a&gt;: With a simple map and a custom reduce function, one can easily calculate the average document size in the bucket.&lt;/li&gt;
&lt;li&gt;2013-06-14 &lt;a href=&#34;http://avsej.net/2013/analyzing-binary-data-in-couchbase&#34;&gt;Analyzing Binary Data in Couchbase (avsej)&lt;/a&gt;: Shows how to access binary (non-json) data from a View. Uses ruby to store the data, but can be adapted to any language.&lt;/li&gt;
&lt;li&gt;2013-02-18 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/02/how-to-get-latest-document-by-datetime.html&#34;&gt;How to get the latest document by date/time field (tgrall)&lt;/a&gt;: A simple example on how to sort View-data based on a timestamp.&lt;/li&gt;
&lt;li&gt;2013-02-13 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/02/introduction-to-collated-views-with.html&#34;&gt;Introduction to Collated Views with Couchbase 2.0 (tgrall)&lt;/a&gt;: Views can also be used to output &amp;ldquo;master/detail&amp;rdquo;-like scenarios. This post shows how.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;java-sdk-jvm&#34;&gt;Java SDK &amp;amp; JVM&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities/java/getting-started&#34;&gt;Getting Started &amp;amp; Download&lt;/a&gt;: The official &amp;ldquo;Getting Started&amp;rdquo; page for the Java SDK. Introduction, Tutorial and Downloads.&lt;/li&gt;
&lt;li&gt;2013-05-16 &lt;a href=&#34;http://nitschinger.at/Logging-with-the-Couchbase-Java-Client&#34;&gt;Logging with the Couchbase Java Client (daschl)&lt;/a&gt;: An in-depth post about how to correctly configure logging for the Java SDK (and the underlying spymemcached library).&lt;/li&gt;
&lt;li&gt;2013-04-17 &lt;a href=&#34;http://nitschinger.at/Couchbase-Java-SDK-Internals&#34;&gt;Couchbase Java SDK Internals (daschl)&lt;/a&gt;: A very detailed post about the inner workings of the Java SDK. Recommended for advanced users who want to understand more of the internals.&lt;/li&gt;
&lt;li&gt;2012-12-30 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2012/12/couchbase-101-create-views-mapreduce.html&#34;&gt;Couchbase 101: Create views (MapReduce) from your Java application (tgrall)&lt;/a&gt;: How to create views and design documents directly from the Java SDK.&lt;/li&gt;
&lt;li&gt;2012-11-05 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2012/11/couchbase-create-large-dataset-using.html&#34;&gt;Couchbase : Create a large dataset using Twitter and Java (tgrall)&lt;/a&gt;: Feed data from Twitter directly into your Couchbase cluster through the Java SDK.&lt;/li&gt;
&lt;li&gt;2012-04-26 &lt;a href=&#34;http://nitschinger.at/Accessing-Couchbase-from-Scala&#34;&gt;Accessing Couchbase from Scala (daschl)&lt;/a&gt;: How to access the Couchbase Java SDK from the Scala programing language.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;net&#34;&gt;.NET&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities/net/getting-started&#34;&gt;Getting Started &amp;amp; Download&lt;/a&gt;: The official &amp;ldquo;Getting Started&amp;rdquo; page for the .NET SDK. Introduction, Tutorial and Downloads.&lt;/li&gt;
&lt;li&gt;2013-06-14 &lt;a href=&#34;http://vimeo.com/68378224&#34;&gt;Video: Code-First NoSQL with .NET and Couchbase (John Zablocki)&lt;/a&gt;: A video where John Zablocki gives an introduction into NoSQL development and especially with Couchbase.&lt;/li&gt;
&lt;li&gt;2013-03-06 &lt;a href=&#34;http://blog.couchbase.com/net-couchbase-client-instrumentation-aspnet-and-glimpse&#34;&gt;.NET Couchbase Client Instrumentation with ASP.NET and Glimpse (John Zablocki)&lt;/a&gt;: See how to get your Couchbase server-side logging errors easily displayed in the browser console. Very helpful during development.&lt;/li&gt;
&lt;li&gt;2013-02-01 &lt;a href=&#34;http://blog.couchbase.com/moving-no-schema-stack-c-and-dynamic-types&#34;&gt;Moving No Schema up the Stack with C# and Dynamic Types (John Zablocki)&lt;/a&gt;: This blog post shows how to store schemaless data with both dictionaries and C#&amp;rsquo;s dynamic typing.&lt;/li&gt;
&lt;li&gt;2013-01-04 &lt;a href=&#34;http://blog.couchbase.com/xdcr-aspnet-and-nancy&#34;&gt;XDCR with ASP.NET and Nancy (John Zablocki)&lt;/a&gt;: Learn how to build an XDCR endpoint (like ElasticSearch integration) and read the data through our XDCR mechanisms.&lt;/li&gt;
&lt;li&gt;2012-10-23 &lt;a href=&#34;http://blog.couchbase.com/using-c-domain-objects-define-couchbase-views&#34;&gt;Using C# Domain Objects to Define Couchbase Views (John Zablocki)&lt;/a&gt;: How to automatically create DesignDocuments based of C# domain objects.&lt;/li&gt;
&lt;li&gt;2012-10-05 &lt;a href=&#34;http://blog.couchbase.com/new-visual-studio-code-snippets-net-couchbase-client-library&#34;&gt;New Visual Studio Code Snippets for the .NET Couchbase Client Library (John Zablocki)&lt;/a&gt;: A collection of helpful snippets in the day-to-day development process.&lt;/li&gt;
&lt;li&gt;2012-09-20 &lt;a href=&#34;http://blog.couchbase.com/strongly-typed-views-net-client-library&#34;&gt;Strongly Typed Views with the .NET Client Library (John Zablocki)&lt;/a&gt;: Learn how to map View responses directly onto domain objects.&lt;/li&gt;
&lt;li&gt;2012-08-01 &lt;a href=&#34;http://blog.couchbase.com/introducing-couchbase-aspnet-outputcache-provider&#34;&gt;Introducing the Couchbase ASP.NET OutputCache Provider (John Zablocki)&lt;/a&gt;: A short post on how to use Couchbase for easy caching in the ASP.NET environment.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;php&#34;&gt;PHP&lt;/h2&gt;

&lt;p&gt;(Note: some of these posts are outdated in the way that currently the &amp;ldquo;way to go&amp;rdquo; when installing the PHP SDK is through PECL. See the the &lt;a href=&#34;http://www.couchbase.com/communities/php/getting-started&#34;&gt;Getting Started &amp;amp; Download&lt;/a&gt; guide for more information.)&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities/php/getting-started&#34;&gt;Getting Started &amp;amp; Download&lt;/a&gt;: The official &amp;ldquo;Getting Started&amp;rdquo; page for the PHP SDK. Introduction, Tutorial and Downloads.&lt;/li&gt;
&lt;li&gt;2013-04-02  &lt;a href=&#34;http://trondn.blogspot.co.at/2013/04/couchbase-php-xampp-and-windows.html&#34;&gt;Couchbase, PHP, XAMPP and Windows (trondn)&lt;/a&gt;: A short post on how to use the PHP SDK from Microsoft Windows.&lt;/li&gt;
&lt;li&gt;2013-04-01 &lt;a href=&#34;http://trondn.blogspot.co.at/2013/04/building-couchbase-php-driver-on-ubuntu.html&#34;&gt;Building Couchbase PHP driver on Ubuntu (trondn)&lt;/a&gt;: Learn how to build the Couchbase driver on Ubuntu and use it in a simple program.&lt;/li&gt;
&lt;li&gt;2013-02-04 &lt;a href=&#34;http://trondn.blogspot.co.at/2013/02/accessing-couchbase-from-php-on-your-mac.html&#34;&gt;Accessing Couchbase from PHP on your Mac! (trondn)&lt;/a&gt; Building and running the SDK on your Mac is easy, learn how to do it in this post.&lt;/li&gt;
&lt;li&gt;2012-11-01 &lt;a href=&#34;http://trondn.blogspot.co.at/2012/11/building-php-extension-for-couchbase-on.html&#34;&gt;Building the PHP extension for Couchbase on Microsoft Windows! (trondn)&lt;/a&gt;: Learn how to compile the SDK on Windows using Visual Studio 2008.&lt;/li&gt;
&lt;li&gt;2012-06-25 &lt;a href=&#34;http://nitschinger.at/How-to-store-PHP-sessions-in-Couchbase&#34;&gt;How to store PHP sessions in Couchbase (daschl)&lt;/a&gt;: This post shows how to store PHP sessions in Couchbase using different mechanims (not only the official SDK).&lt;/li&gt;
&lt;li&gt;2012-06-21 &lt;a href=&#34;http://nitschinger.at/Using-Couchbase-as-a-flexible-session-store&#34;&gt;Using Couchbase as a flexible session store (daschl)&lt;/a&gt;: With Couchbase Server 2.0, JSON data and Views, its easy to run metrics over your sessions and identify user behavior. Learn how in this post.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;c-go&#34;&gt;C &amp;amp; Go&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities/c/getting-started&#34;&gt;Getting Started &amp;amp; Download with the C SDK&lt;/a&gt;: The official &amp;ldquo;Getting Started&amp;rdquo; page for the C SDK. Introduction, Tutorial and Downloads.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/couchbaselabs/go-couchbase&#34;&gt;Official Go Client Repository&lt;/a&gt;: The Go repository with code and simple examples.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ruby&#34;&gt;Ruby&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities/ruby/getting-started&#34;&gt;Getting Started &amp;amp; Download&lt;/a&gt;: The official &amp;ldquo;Getting Started&amp;rdquo; page for the Ruby SDK. Introduction, Tutorial and Downloads.&lt;/li&gt;
&lt;li&gt;2013-02-23 &lt;a href=&#34;http://avsej.net/links/2013/couchbase-and-rails/&#34;&gt;Couchbase and Rails Talk (avsej)&lt;/a&gt;: A presentation by our lead Ruby SDK developer on how to integrate it with Ruby on Rails.&lt;/li&gt;
&lt;li&gt;2013-02-11 &lt;a href=&#34;http://blog.couchbase.com/using-couchbase-ruby-gem-eventmachine&#34;&gt;Using Couchbase Ruby Gem with EventMachine (avsej)&lt;/a&gt;: This post shows how to use the Ruby SDK together with the high performance EventMachine (custom protocols and performance for TCP/IP) gem.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;node-js&#34;&gt;Node.JS&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;2013-03-06 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/03/easy-application-development-with.html&#34;&gt;Easy application development with Couchbase, Angular and Node (tgrall)&lt;/a&gt;: Storing Ideas and Votes in Couchbase with Angular and NodeJS.&lt;/li&gt;
&lt;li&gt;2013-01-04 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/01/getting-started-with-couchbase-and.html&#34;&gt;Getting started with Couchbase and node.js on Windows (tgrall)&lt;/a&gt;: How to install and use the NodeJS Couchbase client library on Windows.&lt;/li&gt;
&lt;li&gt;2012-11-13 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2012/11/building-chat-application-using-nodejs.html&#34;&gt;Building a chat application using Node.js and Couchbase (tgrall)&lt;/a&gt;: A nice chat application using Couchbase, NodeJS and socket.io for &amp;ldquo;real time&amp;rdquo; feeling.&lt;/li&gt;
&lt;li&gt;2012-09-24 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2012/09/create-simple-nodejs-and-couchbase.html&#34;&gt;Create a Simple Node.js and Couchbase application&amp;hellip; on OS X (tgrall)&lt;/a&gt; A simple (but maybe outdated) tutorial on how to use the NodeJS driver from OSX.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;python&#34;&gt;Python&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/communities/python/getting-started&#34;&gt;Getting Started &amp;amp; Download&lt;/a&gt;: The official &amp;ldquo;Getting Started&amp;rdquo; page for the Python SDK. Introduction, Tutorial and Downloads.&lt;/li&gt;
&lt;li&gt;2013-06-21 &lt;a href=&#34;http://mnunberg.github.io/2013/python-extension-windows-binaries&#34;&gt;Python Extension Windows Binaries (mnunberg)&lt;/a&gt;: A tale by our maintainer of the Python SDK on how to upload Windows binaries to PyPi.&lt;/li&gt;
&lt;li&gt;2013-05-30 &lt;a href=&#34;http://blog.couchbase.com/whats-python-couchbase-sdk&#34;&gt;What&amp;rsquo;s up with the Python Couchbase SDK (volker)&lt;/a&gt;: A rundown of the latest changes on the Python SDK.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ecosystem&#34;&gt;Ecosystem&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;2013-07-31 &lt;a href=&#34;http://www.ortussolutions.com/blog/couchbase-cluster-setup-orm-secondary-cache-introduction&#34;&gt;Couchbase: Cluster Setup + ORM Secondary Cache Introduction (Brad Wood)&lt;/a&gt;: Using ColdFusion and looking for a secondary cache implementation? Look no further.&lt;/li&gt;
&lt;li&gt;2013-07-22 &lt;a href=&#34;http://blog.jeroenreijn.com/2013/07/visitor-analysis-with-couchbase-elasticsearch.html&#34;&gt;Real-time visitor analysis with Couchbase, Elasticsearch and Kibana (Jeroen Reijn)&lt;/a&gt;: A great post on a customer&amp;rsquo;s use case for real-time visitor analysis.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;troubleshooting&#34;&gt;Troubleshooting&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.couchbase.com/docs/couchbase-manual-2.1.0/couchbase-troubleshooting.html&#34;&gt;Official troubleshooting Guide&lt;/a&gt;: The best place to start if something goes wrong on the server and you don&amp;rsquo;t know why.&lt;/li&gt;
&lt;li&gt;2012-12-26 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2012/12/what-to-do-if-your-couchbase-server.html&#34;&gt;What to do if your Couchbase Server does not start? (tgrall)&lt;/a&gt;: If you have troubles getting older Couchbase Server 2.0 versions to run on Windows, this post is for you.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;fun-stuff&#34;&gt;Fun Stuff&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/couchbaselabs/DeveloperDay&#34;&gt;Example code for lots of SDKs and Languages&lt;/a&gt;: Our DeveloperDay material with hands-on code examples to try and learn.&lt;/li&gt;
&lt;li&gt;2013-06-18 &lt;a href=&#34;http://nitschinger.at/Fun-with-Couchbase-Views-and-Message-Pack&#34;&gt;Fun with Couchbase Views and MessagePack (daschl)&lt;/a&gt;: While JSON is tried and true, with a little twiggling and some fun you can get Couchbase Views to speak MessagePack!&lt;/li&gt;
&lt;li&gt;2013-04-29 &lt;a href=&#34;http://tugdualgrall.blogspot.co.at/2013/04/screencast-fun-with-couchbase-mapreduce.html&#34;&gt;Screencast : Fun with Couchbase, MapReduce and Twitter (tgrall)&lt;/a&gt;: A Screencast on importing Twitter data into Couchbase and analyzing it on the fly through Views.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Last Updated: 2013-08-06 (daschl)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Printing JVM generated Assembler on Mac OS X</title>
      <link>http://nitschinger.at/Printing-JVM-generated-Assembler-on-Mac-OS-X/</link>
      <pubDate>Mon, 24 Jun 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Printing-JVM-generated-Assembler-on-Mac-OS-X/</guid>
      <description>&lt;p&gt;Thankfully, the JVM abstracts all of the nitty gritty details from us. Sometimes though, we need to peel off the first layers and see what&amp;rsquo;s going on underneath. If you are curious (and here may be dragons) and want to learn about the actual &lt;a href=&#34;http://en.wikipedia.org/wiki/Assembly_language&#34;&gt;assembler&lt;/a&gt; that your code is generating, the JVM provides mechanisms to inspect it.&lt;/p&gt;

&lt;p&gt;Since I wanted to make it work on my development machine and didn&amp;rsquo;t find something comprehensive for Mac, here is how to do it.&lt;/p&gt;

&lt;p&gt;First, make sure to have a more or less recent JDK installed. Mac ships with Java 6, but I think you want to upgrade to 7. You can grab the JDK packages from &lt;a href=&#34;http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html&#34;&gt;here&lt;/a&gt; if you haven&amp;rsquo;t already.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;~ $ java -version
java version &amp;quot;1.7.0_17&amp;quot;
Java(TM) SE Runtime Environment (build 1.7.0_17-b02)
Java HotSpot(TM) 64-Bit Server VM (build 23.7-b01, mixed mode)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now to enable the ASM output, you need to pass in two flags, namely &lt;code&gt;UnlockDiagnosticVMOptions&lt;/code&gt; and &lt;code&gt;PrintAssembly&lt;/code&gt;. Because the generated ASM is different for each runtime, you need to pass it to the &lt;code&gt;java&lt;/code&gt; command and not &lt;code&gt;javac&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Create a very simple script like this and name it &lt;code&gt;Main.java&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public class Main {
    public static void main(String[] args) {
        System.out.println(&amp;quot;Hello World&amp;quot;);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, we&amp;rsquo;re going to compile and run it with those options:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;michael@daschlbook ~/Downloads/java $ javac Main.java &amp;amp;&amp;amp; java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly Main
Java HotSpot(TM) 64-Bit Server VM warning: PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output
Could not load hsdis-amd64.dylib; library not loadable; PrintAssembly is disabled
Hello World
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Woops, not what we expected. The code did compile properly, but HotSpot complains about &lt;code&gt;hsdis-amd64.dylib&lt;/code&gt;. I had to google a bit to find it, but you can download &lt;a href=&#34;https://kenai.com/projects/base-hsdis/downloads/download/gnu-versions/hsdis-amd64.dylib&#34;&gt;the file&lt;/a&gt; from &lt;a href=&#34;https://kenai.com/projects/base-hsdis/downloads/directory/gnu-versions&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now we need to put it somewhere to make it loadable, and the easiest thing I found is to put it onto &lt;code&gt;LD_LIBRARY_PATH&lt;/code&gt;. Make sure to not override any other settings, but in my case the variable was empty so its straightforward.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export LD_LIBRARY_PATH=~/PathToFile/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you run our command again from before, you should now see &amp;ldquo;beautiful&amp;rdquo; ASM code generated:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;michael@daschlbook ~/Downloads/java $ javac Main.java &amp;amp;&amp;amp; java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly Main
Java HotSpot(TM) 64-Bit Server VM warning: PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output
Loaded disassembler from hsdis-amd64.dylib
Decoding compiled method 0x000000010ac74150:
  0x000000010ac742ba: add   [eax], al
[Disassembling for mach=&#39;i386(base-hsdis)&#39;]
[Entry Point]
[Constants]
  # {method} &#39;hashCode&#39; &#39;()I&#39; in &#39;java/lang/String&#39;
  #           [sp+0x30]  (sp of caller)
  0x000000010ac742a0: inc   esp
  0x000000010ac742a1: mov   edx, [esi+0x8]
  0x000000010ac742a4: dec   ecx
  0x000000010ac742a5: shl   edx, 3
  0x000000010ac742a8: dec   ecx
  0x000000010ac742a9: cmp   eax, edx
  0x000000010ac742ab: jnz   0x000000000ac4ba60  ;   {runtime_call}
  0x000000010ac742b1: nop
  0x000000010ac742b4: invalid   0x0f #size=0
  0x000000010ac742b5: pop   ds
  0x000000010ac742b6: test  [eax], al
  0x000000010ac742b8: add   [eax], al
  0x000000010ac742ba: add   [eax], al
  0x000000010ac742bc: nop
[Verified Entry Point]
  0x000000010ac742c0: mov   [esp-0x14000], eax
  0x000000010ac742c7: push  ebp
  0x000000010ac742c8: dec   eax
  0x000000010ac742c9: sub   esp, 0x0000000000000020
                                                ;*synchronization entry
                                                ; - java.lang.String::hashCode@-1 (line 1446)
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now I guess this is were the real fun starts, happy debugging!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Fun with Couchbase Views and MessagePack</title>
      <link>http://nitschinger.at/Fun-with-Couchbase-Views-and-Message-Pack/</link>
      <pubDate>Tue, 18 Jun 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Fun-with-Couchbase-Views-and-Message-Pack/</guid>
      <description>

&lt;p&gt;Alright, before we start I have to admit that this is a little bit of a hack. Not that it doesn&amp;rsquo;t work, but of course Couchbase Server 2.0 officially only supports JSON documents to be queried through Views. In addition to that, it is not so much known that you have access to all the other documents through Base64 encoding. Recently, &lt;a href=&#34;http://avsej.net/2013/analyzing-binary-data-in-couchbase/&#34;&gt;Sergey&lt;/a&gt; showed us how to very easily analyze binary data in Couchbase Views and this brought me on the idea to take it one step further.&lt;/p&gt;

&lt;p&gt;In this blog post we&amp;rsquo;re going to store &lt;a href=&#34;http://msgpack.org/&#34;&gt;MessagePack&lt;/a&gt; formatted data in Couchbase and then make its content available to Views (and allow us to query it). Note that you don&amp;rsquo;t need to patch Couchbase for this, its just a snippet of JavaScript code that you need to include in your map function. We&amp;rsquo;ll be using Java on the client side here, but nearly every combination of our official SDKs and MessagePack modules works for this.&lt;/p&gt;

&lt;h2 id=&#34;storing-the-data&#34;&gt;Storing the Data&lt;/h2&gt;

&lt;p&gt;In order to store something meaningful we can query later, let&amp;rsquo;s create a Maven project with all needed dependencies. Note that I&amp;rsquo;m assuming you have a Couchbase Server installation running and are familiar with the Couchbase Java SDK (at least a little bit). Also I won&amp;rsquo;t cover the View fundamentals since this is a little advanced topic.&lt;/p&gt;

&lt;p&gt;Here are the required dependencies to start with the fun:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependencies&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;couchbase&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;couchbase-client&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;1.1.7&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
    &amp;lt;dependency&amp;gt;
        &amp;lt;groupId&amp;gt;org.msgpack&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;msgpack&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;0.6.7&amp;lt;/version&amp;gt;
    &amp;lt;/dependency&amp;gt;
&amp;lt;/dependencies&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Also, don&amp;rsquo;t forget that the Couchbase SDK lives in its own repository:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;repository&amp;gt;
    &amp;lt;id&amp;gt;couchbase&amp;lt;/id&amp;gt;
    &amp;lt;name&amp;gt;Couchbase Maven Repository&amp;lt;/name&amp;gt;
    &amp;lt;url&amp;gt;http://files.couchbase.com/maven2/&amp;lt;/url&amp;gt;
    &amp;lt;snapshots&amp;gt;
        &amp;lt;enabled&amp;gt;false&amp;lt;/enabled&amp;gt;
    &amp;lt;/snapshots&amp;gt;
&amp;lt;/repository&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, we can create a simple script that connects to Couchbase, creates some HashMaps with meaningful content, encodes them with the MessagePack encoder and stores them in the database:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import com.couchbase.client.CouchbaseClient;
import org.msgpack.MessagePack;

import java.net.URI;
import java.util.Arrays;
import java.util.HashMap;

public class Main {

  public static void main(String[] args) throws Exception {

    // Connect to Couchbase
    CouchbaseClient cb = new CouchbaseClient(Arrays.asList(new URI(&amp;quot;http://127.0.0.1:8091/pools&amp;quot;)), &amp;quot;default&amp;quot;, &amp;quot;&amp;quot;);

    // Init MessagePack
    MessagePack msgpack = new MessagePack();

    // Create a few Documents with some content
    HashMap&amp;lt;String, String&amp;gt; user1 = new HashMap&amp;lt;String, String&amp;gt;();
    user1.put(&amp;quot;firstname&amp;quot;, &amp;quot;Michael&amp;quot;);
    user1.put(&amp;quot;lastname&amp;quot;, &amp;quot;Nitschinger&amp;quot;);

    HashMap&amp;lt;String, String&amp;gt; user2 = new HashMap&amp;lt;String, String&amp;gt;();
    user2.put(&amp;quot;firstname&amp;quot;, &amp;quot;Matt&amp;quot;);
    user2.put(&amp;quot;lastname&amp;quot;, &amp;quot;Ingenthron&amp;quot;);

    HashMap&amp;lt;String, String&amp;gt; user3 = new HashMap&amp;lt;String, String&amp;gt;();
    user3.put(&amp;quot;firstname&amp;quot;, &amp;quot;Sergey&amp;quot;);
    user3.put(&amp;quot;lastname&amp;quot;, &amp;quot;Avseyev&amp;quot;);

    // Encode and store them
    cb.set(&amp;quot;user:michael&amp;quot;, msgpack.write(user1)).get();
    cb.set(&amp;quot;user:matt&amp;quot;, msgpack.write(user2)).get();
    cb.set(&amp;quot;user:sergey&amp;quot;, msgpack.write(user3)).get();

    // Close the Connection
    cb.shutdown();
  }

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The only new part to Couchbase folks is the &amp;ldquo;MessagePack&amp;rdquo; code. You create a new instance of &lt;code&gt;MessagePack&lt;/code&gt; and then pass the data to the &lt;code&gt;write&lt;/code&gt; method. I&amp;rsquo;m not an expert on this library, but it looks like you can also make it work with generic POJOs, which would be something to look into if you model an actual application with it.&lt;/p&gt;

&lt;h2 id=&#34;querying-the-data&#34;&gt;Querying the Data&lt;/h2&gt;

&lt;p&gt;Now if we run the code, we&amp;rsquo;ll see that three documents have been persisted, but they show up as binary. That&amp;rsquo;s because its not JSON and kind of expected. Now, go create a View on your bucket and start out with an empty map function like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;function(doc, meta) {
  emit(doc, null);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you query it, you&amp;rsquo;ll see the document keys emitted like &lt;code&gt;gqhsYXN0bmFtZadBdnNleWV2qWZpcnN0bmFtZaZTZXJnZXk&lt;/code&gt;, which is &lt;a href=&#34;http://en.wikipedia.org/wiki/Base64&#34;&gt;Base64&lt;/a&gt; encoding. Now, let&amp;rsquo;s change the view function a bit and use the built-in &lt;code&gt;decodeBase64&lt;/code&gt; method:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;function(doc, meta) {
  emit(decodeBase64(doc), null);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now your output looks more like &lt;code&gt;[130,168,108,97,115,116,110,97,109,...121]&lt;/code&gt;, which is the native format of MessagePack! You would also see the same output if you take the result of &lt;code&gt;msgpack.write()&lt;/code&gt; and print out the byte array properly.&lt;/p&gt;

&lt;p&gt;The first step is done, we have direct access to the stored data. Now we need to decode it. The good news is that there is a JavaScript library for MessagePack, but it doesn&amp;rsquo;t work out of the box with our view code. The library does lots of browser stuff which we don&amp;rsquo;t have in the environment. &lt;a href=&#34;https://raw.github.com/msgpack/msgpack-javascript/master/msgpack.js&#34;&gt;here&lt;/a&gt; is the link to the original library.&lt;/p&gt;

&lt;p&gt;Now, after some fiddling with the code and removing unneeded parts (but actually not changing how it works), I ended up with something that works. You can go ahead and grab the full snippet &lt;a href=&#34;https://gist.github.com/daschl/5796263&#34;&gt;here&lt;/a&gt;. Personally, I prefer to have my map functions short and sweet, so here is the same code, but &lt;a href=&#34;https://gist.github.com/daschl/5796268&#34;&gt;minified&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now, we can plug this code into our map function and use the method to decode our data on the fly:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;function(doc, meta) {
    /*!{id:msgpack.js,ver:1.05,license:&amp;quot;MIT&amp;quot;,author:&amp;quot;uupaa.js@gmail.com&amp;quot;}*/
    /* Modified by @daschl and @avsej to strip out whats not needed */
    var msgunpack=function(){function k(){var g,d,e,b=0,f,h,c=m;d=c[++a];if(224&amp;lt;=d)return d-256;if(192&amp;gt;d){if(128&amp;gt;d)return d;144&amp;gt;d?(b=d-128,d=128):160&amp;gt;d?(b=d-144,d=144):(b=d-160,d=160)}switch(d){case 192:return null;case 194:return!1;case 195:return!0;case 202:return b=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16)+(c[++a]&amp;lt;&amp;lt;8)+c[++a],f=b&amp;gt;&amp;gt;23&amp;amp;255,h=b&amp;amp;8388607,!b||2147483648===b?0:255===f?h?NaN:Infinity:(b&amp;amp;2147483648?-1:1)*(h|8388608)*Math.pow(2,f-127-23);case 203:b=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16)+(c[++a]&amp;lt;&amp;lt;8)+c[++a];d=b&amp;amp;2147483648;
    f=b&amp;gt;&amp;gt;20&amp;amp;2047;h=b&amp;amp;1048575;if(!b||2147483648===b)return a+=4,0;if(2047===f)return a+=4,h?NaN:Infinity;b=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16)+(c[++a]&amp;lt;&amp;lt;8)+c[++a];return(d?-1:1)*((h|1048576)*Math.pow(2,f-1023-20)+b*Math.pow(2,f-1023-52));case 207:return b=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16)+(c[++a]&amp;lt;&amp;lt;8)+c[++a],4294967296*b+16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16)+(c[++a]&amp;lt;&amp;lt;8)+c[++a];case 206:b+=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16);case 205:b+=c[++a]&amp;lt;&amp;lt;8;case 204:return b+c[++a];case 211:return b=c[++a],b&amp;amp;128?-1*(72057594037927936*(b^255)+
    281474976710656*(c[++a]^255)+1099511627776*(c[++a]^255)+4294967296*(c[++a]^255)+16777216*(c[++a]^255)+65536*(c[++a]^255)+256*(c[++a]^255)+(c[++a]^255)+1):72057594037927936*b+281474976710656*c[++a]+1099511627776*c[++a]+4294967296*c[++a]+16777216*c[++a]+65536*c[++a]+256*c[++a]+c[++a];case 210:return b=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16)+(c[++a]&amp;lt;&amp;lt;8)+c[++a],2147483648&amp;gt;b?b:b-4294967296;case 209:return b=(c[++a]&amp;lt;&amp;lt;8)+c[++a],32768&amp;gt;b?b:b-65536;case 208:return b=c[++a],128&amp;gt;b?b:b-256;case 219:b+=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;
    16);case 218:b+=(c[++a]&amp;lt;&amp;lt;8)+c[++a];case 160:f=[];d=a;for(g=d+b;d&amp;lt;g;)e=c[++d],f.push(128&amp;gt;e?e:224&amp;gt;e?(e&amp;amp;31)&amp;lt;&amp;lt;6|c[++d]&amp;amp;63:(e&amp;amp;15)&amp;lt;&amp;lt;12|(c[++d]&amp;amp;63)&amp;lt;&amp;lt;6|c[++d]&amp;amp;63);a=d;return 10240&amp;gt;f.length?l.apply(null,f):n(f);case 223:b+=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16);case 222:b+=(c[++a]&amp;lt;&amp;lt;8)+c[++a];case 128:for(h={};b--;){g=c[++a]-160;f=[];d=a;for(g=d+g;d&amp;lt;g;)e=c[++d],f.push(128&amp;gt;e?e:224&amp;gt;e?(e&amp;amp;31)&amp;lt;&amp;lt;6|c[++d]&amp;amp;63:(e&amp;amp;15)&amp;lt;&amp;lt;12|(c[++d]&amp;amp;63)&amp;lt;&amp;lt;6|c[++d]&amp;amp;63);a=d;h[l.apply(null,f)]=k()}return h;case 221:b+=16777216*c[++a]+(c[++a]&amp;lt;&amp;lt;16);case 220:b+=
    (c[++a]&amp;lt;&amp;lt;8)+c[++a];case 144:for(f=[];b--;)f.push(k());return f}}function n(a){try{return l.apply(this,a)}catch(d){}for(var e=[],b=0,f=a.length,h=p;b&amp;lt;f;++b)e[b]=h[a[b]];return e.join(&amp;quot;&amp;quot;)}var j={},p={},m=[],a=0,l=String.fromCharCode;return function(g){var d;if(&amp;quot;string&amp;quot;===typeof g){d=[];var e=g.split(&amp;quot;&amp;quot;),b=-1,f;f=e.length;for(g=f%8;g--;)++b,d[b]=j[e[b]];for(g=f&amp;gt;&amp;gt;3;g--;)d.push(j[e[++b]],j[e[++b]],j[e[++b]],j[e[++b]],j[e[++b]],j[e[++b]],j[e[++b]],j[e[++b]])}else d=g;m=d;a=-1;return k()}}();

    var obj = msgunpack(decodeBase64(doc));
    if(obj.firstname) {
        emit(obj.firstname, null);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This map function decodes our MessagePack data and just emits the value with key &amp;ldquo;firstname&amp;rdquo;. Once you query this view, you&amp;rsquo;ll see stuff like this emitted:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
    total_rows: 3,
    rows: [{
        id: &amp;quot;user:matt&amp;quot;,
        key: &amp;quot;Matt&amp;quot;,
        value: null
    },{
        id: &amp;quot;user:michael&amp;quot;,
        key: &amp;quot;Michael&amp;quot;,
        value: null
    },{
        id: &amp;quot;user:sergey&amp;quot;,
        key: &amp;quot;Sergey&amp;quot;,
        value: null
    }]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Isn&amp;rsquo;t that lovely? We can now query this view from our Java SDK and use the MessagePack decoding facilities to retrieve the full documents as needed:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// Query View
View view = cb.getView(&amp;quot;designname&amp;quot;, &amp;quot;viewname&amp;quot;);
ViewResponse response = cb.query(view, new Query().setIncludeDocs(true));

// Iterate and load full documents
for (ViewRow row : response) {
  System.out.println(msgpack.read((byte[]) row.getDocument()));
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the console, you&amp;rsquo;ll see the full document content:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{&amp;quot;lastname&amp;quot;:&amp;quot;Ingenthron&amp;quot;,&amp;quot;firstname&amp;quot;:&amp;quot;Matt&amp;quot;}
{&amp;quot;lastname&amp;quot;:&amp;quot;Nitschinger&amp;quot;,&amp;quot;firstname&amp;quot;:&amp;quot;Michael&amp;quot;}
{&amp;quot;lastname&amp;quot;:&amp;quot;Avseyev&amp;quot;,&amp;quot;firstname&amp;quot;:&amp;quot;Sergey&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Of course, feel free to use all the well-known query mechanisms for Views.&lt;/p&gt;

&lt;h2 id=&#34;benefits-anyone&#34;&gt;Benefits, anyone?&lt;/h2&gt;

&lt;p&gt;Now one could argue that this is nice to play around with, but what do I actually gain from it? Arguably, there is more work included for the developer, and maybe for the Server side as well.&lt;/p&gt;

&lt;p&gt;MessagePack makes bold claims that its faster and smaller than JSON, so lets try to verify this in our environment.&lt;/p&gt;

&lt;p&gt;To verify the size argument, let&amp;rsquo;s go ahead and create 1M docs with a &amp;ldquo;reasonable&amp;rdquo; size and store them both through JSON and MessagePack. Since the overhead for each document is static inside Couchbase Server, we can very easily see how much RAM is used to hold the documents and conclude on the size difference (which is what matters at the end).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;int numdocs = 1000000;
HashMap&amp;lt;String, Object&amp;gt; user = new HashMap&amp;lt;String, Object&amp;gt;();
user.put(&amp;quot;firstname&amp;quot;, &amp;quot;Michael&amp;quot;);
user.put(&amp;quot;lastname&amp;quot;, &amp;quot;Nitschinger&amp;quot;);
user.put(&amp;quot;age&amp;quot;, 25);
user.put(&amp;quot;loggedIn&amp;quot;, false);
user.put(&amp;quot;active&amp;quot;, true);

for (int i = 0; i &amp;lt; numdocs; i++) {
  cb.set(&amp;quot;user:&amp;quot; + i, msgpack.write(user)).get();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For 1M documents on my machine with Couchbase Server 2.0, the amount of RAM used is 166MB. Now, let&amp;rsquo;s do the same with JSON. I&amp;rsquo;m going to use &lt;a href=&#34;https://code.google.com/p/google-gson/&#34;&gt;Google GSON&lt;/a&gt; to convert the HashMap:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;int numdocs = 1000000;
HashMap&amp;lt;String, Object&amp;gt; user = new HashMap&amp;lt;String, Object&amp;gt;();
user.put(&amp;quot;firstname&amp;quot;, &amp;quot;Michael&amp;quot;);
user.put(&amp;quot;lastname&amp;quot;, &amp;quot;Nitschinger&amp;quot;);
user.put(&amp;quot;age&amp;quot;, 25);
user.put(&amp;quot;loggedIn&amp;quot;, false);
user.put(&amp;quot;active&amp;quot;, true);

for (int i = 0; i &amp;lt; numdocs; i++) {
  cb.set(&amp;quot;user:&amp;quot; + i, gson.toJson(user)).get();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After inserting those 1M JSON records, Couchbase Server reported exactly 198MB of RAM used! So the difference is 32MB (1/5th of the total data size), or 32 byte per document. That pays off if you have lots of records in your cluster! After doubling the content of the HashMap and storing twice as many documents (2M) MessagePack is ahead of raw JSON by around 96MB. That&amp;rsquo;s another 400K documents you could store (one document is around 230 bytes compared to 285 with raw JSON).&lt;/p&gt;

&lt;p&gt;Of course, YMMV depending on the number and size of the documents. I&amp;rsquo;m curious if you could do the same runs on your real workload and see by how much you could improve.&lt;/p&gt;

&lt;p&gt;Now, before we talk about RAW encoding/decoding performance, we also need to look into the overhead involved on the server side. Storing and retreiving documents is not slower than any other document, because the server doesn&amp;rsquo;t need to do anything special. The only overhead I can think of is that during index creation, more CPU will be consumed because you execute more JavaScript logic. I guess this CPU overhead increases with the document sizes, but I don&amp;rsquo;t have any actual numbers to share here. Personally, I&amp;rsquo;d use the [sizing]() guidelines for Views and maybe add some more CPU just to be safe. It&amp;rsquo;s important to note that at query time, you won&amp;rsquo;t see a difference between JSON and MessagePack, because the index is already created.&lt;/p&gt;

&lt;p&gt;Congratulations if you followed to this point! As a bonus, we&amp;rsquo;ll look into the raw encoding/decoding performance of JSON and MessagePack on the JVM. Since there are lots of JSON libraries out there, we&amp;rsquo;re going to use &lt;a href=&#34;http://jackson.codehaus.org/&#34;&gt;Jackson&lt;/a&gt; and Google GSON. Benchmarking on the JVM is not a trivial task, so I&amp;rsquo;ll do my best to keep it objective and we&amp;rsquo;re going to use &lt;a href=&#34;https://code.google.com/p/caliper/&#34;&gt;Google Caliper&lt;/a&gt; to handle things like JVM warmup. Make sure to add everything to your &lt;code&gt;pom.xml&lt;/code&gt; like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;org.msgpack&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;msgpack&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;0.6.7&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.google.code.gson&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;gson&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;2.2.4&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.google.caliper&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;caliper&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;1.0-beta-1&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.google.code.java-allocation-instrumenter&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;java-allocation-instrumenter&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;2.1&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;com.fasterxml.jackson.core&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;jackson-databind&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;2.2.2&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In this simple benchmark, we are only testing smaller and slightly larger &lt;code&gt;HashMap&lt;/code&gt;s. I know that this test is not conclusive, but it should give you a starting point from where you can do your own research.&lt;/p&gt;

&lt;p&gt;To write a Caliper benchmark, you need to extend the &lt;code&gt;Benchmark&lt;/code&gt; class from the caliper package. its as simple as this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public class EncodingBenchmark extends Benchmark {

  private final Gson gson = new Gson();
  private final MessagePack msgpack = new MessagePack();
  private final ObjectMapper mapper = new ObjectMapper();

  private HashMap&amp;lt;String, Object&amp;gt; smallMap;
  private HashMap&amp;lt;String, Object&amp;gt; largeMap;

  @Override
  protected void setUp() {
    smallMap = new HashMap&amp;lt;String, Object&amp;gt;();
    smallMap.put(&amp;quot;firstname&amp;quot;, &amp;quot;Foo&amp;quot;);
    smallMap.put(&amp;quot;lastname&amp;quot;, &amp;quot;bar&amp;quot;);
    smallMap.put(&amp;quot;active&amp;quot;, false);

    largeMap = new HashMap&amp;lt;String, Object&amp;gt;();
    largeMap.put(&amp;quot;firstname&amp;quot;, &amp;quot;Foo&amp;quot;);
    largeMap.put(&amp;quot;lastname&amp;quot;, &amp;quot;bar&amp;quot;);
    largeMap.put(&amp;quot;active&amp;quot;, false);
    largeMap.put(&amp;quot;firstname1&amp;quot;, &amp;quot;Foo&amp;quot;);
    largeMap.put(&amp;quot;lastname1&amp;quot;, &amp;quot;bar&amp;quot;);
    largeMap.put(&amp;quot;active1&amp;quot;, false);
    largeMap.put(&amp;quot;firstname2&amp;quot;, &amp;quot;Foo&amp;quot;);
    largeMap.put(&amp;quot;lastname2&amp;quot;, &amp;quot;bar&amp;quot;);
    largeMap.put(&amp;quot;active2&amp;quot;, false);
    largeMap.put(&amp;quot;firstname3&amp;quot;, &amp;quot;Foo&amp;quot;);
    largeMap.put(&amp;quot;lastname3&amp;quot;, &amp;quot;bar&amp;quot;);
    largeMap.put(&amp;quot;active3&amp;quot;, false);
  }

  public void timeMessagePackSmall(final int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      msgpack.write(smallMap);
    }
  }

  public void timeGoogleGsonSmall(int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      gson.toJson(smallMap);
    }
  }

  public void timeJacksonSmall(int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      mapper.writeValueAsString(smallMap);
    }
  }
  public void timeJsonSmartSmall(int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      mapper.writeValueAsString(smallMap);
    }
  }

  public void timeMessagePackLarge(final int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      msgpack.write(largeMap);
    }
  }

  public void timeGoogleGsonLarge(int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      gson.toJson(largeMap);
    }
  }

  public void timeJacksonLarge(int reps) throws Exception {
    for (int i = 0; i &amp;lt; reps; i++) {
      mapper.writeValueAsString(largeMap);
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;First, we create our converter instances (for MessagePack, GSON and Jackson) and the HashMaps. All the runs in this benchmark are executed by Caliper. We need to modify our &lt;code&gt;main&lt;/code&gt; class to load the wrapper:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import business.MsgpackBenchmark;
import com.google.caliper.runner.CaliperMain;

public class Main {
  public static void main(String[] args) throws Exception {
    CaliperMain.main(EncodingBenchmark.class, args);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now if you run this in your IDE, you&amp;rsquo;ll see some logging going on:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Experiment selection: 
  Instruments:   [allocation, micro]
  User parameters:   {}
  Virtual machines:  [default]
  Selection type:    Full cartesian product

This selection yields 12 experiments.
Starting experiment 1 of 12: {instrument=allocation, method=GoogleGsonLarge, vm=default, parameters={}}
Complete!
Starting experiment 2 of 12: {instrument=allocation, method=GoogleGsonSmall, vm=default, parameters={}}
Complete!
Starting experiment 3 of 12: {instrument=allocation, method=JacksonLarge, vm=default, parameters={}}
Complete!
Starting experiment 4 of 12: {instrument=allocation, method=JacksonSmall, vm=default, parameters={}}
Complete!
...
Starting experiment 11 of 12: {instrument=micro, method=MessagePackLarge, vm=default, parameters={}}
Complete!
Starting experiment 12 of 12: {instrument=micro, method=MessagePackSmall, vm=default, parameters={}}
Complete!

Execution complete: 7.058m.
Collected 162 measurements from:
  2 instrument(s)
  1 virtual machine(s)
  6 benchmark(s)
Results have been uploaded. View them at: https://microbenchmarks.appspot.com/runs/f25820e0-08dd-43f8-833e-e44847400f19
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once finished, Caliper even uploaded your results to a webpage (so make sure to have internet connection)! Note that if you see &amp;ldquo;GC errors&amp;rdquo; during your runs, it may be good to retry and if they still persist, consider increasing your heap size a bit. I don&amp;rsquo;t know for how long the data is held on the web page, but &lt;a href=&#34;https://microbenchmarks.appspot.com/runs/f25820e0-08dd-43f8-833e-e44847400f19#r:scenario.benchmarkSpec.methodName&#34;&gt;here&lt;/a&gt; are my results.&lt;/p&gt;

&lt;p&gt;At least in my benchmarks I found that libraries like Jackson outperform MessagePack by a large amount when encoding &lt;code&gt;HashMap&lt;/code&gt;s. Maybe it&amp;rsquo;s different with other data types and sizes though.&lt;/p&gt;

&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;I hope this blog post was a fun introduction and showed what&amp;rsquo;s possible with Couchbase Server 2.0 and its new View engine. I found that MessagePack really saves you a good amount of bytes on the wire (and on the server), but is much slower on the JVM when it comes to encoding data (here &lt;code&gt;HashMap&lt;/code&gt;s).&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>A Couchbase Cluster in Minutes with Vagrant and Puppet</title>
      <link>http://nitschinger.at/A-Couchbase-Cluster-in-Minutes-with-Vagrant-and-Puppet/</link>
      <pubDate>Mon, 27 May 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/A-Couchbase-Cluster-in-Minutes-with-Vagrant-and-Puppet/</guid>
      <description>

&lt;h2 id=&#34;motivation&#34;&gt;Motivation&lt;/h2&gt;

&lt;p&gt;Since I work as part of the engineering team at Couchbase, I need to run my code against a variety of server deployments. We run a multitude of operating systems and software versions, and so do our customers. In order to fix bugs reliably and build new features, it is critical to get a cluster up and running that resembles these deployments as good as possible. I know that I can run all of these combinations on EC2, but the cost for this would be very high and most of the time its overkill.&lt;/p&gt;

&lt;p&gt;What I need is to get such a cluster up and running in minutes and not spending too much time on configuring it. I heard about &lt;a href=&#34;http://www.vagrantup.com/&#34;&gt;Vagrant&lt;/a&gt; and &lt;a href=&#34;https://puppetlabs.com/&#34;&gt;Puppet&lt;/a&gt; in the past, but never got around to use them on my own box (though I always use &lt;a href=&#34;https://www.virtualbox.org/&#34;&gt;VirtualBox&lt;/a&gt; on MacOS to create virtual machines by hand).&lt;/p&gt;

&lt;p&gt;This morning I sat down to take a closer look on how these tools can help me to get more productive - and to my huge surprise I got a 4 node Couchbase Server cluster running in less than 30 minutes (with looking up all the configuration details). Since its so easy, I want to share it with you.&lt;/p&gt;

&lt;h2 id=&#34;prerequisites&#34;&gt;Prerequisites&lt;/h2&gt;

&lt;p&gt;Before we can provision our nodes, you need to make sure to have Vagrant and VirtualBox installed. If you use MacOS like me, just download the &lt;code&gt;.dmg&lt;/code&gt; files for both and you&amp;rsquo;re set. Now, create a directory somewhere to store the configuration files - I called mine &amp;lsquo;vagrants&amp;rsquo;.&lt;/p&gt;

&lt;p&gt;In this directory, you need to create a &lt;code&gt;Vagrantfile&lt;/code&gt;. Its like the Vagrants &lt;code&gt;makefile&lt;/code&gt; and it will pick it up to learn how you want to have your nodes provisioned. Note that this doesn&amp;rsquo;t configure the software on top of the OS (like installing Couchbase), this is handled by puppet in a separate step. Here is the full config:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Vagrant.configure(&amp;quot;2&amp;quot;) do |config|

    # Number of nodes to provision
    numNodes = 4

    # IP Address Base for private network
    ipAddrPrefix = &amp;quot;192.168.56.10&amp;quot;

    # Define Number of RAM for each node
    config.vm.provider &amp;quot;virtualbox&amp;quot; do |v|
        v.customize [&amp;quot;modifyvm&amp;quot;, :id, &amp;quot;--memory&amp;quot;, 1024]
    end

    # Provision the server itself with puppet
    config.vm.provision :puppet

    # Download the initial box from this url
    config.vm.box_url = &amp;quot;http://files.vagrantup.com/precise64.box&amp;quot;

    # Provision Config for each of the nodes
    1.upto(numNodes) do |num|
        nodeName = (&amp;quot;node&amp;quot; + num.to_s).to_sym
        config.vm.define nodeName do |node|
            node.vm.box = &amp;quot;precise64&amp;quot;
            node.vm.network :private_network, ip: ipAddrPrefix + num.to_s
            node.vm.provider &amp;quot;virtualbox&amp;quot; do |v|
                v.name = &amp;quot;Couchbase Server Node &amp;quot; + num.to_s
            end
        end
    end

end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This file is just ruby code that configures Vagrant. Let&amp;rsquo;s go through each directive and see what it does for us.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Number of nodes to provision
numNodes = 4

# IP Address Base for private network
ipAddrPrefix = &amp;quot;192.168.56.10&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can change these values, I just created them to fit my environment here. Depending on the amount of &lt;code&gt;numNodes&lt;/code&gt; set, VMs will be created. I added a loop down below depending on this setting, so I don&amp;rsquo;t have to duplicate code a lot. The ip address prefix is used to easily determine the (static) IP address for the server. The numbers will be counted upwards incrementally, so you will end up with four servers accessible through &lt;code&gt;192.168.56.101&lt;/code&gt; to &lt;code&gt;192.168.56.104&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Define Number of RAM for each node
config.vm.provider &amp;quot;virtualbox&amp;quot; do |v|
    v.customize [&amp;quot;modifyvm&amp;quot;, :id, &amp;quot;--memory&amp;quot;, 1024]
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This config block is needed to increase the memory size of the VM. By default its less than that (I believe around 512MB), and I want to have 1 gig of RAM for each. Of course, feel free to tune that value or remove it completely.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Provision the server itself with puppet
config.vm.provision :puppet
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Because we&amp;rsquo;ll be using puppet to provision the server software, we need to tell Vagrant to use it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Download the initial box from this url
config.vm.box_url = &amp;quot;http://files.vagrantup.com/precise64.box&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Vagrant reuses predefined images so you don&amp;rsquo;t have to reinstall everything from scratch. Here we use a predefined Ubuntu 12.04 64bit box.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Provision Config for each of the nodes
1.upto(numNodes) do |num|
    nodeName = (&amp;quot;node&amp;quot; + num.to_s).to_sym
    config.vm.define nodeName do |node|
        node.vm.box = &amp;quot;precise64&amp;quot;
        node.vm.network :private_network, ip: ipAddrPrefix + num.to_s
        node.vm.provider &amp;quot;virtualbox&amp;quot; do |v|
            v.name = &amp;quot;Couchbase Server Node &amp;quot; + num.to_s
        end
    end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This code block configures each virtual machine. Given the number of nodes we want to create, for each of them it assigns an IP address and gives it a descriptive name inside Virtualbox. If you want to add server-dependent settings, the &amp;ldquo;node&amp;rdquo; block is the right place for it. Otherwise it will pick the cluster wide settings defined in the &amp;ldquo;config&amp;rdquo; block.&lt;/p&gt;

&lt;p&gt;Now if we would run &lt;code&gt;vagrant up&lt;/code&gt; from the command line in this directory, we&amp;rsquo;d get four Ubuntu machines setup where we could SSH into, but nothing else would be installed. In order to make them do something, we want to install Couchbase Server. Puppet is a system automation software and very good at provisioning systems. Vagrant has amazing support for it, all we need to is create a &lt;code&gt;default.pp&lt;/code&gt; file inside a &lt;code&gt;manifests&lt;/code&gt; directory that looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exec { &amp;quot;couchbase-server-source&amp;quot;: 
    command =&amp;gt; &amp;quot;/usr/bin/wget http://packages.couchbase.com/releases/2.0.1/couchbase-server-enterprise_x86_64_2.0.1.deb&amp;quot;,
    cwd =&amp;gt; &amp;quot;/home/vagrant/&amp;quot;,
    creates =&amp;gt; &amp;quot;/home/vagrant/couchbase-server-enterprise_x86_64_2.0.1.deb&amp;quot;,
    before =&amp;gt; Package[&#39;couchbase-server&#39;]
}

exec { &amp;quot;install-deps&amp;quot;:
    command =&amp;gt; &amp;quot;/usr/bin/apt-get install libssl0.9.8&amp;quot;,
    before =&amp;gt; Package[&#39;couchbase-server&#39;]
}

package { &amp;quot;couchbase-server&amp;quot;:
    provider =&amp;gt; dpkg,
    ensure =&amp;gt; installed,
    source =&amp;gt; &amp;quot;/home/vagrant/couchbase-server-enterprise_x86_64_2.0.1.deb&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s go over the internals once more.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exec { &amp;quot;couchbase-server-source&amp;quot;: 
    command =&amp;gt; &amp;quot;/usr/bin/wget http://packages.couchbase.com/releases/2.0.1/couchbase-server-enterprise_x86_64_2.0.1.deb&amp;quot;,
    cwd =&amp;gt; &amp;quot;/home/vagrant/&amp;quot;,
    creates =&amp;gt; &amp;quot;/home/vagrant/couchbase-server-enterprise_x86_64_2.0.1.deb&amp;quot;,
    before =&amp;gt; Package[&#39;couchbase-server&#39;]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In puppet, we define some tasks that we want to run. This task executes a shell command &lt;code&gt;wget&lt;/code&gt; and stores the file inside the home directory of the user. We tell puppet to download the debian package of the server. Note that there is a &lt;code&gt;before&lt;/code&gt; dependency to the package installation task, because we can&amp;rsquo;t install it before the file wasn&amp;rsquo;t downloaded.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exec { &amp;quot;install-deps&amp;quot;:
    command =&amp;gt; &amp;quot;/usr/bin/apt-get install libssl0.9.8&amp;quot;,
    before =&amp;gt; Package[&#39;couchbase-server&#39;]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We also need to install &lt;code&gt;libssl0.9.8&lt;/code&gt; on the server, this is the only dependency it has. We use the command line tool &lt;code&gt;apt-get&lt;/code&gt; for this.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package { &amp;quot;couchbase-server&amp;quot;:
    provider =&amp;gt; dpkg,
    ensure =&amp;gt; installed,
    source =&amp;gt; &amp;quot;/home/vagrant/couchbase-server-enterprise_x86_64_2.0.1.deb&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finally, we can install the debian package from couchbase-server, because the file is in place and all dependencies are satisfied.&lt;/p&gt;

&lt;p&gt;Of course, this puppet file is very simple and I&amp;rsquo;m you can do much more with it (and maybe even simplify it more) - but for my needs it is more than enough. If I want a different server version, I just need to change the puppet file and point it to the new debian package.&lt;/p&gt;

&lt;p&gt;Now if we run &lt;code&gt;vagrant up&lt;/code&gt; again, much more happens. Note that if you want to play with your puppet files, you can also use &lt;code&gt;vagrant provision&lt;/code&gt; to apply the changes while the node is running.&lt;/p&gt;

&lt;p&gt;If everything is okay, the output should look like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Bringing machine &#39;node1&#39; up with &#39;virtualbox&#39; provider...
Bringing machine &#39;node2&#39; up with &#39;virtualbox&#39; provider...
Bringing machine &#39;node3&#39; up with &#39;virtualbox&#39; provider...
Bringing machine &#39;node4&#39; up with &#39;virtualbox&#39; provider...
[node1] Clearing any previously set forwarded ports...
[node1] Creating shared folders metadata...
[node1] Clearing any previously set network interfaces...
[node1] Preparing network interfaces based on configuration...
[node1] Forwarding ports...
[node1] -- 22 =&amp;gt; 2222 (adapter 1)
[node1] Running any VM customizations...
[node1] Booting VM...
[node1] Waiting for VM to boot. This can take a few minutes.
[node1] VM booted and ready for use!
[node1] Configuring and enabling network interfaces...
[node1] Mounting shared folders...
[node1] -- /vagrant
[node1] -- /tmp/vagrant-puppet/manifests
[node1] Running provisioner: puppet...
Running Puppet with default.pp...
stdin: is not a tty
notice: /Stage[main]//Exec[install-deps]/returns: executed successfully
notice: Finished catalog run in 0.77 seconds
.... more for all the other nodes.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can then point your browser to &lt;code&gt;192.168.56.10[1-4]&lt;/code&gt; and work with your Couchbase cluster. If you are done with it, you can use the &lt;code&gt;vagrant halt&lt;/code&gt; command to shut it down cleanly. Very handy is also &lt;code&gt;vagrant suspend&lt;/code&gt;, which will save the state of the nodes instead of shutting them down completely.&lt;/p&gt;

&lt;p&gt;If you want to interact with one of the nodes instead of the whole cluster, you can always specify the node identifier. For example, if you want to start only the first node you can do it with the &lt;code&gt;vagrant up node1&lt;/code&gt; command.&lt;/p&gt;

&lt;p&gt;To me, this is a very fast and clean way to provision server nodes. I just need to change a few lines in a file and get a new cluster without much hassle. Even more important, I can put those config files in version control and &lt;a href=&#34;https://github.com/daschl/vagrants&#34;&gt;share them&lt;/a&gt; with other folks!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Logging with the Couchbase Java Client</title>
      <link>http://nitschinger.at/Logging-with-the-Couchbase-Java-Client/</link>
      <pubDate>Thu, 16 May 2013 00:00:00 +0000</pubDate>
      
      <guid>http://nitschinger.at/Logging-with-the-Couchbase-Java-Client/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;There is a huge variety in logging frameworks for Java, and its hard to please everyone. To understand how logging is currently handled in the SDK, we have to go back a few years. As you may know, the SDK depends on the &lt;a href=&#34;https://code.google.com/p/spymemcached/&#34;&gt;spymemcached&lt;/a&gt; library and therefore also inherits its logging mechanisms. Back in the days when &lt;a href=&#34;https://twitter.com/dlsspy&#34;&gt;@dustin&lt;/a&gt; wrote spy, there was no good abstraction for logging available (like SLF4J), so he wrote his own. Nowadays things have changed, but spy still inherits this legacy.&lt;/p&gt;

&lt;p&gt;At the time of writing, the SDK supports logging to a simple default logger (logs to STDERR from INFO level up), &lt;a href=&#34;http://logging.apache.org/log4j/1.2/&#34;&gt;Log4J&lt;/a&gt; and the SunLogger (java.util.logging). In the upcoming 2.9.0 release of spymemcached, it will also support the SLF4J logging facade where you can plug in your own implementation. The next version of the SDK (most likely 1.1.7) will depend on spy 2.9, so you&amp;rsquo;ll also get the benefits there.&lt;/p&gt;

&lt;p&gt;Before we dig into the concepts, here are the supported Log Levels (defined by &lt;code&gt;net.spy.memcached.compat.log.Level&lt;/code&gt;):&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;TRACE (with 2.9)&lt;/li&gt;
&lt;li&gt;DEBUG&lt;/li&gt;
&lt;li&gt;INFO&lt;/li&gt;
&lt;li&gt;WARN&lt;/li&gt;
&lt;li&gt;ERROR&lt;/li&gt;
&lt;li&gt;FATAL&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Keep in mind that different loggers implement different levels, so for some of them a mapping needs top happen. This will be noted during the descriptions of each implementation.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;ll now look at the different logging mechanisms available and how you can configure them. SLF4J will be covered towards the end.&lt;/p&gt;

&lt;h2 id=&#34;switching-logging&#34;&gt;Switching Logging&lt;/h2&gt;

&lt;p&gt;If you don&amp;rsquo;t change anything, the default logger will be used. This mechanism just prints log messages to STDERR (from INFO level upwards). Chances are that you want to integrate the SDK with the same logging library that you use as well. The LoggerFactory inside spy decides at construction which one to choose, based on a system property. So you can either change this programmatically or through a param to the &lt;code&gt;java&lt;/code&gt; command.&lt;/p&gt;

&lt;p&gt;If you want to use the Log4JLogger programmatically, do it this way (before initializing the &lt;code&gt;CouchbaseClient&lt;/code&gt; object):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.Log4JLogger&amp;quot;);
System.setProperties(systemProperties);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Of course, you need to add the Log4J JAR to your CLASSPATH to make it work (as we&amp;rsquo;ll see later). Alternatively, you can set it this way on the comman dline:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;java -Dnet.spy.log.LoggerImpl=net.spy.memcached.compat.log.Log4JLogger ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we know how to enable the different implementations, let&amp;rsquo;s look at them in greater detail.&lt;/p&gt;

&lt;h2 id=&#34;the-simple-default-logger&#34;&gt;The Simple Default Logger&lt;/h2&gt;

&lt;p&gt;If you don&amp;rsquo;t change anything, the SDK will use the DefaultLogger (net.spy.memcached.compat.log.DefaultLogger). This logger has no dependencies and prints every log message that is INFO level or higher (INFO, WARN, ERROR and FATAL) to the systems STDERR. Since the STDERR is covered by most IDEs automatically, you&amp;rsquo;ll also see them in the console output window.&lt;/p&gt;

&lt;p&gt;Since its so simple, you can&amp;rsquo;t customize this behavior. Every log message gets timestamped as well (the format is &lt;code&gt;yyyy-MM-dd HH:mm:ss.SSS&lt;/code&gt;). Connecting to Couchbase commonly looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;2013-05-07 12:28:41.852 INFO com.couchbase.client.CouchbaseConnection:  Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
2013-05-07 12:28:41.862 INFO com.couchbase.client.CouchbaseConnection:  Connection state changed for sun.nio.ch.SelectionKeyImpl@3d9360e2
2013-05-07 12:28:41.887 INFO com.couchbase.client.ViewConnection:  Added localhost to connect queue
2013-05-07 12:28:41.888 INFO com.couchbase.client.CouchbaseClient:  viewmode property isn&#39;t defined. Setting viewmode to production mode
2013-05-07 12:28:41.986 INFO com.couchbase.client.CouchbaseConnection:  Shut down Couchbase client
2013-05-07 12:28:41.991 INFO com.couchbase.client.ViewConnection:  Node localhost has no ops in the queue
2013-05-07 12:28:41.992 INFO com.couchbase.client.ViewNode:  I/O reactor terminated for localhost
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So the format is always: &lt;code&gt;&amp;lt;timestamp&amp;gt; &amp;lt;level&amp;gt; &amp;lt;classname&amp;gt; &amp;lt;message&amp;gt;&lt;/code&gt;. Remeber that DEBUG messages or so will not be logged, so you won&amp;rsquo;t see them with the DefaultLogger.&lt;/p&gt;

&lt;h2 id=&#34;the-sunlogger-java-util-logging&#34;&gt;The SunLogger (java.util.logging)&lt;/h2&gt;

&lt;p&gt;The SunLogger also doesn&amp;rsquo;t introduce additional dependencies, since it depends on the &lt;code&gt;java.util.logging&lt;/code&gt; implementation. The &lt;code&gt;java.util.logging.Level&lt;/code&gt; enum defines the following levels: ALL, CONFIG, FINEST, FINER, FINE, INFO, WARNING, SEVERE and OFF. Since this does not map well to our defined Levels, here is the mapping that happens:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;TRACE to FINEST (with 2.9)&lt;/li&gt;
&lt;li&gt;DEBUG to FINE&lt;/li&gt;
&lt;li&gt;INFO to INFO&lt;/li&gt;
&lt;li&gt;WARN to WARNING&lt;/li&gt;
&lt;li&gt;ERROR to SEVERE&lt;/li&gt;
&lt;li&gt;FATAL to SEVERE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Without any further changes, the SunLogger also prints from INFO level upwards like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;May 7, 2013 12:42:16 PM com.couchbase.client.CouchbaseProperties setPropertyFile
INFO: Could not load properties file &amp;quot;cbclient.properties&amp;quot; because: File not found with system classloader.
May 7, 2013 12:42:16 PM net.spy.memcached.MemcachedConnection createConnections
INFO: Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
May 7, 2013 12:42:16 PM net.spy.memcached.MemcachedConnection handleIO
INFO: Connection state changed for sun.nio.ch.SelectionKeyImpl@4ce2cb55
May 7, 2013 12:42:16 PM com.couchbase.client.ViewConnection createConnections
INFO: Added localhost to connect queue
May 7, 2013 12:42:16 PM com.couchbase.client.CouchbaseClient &amp;lt;init&amp;gt;
INFO: viewmode property isn&#39;t defined. Setting viewmode to production mode
May 7, 2013 12:42:16 PM com.couchbase.client.CouchbaseConnection run
INFO: Shut down Couchbase client
May 7, 2013 12:42:16 PM com.couchbase.client.ViewConnection shutdown
INFO: Node localhost has no ops in the queue
May 7, 2013 12:42:16 PM com.couchbase.client.ViewNode$1 run
INFO: I/O reactor terminated for localhost
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you want to change the log level to DEBUG and lower, you can do it like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Logger.getLogger(&amp;quot;com.couchbase.client&amp;quot;).setLevel(Level.FINEST);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now there is one more thing you need to do if you want to print all debug messages to the console. You set the logging level correctly, but the &lt;code&gt;ConsoleHandler&lt;/code&gt; is not set to debug yet (so most likely you will pay the price for debug logging, but won&amp;rsquo;t actually see anything in your IDE).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;for(Handler h : Logger.getLogger(&amp;quot;com.couchbase.client&amp;quot;).getParent().getHandlers()) {
    if(h instanceof ConsoleHandler) {
        h.setLevel(Level.FINEST);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, here is a full example on how to use the &lt;code&gt;SunLogger&lt;/code&gt; and get all Debug messages on the console.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.SunLogger&amp;quot;);
System.setProperties(systemProperties);

Logger logger = Logger.getLogger(&amp;quot;com.couchbase.client&amp;quot;);
logger.setLevel(Level.FINEST);
for(Handler h : logger.getParent().getHandlers()) {
    if(h instanceof ConsoleHandler){
        h.setLevel(Level.FINEST);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then just go ahead and create your &lt;code&gt;CouchbaseClient&lt;/code&gt; object, you will see detailed output like this (trimmed here):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: Received an update, notifying reconfigurables about a com.couchbase.client.vbucket.config.Bucketcom.couchbase.client.vbucket.config.Bucket@3d77949
May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: Received an update, notifying reconfigurables about a com.couchbase.client.vbucket.config.Bucketcom.couchbase.client.vbucket.config.Bucket@4e927aef
May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: It says it is default and it&#39;s talking to /pools/default/bucketsStreaming/default?bucket_uuid=adfff22b70e09fafaa26ca37b7e05e9d
May 7, 2013 12:54:34 PM com.couchbase.client.vbucket.ReconfigurableObserver update
FINEST: It says it is default and it&#39;s talking to /pools/default/bucketsStreaming/default?bucket_uuid=adfff22b70e09fafaa26ca37b7e05e9d
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;log4j&#34;&gt;Log4J&lt;/h2&gt;

&lt;p&gt;Most people will need more flexibility, and Log4J was (and still is) standard in lots of applications. The SDK provides support for Log4J as well. To make it work, you first need to set the instance correctly:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.Log4JLogger&amp;quot;);
System.setProperties(systemProperties);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now if you run this, you&amp;rsquo;ll get an error that some of the Log4J classes can not be found. This is not a surprise, because its not on the classpath. Let&amp;rsquo;s fix this by adding it accordingly. If you use maven, add the &lt;code&gt;log4j.log4j&lt;/code&gt; dependency (current version is 1.2.17). You can also just download the JAR and add it to the CLASSPATH as needed.&lt;/p&gt;

&lt;p&gt;Now if we run it again, we get another error:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;log4j:WARN No appenders could be found for logger (com.couchbase.client.vbucket.ConfigurationProviderHTTP).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;One way to fix this is to get a correct &lt;code&gt;log4j.xml&lt;/code&gt; configuration file into our CLASSPATH, but to make it work quickly Log4J provides a &lt;code&gt;BasicConfigurator&lt;/code&gt;. Right after the system property configurations, add this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;org.apache.log4j.BasicConfigurator.configure();
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you run it with the code change applied, you will see that we get nicely printed log messages. You can also see that they show up straight from the DEBUG level (and even contain information from which thread they got logged):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;69 [main] INFO com.couchbase.client.CouchbaseConnection  - Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
70 [main] DEBUG com.couchbase.client.vbucket.VBucketNodeLocator  - Updating nodesMap in VBucketNodeLocator.
73 [main] DEBUG com.couchbase.client.vbucket.VBucketNodeLocator  - Adding node with hostname 127.0.0.1:11210.
74 [main] DEBUG com.couchbase.client.vbucket.VBucketNodeLocator  - Node added is {QA sa=localhost/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=8}.
74 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG com.couchbase.client.CouchbaseConnection  - Done dealing with queue.
74 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG com.couchbase.client.CouchbaseConnection  - Selecting with delay of 0ms
79 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG com.couchbase.client.CouchbaseConnection  - Selected 1, selected 1 keys
79 [Memcached IO over
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can control the logging levels through the usual Log4J mechanisms. I won&amp;rsquo;t go into detail about them here, so please &lt;a href=&#34;http://logging.apache.org/log4j/1.2/manual.html&#34;&gt;check out&lt;/a&gt; their official documentation (for example on how to use the &lt;code&gt;PropertyConfigurator&lt;/code&gt; instead).&lt;/p&gt;

&lt;p&gt;Speaking of Log4J, &lt;a href=&#34;https://twitter.com/zooldk&#34;&gt;Steffen Larsen&lt;/a&gt; implemented a &lt;a href=&#34;https://github.com/zooldk/log4j-couchbase&#34;&gt;Log4J appender&lt;/a&gt; to store logs in Couchbase (instead of a file)!&lt;/p&gt;

&lt;h2 id=&#34;the-new-facade-slf4j&#34;&gt;The new Facade: SLF4J&lt;/h2&gt;

&lt;p&gt;Not binding the application to a specific logging library is always a good idea. SLF4J is a facade for various pluggable logging frameworks behind it. So you can choose the logging implementation during runtime, be it &lt;a href=&#34;http://logback.qos.ch/&#34;&gt;logback&lt;/a&gt;, Log4J or others. Since we already tried Log4J, let&amp;rsquo;s make SLF4J work with Logback, one of the other very common log frameworks out there.&lt;/p&gt;

&lt;p&gt;Note that SLF4J support will be available in the 1.9.0 release of spymemcached and therefore also in one of the next releases of the Couchbase Java SDK.&lt;/p&gt;

&lt;p&gt;First, we need to configure it accordingly:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Properties systemProperties = System.getProperties();
systemProperties.put(&amp;quot;net.spy.log.LoggerImpl&amp;quot;, &amp;quot;net.spy.memcached.compat.log.SLF4JLogger&amp;quot;);
System.setProperties(systemProperties);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, we need to include two JARs into our classpath. The first one is the SLF4J facade API and the other one is our logging framework of choice. The facade API package is called &lt;code&gt;slf4j-api&lt;/code&gt; (this package always needs to be in place) and since we want to use logback we need to include the &lt;code&gt;logback-classic&lt;/code&gt; JAR. Note that this is not specific to the SDK, you can find this information &lt;a href=&#34;http://logback.qos.ch/manual/introduction.html&#34;&gt;here&lt;/a&gt;. If you use maven, you can use this snippet:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;dependency&amp;gt;
  &amp;lt;groupId&amp;gt;org.slf4j&amp;lt;/groupId&amp;gt;
  &amp;lt;artifactId&amp;gt;slf4j-api&amp;lt;/artifactId&amp;gt;
  &amp;lt;version&amp;gt;1.7.5&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&amp;lt;dependency&amp;gt;
  &amp;lt;groupId&amp;gt;ch.qos.logback&amp;lt;/groupId&amp;gt;
  &amp;lt;artifactId&amp;gt;logback-classic&amp;lt;/artifactId&amp;gt;
  &amp;lt;version&amp;gt;1.0.12&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;SLF4J will automatically pick up our logback implementation, so the logs will look like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;13:25:43.692 [main] INFO  c.c.client.CouchbaseConnection - Added {QA sa=/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0} to connect queue
13:25:43.694 [main] DEBUG c.c.c.vbucket.VBucketNodeLocator - Updating nodesMap in VBucketNodeLocator.
13:25:43.697 [main] DEBUG c.c.c.vbucket.VBucketNodeLocator - Adding node with hostname 127.0.0.1:11210.
13:25:43.697 [main] DEBUG c.c.c.vbucket.VBucketNodeLocator - Node added is {QA sa=localhost/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=8}.
13:25:43.698 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Done dealing with queue.
13:25:43.699 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Selecting with delay of 0ms
13:25:43.702 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Selected 1, selected 1 keys
13:25:43.703 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] DEBUG c.c.client.CouchbaseConnection - Handling IO for:  sun.nio.ch.SelectionKeyImpl@48ff2413 (r=false, w=false, c=true, op={QA sa=localhost/127.0.0.1:11210, #Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=8})
13:25:43.703 [Memcached IO over {MemcachedConnection to localhost/127.0.0.1:11210}] INFO  c.c.client.CouchbaseConnection - Connection state changed for sun.nio.ch.SelectionKeyImpl@48ff2413
13:25:43.713
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, they also include DEBUG level logging here. If you don&amp;rsquo;t include the logging implementation during runtime, SLF4J will complain at startup:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;SLF4J: Failed to load class &amp;quot;org.slf4j.impl.StaticLoggerBinder&amp;quot;.
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you want to learn how to configure logback, &lt;a href=&#34;http://logback.qos.ch/manual/configuration.html&#34;&gt;look here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Once you know the abstraction in spymemcached and how it works, switching logging implementations is easy and straightforward. If you work with one of the Couchbase people to report errors, please try to include output with DEBUG turned on, because this includes lots of useful information that can be used to determine the failure sources.&lt;/p&gt;

&lt;p&gt;With the SLF4J facade added in the next spy release (2.9), you will be able to plug every large logging framework out there into the SDK. Let us know if you see a use case not covered with these mechanisms or if you have other comments on this.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>